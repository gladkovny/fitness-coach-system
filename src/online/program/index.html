<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí™ MARK WORKOUT TRACKER üí™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 3px solid #ff0000;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            color: #ff0000;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #95a5a6;
            font-size: 1.1em;
        }
        
        .config-section {
            background: rgba(255,255,255,0.08);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 0, 0, 0.2);
        }
        
        .config-section h3 {
            color: #ff0000;
            margin-bottom: 15px;
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            margin-bottom: 10px;
        }
        
        button {
            padding: 12px 30px;
            background: #ff0000;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #cc0000;
            transform: scale(1.05);
        }
        
        /* Source indicator badge */
        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .source-badge.sheets {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid #2ecc71;
        }
        
        .source-badge.default {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
            border: 1px solid #9b59b6;
        }
        
        .workout-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        
        #workoutContent {
            margin-top: 20px;
        }
        
        .workout-btn {
            padding: 25px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255, 0, 0, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .workout-btn:hover {
            background: rgba(255, 0, 0, 0.2);
            border-color: #ff0000;
            transform: translateY(-5px);
        }
        
        .workout-btn.active {
            background: #ff0000;
            border-color: #ff0000;
        }
        
        .workout-btn h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .workout-btn .subtitle {
            color: #95a5a6;
            font-size: 0.9em;
        }
        
        .workout-btn.active .subtitle {
            color: rgba(255,255,255,0.8);
        }
        
        .exercise-list {
            display: none;
        }
        
        .exercise-list.active {
            display: block;
        }
        
        .exercise-card {
            background: rgba(255,255,255,0.08);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 0, 0, 0.2);
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .exercise-title {
            color: #ff0000;
            font-size: 1.3em;
        }
        
        .video-link {
            padding: 8px 15px;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 5px;
            color: #fff;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .video-link:hover {
            background: #ff0000;
        }
        
        .last-result {
            background: rgba(46, 204, 113, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #2ecc71;
        }
        
        .last-result-title {
            color: #2ecc71;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .set-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .set-input {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .delete-set-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            line-height: 1;
        }
        
        .delete-set-btn:hover {
            color: #e74c3c;
            transform: scale(1.2);
        }
        
        .formula-info {
            background: linear-gradient(135deg, rgba(241, 196, 15, 0.15), rgba(0, 0, 0, 0.3));
            border: 1px solid rgba(241, 196, 15, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .formula-info.gravitron {
            background: linear-gradient(135deg, rgba(241, 196, 15, 0.15), rgba(0, 0, 0, 0.3));
            border-color: rgba(241, 196, 15, 0.3);
        }
        
        .formula-info.bodyweight {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.15), rgba(0, 0, 0, 0.3));
            border-color: rgba(46, 204, 113, 0.3);
        }
        
        .instruction-box {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.1), rgba(0, 0, 0, 0.3));
            border: 2px solid rgba(255, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            color: #ecf0f1;
        }
        
        .instruction-box h3 {
            color: #ff0000;
            margin: 0 0 15px 0;
            font-size: 1.1em;
        }
        
        .instruction-box ul {
            margin: 0;
            padding-left: 20px;
            line-height: 1.8;
        }
        
        .instruction-box li {
            margin-bottom: 8px;
        }
        
        .instruction-box strong {
            color: #f1c40f;
        }
        
        .comments-section {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(46, 204, 113, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        
        .comments-section h3 {
            color: #2ecc71;
            margin: 0 0 15px 0;
            font-size: 1.1em;
        }
        
        .comments-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            font-family: Arial, sans-serif;
            resize: vertical;
        }
        
        .comments-textarea:focus {
            outline: none;
            border-color: #2ecc71;
        }
        
        .set-input label {
            display: block;
            color: #95a5a6;
            font-size: 0.8em;
            margin-bottom: 5px;
        }
        
        .set-input input {
            margin-bottom: 0;
        }
        
        .tonnage-display {
            text-align: center;
            padding: 15px;
            background: rgba(241, 196, 15, 0.2);
            border-radius: 10px;
            border: 1px solid #f1c40f;
            margin-top: 10px;
        }
        
        .tonnage-value {
            font-size: 1.5em;
            color: #f1c40f;
            font-weight: bold;
        }
        
        .save-workout-btn {
            width: 100%;
            padding: 20px;
            font-size: 1.2em;
            margin-top: 30px;
            background: linear-gradient(135deg, #ff0000, #cc0000);
        }
        
        .stats-section {
            background: rgba(255,255,255,0.08);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            border: 2px solid rgba(255, 0, 0, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            color: #ff0000;
            font-weight: bold;
        }
        
        .stat-label {
            color: #95a5a6;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        #status {
            margin-top: 10px;
            color: #95a5a6;
            font-size: 0.9em;
        }
        
        .loading-programs {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 0, 0, 0.2);
            border-top: 4px solid #ff0000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .workout-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav style="display: flex; background: rgba(255,255,255,0.05); border-bottom: 2px solid rgba(255, 0, 0, 0.3);">
        <a href="../dashboard/" style="flex: 1; padding: 14px; text-align: center; color: #888; text-decoration: none; font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent;">üìä –î–∞—à–±–æ—Ä–¥</a>
        <a href="index.html" style="flex: 1; padding: 14px; text-align: center; color: #ff0000; text-decoration: none; font-size: 14px; font-weight: 600; border-bottom: 2px solid #ff0000;">üí™ –ü—Ä–æ–≥—Ä–∞–º–º–∞</a>
    </nav>

    <div class="container">
        <div class="header">
            <h1>üí™ MARK WORKOUT TRACKER üí™</h1>
            <div class="subtitle">–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–∞</div>
        </div>
        
        <div class="config-section">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h3>
            <input type="text" id="apiUrl" placeholder="–í—Å—Ç–∞–≤—å Google Sheets API URL">
            <button onclick="saveApiUrl()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
            <div id="status"></div>
            <div id="sourceIndicator"></div>
        </div>
        
        <div class="instruction-box">
            <h3>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
            <ul>
                <li><strong>–ó–∞–ø–∏—Å—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ –ø–æ–¥—Ö–æ–¥—ã</strong> ‚Äî —Ç–µ, –≥–¥–µ –∏–¥—ë—à—å –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</li>
                <li>–†–∞–∑–º–∏–Ω–∞–π—Å—è –∏ –ø–æ–¥–±–∏—Ä–∞–π –≤–µ—Å —Å—Ç–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥–æ–≤, —Å–∫–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–æ–±—ã—á–Ω–æ 1-3 –ø–æ–¥—Ö–æ–¥–∞)</li>
                <li><strong>–û—Ç–¥—ã—Ö –º–µ–∂–¥—É –ø–æ–¥—Ö–æ–¥–∞–º–∏:</strong> —Ä–∞–∑–º–∏–Ω–æ—á–Ω—ã–µ ‚Äî –Ω–µ –±–æ–ª–µ–µ 1,5 –º–∏–Ω—É—Ç—ã, —Ä–∞–±–æ—á–∏–µ ‚Äî 3-4 –º–∏–Ω—É—Ç—ã</li>
                <li><strong>–ü–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π:</strong> —Ä–∞–∑–º–∏–Ω–∞–π—Å—è –∏ –≥—Ä–µ–π –∫–ª—é—á–µ–≤—ã–µ —Å—É—Å—Ç–∞–≤—ã</li>
                <li><strong>–ü–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:</strong> –ø–æ—Ç—è–Ω–∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã–µ –º—ã—à—Ü—ã</li>
            </ul>
        </div>
        
        <!-- Loading state -->
        <div class="loading-programs" id="loadingPrograms" style="display: none;">
            <div class="loading-spinner"></div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º...</div>
        </div>
        
        <div class="workout-selector" id="workoutSelector"></div>
        
        <div id="workoutContent"></div>
        
        <div class="stats-section" id="statsSection" style="display: none;">
            <h3 style="color: #ff0000; margin-bottom: 15px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalWorkouts">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTonnage">0</div>
                    <div class="stat-label">–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂ (–∫–≥)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgTonnage">0</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ç–æ–Ω–Ω–∞–∂</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let apiUrl = localStorage.getItem('markWorkoutApiUrl') || '';
        let currentWorkout = null;
        let workoutData = {};
        let workoutHistory = [];
        let bodyWeight = 105; // Default body weight, updated from Daily sheet
        
        // Programs loaded from API
        let workoutPrograms = {};
        let programsSource = 'default';
        
        // ==========================================
        // LOAD PROGRAMS FROM API
        // ==========================================
        
        async function loadWorkoutPrograms() {
            if (!apiUrl) {
                console.log('No API URL, using default programs');
                workoutPrograms = getDefaultPrograms();
                programsSource = 'default';
                renderWorkoutSelector();
                return;
            }
            
            document.getElementById('loadingPrograms').style.display = 'block';
            document.getElementById('workoutSelector').style.display = 'none';
            
            try {
                const response = await fetch(apiUrl + '?action=getWorkoutPrograms');
                const data = await response.json();
                
                if (data.programs && data.programs.length > 0) {
                    // Convert array to object keyed by ID
                    workoutPrograms = {};
                    data.programs.forEach(program => {
                        workoutPrograms[program.id] = {
                            name: program.name,
                            displayName: program.displayName || program.id,
                            description: program.description || '',
                            emoji: program.emoji || 'üèãÔ∏è',
                            exercises: program.exercises || []
                        };
                    });
                    programsSource = data.source || 'sheets';
                    console.log('Loaded', Object.keys(workoutPrograms).length, 'programs from', programsSource);
                } else {
                    console.log('No programs in response, using defaults');
                    workoutPrograms = getDefaultPrograms();
                    programsSource = 'default';
                }
            } catch (error) {
                console.error('Error loading programs:', error);
                workoutPrograms = getDefaultPrograms();
                programsSource = 'default';
            }
            
            document.getElementById('loadingPrograms').style.display = 'none';
            document.getElementById('workoutSelector').style.display = 'grid';
            
            renderWorkoutSelector();
            updateSourceIndicator();
        }
        
        function getDefaultPrograms() {
            return {
                'A': {
                    name: '–ì—Ä—É–¥—å + –¢—Ä–∏—Ü–µ–ø—Å',
                    displayName: 'A',
                    description: '–ñ–∏–º–æ–≤—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è',
                    emoji: 'üî•',
                    exercises: [
                        { name: '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ', sets: 2, reps: '6-10', video: '', formula: 'gravitron' },
                        { name: '–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª–µ–∂–∞', sets: 3, reps: '6-10', video: '', formula: 'standard' },
                        { name: '–ñ–∏–º –≤ —Å–º–∏—Ç–µ –Ω–∞ –Ω–∞–∫–ª–æ–Ω–Ω–æ–π', sets: 2, reps: '12/9/6', video: '', formula: 'standard' },
                        { name: '–†–∞–∑–≤–æ–¥–∫–∏ –≥–∞–Ω—Ç–µ–ª–µ–π', sets: 2, reps: '12-15', video: '', formula: 'standard' },
                        { name: '–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–∞ —Ç—Ä–∏—Ü–µ–ø—Å', sets: 2, reps: '12-15', video: '', formula: 'standard' }
                    ]
                },
                'B': {
                    name: '–°–ø–∏–Ω–∞ + –ë–∏—Ü–µ–ø—Å',
                    displayName: 'B',
                    description: '–¢—è–≥–æ–≤—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è',
                    emoji: 'üí™',
                    exercises: [
                        { name: '–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞', sets: 2, reps: '12/9/6', video: '', formula: 'standard' },
                        { name: '–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è', sets: 2, reps: '5-9', video: '', formula: 'bodyweight' },
                        { name: '–¢—è–≥–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ –±–ª–æ–∫–∞', sets: 2, reps: '12/9/6', video: '', formula: 'standard' },
                        { name: '–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è', sets: 2, reps: '12-15', video: '', formula: 'standard' },
                        { name: '–ü–æ–¥—ä–µ–º—ã –Ω–∞ –±–∏—Ü–µ–ø—Å', sets: 2, reps: '12/9/6', video: '', formula: 'standard' }
                    ]
                },
                'C': {
                    name: '–ü–ª–µ—á–∏ + –ù–æ–≥–∏',
                    displayName: 'C',
                    description: '–°–º–µ—à–∞–Ω–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',
                    emoji: 'ü¶µ',
                    exercises: [
                        { name: '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è —Å —Ä–µ–∑–∏–Ω–∫–æ–π', sets: 2, reps: '6-10', video: '', formula: 'standard' },
                        { name: '–ñ–∏–º –ª–µ–∂–∞', sets: 3, reps: '3-6', video: '', formula: 'standard' },
                        { name: '–û—Ç–≤–µ–¥–µ–Ω–∏–µ –≥–∞–Ω—Ç–µ–ª–µ–π', sets: 2, reps: '12', video: '', formula: 'standard' },
                        { name: '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –≤–≤–µ—Ä—Ö', sets: 2, reps: '12', video: '', formula: 'standard' },
                        { name: '–ü—Ä–µ—Å—Å', sets: 2, reps: '15-20', video: '', formula: 'bodyweight' }
                    ]
                },
                'FREE': {
                    name: '–°–≤–æ–±–æ–¥–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',
                    displayName: '–°–≤–æ—è',
                    description: '–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è',
                    emoji: 'üéØ',
                    exercises: []
                }
            };
        }
        
        function updateSourceIndicator() {
            const container = document.getElementById('sourceIndicator');
            if (programsSource === 'sheets') {
                container.innerHTML = '<span class="source-badge sheets">üìä –ü—Ä–æ–≥—Ä–∞–º–º—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã</span>';
            } else {
                container.innerHTML = '<span class="source-badge default">üíæ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</span>';
            }
        }
        
        // ==========================================
        // RENDER WORKOUT SELECTOR
        // ==========================================
        
        function renderWorkoutSelector() {
            const container = document.getElementById('workoutSelector');
            
            // Sort: A, B, C first, then others, FREE last
            const sortedIds = Object.keys(workoutPrograms).sort((a, b) => {
                if (a === 'FREE') return 1;
                if (b === 'FREE') return -1;
                if (a === 'A') return -1;
                if (b === 'A') return 1;
                if (a === 'B') return -1;
                if (b === 'B') return 1;
                if (a === 'C') return -1;
                if (b === 'C') return 1;
                return a.localeCompare(b);
            });
            
            let html = '';
            sortedIds.forEach(id => {
                const program = workoutPrograms[id];
                html += `
                    <div class="workout-btn" onclick="selectWorkout('${id}')" data-type="${id}">
                        <h3>${program.emoji} ${program.displayName || id}</h3>
                        <div class="subtitle">${program.name}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // API URL & DATA LOADING
        // ==========================================
        
        function saveApiUrl() {
            const url = document.getElementById('apiUrl').value.trim();
            if (url) {
                localStorage.setItem('markWorkoutApiUrl', url);
                apiUrl = url;
                document.getElementById('status').textContent = '‚úÖ URL —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ...';
                document.getElementById('status').style.color = '#2ecc71';
                loadWorkoutPrograms();
                loadWorkoutHistory();
                loadBodyWeight();
            } else {
                document.getElementById('status').textContent = '‚ùå –í–≤–µ–¥–∏ URL';
                document.getElementById('status').style.color = '#e74c3c';
            }
        }
        
        async function loadWorkoutHistory() {
            if (!apiUrl) return;
            
            try {
                const response = await fetch(apiUrl + '?action=getWorkouts');
                const data = await response.json();
                
                if (data.workoutHistory) {
                    workoutHistory = data.workoutHistory;
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }
        
        async function loadBodyWeight() {
            if (!apiUrl) return;
            
            try {
                const response = await fetch(apiUrl + '?action=getDaily');
                const data = await response.json();
                
                if (data.dailyData) {
                    const dates = Object.keys(data.dailyData).sort((a, b) => {
                        const dateA = a.split('.').reverse().join('-');
                        const dateB = b.split('.').reverse().join('-');
                        return new Date(dateB) - new Date(dateA);
                    });
                    
                    for (const date of dates) {
                        const entry = data.dailyData[date];
                        if (entry.weight && entry.weight !== '') {
                            bodyWeight = parseFloat(entry.weight);
                            console.log('Body weight loaded:', bodyWeight, 'kg');
                            break;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading body weight:', error);
            }
        }
        
        // ==========================================
        // WORKOUT SELECTION & RENDERING
        // ==========================================
        
        function selectWorkout(type) {
            currentWorkout = type;
            
            document.querySelectorAll('.workout-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.workout-btn[data-type="${type}"]`).classList.add('active');
            
            const program = workoutPrograms[type];
            
            if (type === 'FREE' || !program.exercises || program.exercises.length === 0) {
                renderFreeWorkout();
            } else {
                renderWorkout(type);
            }
            
            document.getElementById('statsSection').style.display = 'block';
            
            setTimeout(() => {
                const workoutContent = document.getElementById('workoutContent');
                const yOffset = -20;
                const y = workoutContent.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }, 50);
        }
        
        function renderWorkout(type) {
            const program = workoutPrograms[type];
            const content = document.getElementById('workoutContent');
            
            let html = `<h2 style="color: #ff0000; margin-bottom: 20px;">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ${type}: ${program.name}</h2>`;
            
            // Tonnage chart for this workout type
            const workoutTypeHistory = workoutHistory.filter(w => w.type === type).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (workoutTypeHistory.length > 0) {
                html += `
                    <div class="exercise-card" style="margin-bottom: 30px;">
                        <h3 style="color: #f1c40f; margin-bottom: 15px;">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å —Ç–æ–Ω–Ω–∞–∂–∞ (${type})</h3>
                        <canvas id="tonnageChart" width="800" height="300" style="max-width: 100%;"></canvas>
                        <div style="margin-top: 15px; color: #95a5a6; font-size: 0.9em;">
                            üí° –ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–≤–æ–π —Å—É–º–º–∞—Ä–Ω—ã–π —Ç–æ–Ω–Ω–∞–∂ –ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º
                        </div>
                    </div>
                `;
            }
            
            program.exercises.forEach((exercise, index) => {
                const lastResult = getLastResult(type, exercise.name);
                
                // Determine formula type
                const formula = (exercise.formula || 'standard').toLowerCase();
                const isGravitron = formula === 'gravitron' || exercise.name.toLowerCase().includes('–≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ');
                const isBodyweight = formula === 'bodyweight' || exercise.name.toLowerCase().includes('–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è');
                
                // Number of sets (from sheet or default)
                const numSets = exercise.sets || 3;
                
                html += `
                    <div class="exercise-card">
                        <div class="exercise-header">
                            <div class="exercise-title">${index + 1}. ${exercise.name}</div>
                            ${exercise.video ? `<a href="${exercise.video}" target="_blank" class="video-link">üìπ –¢–µ—Ö–Ω–∏–∫–∞</a>` : ''}
                        </div>
                        
                        ${isGravitron ? `
                            <div class="formula-info gravitron">
                                ‚öôÔ∏è <strong>–ì—Ä–∞–≤–∏—Ç—Ä–æ–Ω:</strong> –í–µ—Å —Ç–µ–ª–∞: <strong>${bodyWeight} –∫–≥</strong>. –¢–æ–Ω–Ω–∞–∂ = (${bodyWeight} –∫–≥ - –ø—Ä–æ—Ç–∏–≤–æ–≤–µ—Å) √ó –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                            </div>
                        ` : ''}
                        
                        ${isBodyweight ? `
                            <div class="formula-info bodyweight">
                                üí™ <strong>–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å:</strong> –í–µ—Å —Ç–µ–ª–∞: <strong>${bodyWeight} –∫–≥</strong>. –¢–æ–Ω–Ω–∞–∂ = ${bodyWeight} –∫–≥ √ó –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                            </div>
                        ` : ''}
                        
                        ${lastResult ? `
                            <div class="last-result">
                                <div class="last-result-title">üìä –ü—Ä–æ—à–ª–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:</div>
                                <div>${lastResult}</div>
                            </div>
                        ` : ''}
                        
                        <div class="set-grid" id="exercise-${index}">
                            ${Array(numSets).fill(0).map((_, setIndex) => `
                                <div class="set-input" id="set-${index}-${setIndex}">
                                    <label>–ü–æ–¥—Ö–æ–¥ ${setIndex + 1} ${exercise.reps ? `(${exercise.reps})` : ''}</label>
                                    ${isBodyweight ? '' : `<input type="number" placeholder="${isGravitron ? '–ü—Ä–æ—Ç–∏–≤–æ–≤–µ—Å (–∫–≥)' : '–í–µ—Å (–∫–≥)'}" id="weight-${index}-${setIndex}" step="0.5">`}
                                    <input type="number" placeholder="–ü–æ–≤—Ç–æ—Ä—ã" id="reps-${index}-${setIndex}">
                                </div>
                            `).join('')}
                        </div>
                        
                        <button style="margin-top: 10px; padding: 8px 15px; background: rgba(46, 204, 113, 0.3); border: 1px solid #2ecc71; border-radius: 5px; color: #2ecc71; cursor: pointer; font-size: 0.9em;" 
                                onclick="addSet(${index}, '${exercise.name}', '${formula}')">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥
                        </button>
                        
                        <div class="tonnage-display">
                            <div style="color: #95a5a6; font-size: 0.9em;">–¢–æ–Ω–Ω–∞–∂:</div>
                            <div class="tonnage-value" id="tonnage-${index}">0 –∫–≥</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div class="comments-section">
                    <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</h3>
                    <textarea id="workoutComments" class="comments-textarea" placeholder="–ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞? –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, —á—Ç–æ –∑–∞–º–µ—Ç–∏–ª..."></textarea>
                    <div style="margin-top: 10px; color: #95a5a6; font-size: 0.9em;">
                        üí° –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–ø–∏—à–∏ —Å–≤–æ–∏ –æ—â—É—â–µ–Ω–∏—è, —ç–Ω–µ—Ä–≥–∏—é, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
                    </div>
                </div>
                <button class="save-workout-btn" onclick="saveWorkout()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –¢–†–ï–ù–ò–†–û–í–ö–£</button>
            `;
            
            content.innerHTML = html;
            
            // Add event listeners for tonnage calculation
            program.exercises.forEach((exercise, index) => {
                const formula = (exercise.formula || 'standard').toLowerCase();
                const isBodyweight = formula === 'bodyweight' || exercise.name.toLowerCase().includes('–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è');
                const numSets = exercise.sets || 3;
                
                for (let setIndex = 0; setIndex < numSets; setIndex++) {
                    const weightInput = document.getElementById(`weight-${index}-${setIndex}`);
                    const repsInput = document.getElementById(`reps-${index}-${setIndex}`);
                    
                    if (weightInput) {
                        weightInput.addEventListener('input', () => calculateTonnage(index, numSets, exercise.name, formula));
                    }
                    
                    if (repsInput) {
                        repsInput.addEventListener('input', () => calculateTonnage(index, numSets, exercise.name, formula));
                    }
                }
            });
            
            // Draw tonnage chart if there's history
            if (workoutTypeHistory.length > 0) {
                setTimeout(() => drawTonnageChart(workoutTypeHistory), 100);
            }
        }
        
        function calculateTonnage(exerciseIndex, totalSets, exerciseName = '', formula = 'standard') {
            let tonnage = 0;
            const exerciseGrid = document.getElementById(`exercise-${exerciseIndex}`);
            const allSets = exerciseGrid.querySelectorAll('.set-input');
            
            // Determine formula type
            const isGravitron = formula === 'gravitron' || exerciseName.toLowerCase().includes('–≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ');
            const isBodyweight = formula === 'bodyweight' || exerciseName.toLowerCase().includes('–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è');
            
            allSets.forEach((setDiv, setIndex) => {
                const weight = parseFloat(document.getElementById(`weight-${exerciseIndex}-${setIndex}`)?.value) || 0;
                const reps = parseInt(document.getElementById(`reps-${exerciseIndex}-${setIndex}`)?.value) || 0;
                
                if (isGravitron) {
                    // Gravitron: (Body weight - Counterweight) √ó Reps
                    const actualWeight = bodyWeight - weight;
                    tonnage += actualWeight * reps;
                } else if (isBodyweight) {
                    // Bodyweight: Body weight √ó Reps
                    tonnage += bodyWeight * reps;
                } else {
                    // Standard: Weight √ó Reps
                    tonnage += weight * reps;
                }
            });
            
            const tonnageDisplay = document.getElementById(`tonnage-${exerciseIndex}`);
            if (tonnageDisplay) {
                tonnageDisplay.textContent = `${tonnage.toFixed(1)} –∫–≥`;
            }
        }
        
        function addSet(exerciseIndex, exerciseName, formula) {
            const exerciseGrid = document.getElementById(`exercise-${exerciseIndex}`);
            const currentSets = exerciseGrid.querySelectorAll('.set-input').length;
            const newSetIndex = currentSets;
            
            const isGravitron = formula === 'gravitron' || exerciseName.toLowerCase().includes('–≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ');
            const isBodyweight = formula === 'bodyweight' || exerciseName.toLowerCase().includes('–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è');
            const weightPlaceholder = isGravitron ? '–ü—Ä–æ—Ç–∏–≤–æ–≤–µ—Å (–∫–≥)' : '–í–µ—Å (–∫–≥)';
            
            const newSet = document.createElement('div');
            newSet.className = 'set-input';
            newSet.id = `set-${exerciseIndex}-${newSetIndex}`;
            newSet.innerHTML = `
                <button class="delete-set-btn" onclick="removeSet(${exerciseIndex}, ${newSetIndex}, '${exerciseName}', '${formula}')" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥">‚úï</button>
                <label>–ü–æ–¥—Ö–æ–¥ ${newSetIndex + 1}</label>
                ${isBodyweight ? '' : `<input type="number" placeholder="${weightPlaceholder}" id="weight-${exerciseIndex}-${newSetIndex}" step="0.5">`}
                <input type="number" placeholder="–ü–æ–≤—Ç–æ—Ä—ã" id="reps-${exerciseIndex}-${newSetIndex}">
            `;
            
            exerciseGrid.appendChild(newSet);
            
            // Add event listeners
            const weightInput = document.getElementById(`weight-${exerciseIndex}-${newSetIndex}`);
            const repsInput = document.getElementById(`reps-${exerciseIndex}-${newSetIndex}`);
            
            if (repsInput) {
                repsInput.addEventListener('input', () => calculateTonnage(exerciseIndex, currentSets + 1, exerciseName, formula));
            }
            
            if (weightInput) {
                weightInput.addEventListener('input', () => calculateTonnage(exerciseIndex, currentSets + 1, exerciseName, formula));
            }
        }
        
        function removeSet(exerciseIndex, setIndex, exerciseName, formula) {
            const setElement = document.getElementById(`set-${exerciseIndex}-${setIndex}`);
            if (setElement) {
                setElement.remove();
                
                // Recalculate tonnage
                const exerciseGrid = document.getElementById(`exercise-${exerciseIndex}`);
                const remainingSets = exerciseGrid.querySelectorAll('.set-input').length;
                calculateTonnage(exerciseIndex, remainingSets, exerciseName, formula);
                
                // Renumber remaining sets
                const allSets = exerciseGrid.querySelectorAll('.set-input');
                allSets.forEach((setDiv, index) => {
                    const label = setDiv.querySelector('label');
                    if (label) {
                        label.textContent = `–ü–æ–¥—Ö–æ–¥ ${index + 1}`;
                    }
                });
            }
        }
        
        function drawTonnageChart(workoutTypeHistory) {
            const canvas = document.getElementById('tonnageChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            const dates = workoutTypeHistory.map(w => {
                const d = new Date(w.date);
                return `${d.getDate()}/${d.getMonth() + 1}`;
            });
            const tonnages = workoutTypeHistory.map(w => w.totalTonnage);
            const maxTonnage = Math.max(...tonnages);
            const minTonnage = Math.min(...tonnages);
            
            const marginLeft = 60;
            const marginRight = 20;
            const marginTop = 20;
            const marginBottom = 40;
            
            const chartWidth = width - marginLeft - marginRight;
            const chartHeight = height - marginTop - marginBottom;
            
            // Draw axes
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(marginLeft, marginTop);
            ctx.lineTo(marginLeft, height - marginBottom);
            ctx.lineTo(width - marginRight, height - marginBottom);
            ctx.stroke();
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            ctx.font = '12px Arial';
            ctx.fillStyle = '#95a5a6';
            
            const ySteps = 5;
            for (let i = 0; i <= ySteps; i++) {
                const y = height - marginBottom - (i / ySteps) * chartHeight;
                const value = minTonnage + (maxTonnage - minTonnage) * (i / ySteps);
                
                ctx.beginPath();
                ctx.moveTo(marginLeft, y);
                ctx.lineTo(width - marginRight, y);
                ctx.stroke();
                
                ctx.fillText(value.toFixed(0), 10, y + 4);
            }
            
            // Draw line
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            tonnages.forEach((tonnage, index) => {
                const x = marginLeft + (index / (tonnages.length - 1 || 1)) * chartWidth;
                const y = height - marginBottom - ((tonnage - minTonnage) / (maxTonnage - minTonnage || 1)) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw points
            tonnages.forEach((tonnage, index) => {
                const x = marginLeft + (index / (tonnages.length - 1 || 1)) * chartWidth;
                const y = height - marginBottom - ((tonnage - minTonnage) / (maxTonnage - minTonnage || 1)) * chartHeight;
                
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#95a5a6';
                ctx.fillText(dates[index], x - 15, height - marginBottom + 20);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 11px Arial';
                ctx.fillText(tonnage.toFixed(0), x - 15, y - 10);
            });
        }
        
        function getLastResult(workoutType, exerciseName) {
            const lastWorkout = workoutHistory
                .filter(w => w.type === workoutType)
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            
            if (!lastWorkout) return null;
            
            const exercise = lastWorkout.exercises.find(e => e.name === exerciseName);
            if (!exercise) return null;
            
            const sets = exercise.sets.map((s, i) => `${i+1}: ${s.weight}–∫–≥ √ó ${s.reps}`).join(' | ');
            return `${sets} = ${exercise.tonnage.toFixed(1)}–∫–≥`;
        }
        
        async function saveWorkout() {
            if (!apiUrl) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π API URL');
                return;
            }
            
            if (!currentWorkout) {
                alert('‚ùå –í—ã–±–µ—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É');
                return;
            }
            
            const program = workoutPrograms[currentWorkout];
            const workout = {
                type: currentWorkout,
                date: new Date().toISOString(),
                exercises: []
            };
            
            let totalTonnage = 0;
            
            program.exercises.forEach((exercise, index) => {
                const sets = [];
                let exerciseTonnage = 0;
                
                const exerciseGrid = document.getElementById(`exercise-${index}`);
                const allSets = exerciseGrid.querySelectorAll('.set-input');
                
                const formula = (exercise.formula || 'standard').toLowerCase();
                const isGravitron = formula === 'gravitron' || exercise.name.toLowerCase().includes('–≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ');
                const isBodyweight = formula === 'bodyweight' || exercise.name.toLowerCase().includes('–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è');
                
                allSets.forEach((setDiv, setIndex) => {
                    const weightInput = document.getElementById(`weight-${index}-${setIndex}`);
                    const weight = weightInput ? parseFloat(weightInput.value) || 0 : 0;
                    const reps = parseInt(document.getElementById(`reps-${index}-${setIndex}`)?.value) || 0;
                    
                    if (reps > 0) {
                        let actualWeight = weight;
                        let setTonnage = 0;
                        
                        if (isGravitron) {
                            actualWeight = bodyWeight - weight;
                            setTonnage = actualWeight * reps;
                        } else if (isBodyweight) {
                            actualWeight = bodyWeight;
                            setTonnage = bodyWeight * reps;
                        } else {
                            if (weight > 0) {
                                setTonnage = weight * reps;
                            }
                        }
                        
                        if (setTonnage > 0) {
                            sets.push({ weight: actualWeight, reps });
                            exerciseTonnage += setTonnage;
                        }
                    }
                });
                
                if (sets.length > 0) {
                    workout.exercises.push({
                        name: exercise.name,
                        sets: sets,
                        tonnage: exerciseTonnage
                    });
                    totalTonnage += exerciseTonnage;
                }
            });
            
            workout.totalTonnage = totalTonnage;
            workout.comments = document.getElementById('workoutComments')?.value.trim() || '';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveWorkout',
                        workout: workout
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                    workoutHistory.push(workout);
                    updateStats();
                    const commentsField = document.getElementById('workoutComments');
                    if (commentsField) commentsField.value = '';
                    renderWorkout(currentWorkout);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        function renderFreeWorkout() {
            const content = document.getElementById('workoutContent');
            content.innerHTML = `
                <h2 style="color: #ff0000; margin-bottom: 20px;">–°–≤–æ–±–æ–¥–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
                <div class="exercise-card">
                    <div class="exercise-header">
                        <div class="exercise-title">üìù –ó–∞–º–µ—Ç–∫–∏ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</div>
                    </div>
                    
                    <textarea id="freeWorkoutNotes" 
                        style="width: 100%; 
                               min-height: 200px; 
                               padding: 15px; 
                               background: rgba(255,255,255,0.05); 
                               border: 2px solid rgba(255, 0, 0, 0.3); 
                               border-radius: 10px; 
                               color: #fff; 
                               font-size: 1em;
                               font-family: Arial, sans-serif;
                               resize: vertical;"
                        placeholder="–ß—Ç–æ –¥–µ–ª–∞–ª –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ?
–ù–∞–ø—Ä–∏–º–µ—Ä:
- –ö–∞—Ä–¥–∏–æ 30 –º–∏–Ω—É—Ç
- –†–∞—Å—Ç—è–∂–∫–∞
- –ü—Ä–æ–±–æ–≤–∞–ª –Ω–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
- –û—Ç—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Ö–Ω–∏–∫–∏

–≠—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ, –Ω–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–æ–Ω–Ω–∞–∂."></textarea>
                    
                    <div style="margin-top: 15px; color: #95a5a6; font-size: 0.9em;">
                        üí° –°–≤–æ–±–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: –æ–ø–∏—à–∏ —á—Ç–æ –¥–µ–ª–∞–ª, –∫–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤–æ–≤–∞–ª, –∫–∞–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø—Ä–æ–±–æ–≤–∞–ª
                    </div>
                </div>
                
                <button class="save-workout-btn" onclick="saveFreeWorkout()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –¢–†–ï–ù–ò–†–û–í–ö–£</button>
            `;
        }
        
        async function saveFreeWorkout() {
            if (!apiUrl) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π API URL');
                return;
            }
            
            const notes = document.getElementById('freeWorkoutNotes').value.trim();
            
            if (!notes) {
                alert('‚ùå –ù–∞–ø–∏—à–∏ —á—Ç–æ –¥–µ–ª–∞–ª –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ');
                return;
            }
            
            const workout = {
                type: 'FREE',
                date: new Date().toISOString(),
                notes: notes,
                exercises: [],
                totalTonnage: 0
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveWorkout',
                        workout: workout
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                    document.getElementById('freeWorkoutNotes').value = '';
                    workoutHistory.push(workout);
                    updateStats();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        function updateStats() {
            const total = workoutHistory.length;
            const totalTonnage = workoutHistory.reduce((sum, w) => sum + (w.totalTonnage || 0), 0);
            const avgTonnage = total > 0 ? totalTonnage / total : 0;
            
            document.getElementById('totalWorkouts').textContent = total;
            document.getElementById('totalTonnage').textContent = totalTonnage.toFixed(0);
            document.getElementById('avgTonnage').textContent = avgTonnage.toFixed(0);
        }
        
        function init() {
            if (apiUrl) {
                document.getElementById('apiUrl').value = apiUrl;
                loadWorkoutPrograms();
                loadWorkoutHistory();
                loadBodyWeight();
            } else {
                // Show default programs even without API
                workoutPrograms = getDefaultPrograms();
                renderWorkoutSelector();
                updateSourceIndicator();
            }
        }
        
        init();
    </script>
</body>
</html>
