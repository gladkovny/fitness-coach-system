<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Прогресс тренировок</title>
  <style>
    :root {
      --bg: #f5f5f7;
      --card: #ffffff;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --accent: #0071e3;
      --accent-light: #e8f4fd;
      --success: #34c759;
      --warning: #ff9500;
      --danger: #ff3b30;
      --border: #d2d2d7;
      --shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
      padding-bottom: 90px;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%);
      color: white;
      padding: 20px 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .header h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
    .header .start-date { opacity: 0.7; font-size: 13px; margin-top: 4px; }
    
    .settings-btn {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }
    
    /* Main */
    main { padding: 16px; max-width: 600px; margin: 0 auto; }
    
    /* Cards */
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    /* Period Selector */
    .period-selector {
      display: flex;
      gap: 4px;
      background: var(--bg);
      padding: 3px;
      border-radius: 8px;
    }
    
    .period-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .period-btn.active {
      background: white;
      color: var(--text);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Block Progress */
    .block-stats {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .block-circle {
      width: 80px;
      height: 80px;
      position: relative;
    }
    
    .block-circle svg {
      transform: rotate(-90deg);
      width: 80px;
      height: 80px;
    }
    
    .block-circle-bg {
      fill: none;
      stroke: var(--bg);
      stroke-width: 6;
    }
    
    .block-circle-fill {
      fill: none;
      stroke: var(--accent);
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }
    
    .block-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-weight: 700;
    }
    
    .block-info { flex: 1; }
    .block-label { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .block-sublabel { font-size: 13px; color: var(--text-secondary); }
    
    /* Goals */
    .goals-list { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .goal-tag {
      background: var(--accent-light);
      color: var(--accent);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    
    /* Muscle Groups */
    .muscle-groups { display: flex; flex-direction: column; gap: 12px; }
    
    .muscle-group {
      background: var(--bg);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .muscle-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .muscle-group-header:hover { background: rgba(0,0,0,0.02); }
    
    .muscle-group-name {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 15px;
    }
    
    .muscle-group-icon { font-size: 20px; }
    
    .muscle-group-stats {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .muscle-group-sets {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .muscle-group-bar {
      width: 60px;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .muscle-group-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .muscle-group-arrow {
      color: var(--text-secondary);
      transition: transform 0.2s;
    }
    
    .muscle-group.expanded .muscle-group-arrow { transform: rotate(180deg); }
    
    .muscle-details {
      display: none;
      padding: 0 16px 14px;
    }
    
    .muscle-group.expanded .muscle-details { display: block; }
    
    .muscle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-top: 1px solid var(--border);
    }
    
    .muscle-name { font-size: 14px; color: var(--text-secondary); }
    .muscle-value { font-size: 14px; font-weight: 500; }
    
    /* Weekly Comparison */
    .weeks-comparison {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .week-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }
    
    .week-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
    .week-value { font-size: 24px; font-weight: 700; }
    .week-subvalue { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    
    .week-change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 8px;
    }
    
    .week-change.up { background: #d4edda; color: #155724; }
    .week-change.down { background: #f8d7da; color: #721c24; }
    .week-change.same { background: var(--border); color: var(--text-secondary); }
    
    /* Progress Records */
    .progress-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .progress-item:last-child { border-bottom: none; }
    
    .progress-info { flex: 1; }
    .progress-name { font-weight: 600; font-size: 15px; }
    .progress-date { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    
    .progress-values {
      text-align: right;
    }
    
    .progress-weight { font-size: 18px; font-weight: 700; color: var(--accent); }
    .progress-change { font-size: 12px; color: var(--success); font-weight: 500; }
    
    /* Sessions */
    .session-item {
      padding: 14px;
      background: var(--bg);
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .session-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .session-item:last-child { margin-bottom: 0; }
    
    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .session-date { font-weight: 600; font-size: 15px; }
    .session-type { font-size: 13px; color: var(--accent); font-weight: 500; }
    
    .session-stats {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .session-stat { display: flex; align-items: center; gap: 4px; }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 300;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: var(--card);
      border-radius: 20px 20px 0 0;
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      padding: 20px;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    
    .modal-handle {
      width: 36px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 0 auto 16px;
    }
    
    .modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .modal-subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
    
    .modal-section { margin-bottom: 20px; }
    .modal-section-title { font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; font-weight: 500; }
    
    .modal-stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .modal-stat {
      background: var(--bg);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .modal-stat-value { font-size: 20px; font-weight: 700; }
    .modal-stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
    
    .modal-exercise-list { list-style: none; }
    
    .modal-exercise {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-exercise:last-child { border-bottom: none; }
    .modal-exercise-name { font-size: 14px; }
    .modal-exercise-detail { font-size: 14px; color: var(--text-secondary); }
    
    /* Settings Modal */
    .settings-modal {
      border-radius: 20px;
      max-width: 400px;
      margin: auto;
    }
    
    .settings-modal h2 { margin-bottom: 20px; }
    
    .settings-modal label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .settings-modal input {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .modal-buttons { display: flex; gap: 12px; margin-top: 10px; }
    
    .modal-buttons button {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-cancel { background: var(--bg); border: none; color: var(--text); }
    .btn-save { background: var(--accent); border: none; color: white; }
    
    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      display: flex;
      justify-content: space-around;
      padding: 10px 0 20px;
      box-shadow: 0 -1px 10px rgba(0,0,0,0.08);
      z-index: 100;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 24px; margin-bottom: 2px; }
    
    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .empty-state {
      text-align: center;
      padding: 32px;
      color: var(--text-secondary);
    }
    
    .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    
    /* Page: History */
    .history-page, .records-page { display: none; }
    .history-page.active, .records-page.active { display: block; }
    .main-page { display: block; }
    .main-page.hidden { display: none; }
    
    /* Chart Container */
    .chart-container {
      height: 200px;
      background: var(--bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
    }
    
    .chart-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    /* Records List */
    .record-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      background: var(--bg);
      border-radius: 12px;
      margin-bottom: 10px;
    }
    
    .record-type {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .record-name { font-weight: 600; font-size: 15px; margin-top: 2px; }
    
    .record-value-container { text-align: right; }
    .record-value { font-size: 20px; font-weight: 700; color: var(--accent); }
    .record-date { font-size: 12px; color: var(--text-secondary); }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">
      <div class="spinner"></div>
      <div>Загрузка...</div>
    </div>
  </div>

  <script>
    // ══════════════════════════════════════════════════════════════
    // CONFIG & STATE
    // ══════════════════════════════════════════════════════════════
    
    const CONFIG = {
      get API_URL() { return localStorage.getItem('api_url') || 'https://script.google.com/macros/s/AKfycbzLfiQUxi5HAojhxaitEpqUxrn7E0XFEDFSNc2WGbgVrYNv14awSB7W7VigbcbmvOX9/exec'; },
      set API_URL(v) { localStorage.setItem('api_url', v); },
      get CLIENT_ID() {
        return new URLSearchParams(window.location.search).get('client') || 
               localStorage.getItem('client_id') || 'yaroslav';
      },
      set CLIENT_ID(v) { localStorage.setItem('client_id', v); }
    };
    
    let data = null;
    let currentPage = 'main';
    let currentPeriod = 'block';
    
    // ══════════════════════════════════════════════════════════════
    // MAIN
    // ══════════════════════════════════════════════════════════════
    
    async function loadDashboard() {
      if (!CONFIG.API_URL) { showSetupScreen(); return; }
      
      try {
        const url = `${CONFIG.API_URL}?action=getOfflineDashboard&clientId=${CONFIG.CLIENT_ID}`;
        const response = await fetch(url);
        data = await response.json();
        
        if (data.error) { showError(data.error); return; }
        
        renderApp();
        localStorage.setItem(`dashboard_${CONFIG.CLIENT_ID}`, JSON.stringify(data));
        
      } catch (error) {
        const cached = localStorage.getItem(`dashboard_${CONFIG.CLIENT_ID}`);
        if (cached) { data = JSON.parse(cached); renderApp(); }
        else { showError('Ошибка загрузки: ' + error.message); }
      }
    }
    
    function renderApp() {
      const clientName = data.goals?.clientName || data.profile?.name || 'Клиент';
      const startDate = data.goals?.startDate || '';
      
      document.getElementById('app').innerHTML = `
        <header class="header">
          <div class="header-top">
            <div>
              <h1>${clientName}</h1>
              ${startDate ? `<div class="start-date">С ${formatDateFull(startDate)}</div>` : ''}
            </div>
            <button class="settings-btn" onclick="showSettings()">⚙️</button>
          </div>
        </header>
        
        <main class="main-page" id="mainPage">
          ${renderBlockProgress()}
          ${renderGoals()}
          ${renderMuscleLoad()}
          ${renderWeeklyComparison()}
          ${renderProgress()}
          ${renderRecentSessions()}
        </main>
        
        <main class="history-page" id="historyPage">
          ${renderHistoryPage()}
        </main>
        
        <main class="records-page" id="recordsPage">
          ${renderRecordsPage()}
        </main>
        
        <nav class="bottom-nav">
          <div class="nav-item active" onclick="showPage('main')"><span class="nav-icon">??</span>Главная</div>
          <div class="nav-item" onclick="showPage('history')"><span class="nav-icon">??</span>История</div>
          <div class="nav-item" onclick="showPage('records')"><span class="nav-icon">??</span>Рекорды</div>
        </nav>
        
        <div class="modal-overlay" id="sessionModal" onclick="if(event.target===this)closeModal()"></div>
        <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)hideSettings()"></div>
      `;
    }
    
    // ══════════════════════════════════════════════════════════════
    // RENDER: BLOCK PROGRESS
    // ══════════════════════════════════════════════════════════════
    
    function renderBlockProgress() {
      const block = data.currentBlock;
      if (!block || block.status === 'none') {
        return `<div class="card"><div class="card-title">?? Блок</div>
          <div class="empty-state"><div class="empty-icon">??</div>Нет активного блока</div></div>`;
      }
      
      const circumference = 2 * Math.PI * 35;
      const offset = circumference - (block.progress / 100) * circumference;
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">?? Блок ${block.blockId || 1}</span></div>
          <div class="block-stats">
            <div class="block-circle">
              <svg viewBox="0 0 80 80">
                <circle class="block-circle-bg" cx="40" cy="40" r="35"/>
                <circle class="block-circle-fill" cx="40" cy="40" r="35" 
                  stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/>
              </svg>
              <div class="block-number">${block.usedSessions}</div>
            </div>
            <div class="block-info">
              <div class="block-label">${block.usedSessions} из ${block.totalSessions} тренировок</div>
              <div class="block-sublabel">${block.remaining > 0 ? `Осталось ${block.remaining}` : '?? Завершён!'}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // ══════════════════════════════════════════════════════════════
    // RENDER: GOALS
    // ══════════════════════════════════════════════════════════════
    
    function renderGoals() {
      const goalsText = data.goals?.mainGoals || '';
      if (!goalsText) return '';
      
      const goals = goalsText.split(/[.,]/).map(g => g.trim()).filter(g => g.length > 2);
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">?? Цели</span></div>
          <div class="goals-list">${goals.map(g => `<span class="goal-tag">${g}</span>`).join('')}</div>
        </div>
      `;
    }
    
    // ══════════════════════════════════════════════════════════════
    // RENDER: MUSCLE LOAD (Grouped)
    // ══════════════════════════════════════════════════════════════
    
    function renderMuscleLoad() {
      const heatmap = data.muscleHeatmap;
      if (!heatmap?.muscles) {
        return `<div class="card"><div class="card-title">?? Нагрузка</div>
          <div class="empty-state"><div class="empty-icon">??</div>Нет данных</div></div>`;
      }
      
      // Группируем мышцы
      const groups = {
        legs: { 
          name: 'Ноги', 
          icon: '??', 
          color: '#007aff',
          muscles: ['quads', 'hamstrings', 'glutes', 'calves'],
          labels: { quads: 'Квадрицепс', hamstrings: 'Бицепс бедра', glutes: 'Ягодицы', calves: 'Икры' }
        },
        back: { 
          name: 'Спина', 
          icon: '??', 
          color: '#5856d6',
          muscles: ['lats', 'traps', 'low_back', 'rear_delt'],
          labels: { lats: 'Широчайшие', traps: 'Трапеция', low_back: 'Поясница', rear_delt: 'Задняя дельта' }
        },
        chest: { 
          name: 'Грудь и плечи', 
          icon: '??', 
          color: '#ff2d55',
          muscles: ['chest', 'front_delt', 'mid_delt'],
          labels: { chest: 'Грудь', front_delt: 'Передняя дельта', mid_delt: 'Средняя дельта' }
        },
        arms: { 
          name: 'Руки и кор', 
          icon: '??', 
          color: '#ff9500',
          muscles: ['biceps', 'triceps', 'core'],
          labels: { biceps: 'Бицепс', triceps: 'Трицепс', core: 'Кор/Пресс' }
        }
      };
      
      // Считаем суммы по группам
      const muscles = heatmap.muscles;
      let maxGroupSets = 0;
      
      for (const [key, group] of Object.entries(groups)) {
        group.totalSets = group.muscles.reduce((sum, m) => sum + (muscles[m]?.sets || 0), 0);
        maxGroupSets = Math.max(maxGroupSets, group.totalSets);
      }
      
      return `
        <div class="card">
          <div class="card-header">
            <span class="card-title">?? Нагрузка по мышцам</span>
            <div class="period-selector">
              <button class="period-btn ${currentPeriod === 'block' ? 'active' : ''}" onclick="setPeriod('block')">Блок</button>
              <button class="period-btn ${currentPeriod === '3m' ? 'active' : ''}" onclick="setPeriod('3m')">3 мес</button>
              <button class="period-btn ${currentPeriod === 'all' ? 'active' : ''}" onclick="setPeriod('all')">Всё</button>
            </div>
          </div>
          <div class="muscle-groups">
            ${Object.entries(groups).map(([key, group]) => {
              const width = maxGroupSets > 0 ? (group.totalSets / maxGroupSets) * 100 : 0;
              return `
                <div class="muscle-group" id="group-${key}">
                  <div class="muscle-group-header" onclick="toggleMuscleGroup('${key}')">
                    <div class="muscle-group-name">
                      <span class="muscle-group-icon">${group.icon}</span>
                      ${group.name}
                    </div>
                    <div class="muscle-group-stats">
                      <span class="muscle-group-sets">${Math.round(group.totalSets)} подх.</span>
                      <div class="muscle-group-bar">
                        <div class="muscle-group-fill" style="width: ${width}%; background: ${group.color}"></div>
                      </div>
                      <span class="muscle-group-arrow">▼</span>
                    </div>
                  </div>
                  <div class="muscle-details">
                    ${group.muscles.map(m => {
                      const sets = muscles[m]?.sets || 0;
                      return `
                        <div class="muscle-item">
                          <span class="muscle-name">${group.labels[m]}</span>
                          <span class="muscle-value">${Math.round(sets * 10) / 10}</span>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    function toggleMuscleGroup(key) {
      document.getElementById(`group-${key}`).classList.toggle('expanded');
    }
    
    function setPeriod(period) {
      currentPeriod = period;
      // TODO: Перезагрузить данные с API для нужного периода
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(
          period === 'block' ? 'блок' : period === '3m' ? '3' : 'всё'
        ));
      });
    }
    
    // ══════════════════════════════════════════════════════════════
    // RENDER: WEEKLY COMPARISON
    // ══════════════════════════════════════════════════════════════
    
    function renderWeeklyComparison() {
      // Рассчитываем из последних сессий
      const sessions = data.recentSessions || [];
      
      const now = new Date();
      const thisWeekStart = new Date(now);
      thisWeekStart.setDate(now.getDate() - now.getDay());
      thisWeekStart.setHours(0, 0, 0, 0);
      
      const lastWeekStart = new Date(thisWeekStart);
      lastWeekStart.setDate(lastWeekStart.getDate() - 7);
      
      let thisWeek = { count: 0, volume: 0 };
      let lastWeek = { count: 0, volume: 0 };
      
      sessions.forEach(s => {
        const date = new Date(s.date);
        const volume = s.totalVolume || 0;
        
        if (date >= thisWeekStart) {
          thisWeek.count++;
          thisWeek.volume += volume;
        } else if (date >= lastWeekStart) {
          lastWeek.count++;
          lastWeek.volume += volume;
        }
      });
      
      const countChange = thisWeek.count - lastWeek.count;
      const volumeChange = lastWeek.volume > 0 
        ? Math.round(((thisWeek.volume - lastWeek.volume) / lastWeek.volume) * 100) 
        : 0;
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">?? Эта неделя vs прошлая</span></div>
          <div class="weeks-comparison">
            <div class="week-card">
              <div class="week-label">Тренировок</div>
              <div class="week-value">${thisWeek.count}</div>
              <div class="week-subvalue">прошлая: ${lastWeek.count}</div>
              <div class="week-change ${countChange > 0 ? 'up' : countChange < 0 ? 'down' : 'same'}">
                ${countChange > 0 ? '↑' : countChange < 0 ? '↓' : '='} ${Math.abs(countChange)}
              </div>
            </div>
            <div class="week-card">
              <div class="week-label">Тоннаж (кг)</div>
              <div class="week-value">${formatNumber(thisWeek.volume)}</div>
              <div class="week-subvalue">прошлая: ${formatNumber(lastWeek.volume)}</div>
              <div class="week-change ${volumeChange > 0 ? 'up' : volumeChange < 0 ? 'down' : 'same'}">
                ${volumeChange > 0 ? '↑' : volumeChange < 0 ? '↓' : ''} ${Math.abs(volumeChange)}%
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // ══════════════════════════════════════════════════════════════
    // RENDER: PROGRESS (Only improvements)
    // ══════════════════════════════════════════════════════════════
    
    function renderProgress() {
      const progress = data.exerciseProgress?.topExercises || [];
      
      // Фильтруем только те, где есть положительный прогресс
      const improved = progress.filter(ex => ex.progress > 0);
      
      if (!improved.length) {
        return `<div class="card"><div class="card-title">?? Прогресс</div>
          <div class="empty-state"><div class="empty-icon">??</div>Пока нет рекордов</div></div>`;
      }
      
      return `
        <div class="card">
          <div class="card-header">
            <span class="card-title">?? Прогресс</span>
            <span style="font-size: 12px; color: var(--text-secondary);">Повышение веса</span>
          </div>
          ${improved.slice(0, 5).map(ex => `
            <div class="progress-item">
              <div class="progress-info">
                <div class="progress-name">${ex.name}</div>
                <div class="progress-date">?? ${ex.lastDate || 'недавно'}</div>
              </div>
              <div class="progress-values">
                <div class="progress-weight">${ex.lastWeight} кг</div>
                <div class="progress-change">+${ex.progressKg || 0} кг (+${ex.progress}%)</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // ══════════════════════════════════════════════════════════════
    // RENDER: RECENT SESSIONS (3 with modal)
    // ══════════════════════════════════════════════════════════════
    
    function renderRecentSessions() {
      const sessions = data.recentSessions || [];
      
      if (!sessions.length) {
        return `<div class="card"><div class="card-title">?? Тренировки</div>
          <div class="empty-state"><div class="empty-icon">??</div>Нет тренировок</div></div>`;
      }
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">?? Последние тренировки</span></div>
          ${sessions.slice(0, 3).map((s, i) => `
            <div class="session-item" onclick="showSessionModal(${i})">
              <div class="session-header">
                <span class="session-date">${formatDate(s.date)}</span>
                <span class="session-type">${s.splitType || s.type || 'Тренировка'}</span>
              </div>
              <div class="session-stats">
                <span class="session-stat">??️ ${s.exerciseCount || 0} упр.</span>
                <span class="session-stat">?? ${s.totalSets || 0} подх.</span>
                <span class="session-stat">⚖️ ${formatNumber(s.totalVolume || 0)} кг</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // ══════════════════════════════════════════════════════════════
    // RENDER: HISTORY PAGE
    // ══════════════════════════════════════════════════════════════
    
    function renderHistoryPage() {
      const sessions = data.recentSessions || [];
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">?? Тоннаж по тренировкам</span></div>
          <div class="chart-container">
            <div class="chart-placeholder">
              График тоннажа<br>
              <small style="opacity: 0.7">Доступно в Google Sheets</small>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">?? Все тренировки</span></div>
          ${sessions.map((s, i) => `
            <div class="session-item" onclick="showSessionModal(${i})">
              <div class="session-header">
                <span class="session-date">${formatDate(s.date)}</span>
                <span class="session-type">${s.splitType || s.type || ''}</span>
              </div>
              <div class="session-stats">
                <span class="session-stat">??️ ${s.exerciseCount || 0} упр.</span>
                <span class="session-stat">⚖️ ${formatNumber(s.totalVolume || 0)} кг</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // ══════════════════════════════════════════════════════════════
    // RENDER: RECORDS PAGE
    // ══════════════════════════════════════════════════════════════
    
    function renderRecordsPage() {
      const records = data.personalRecords?.records || [];
      const progress = data.exerciseProgress?.topExercises || [];
      
      // Комбинируем рекорды по весу
      const allRecords = [
        ...progress.filter(p => p.progress > 0).map(p => ({
          type: 'Вес',
          name: p.name,
          value: `${p.lastWeight} кг`,
          date: p.lastDate,
          change: `+${p.progressKg} кг`
        })),
        ...records.map(r => ({
          type: '1RM (расч.)',
          name: r.name,
          value: `${r.estimated1RM} кг`,
          date: r.date,
          change: `${r.weight}×${r.reps}`
        }))
      ];
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">?? Все рекорды</span></div>
          ${allRecords.length ? allRecords.map(r => `
            <div class="record-item">
              <div>
                <div class="record-type">${r.type}</div>
                <div class="record-name">${r.name}</div>
              </div>
              <div class="record-value-container">
                <div class="record-value">${r.value}</div>
                <div class="record-date">${r.date || ''} ${r.change ? `• ${r.change}` : ''}</div>
              </div>
            </div>
          `).join('') : '<div class="empty-state"><div class="empty-icon">??</div>Пока нет рекордов</div>'}
        </div>
      `;
    }
    
    // ══════════════════════════════════════════════════════════════
    // MODALS
    // ══════════════════════════════════════════════════════════════
    
    function showSessionModal(index) {
      const session = data.recentSessions[index];
      if (!session) return;
      
      const modal = document.getElementById('sessionModal');
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-handle"></div>
          <h2>${formatDate(session.date)}</h2>
          <div class="modal-subtitle">${session.splitType || session.type || 'Тренировка'}</div>
          
          <div class="modal-section">
            <div class="modal-stat-grid">
              <div class="modal-stat">
                <div class="modal-stat-value">${session.exerciseCount || 0}</div>
                <div class="modal-stat-label">Упражнений</div>
              </div>
              <div class="modal-stat">
                <div class="modal-stat-value">${session.totalSets || 0}</div>
                <div class="modal-stat-label">Подходов</div>
              </div>
              <div class="modal-stat">
                <div class="modal-stat-value">${formatNumber(session.totalVolume || 0)}</div>
                <div class="modal-stat-label">Тоннаж (кг)</div>
              </div>
            </div>
          </div>
          
          ${session.duration ? `
          <div class="modal-section">
            <div class="modal-section-title">Длительность</div>
            <div>${session.duration} мин</div>
          </div>
          ` : ''}
          
          ${session.notes ? `
          <div class="modal-section">
            <div class="modal-section-title">Заметки</div>
            <div>${session.notes}</div>
          </div>
          ` : ''}
          
          <div class="modal-section">
            <div class="modal-section-title">Подробнее</div>
            <div style="color: var(--text-secondary); font-size: 14px;">
              Полная информация доступна в Google Sheets клиента
            </div>
          </div>
        </div>
      `;
      modal.classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('sessionModal').classList.remove('active');
    }
    
    function showSettings() {
      const modal = document.getElementById('settingsModal');
      modal.innerHTML = `
        <div class="modal settings-modal">
          <h2>⚙️ Настройки</h2>
          <label>API URL</label>
          <input type="text" id="apiUrlInput" value="${CONFIG.API_URL}" placeholder="https://script.google.com/...">
          <label>Client ID</label>
          <input type="text" id="clientIdInput" value="${CONFIG.CLIENT_ID}" placeholder="yaroslav">
          <div class="modal-buttons">
            <button class="btn-cancel" onclick="hideSettings()">Отмена</button>
            <button class="btn-save" onclick="saveSettings()">Сохранить</button>
          </div>
        </div>
      `;
      modal.classList.add('active');
    }
    
    function hideSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }
    
    function saveSettings() {
      CONFIG.API_URL = document.getElementById('apiUrlInput').value.trim();
      CONFIG.CLIENT_ID = document.getElementById('clientIdInput').value.trim() || 'yaroslav';
      hideSettings();
      loadDashboard();
    }
    
    // ══════════════════════════════════════════════════════════════
    // NAVIGATION
    // ══════════════════════════════════════════════════════════════
    
    function showPage(page) {
      currentPage = page;
      
      document.querySelectorAll('.nav-item').forEach((item, i) => {
        const pages = ['main', 'history', 'records'];
        item.classList.toggle('active', pages[i] === page);
      });
      
      document.getElementById('mainPage').classList.toggle('hidden', page !== 'main');
      document.getElementById('historyPage').classList.toggle('active', page === 'history');
      document.getElementById('recordsPage').classList.toggle('active', page === 'records');
    }
    
    // ══════════════════════════════════════════════════════════════
    // HELPERS
    // ══════════════════════════════════════════════════════════════
    
    function formatDate(str) {
      if (!str) return '';
      try {
        return new Date(str).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
      } catch { return str; }
    }
    
    function formatDateFull(str) {
      if (!str) return '';
      try {
        return new Date(str).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
      } catch { return str; }
    }
    
    function formatNumber(n) {
      if (n >= 1000) return Math.round(n / 100) / 10 + 'k';
      return Math.round(n);
    }
    
    function showSetupScreen() {
      document.getElementById('app').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 20px;">⚙️</div>
          <h2 style="margin-bottom: 12px;">Настройте подключение</h2>
          <p style="color: var(--text-secondary); margin-bottom: 24px;">Укажите URL API и ID клиента</p>
          <button onclick="showSettingsFromSetup()" style="background: var(--accent); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 16px; cursor: pointer;">Настроить</button>
        </div>
        <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)hideSettings()"></div>
      `;
    }
    
    function showSettingsFromSetup() {
      showSettings();
    }
    
    function showError(msg) {
      document.getElementById('app').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">??</div>
          <div style="color: var(--danger); margin-bottom: 8px;">Ошибка</div>
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">${msg}</div>
          <button onclick="loadDashboard()" style="background: var(--accent); color: white; border: none; padding: 14px 28px; border-radius: 12px; cursor: pointer;">Обновить</button>
        </div>
      `;
    }
    
    // Init
    document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
</body>
</html>
