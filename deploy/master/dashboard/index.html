<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº</title>

    <!-- ĞĞ±Ñ‰Ğ¸Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ -->
    <link rel="stylesheet" href="../css/common.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ° -->
    <style>
      /* ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ±Ğ»Ğ¾ĞºĞ° */
      .block-stats {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .block-circle {
        width: 80px;
        height: 80px;
        position: relative;
      }
      .block-circle svg {
        transform: rotate(-90deg);
        width: 80px;
        height: 80px;
      }
      .block-circle-bg {
        fill: none;
        stroke: var(--bg);
        stroke-width: 6;
      }
      .block-circle-fill {
        fill: none;
        stroke: var(--accent);
        stroke-width: 6;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
      }
      .block-number {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        font-weight: 700;
      }

      .block-info {
        flex: 1;
      }
      .block-label {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .block-sublabel {
        font-size: 13px;
        color: var(--text-secondary);
      }

      /* Ğ¦ĞµĞ»Ğ¸ */
      .goals-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .goal-tag {
        background: var(--accent-light);
        color: var(--accent);
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
      }

      /* ĞœÑ‹ÑˆĞµÑ‡Ğ½Ñ‹Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ */
      .muscle-groups {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .muscle-group {
        background: var(--bg);
        border-radius: 12px;
        overflow: hidden;
      }
      .muscle-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .muscle-group-header:hover {
        background: rgba(0, 0, 0, 0.02);
      }
      .muscle-group-name {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 15px;
      }
      .muscle-group-icon {
        font-size: 20px;
      }
      .muscle-group-stats {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .muscle-group-sets {
        font-size: 14px;
        color: var(--text-secondary);
      }
      .muscle-group-bar {
        width: 60px;
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        overflow: hidden;
      }
      .muscle-group-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
      }
      .muscle-group-arrow {
        color: var(--text-secondary);
        transition: transform 0.2s;
      }
      .muscle-group.expanded .muscle-group-arrow {
        transform: rotate(180deg);
      }
      .muscle-details {
        display: none;
        padding: 0 16px 14px;
      }
      .muscle-group.expanded .muscle-details {
        display: block;
      }
      .muscle-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-top: 1px solid var(--border);
      }
      .muscle-name {
        font-size: 14px;
        color: var(--text-secondary);
      }
      .muscle-value {
        font-size: 14px;
        font-weight: 500;
      }

      /* Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ½ĞµĞ´ĞµĞ»ÑŒ */
      .weeks-comparison {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .week-card {
        background: var(--bg);
        border-radius: 12px;
        padding: 14px;
        text-align: center;
      }
      .week-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }
      .week-value {
        font-size: 24px;
        font-weight: 700;
      }
      .week-subvalue {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 4px;
      }
      .week-change {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        margin-top: 8px;
      }
      .week-change.up {
        background: #d4edda;
        color: #155724;
      }
      .week-change.down {
        background: #f8d7da;
        color: #721c24;
      }
      .week-change.same {
        background: var(--border);
        color: var(--text-secondary);
      }

      /* ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ */
      .progress-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        border-bottom: 1px solid var(--border);
      }
      .progress-item:last-child {
        border-bottom: none;
      }
      .progress-info {
        flex: 1;
      }
      .progress-name {
        font-weight: 600;
        font-size: 15px;
      }
      .progress-date {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 2px;
      }
      .progress-values {
        text-align: right;
      }
      .progress-weight {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent);
      }
      .progress-change {
        font-size: 12px;
        color: var(--success);
        font-weight: 500;
      }

      /* Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ */
      .session-item {
        padding: 14px;
        background: var(--bg);
        border-radius: 12px;
        margin-bottom: 10px;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      .session-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .session-item:last-child {
        margin-bottom: 0;
      }
      .session-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .session-date {
        font-weight: 600;
        font-size: 15px;
      }
      .session-type {
        font-size: 13px;
        color: var(--accent);
        font-weight: 500;
      }
      .session-stats {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: var(--text-secondary);
      }
      .session-stat {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Ğ ĞµĞºĞ¾Ñ€Ğ´Ñ‹ */
      .record-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px;
        background: var(--bg);
        border-radius: 12px;
        margin-bottom: 10px;
      }
      .record-type {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .record-name {
        font-weight: 600;
        font-size: 15px;
        margin-top: 2px;
      }
      .record-value-container {
        text-align: right;
      }
      .record-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--accent);
      }
      .record-date {
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ */
      .modal-stat-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
      .modal-stat {
        background: var(--bg);
        border-radius: 12px;
        padding: 12px;
        text-align: center;
      }
      .modal-stat-value {
        font-size: 20px;
        font-weight: 700;
      }
      .modal-stat-label {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
      }
      .modal-exercise-list {
        list-style: none;
      }
      .modal-exercise {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
      }
      .modal-exercise:last-child {
        border-bottom: none;
      }
      .modal-exercise-name {
        font-size: 14px;
        flex: 1;
      }
      .modal-exercise-detail {
        font-size: 14px;
        color: var(--text-secondary);
        text-align: right;
      }

      /* Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº */
      .chart-container {
        height: 220px;
        position: relative;
      }

      /* Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ */
      .history-page,
      .records-page {
        display: none;
      }
      .history-page.active,
      .records-page.active {
        display: block;
      }
      .main-page {
        display: block;
      }
      .main-page.hidden {
        display: none;
      }

      /* Ğ’Ñ‹Ğ±Ğ¾Ñ€ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° */
      .client-picker-wrap {
        min-height: 100vh;
        padding: 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .client-picker-wrap h2 {
        margin-bottom: 8px;
      }
      .client-picker-desc {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 24px;
      }
      .client-picker-list {
        width: 100%;
        max-width: 360px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 24px;
      }
      .client-picker-item {
        background: var(--card);
        padding: 16px;
        border-radius: var(--radius-md);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow);
        transition: transform 0.2s;
      }
      .client-picker-item:hover {
        transform: translateY(-2px);
      }
      .client-picker-name {
        font-weight: 600;
      }
      .client-picker-status {
        font-size: 12px;
        color: var(--text-secondary);
      }
      .header-client-select {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 4px;
        cursor: pointer;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading">
        <div class="spinner"></div>
        <div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
      </div>
    </div>

    <!-- ĞĞ±Ñ‰Ğ¸Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸ -->
    <script src="../js/supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>

    <script>
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SUPABASE & AUTH
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const supabaseClient = window.supabase.createClient(
        window.SUPABASE_URL,
        window.SUPABASE_ANON_KEY
      );
      let clientsList = [];
      let programsList = [];

      async function requireAuth() {
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
        if (!session) {
          window.location.href =
            '../login.html?redirect=' + encodeURIComponent('dashboard/index.html');
          return false;
        }
        return true;
      }

      async function handleLogout() {
        await supabaseClient.auth.signOut();
        window.location.href = '../login.html';
      }

      async function loadClientsFromSupabase() {
        const { data: list, error } = await supabaseClient
          .from('clients')
          .select('id, name, email, status')
          .order('name');
        if (error) throw error;
        return list || [];
      }

      async function loadProgramsFromSupabase(clientId) {
        const { data: list, error } = await supabaseClient
          .from('programs')
          .select('id, name, type, status')
          .eq('client_id', clientId)
          .order('name');
        if (error) throw error;
        return list || [];
      }

      async function loadDashboardFromSupabase(clientId) {
        const [
          { data: client, error: clientErr },
          { data: allSessions, error: sessionsErr },
          mandatoryResult,
        ] = await Promise.all([
          supabaseClient.from('clients').select('id, name, profile').eq('id', clientId).single(),
          supabaseClient
            .from('workout_sessions')
            .select('id, date, type, status, notes, total_tonnage, block_id')
            .eq('client_id', clientId)
            .order('date', { ascending: false })
            .limit(1000),
          Promise.all([
            supabaseClient
              .from('mandatory_tasks')
              .select('id, name, category')
              .eq('client_id', clientId)
              .eq('active', true)
              .order('sort_order'),
            supabaseClient.from('mandatory_task_log').select('task_id').eq('client_id', clientId),
          ])
            .then(([a, b]) => ({ tasks: a.data || [], logs: b.data || [] }))
            .catch(() => ({ tasks: [], logs: [] })),
        ]);
        const mandatoryTasks = mandatoryResult.tasks || [];
        const mandatoryLogs = mandatoryResult.logs || [];
        const mandatoryStats = {
          tasks: mandatoryTasks.map((t) => ({
            ...t,
            completed: mandatoryLogs.filter((l) => l.task_id === t.id).length,
          })),
        };
        if (clientErr || !client) throw clientErr || new Error('ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');

        const profile = client.profile || {};
        const goals = {
          clientName: client.name,
          startDate: profile.startDate || profile.start_date || '',
          mainGoals: profile.mainGoals || profile.main_goals || '',
        };

        let blocks = [];
        const { data: programs } = await supabaseClient
          .from('programs')
          .select('id')
          .eq('client_id', clientId);
        if (programs?.length) {
          const { data: blocksData } = await supabaseClient
            .from('training_blocks')
            .select('id, name, total_sessions, used_sessions, start_date, status')
            .in(
              'program_id',
              programs.map((p) => p.id)
            )
            .order('start_date', { ascending: false });
          blocks = blocksData || [];
        }

        const activeBlock = blocks.find((b) => b.status === 'active') || blocks[0];
        // Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº: Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ñ… = COUNT(workout_sessions) Ğ¿Ğ¾ Ğ±Ğ»Ğ¾ĞºÑƒ (Ğ½Ğµ training_blocks.used_sessions)
        const completedInBlock = activeBlock
          ? (allSessions || []).filter(
              (s) => s.block_id === activeBlock.id && (s.status || 'completed') === 'completed'
            ).length
          : 0;
        const totalSessions = activeBlock?.total_sessions || 0;
        const currentBlock = activeBlock
          ? {
              blockId: 1,
              blockNumber: 1,
              totalSessions,
              usedSessions: completedInBlock,
              remaining: Math.max(0, totalSessions - completedInBlock),
              progress: totalSessions ? Math.round((completedInBlock / totalSessions) * 100) : 0,
              status: activeBlock.status || 'active',
            }
          : { status: 'none' };

        const now = new Date();
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - 90);
        const cutoffStr = cutoffDate.toISOString().slice(0, 10);
        const sessions = (allSessions || []).filter((s) => {
          if (currentPeriod === 'block') {
            if (!activeBlock?.id) return false;
            return s.block_id === activeBlock.id;
          }
          if (currentPeriod === '3m') return (s.date || '') >= cutoffStr;
          return true;
        });
        const displaySessions = (allSessions || []).slice(0, 15);

        const sessionIds = sessions.map((s) => s.id);
        const displayIds = displaySessions.map((s) => s.id);
        const allSessionIds = (allSessions || []).map((s) => s.id);
        const idsForSets = [...new Set([...sessionIds, ...displayIds, ...allSessionIds])];
        let setsBySession = {};
        let allSets = [];
        if (idsForSets.length) {
          const { data: sets } = await supabaseClient
            .from('workout_sets')
            .select(
              'session_id, reps, weight, exercise_id, exercise_name, exercises(id, name, category, equipment, muscle_coefficients)'
            )
            .in('session_id', idsForSets);
          const fetchedSets = sets || [];
          allSets = sessionIds.length
            ? fetchedSets.filter((st) => sessionIds.includes(st.session_id))
            : [];
          const displaySets = fetchedSets.filter((st) => displayIds.includes(st.session_id));
          const volumeBySession = {};
          fetchedSets.forEach((set) => {
            const vol = parseNum(set.weight) * parseNum(set.reps);
            volumeBySession[set.session_id] = (volumeBySession[set.session_id] || 0) + vol;
          });
          displaySets.forEach((set) => {
            if (!setsBySession[set.session_id]) setsBySession[set.session_id] = {};
            const exData =
              (set.exercises && typeof set.exercises === 'object' ? set.exercises : null) ||
              (set.exercise && typeof set.exercise === 'object' ? set.exercise : null);
            const displayName =
              exData?.name ||
              (set.exercise_name && String(set.exercise_name).trim()) ||
              'Ğ£Ğ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ';
            // ĞšĞ»ÑÑ‡: exercise_id Ğ¸Ğ»Ğ¸ exercise_name (Ğ´Ğ»Ñ backfill Ğ±ĞµĞ· exercise_id â€” Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ²ÑĞµ Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑÑÑ‚ÑÑ Ğ² Â«unknownÂ»)
            const key = set.exercise_id || `n:${(set.exercise_name || '').trim() || '?'}`;
            if (!setsBySession[set.session_id][key]) {
              setsBySession[set.session_id][key] = { name: displayName, setsList: [] };
            }
            setsBySession[set.session_id][key].setsList.push({
              reps: parseNum(set.reps),
              weight: parseNum(set.weight),
            });
          });
          Object.keys(setsBySession).forEach((sid) => {
            setsBySession[sid] = Object.values(setsBySession[sid]).map((ex) => {
              const list = ex.setsList || [];
              const totalSets = list.length;
              const last = list[list.length - 1];
              const totalVol = list.reduce((s, x) => s + (x.weight || 0) * (x.reps || 0), 0);
              return {
                name: ex.name,
                sets: totalSets,
                reps: last?.reps ?? 0,
                weight: last?.weight ?? 0,
                setsList: list,
                totalVolume: totalVol,
              };
            });
          });

          const sessionDateMap = sessions.reduce((acc, s) => {
            acc[s.id] = s.date;
            return acc;
          }, {});
          const allSessionDateMap = (allSessions || []).reduce((acc, s) => {
            acc[s.id] = s.date;
            return acc;
          }, {});
          const exById = {};
          fetchedSets.forEach((s) => {
            if (s.exercise_id && s.exercises && !exById[s.exercise_id])
              exById[s.exercise_id] = s.exercises;
          });
          const progressSets = fetchedSets.filter((st) => allSessionIds.includes(st.session_id));
          const muscleLoad = computeMuscleLoad(allSets, exById, sessionDateMap);
          const exerciseProgress = computeExerciseProgress(progressSets, exById, allSessionDateMap);
          const allRecords = computeAllRecords(progressSets, exById, allSessionDateMap);

          const recentSessions = displaySessions.map((s) => {
            const exList = setsBySession[s.id] || [];
            const totalVolume = exList.reduce((sum, ex) => sum + (ex.totalVolume || 0), 0);
            const totalSets = exList.reduce((sum, ex) => sum + (ex.sets || 0), 0);
            return {
              sessionId: s.id,
              date: s.date,
              type: s.type || 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°',
              splitType: s.type || '',
              totalVolume:
                s.total_tonnage != null ? Number(s.total_tonnage) : Math.round(totalVolume),
              exerciseCount: exList.length,
              totalSets,
              exercises: exList,
              notes: s.notes,
            };
          });

          let thisWeekCount = 0,
            thisWeekVol = 0,
            lastWeekCount = 0,
            lastWeekVol = 0;
          const dayOfWeek = now.getDay();
          const thisWeekStart = new Date(now);
          thisWeekStart.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
          thisWeekStart.setHours(0, 0, 0, 0);
          const lastWeekStart = new Date(thisWeekStart);
          lastWeekStart.setDate(lastWeekStart.getDate() - 7);
          const lastWeekEnd = new Date(thisWeekStart.getTime() - 1);
          (allSessions || []).forEach((s) => {
            const d = new Date(s.date + 'T12:00:00');
            const vol =
              s.total_tonnage != null ? Number(s.total_tonnage) : volumeBySession[s.id] || 0;
            if (d >= thisWeekStart) {
              thisWeekCount++;
              thisWeekVol += vol;
            } else if (d >= lastWeekStart && d <= lastWeekEnd) {
              lastWeekCount++;
              lastWeekVol += vol;
            }
          });

          return {
            success: true,
            clientId,
            period: currentPeriod,
            generatedAt: new Date().toISOString(),
            profile: { name: client.name },
            goals,
            currentBlock,
            mandatoryStats,
            recentSessions,
            exerciseProgress,
            muscleLoad,
            allRecords,
            weeklyComparison: {
              thisWeek: { count: thisWeekCount, volume: thisWeekVol },
              lastWeek: { count: lastWeekCount, volume: lastWeekVol },
              changes: {
                count: thisWeekCount - lastWeekCount,
                volumePercent: (() => {
                  if (thisWeekVol === 0 && lastWeekVol > 0) return -100;
                  if (lastWeekVol === 0) return thisWeekVol > 0 ? 100 : 0;
                  return Math.round(((thisWeekVol - lastWeekVol) / lastWeekVol) * 100);
                })(),
              },
            },
          };
        }

        const recentSessions = displaySessions.map((s) => ({
          sessionId: s.id,
          date: s.date,
          type: s.type || 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°',
          splitType: s.type || '',
          totalVolume: s.total_tonnage != null ? Number(s.total_tonnage) : 0,
          exerciseCount: 0,
          totalSets: 0,
          exercises: [],
          notes: s.notes,
        }));
        let thisWeekCount = 0,
          thisWeekVol = 0,
          lastWeekCount = 0,
          lastWeekVol = 0;
        const dayOfWeekFallback = now.getDay();
        const thisWeekStartFb = new Date(now);
        thisWeekStartFb.setDate(
          now.getDate() - (dayOfWeekFallback === 0 ? 6 : dayOfWeekFallback - 1)
        );
        thisWeekStartFb.setHours(0, 0, 0, 0);
        const lastWeekStartFb = new Date(thisWeekStartFb);
        lastWeekStartFb.setDate(lastWeekStartFb.getDate() - 7);
        const lastWeekEndFb = new Date(thisWeekStartFb.getTime() - 1);
        (allSessions || []).forEach((s) => {
          const d = new Date(s.date + 'T12:00:00');
          const vol = s.total_tonnage != null ? Number(s.total_tonnage) : 0;
          if (d >= thisWeekStartFb) {
            thisWeekCount++;
            thisWeekVol += vol;
          } else if (d >= lastWeekStartFb && d <= lastWeekEndFb) {
            lastWeekCount++;
            lastWeekVol += vol;
          }
        });

        return {
          success: true,
          clientId,
          period: currentPeriod,
          generatedAt: new Date().toISOString(),
          profile: { name: client.name },
          goals,
          currentBlock,
          recentSessions,
          exerciseProgress: { improvements: [] },
          muscleLoad: { groups: {} },
          allRecords: [],
          mandatoryStats,
          weeklyComparison: {
            thisWeek: { count: thisWeekCount, volume: thisWeekVol },
            lastWeek: { count: lastWeekCount, volume: lastWeekVol },
            changes: {
              count: thisWeekCount - lastWeekCount,
              volumePercent: (() => {
                if (thisWeekVol === 0 && lastWeekVol > 0) return -100;
                if (lastWeekVol === 0) return thisWeekVol > 0 ? 100 : 0;
                return Math.round(((thisWeekVol - lastWeekVol) / lastWeekVol) * 100);
              })(),
            },
          },
        };
      }

      const CATEGORY_TO_MUSCLES = {
        Ğ³Ñ€ÑƒĞ´ÑŒ: { chest: 0.8, front_delt: 0.2 },
        ÑĞ¿Ğ¸Ğ½Ğ°: { lats: 0.6, traps: 0.2, biceps: 0.2 },
        Ğ½Ğ¾Ğ³Ğ¸: { quads: 0.5, hamstrings: 0.3, glutes: 0.2 },
        Ğ¿Ğ»ĞµÑ‡Ğ¸: { front_delt: 0.4, mid_delt: 0.4, rear_delt: 0.2 },
        Ñ€ÑƒĞºĞ¸: { biceps: 0.5, triceps: 0.5 },
        ĞºĞ¾Ñ€: { core: 1.0 },
        ĞºĞ¾Ñ€Ğ¿ÑƒÑ: { core: 1.0 },
        chest: { chest: 0.8, front_delt: 0.2 },
        back: { lats: 0.6, traps: 0.2, biceps: 0.2 },
        legs: { quads: 0.5, hamstrings: 0.3, glutes: 0.2 },
        shoulders: { front_delt: 0.4, mid_delt: 0.4, rear_delt: 0.2 },
        arms: { biceps: 0.5, triceps: 0.5 },
        core: { core: 1.0 },
      };
      const NAME_KEYWORDS = [
        {
          keys: [
            'Ğ¿Ñ€Ğ¸ÑĞµĞ´',
            'Ğ¶Ğ¸Ğ¼ Ğ½Ğ¾Ğ³',
            'Ñ€Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½ Ğ½Ğ¾Ğ³',
            'Ñ€Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ³',
            'ÑĞ³Ğ¸Ğ±Ğ°Ğ½ Ğ½Ğ¾Ğ³',
            'ÑĞ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ³',
            'Ğ²Ñ‹Ğ¿Ğ°Ğ´',
            'Ğ³Ğ°ĞºĞº',
            'Ğ³Ğ¾Ğ±Ğ»ĞµÑ‚',
            'Ğ·Ğ°Ğ¿Ñ€Ñ‹Ğ³',
            'Ğ¿Ñ€Ñ‹Ğ¶Ğº',
            'Ñ‚ÑƒĞ¼Ğ±Ñƒ',
            'Ğ³Ğ¸Ğ¿ĞµÑ€ÑĞºÑÑ‚ĞµĞ½Ğ·Ğ¸Ñ Ğ½Ğ¾Ğ³',
            'Ğ½Ğ¾ÑĞºĞ¸',
            'squat',
            'leg press',
            'leg curl',
            'leg extension',
          ],
          val: { quads: 0.5, hamstrings: 0.3, glutes: 0.2 },
        },
        {
          keys: [
            'Ğ¿Ğ¾Ğ´Ñ‚ÑĞ³',
            'Ñ‚ÑĞ³Ğ° Ğ²ĞµÑ€Ñ…',
            'Ñ‚ÑĞ³Ğ° Ğº Ğ¿Ğ¾ÑÑÑƒ',
            'Ñ‚ÑĞ³Ğ° Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½',
            'Ñ‚ÑĞ³Ğ° ÑˆÑ‚Ğ°Ğ½Ğ³Ğ¸',
            'Ñ‚ÑĞ³Ğ° Ğ³Ğ°Ğ½Ñ‚ĞµĞ»',
            'Ñ‚ÑĞ³Ğ° ',
            'Ğ¿ÑƒĞ»Ğ¾Ğ²ĞµÑ€',
            'ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ°Ñ',
            'Ñ€Ğ´Ğ»',
            'Ñ€ÑƒĞ¼Ñ‹Ğ½ÑĞº',
            'Ğ³Ğ¸Ğ¿ĞµÑ€ÑĞºÑÑ‚ĞµĞ½Ğ·Ğ¸Ñ',
            'Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½',
            'deadlift',
            'lat pulldown',
            'cable row',
          ],
          val: { lats: 0.5, traps: 0.2, biceps: 0.2, low_back: 0.1 },
        },
        {
          keys: [
            'Ñ€Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½ Ñ€ÑƒĞº',
            'Ñ€Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞµ',
            'Ñ€Ğ°Ğ·Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞµ',
            'Ñ„Ñ€Ğ°Ğ½Ñ†ÑƒĞ·ÑĞº',
            'Ñ‚Ñ€Ğ¸Ñ†ĞµĞ¿Ñ',
            'Ğ±Ñ€ÑƒÑÑŒÑ',
            'tricep',
            'pushdown',
            'Ñ€ÑƒĞºĞ¸ Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞµ',
            'Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ ÑƒĞ·ĞºĞ¸Ğ¼',
          ],
          val: { triceps: 1.0 },
        },
        {
          keys: [
            'Ğ¶Ğ¸Ğ¼ Ğ»Ñ‘Ğ¶Ğ°',
            'Ğ¶Ğ¸Ğ¼ Ğ»ĞµĞ¶Ğ°',
            'Ğ¶Ğ¸Ğ¼ ÑˆÑ‚Ğ°Ğ½Ğ³Ğ¸',
            'Ğ¶Ğ¸Ğ¼ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»',
            'Ñ€Ğ°Ğ·Ğ²Ğ¾Ğ´ĞºĞ°',
            'Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ',
            'Ğ¿ĞµĞºĞ´ĞµĞº',
            'Ğ¿ĞµĞº Ğ´ĞµĞº',
            'bench',
            'Ğ³Ñ€ÑƒĞ´ÑŒ',
            'chest',
          ],
          val: { chest: 0.8, front_delt: 0.15, triceps: 0.05 },
        },
        {
          keys: [
            'Ğ¶Ğ¸Ğ¼ ÑÑ‚Ğ¾Ñ',
            'Ğ¶Ğ¸Ğ¼ ÑĞ¸Ğ´Ñ',
            'Ğ¶Ğ¸Ğ¼ Ğ²Ğ²ĞµÑ€Ñ…',
            'Ğ¶Ğ¸Ğ¼ Ğ¿ĞµÑ€ĞµĞ´',
            'Ğ¼Ğ°Ñ…Ğ¸',
            'Ğ°Ñ€Ğ½Ğ¾Ğ»ÑŒĞ´',
            'Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€Ğ¾Ğ´Ğº',
            'Ğ¿Ğ»ĞµÑ‡',
            'shoulder',
            'delt',
            'Ğ²Ñ‹Ñ…Ğ¾Ğ´Ñ‹ ÑĞ¸Ğ»Ğ¾Ğ¹',
          ],
          val: { front_delt: 0.4, mid_delt: 0.4, rear_delt: 0.2 },
        },
        {
          keys: [
            'ÑĞ³Ğ¸Ğ±Ğ°Ğ½ Ñ€ÑƒĞº',
            'ÑĞ³Ğ¸Ğ±Ğ°Ğ½ Ğ½Ğ° Ğ±Ğ¸Ñ†ĞµĞ¿Ñ',
            'ÑĞ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ğ±Ğ¸Ñ†ĞµĞ¿Ñ',
            'Ğ¼Ğ¾Ğ»Ğ¾Ñ‚',
            'Ğ±Ğ¸Ñ†ĞµĞ¿Ñ',
            'bicep',
            'curl',
          ],
          val: { biceps: 1.0 },
        },
        {
          keys: [
            'Ğ¿Ğ»Ğ°Ğ½ĞºĞ°',
            'ÑĞºÑ€ÑƒÑ‡Ğ¸Ğ²Ğ°Ğ½',
            'Ğ¿Ğ¾Ğ´ÑŠÑ‘Ğ¼ Ğ½Ğ¾Ğ³ Ğ² Ğ²Ğ¸ÑĞµ',
            'Ğ¿Ğ¾Ğ´ÑŠÑ‘Ğ¼ Ğ½Ğ¾Ğ³ (',
            'Ğ¿Ñ€ĞµÑÑ',
            'ĞºĞ¾Ñ€',
            'core',
          ],
          val: { core: 1.0 },
        },
      ];

      function getCoeffs(ex, fallback) {
        const c = ex?.muscle_coefficients;
        if (c && typeof c === 'object' && Object.keys(c).length > 0) return c;
        const cat = (ex?.category || '').toLowerCase();
        for (const [key, val] of Object.entries(CATEGORY_TO_MUSCLES)) {
          if (cat.includes(key)) return val;
        }
        const name = (ex?.name || '').toLowerCase();
        for (const { keys, val } of NAME_KEYWORDS) {
          if (keys.some((k) => name.includes(k))) return val;
        }
        return fallback || { core: 1.0 };
      }

      function computeMuscleLoad(sets, exById, sessionDateMap) {
        const groups = {
          legs: { totalSets: 0, muscles: {} },
          back: { totalSets: 0, muscles: {} },
          chest: { totalSets: 0, muscles: {} },
          arms: { totalSets: 0, muscles: {} },
          core: { totalSets: 0, muscles: {} },
        };
        const muscleToGroup = {
          quads: 'legs',
          hamstrings: 'legs',
          glutes: 'legs',
          calves: 'legs',
          lats: 'back',
          traps: 'back',
          low_back: 'back',
          chest: 'chest',
          biceps: 'arms',
          triceps: 'arms',
          front_delt: 'arms',
          mid_delt: 'arms',
          rear_delt: 'arms',
          core: 'core',
        };

        sets.forEach((set) => {
          const ex =
            (set.exercises && typeof set.exercises === 'object' ? set.exercises : null) ||
            exById[set.exercise_id];
          const exForCoeffs =
            ex || (set.exercise_name ? { name: String(set.exercise_name).trim() } : null);
          const coeffs = getCoeffs(exForCoeffs);
          Object.entries(coeffs).forEach(([muscle, val]) => {
            const g = muscleToGroup[muscle];
            if (!g) return;
            if (!groups[g].muscles[muscle]) groups[g].muscles[muscle] = { sets: 0 };
            groups[g].muscles[muscle].sets += val;
            groups[g].totalSets += val;
          });
        });
        return { groups };
      }

      function parseNum(v) {
        if (v == null || v === '') return 0;
        const n = Number(v);
        if (!isNaN(n)) return n;
        const s = String(v).replace(',', '.');
        const n2 = parseFloat(s);
        return isNaN(n2) ? 0 : n2;
      }
      function normalizeExName(name) {
        const s = String(name || '').trim();
        const idx = s.indexOf(' (');
        return idx > 0 ? s.slice(0, idx).trim() : s;
      }
      function computeExerciseProgress(sets, exById, sessionDateMap) {
        const byEx = {};
        sets.forEach((set) => {
          const exId = set.exercise_id;
          const ex =
            exById[exId] ||
            (set.exercises && typeof set.exercises === 'object' ? set.exercises : null);
          const exName =
            ex?.name || (set.exercise_name && String(set.exercise_name).trim()) || 'Ğ£Ğ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ';
          const normName = normalizeExName(exName);
          const key = normName || '?';
          const date = sessionDateMap[set.session_id];
          if (!date) return;
          const w = parseNum(set.weight);
          const reps = parseNum(set.reps);
          if (!byEx[key]) byEx[key] = { name: normName || exName, points: [] };
          byEx[key].points.push({ date, weight: w, reps });
        });
        const improvements = [];
        Object.entries(byEx).forEach(([, { name, points }]) => {
          if (points.length < 2) return;
          points.sort((a, b) => new Date(a.date) - new Date(b.date));
          const byDate = {};
          points.forEach((p) => {
            const d = p.date;
            const vol = p.weight * p.reps;
            const score = vol > 0 ? vol : p.reps;
            if (!byDate[d] || score > (byDate[d].weight * byDate[d].reps || byDate[d].reps))
              byDate[d] = p;
          });
          const history = Object.entries(byDate)
            .sort((a, b) => new Date(a[0]) - new Date(b[0]))
            .map(([d, p]) => ({ date: d, weight: p.weight, reps: p.reps }));
          const first = history[0];
          const isBwEx = isBodyweightByName(name);
          const val = (p) => (isBwEx ? p.reps : p.weight > 0 ? p.weight : p.reps);
          const best = history.reduce((b, p) => (val(p) > val(b) ? p : b), first);
          const firstVal = val(first);
          const bestVal = val(best);
          const progressVal = bestVal - firstVal;
          if (progressVal <= 0) return;
          const progressPercent = firstVal > 0 ? Math.round((progressVal / firstVal) * 100) : 100;
          improvements.push({
            name,
            firstWeight: first.weight,
            currentWeight: best.weight,
            firstReps: first.reps,
            currentReps: best.reps,
            isBodyweight: isBwEx,
            progressKg:
              !isBwEx && first.weight > 0 ? Math.round((best.weight - first.weight) * 10) / 10 : 0,
            progressReps: isBwEx ? best.reps - first.reps : best.reps - first.reps,
            progressPercent,
            lastDate: best.date,
            history,
          });
        });
        improvements.sort((a, b) => b.progressPercent - a.progressPercent);
        return { improvements: improvements.slice(0, 10), intensityHistory: {} };
      }

      const BODYWEIGHT_KEYS = ['Ğ¿Ğ¾Ğ´Ñ‚ÑĞ³', 'Ğ¾Ñ‚Ğ¶Ğ¸Ğ¼', 'Ğ±Ñ€ÑƒÑÑŒÑ', 'Ğ²Ñ‹Ñ…Ğ¾Ğ´'];
      function isBodyweightByName(name) {
        if (!name) return false;
        const n = String(name).toLowerCase();
        return BODYWEIGHT_KEYS.some((k) => n.includes(k));
      }
      function computeAllRecords(sets, exById, sessionDateMap) {
        const byEx = {};
        sets.forEach((set) => {
          const exId = set.exercise_id;
          const ex =
            exById[exId] ||
            (set.exercises && typeof set.exercises === 'object' ? set.exercises : null);
          const exName =
            ex?.name || (set.exercise_name && String(set.exercise_name).trim()) || null;
          const normName = normalizeExName(exName) || exName || 'Ğ£Ğ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ';
          const w = parseNum(set.weight);
          const reps = parseNum(set.reps);
          const vol = w * reps;
          const date = sessionDateMap[set.session_id];
          if (!date) return;
          const eq = ex?.equipment || '';
          const isBw =
            (eq &&
              (String(eq).toLowerCase().includes('ÑĞ²Ğ¾Ğ¹ Ğ²ĞµÑ') ||
                String(eq).toLowerCase().includes('Ñ‚ĞµĞ»Ğ¾'))) ||
            isBodyweightByName(normName);
          const newScore = vol > 0 ? vol : isBw ? reps : 0;
          const cur = byEx[normName];
          const curScore = cur ? (cur.vol > 0 ? cur.vol : cur.isBodyweight ? cur.reps : 0) : -1;
          if (newScore > curScore) {
            byEx[normName] = { vol, weight: w, reps, date, name: normName, isBodyweight: isBw };
          }
        });
        return Object.entries(byEx)
          .map(([, r]) => {
            const isBw = r.isBodyweight || (r.weight === 0 && isBodyweightByName(r.name));
            const showReps = isBw && r.reps > 0;
            return {
              name: r.name,
              value: showReps ? r.reps : r.weight,
              unit: showReps ? 'Ñ€Ğ°Ğ·' : 'ĞºĞ³',
              date: r.date,
              hint: isBw && r.weight > 0 && !showReps ? ' (ÑĞºĞ².)' : '',
            };
          })
          .filter((r) => {
            if (r.unit === 'ĞºĞ³' && r.value === 0) return false;
            return true;
          });
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // STATE
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      let data = null;
      let currentPage = 'main';
      let currentPeriod = 'block';
      let tonnageChart = null;
      let selectedClientId = null;

      // Ğ”ĞµĞ¼Ğ¾-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
      const DEMO_DATA = {
        success: true,
        clientId: 'demo',
        period: 'block',
        generatedAt: new Date().toISOString(),
        profile: { name: 'Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚' },
        goals: {
          clientName: 'Ğ”ĞµĞ¼Ğ¾ ĞšĞ»Ğ¸ĞµĞ½Ñ‚',
          startDate: '2026-01-08',
          mainGoals: 'ĞĞ¤ĞŸ, ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ 15 Ñ€Ğ°Ğ·, ĞšĞ¾Ñ€Ñ€ĞµĞºÑ†Ğ¸Ñ Ğ¾ÑĞ°Ğ½ĞºĞ¸',
        },
        currentBlock: {
          blockId: 1,
          blockNumber: 1,
          totalSessions: 10,
          usedSessions: 3,
          remaining: 7,
          progress: 30,
          status: 'active',
        },
        recentSessions: [
          {
            sessionId: 'S001',
            date: '2026-01-24',
            type: 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°',
            splitType: 'Push',
            duration: 60,
            exerciseCount: 6,
            totalSets: 11,
            totalVolume: 1100,
            exercises: [
              { name: 'Ğ–Ğ¸Ğ¼ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ĞµĞ¹ Ğ»Ñ‘Ğ¶Ğ°', sets: 3, reps: 10, weight: 12.5 },
              { name: 'Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸', sets: 2, reps: 12, weight: 30 },
            ],
          },
          {
            sessionId: 'S002',
            date: '2026-01-21',
            type: 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°',
            splitType: 'Pull',
            duration: 55,
            exerciseCount: 5,
            totalSets: 10,
            totalVolume: 950,
            exercises: [],
          },
          {
            sessionId: 'S003',
            date: '2026-01-19',
            type: 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°',
            splitType: 'Legs',
            duration: 50,
            exerciseCount: 4,
            totalSets: 9,
            totalVolume: 1200,
            exercises: [],
          },
        ],
        exerciseProgress: {
          improvements: [
            {
              name: 'Ğ–Ğ¸Ğ¼ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ĞµĞ¹ Ğ»Ñ‘Ğ¶Ğ°',
              currentWeight: 12.5,
              firstWeight: 7.5,
              progressKg: 5,
              progressPercent: 67,
              lastDate: '2026-01-24',
            },
            {
              name: 'Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸',
              currentWeight: 30,
              firstWeight: 20,
              progressKg: 10,
              progressPercent: 50,
              lastDate: '2026-01-19',
            },
          ],
        },
        muscleLoad: {
          groups: {
            legs: {
              name: 'ĞĞ¾Ğ³Ğ¸',
              totalSets: 8.5,
              muscles: {
                quads: { sets: 4 },
                hamstrings: { sets: 2 },
                glutes: { sets: 2 },
                calves: { sets: 0.5 },
              },
            },
            back: {
              name: 'Ğ¡Ğ¿Ğ¸Ğ½Ğ°',
              totalSets: 9,
              muscles: { lats: { sets: 6 }, traps: { sets: 2 }, low_back: { sets: 1 } },
            },
            chest: { name: 'Ğ“Ñ€ÑƒĞ´ÑŒ', totalSets: 4, muscles: { chest: { sets: 4 } } },
            arms: {
              name: 'Ğ ÑƒĞºĞ¸ Ğ¸ Ğ¿Ğ»ĞµÑ‡Ğ¸',
              totalSets: 8,
              muscles: {
                biceps: { sets: 2 },
                triceps: { sets: 2 },
                front_delt: { sets: 2 },
                mid_delt: { sets: 1 },
                rear_delt: { sets: 1 },
              },
            },
          },
        },
        weeklyComparison: {
          thisWeek: { count: 2, volume: 2050 },
          lastWeek: { count: 2, volume: 2000 },
          changes: { count: 0, volumePercent: 2 },
        },
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // MAIN
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      async function loadDashboard() {
        if (DEMO_MODE) {
          data = DEMO_DATA;
          renderApp();
          return;
        }

        if (!selectedClientId) {
          showClientPicker();
          return;
        }

        try {
          data = await loadDashboardFromSupabase(selectedClientId);
          API_CONFIG.CLIENT_ID = selectedClientId;
          renderApp();
          cacheData(`dashboard_${selectedClientId}`, { data, _ts: Date.now() });
        } catch (error) {
          const raw = getCachedData(`dashboard_${selectedClientId}`);
          const cached = raw?.data !== undefined ? raw.data : raw;
          const ts = raw?._ts;
          const cacheMaxAgeMs = 5 * 60 * 1000;
          if (cached && ts != null && Date.now() - ts <= cacheMaxAgeMs) {
            data = cached;
            renderApp();
          } else if (cached && (ts == null || Date.now() - ts > cacheMaxAgeMs)) {
            showError(
              'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' +
                (error.message || error) +
                '. ĞšÑÑˆ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ» (ÑÑ‚Ğ°Ñ€ÑˆĞµ 5 Ğ¼Ğ¸Ğ½), Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒÂ».'
            );
          } else {
            showError('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' + (error.message || error));
          }
        }
      }

      function showClientPicker() {
        const list = clientsList
          .map(
            (c) => `
        <div class="client-picker-item" onclick="selectClient('${c.id}')">
          <span class="client-picker-name">${c.name}</span>
          ${c.status ? `<span class="client-picker-status">${c.status}</span>` : ''}
        </div>
      `
          )
          .join('');
        document.getElementById('app').innerHTML = `
        <div class="client-picker-wrap">
          <h2>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°</h2>
          <p class="client-picker-desc">Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ğ¸Ğ· Supabase</p>
          <div class="client-picker-list">${list.length ? list : '<div class="empty-state">ĞĞµÑ‚ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²</div>'}</div>
          <button class="btn btn-secondary" onclick="handleLogout()">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
        </div>
      `;
      }

      async function selectClient(clientId) {
        selectedClientId = clientId;
        try {
          localStorage.setItem('dashboard_client_id', clientId);
        } catch (e) {}
        programsList = await loadProgramsFromSupabase(clientId);
        await loadDashboard();
      }

      function switchClient() {
        selectedClientId = null;
        try {
          localStorage.removeItem('dashboard_client_id');
        } catch (e) {}
        showClientPicker();
      }

      function renderApp() {
        const clientName = data.goals?.clientName || data.profile?.name || 'ĞšĞ»Ğ¸ĞµĞ½Ñ‚';
        const startDate = data.goals?.startDate || '';

        // Debug panel
        const debugPanel = DEBUG_MODE
          ? `
        <div style="margin: 16px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 11px;">
          <strong>ğŸ” DEBUG</strong> ${DEMO_MODE ? '(DEMO)' : '(API)'}
          <pre style="margin-top: 8px; font-size: 10px;">${JSON.stringify(data.muscleLoad?.groups, null, 2)?.slice(0, 500)}</pre>
        </div>
      `
          : '';

        document.getElementById('app').innerHTML = `
        <header class="header">
          <div class="header-top">
            <div>
              <h1>${clientName}</h1>
              ${startDate ? `<div class="start-date">Ğ¡ ${formatDateFull(startDate)}</div>` : ''}
              <div class="header-client-select" onclick="switchClient()">Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°</div>
            </div>
            <button class="settings-btn" onclick="showSettingsModal()">${ICONS.gear}</button>
          </div>
        </header>
        
        ${debugPanel}
        
        <main class="main-page" id="mainPage">
          ${renderBlockProgress()}
          ${renderMandatoryTasks()}
          ${renderGoals()}
          ${renderMuscleLoad()}
          ${renderWeeklyComparison()}
          ${renderProgress()}
          ${renderRecentSessions()}
        </main>
        
        <main class="history-page" id="historyPage">
          ${renderHistoryPage()}
        </main>
        
        <main class="records-page" id="recordsPage">
          ${renderRecordsPage()}
        </main>
        
        <nav class="bottom-nav">
          <div class="nav-item active" onclick="showPage('main')"><span class="nav-icon">${ICONS.chart}</span>Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</div>
          <div class="nav-item" onclick="showPage('history')"><span class="nav-icon">${ICONS.chartUp}</span>Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</div>
          <div class="nav-item" onclick="showPage('records')"><span class="nav-icon">${ICONS.trophy}</span>Ğ ĞµĞºĞ¾Ñ€Ğ´Ñ‹</div>
        </nav>
        
        <div class="modal-overlay" id="sessionModal" onclick="if(event.target===this)closeModal('sessionModal')"></div>
        <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeModal('settingsModal')"></div>
      `;

        if (currentPage === 'history') {
          document.getElementById('historyPage').classList.add('active');
          document.getElementById('mainPage').classList.add('hidden');
          setTimeout(initTonnageChart, 100);
        }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // RENDER FUNCTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      function renderBlockProgress() {
        const block = data.currentBlock;
        if (!block || block.status === 'none') {
          return `<div class="card"><div class="card-title">${ICONS.block} Ğ‘Ğ›ĞĞš</div>
          <div class="empty-state"><div class="empty-icon">${ICONS.block}</div>ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°</div></div>`;
        }

        const circumference = 2 * Math.PI * 35;
        const offset = circumference - (block.progress / 100) * circumference;

        return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.block} Ğ‘Ğ›ĞĞš ${block.blockId || 1}</span></div>
          <div class="block-stats">
            <div class="block-circle">
              <svg viewBox="0 0 80 80">
                <circle class="block-circle-bg" cx="40" cy="40" r="35"/>
                <circle class="block-circle-fill" cx="40" cy="40" r="35" 
                  stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/>
              </svg>
              <div class="block-number">${block.usedSessions}</div>
            </div>
            <div class="block-info">
              <div class="block-label">${block.usedSessions} Ğ¸Ğ· ${block.totalSessions} Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº</div>
              <div class="block-sublabel">${block.remaining > 0 ? `ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ ${block.remaining}` : ICONS.party + ' Ğ—Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!'}</div>
            </div>
          </div>
        </div>
      `;
      }

      function renderMandatoryTasks() {
        const tasks = data.mandatoryStats?.tasks || [];
        if (!tasks.length) return '';
        return `
        <div class="card">
          <div class="card-header"><span class="card-title">âœ… ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ—ĞĞ”ĞĞ§Ğ˜</span></div>
          <div class="goals-list" style="flex-direction: column; gap: 8px;">
            ${tasks
              .map(
                (t) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg); border-radius: 8px;">
                <span>${t.name}</span>
                <strong style="color: var(--accent);">${t.completed} Ñ€Ğ°Ğ·</strong>
              </div>
            `
              )
              .join('')}
          </div>
        </div>
      `;
      }

      function renderGoals() {
        const goalsText = data.goals?.mainGoals || '';
        if (!goalsText) return '';

        const goals = goalsText
          .split(/[.,]/)
          .map((g) => g.trim())
          .filter((g) => g.length > 2);
        return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.target} Ğ¦Ğ•Ğ›Ğ˜</span></div>
          <div class="goals-list">${goals.map((g) => `<span class="goal-tag">${g}</span>`).join('')}</div>
        </div>
      `;
      }

      function renderMuscleLoad() {
        const muscleLoad = data.muscleLoad;
        const heatmap = data.muscleHeatmap;

        const hasMuscleLoadData = muscleLoad?.groups && Object.keys(muscleLoad.groups).length > 0;
        const hasHeatmapData = heatmap?.muscles && Object.keys(heatmap.muscles).length > 0;

        if (!hasMuscleLoadData && !hasHeatmapData) {
          const blockNote =
            currentPeriod === 'block'
              ? '<div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">ĞŸĞ¾ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼Ñƒ Ğ±Ğ»Ğ¾ĞºÑƒ</div>'
              : '';
          return `<div class="card"><div class="card-title">${ICONS.muscle} ĞĞĞ“Ğ Ğ£Ğ—ĞšĞ</div>${blockNote}
          <div class="empty-state"><div class="empty-icon">${ICONS.muscle}</div>ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</div></div>`;
        }

        const groupDefs = {
          legs: {
            name: 'ĞĞ¾Ğ³Ğ¸',
            icon: ICONS.leg,
            color: '#007aff',
            muscles: ['quads', 'hamstrings', 'glutes', 'calves'],
            labels: {
              quads: 'ĞšĞ²Ğ°Ğ´Ñ€Ğ¸Ñ†ĞµĞ¿Ñ',
              hamstrings: 'Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ Ğ±ĞµĞ´Ñ€Ğ°',
              glutes: 'Ğ¯Ğ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹',
              calves: 'Ğ˜ĞºÑ€Ñ‹',
            },
          },
          back: {
            name: 'Ğ¡Ğ¿Ğ¸Ğ½Ğ°',
            icon: ICONS.back,
            color: '#5856d6',
            muscles: ['lats', 'traps', 'low_back'],
            labels: { lats: 'Ğ¨Ğ¸Ñ€Ğ¾Ñ‡Ğ°Ğ¹ÑˆĞ¸Ğµ', traps: 'Ğ¢Ñ€Ğ°Ğ¿ĞµÑ†Ğ¸Ñ', low_back: 'ĞŸĞ¾ÑÑĞ½Ğ¸Ñ†Ğ°' },
          },
          chest: {
            name: 'Ğ“Ñ€ÑƒĞ´ÑŒ',
            icon: ICONS.chest,
            color: '#ff2d55',
            muscles: ['chest'],
            labels: { chest: 'Ğ“Ñ€ÑƒĞ´ÑŒ' },
          },
          arms: {
            name: 'Ğ ÑƒĞºĞ¸ Ğ¸ Ğ¿Ğ»ĞµÑ‡Ğ¸',
            icon: ICONS.muscle,
            color: '#ff9500',
            muscles: ['biceps', 'triceps', 'front_delt', 'mid_delt', 'rear_delt'],
            labels: {
              biceps: 'Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ',
              triceps: 'Ğ¢Ñ€Ğ¸Ñ†ĞµĞ¿Ñ',
              front_delt: 'ĞŸĞµÑ€ĞµĞ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°',
              mid_delt: 'Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°',
              rear_delt: 'Ğ—Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°',
            },
          },
          core: {
            name: 'ĞšĞ¾Ñ€',
            icon: ICONS.muscle,
            color: '#34c759',
            muscles: ['core'],
            labels: { core: 'ĞŸÑ€ĞµÑÑ/ĞºĞ¾Ñ€' },
          },
        };

        let maxGroupSets = 0;
        const groups = {};

        if (hasMuscleLoadData) {
          for (const [key, groupData] of Object.entries(muscleLoad.groups)) {
            const def = groupDefs[key];
            if (!def) continue;
            groups[key] = {
              ...def,
              totalSets: groupData.totalSets || 0,
              muscleData: groupData.muscles || {},
            };
            maxGroupSets = Math.max(maxGroupSets, groups[key].totalSets);
          }
        }

        const blockNote =
          currentPeriod === 'block'
            ? '<div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">ĞŸĞ¾ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼Ñƒ Ğ±Ğ»Ğ¾ĞºÑƒ</div>'
            : '';
        return `
        <div class="card">
          <div class="card-header">
            <span class="card-title">${ICONS.muscle} ĞĞĞ“Ğ Ğ£Ğ—ĞšĞ</span>
            <div class="period-selector">
              <button class="period-btn ${currentPeriod === 'block' ? 'active' : ''}" onclick="setPeriod('block')">Ğ‘Ğ»Ğ¾Ğº</button>
              <button class="period-btn ${currentPeriod === '3m' ? 'active' : ''}" onclick="setPeriod('3m')">3 Ğ¼ĞµÑ</button>
              <button class="period-btn ${currentPeriod === 'all' ? 'active' : ''}" onclick="setPeriod('all')">Ğ’ÑÑ‘</button>
            </div>
          </div>
          ${blockNote}
          <div class="muscle-groups">
            ${Object.entries(groups)
              .sort((a, b) => b[1].totalSets - a[1].totalSets)
              .map(([key, group]) => {
                const width = maxGroupSets > 0 ? (group.totalSets / maxGroupSets) * 100 : 0;
                return `
                <div class="muscle-group" id="group-${key}">
                  <div class="muscle-group-header" onclick="toggleMuscleGroup('${key}')">
                    <div class="muscle-group-name"><span class="muscle-group-icon">${group.icon}</span>${group.name}</div>
                    <div class="muscle-group-stats">
                      <span class="muscle-group-sets">${round(group.totalSets)} Ğ¿Ğ¾Ğ´Ñ….</span>
                      <div class="muscle-group-bar"><div class="muscle-group-fill" style="width: ${width}%; background: ${group.color}"></div></div>
                      <span class="muscle-group-arrow">â–¼</span>
                    </div>
                  </div>
                  <div class="muscle-details">
                    ${group.muscles
                      .map((m) => {
                        const sets = group.muscleData[m]?.sets || 0;
                        return `<div class="muscle-item"><span class="muscle-name">${group.labels[m]}</span><span class="muscle-value">${round(sets)}</span></div>`;
                      })
                      .join('')}
                  </div>
                </div>
              `;
              })
              .join('')}
          </div>
        </div>
      `;
      }

      function renderWeeklyComparison() {
        const apiComparison = data.weeklyComparison;

        let thisWeek = apiComparison?.thisWeek || { count: 0, volume: 0 };
        let lastWeek = apiComparison?.lastWeek || { count: 0, volume: 0 };
        let countChange = apiComparison?.changes?.count ?? thisWeek.count - lastWeek.count;
        let volumeChange = apiComparison?.changes?.volumePercent;
        if (volumeChange === undefined || volumeChange === null) {
          if (thisWeek.volume === 0 && lastWeek.volume > 0) volumeChange = -100;
          else if (lastWeek.volume === 0) volumeChange = thisWeek.volume > 0 ? 100 : 0;
          else
            volumeChange = Math.round(
              ((thisWeek.volume - lastWeek.volume) / lastWeek.volume) * 100
            );
        }

        return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.chart} ĞĞ•Ğ”Ğ•Ğ›Ğ¯ VS ĞŸĞ ĞĞ¨Ğ›ĞĞ¯</span></div>
          <div class="weeks-comparison">
            <div class="week-card">
              <div class="week-label">Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº</div>
              <div class="week-value">${thisWeek.count}</div>
              <div class="week-subvalue">Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°Ñ: ${lastWeek.count}</div>
              <div class="week-change ${countChange > 0 ? 'up' : countChange < 0 ? 'down' : 'same'}">${countChange > 0 ? 'â†‘' : countChange < 0 ? 'â†“' : '='} ${Math.abs(countChange)}</div>
            </div>
            <div class="week-card">
              <div class="week-label">Ğ¢Ğ¾Ğ½Ğ½Ğ°Ğ¶ (ĞºĞ³)</div>
              <div class="week-value">${formatNumber(thisWeek.volume)}</div>
              <div class="week-subvalue">Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°Ñ: ${formatNumber(lastWeek.volume)}</div>
              <div class="week-change ${volumeChange > 0 ? 'up' : volumeChange < 0 ? 'down' : 'same'}">${volumeChange > 0 ? 'â†‘' : volumeChange < 0 ? 'â†“' : ''} ${Math.abs(volumeChange)}%</div>
            </div>
          </div>
        </div>
      `;
      }

      function renderProgress() {
        const progress =
          data.exerciseProgress?.improvements || data.exerciseProgress?.topExercises || [];
        const improved = progress.filter((ex) => (ex.progressPercent || ex.progress) > 0);

        if (!improved.length) {
          return `<div class="card"><div class="card-title">${ICONS.rocket} ĞŸĞ ĞĞ“Ğ Ğ•Ğ¡Ğ¡</div>
          <div class="empty-state"><div class="empty-icon">${ICONS.rocket}</div>ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ñ€Ğ¾ÑÑ‚Ğµ Ğ¸Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸</div></div>`;
        }

        const formatIntensity = (p) => (p.weight > 0 ? `${p.weight} ĞºĞ³` : `${p.reps} Ñ€Ğ°Ğ·`);
        return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.rocket} ĞŸĞ ĞĞ“Ğ Ğ•Ğ¡Ğ¡</span></div>
          ${improved
            .slice(0, 5)
            .map((ex) => {
              const fmt = (p) =>
                ex.isBodyweight
                  ? `${p.reps} Ñ€Ğ°Ğ·`
                  : p.weight > 0
                    ? `${p.weight} ĞºĞ³`
                    : `${p.reps} Ñ€Ğ°Ğ·`;
              const hist = ex.history || [];
              const histStr =
                hist.length > 1
                  ? hist.map((p) => `${formatDate(p.date)}: ${fmt(p)}`).join(' â†’ ')
                  : '';
              const mainVal = ex.isBodyweight
                ? `${ex.currentReps || 0} Ñ€Ğ°Ğ·`
                : (ex.currentWeight || 0) > 0
                  ? `${ex.currentWeight} ĞºĞ³`
                  : `${ex.currentReps || 0} Ñ€Ğ°Ğ·`;
              const changeStr =
                (ex.progressKg || 0) > 0
                  ? `+${ex.progressKg} ĞºĞ³`
                  : (ex.progressReps || 0) > 0
                    ? `+${ex.progressReps} Ñ€Ğ°Ğ·`
                    : '';
              return `
            <div class="progress-item">
              <div class="progress-info">
                <div class="progress-name">${ex.name}</div>
                <div class="progress-date">${ICONS.calendar} ${ex.lastDate || 'Ğ½ĞµĞ´Ğ°Ğ²Ğ½Ğ¾'}</div>
                ${histStr ? `<div class="progress-history" style="font-size:12px;color:var(--text-secondary);margin-top:4px;">${histStr}</div>` : ''}
              </div>
              <div class="progress-values">
                <div class="progress-weight">${mainVal}</div>
                ${changeStr ? `<div class="progress-change">${changeStr} (+${ex.progressPercent || 0}%)</div>` : ''}
              </div>
            </div>`;
            })
            .join('')}
        </div>
      `;
      }

      function renderRecentSessions() {
        const sessions = data.recentSessions || [];

        if (!sessions.length) {
          return `<div class="card"><div class="card-title">${ICONS.calendar} Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞ˜</div>
          <div class="empty-state"><div class="empty-icon">${ICONS.calendar}</div>ĞĞµÑ‚ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº</div></div>`;
        }

        return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.calendar} ĞŸĞĞ¡Ğ›Ğ•Ğ”ĞĞ˜Ğ• Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞ˜</span></div>
          ${sessions
            .slice(0, 3)
            .map((s, i) => {
              const exPreview = (s.exercises || [])
                .slice(0, 3)
                .map((e) => e.name)
                .filter(Boolean)
                .join(', ');
              return `
            <div class="session-item" onclick="showSessionModal(${i})">
              <div class="session-header">
                <span class="session-date">${formatDate(s.date)}</span>
                <span class="session-type">${s.splitType || s.type || 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°'}</span>
              </div>
              ${exPreview ? `<div class="session-exercises" style="font-size:13px;color:var(--text-secondary);margin:6px 0 4px;">${exPreview}</div>` : ''}
              <div class="session-stats">
                <span class="session-stat">${ICONS.weight} ${s.exerciseCount || 0} ÑƒĞ¿Ñ€.</span>
                <span class="session-stat">${ICONS.chart} ${s.totalSets || 0} Ğ¿Ğ¾Ğ´Ñ….</span>
                <span class="session-stat">${ICONS.scale} ${formatNumber(s.totalVolume || 0)} ĞºĞ³</span>
              </div>
            </div>`;
            })
            .join('')}
        </div>
      `;
      }

      function renderHistoryPage() {
        const sessions = data.recentSessions || [];
        return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.chartUp} Ğ¢ĞĞĞĞĞ–</span></div>
          <div class="chart-container"><canvas id="tonnageChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.clipboard} Ğ’Ğ¡Ğ• Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞ˜</span></div>
          ${sessions
            .map((s, i) => {
              const exPreview = (s.exercises || [])
                .slice(0, 3)
                .map((e) => e.name)
                .filter(Boolean)
                .join(', ');
              return `
            <div class="session-item" onclick="showSessionModal(${i})">
              <div class="session-header"><span class="session-date">${formatDate(s.date)}</span><span class="session-type">${s.splitType || ''}</span></div>
              ${exPreview ? `<div class="session-exercises" style="font-size:13px;color:var(--text-secondary);margin:6px 0 4px;">${exPreview}</div>` : ''}
              <div class="session-stats"><span class="session-stat">${ICONS.weight} ${s.exerciseCount || 0} ÑƒĞ¿Ñ€.</span><span class="session-stat">${ICONS.scale} ${formatNumber(s.totalVolume || 0)} ĞºĞ³</span></div>
            </div>`;
            })
            .join('')}
        </div>
      `;
      }

      function renderRecordsPage() {
        const allRecs = data.allRecords || [];
        const progress = data.exerciseProgress?.improvements || [];
        const records = allRecs.length
          ? allRecs.map((r) => ({
              type: r.unit === 'Ñ€Ğ°Ğ·' ? 'ĞœĞ°ĞºÑ. Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ĞµĞ½Ğ¸Ñ' : 'ĞœĞ°ĞºÑ. Ğ²ĞµÑ',
              name: r.name,
              value: `${r.value} ${r.unit || 'ĞºĞ³'}${r.hint || ''}`,
              date: r.date,
              change: '',
            }))
          : progress
              .filter((p) => (p.progressPercent || p.progress) > 0)
              .map((p) => ({
                type: 'ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ',
                name: p.name,
                value: `${p.currentWeight || p.lastWeight} ĞºĞ³`,
                date: p.lastDate,
                change: `+${p.progressKg} ĞºĞ³`,
              }));

        return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.trophy} Ğ Ğ•ĞšĞĞ Ğ”Ğ«</span></div>
          ${
            records.length
              ? records
                  .map(
                    (r) => `
            <div class="record-item">
              <div><div class="record-type">${r.type}</div><div class="record-name">${r.name}</div></div>
              <div class="record-value-container"><div class="record-value">${r.value}</div><div class="record-date">${r.date || ''}${r.change ? ' â€¢ ' + r.change : ''}</div></div>
            </div>
          `
                  )
                  .join('')
              : `<div class="empty-state"><div class="empty-icon">${ICONS.trophy}</div>ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ¾Ğ²</div>`
          }
        </div>
      `;
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // INTERACTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      function toggleMuscleGroup(key) {
        document.getElementById(`group-${key}`).classList.toggle('expanded');
      }

      async function setPeriod(period) {
        currentPeriod = period;
        await loadDashboard();
      }

      function showPage(page) {
        currentPage = page;
        document.querySelectorAll('.nav-item').forEach((item, i) => {
          item.classList.toggle('active', ['main', 'history', 'records'][i] === page);
        });
        document.getElementById('mainPage').classList.toggle('hidden', page !== 'main');
        document.getElementById('historyPage').classList.toggle('active', page === 'history');
        document.getElementById('recordsPage').classList.toggle('active', page === 'records');
        if (page === 'history') setTimeout(initTonnageChart, 100);
      }

      function showSessionModal(index) {
        const s = data.recentSessions[index];
        if (!s) return;
        const exercises = s.exercises || [];

        const workoutName = (s.splitType || s.type || '').trim() || 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°';
        document.getElementById('sessionModal').innerHTML = `
        <div class="modal">
          <div class="modal-handle"></div>
          <h2>${formatDate(s.date)}</h2>
          <div class="modal-subtitle">${workoutName}</div>
          <div class="modal-section">
            <div class="modal-stat-grid">
              <div class="modal-stat"><div class="modal-stat-value">${s.exerciseCount || exercises.length || 0}</div><div class="modal-stat-label">Ğ£Ğ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğ¹</div></div>
              <div class="modal-stat"><div class="modal-stat-value">${s.totalSets || 0}</div><div class="modal-stat-label">ĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´Ğ¾Ğ²</div></div>
              <div class="modal-stat"><div class="modal-stat-value">${formatNumber(s.totalVolume || 0)}</div><div class="modal-stat-label">Ğ¢Ğ¾Ğ½Ğ½Ğ°Ğ¶</div></div>
            </div>
          </div>
          ${
            exercises.length
              ? `<div class="modal-section"><div class="modal-section-title">${ICONS.weight} Ğ£ĞŸĞ ĞĞ–ĞĞ•ĞĞ˜Ğ¯</div>
            <div class="modal-exercise-list">${exercises
              .map((ex) => {
                const list = ex.setsList || (ex.sets ? [{ reps: ex.reps, weight: ex.weight }] : []);
                const fmt = (w) => {
                  const n = parseNum(w);
                  return n % 1 === 0 ? n : Math.round(n * 100) / 100;
                };
                const detail = list.length
                  ? list
                      .map((x) => {
                        const w = parseNum(x.weight);
                        return w > 0 ? `${x.reps}Ã—${fmt(w)} ĞºĞ³` : `${x.reps} Ñ€Ğ°Ğ·`;
                      })
                      .join(', ')
                  : `${ex.sets || 0}Ã—${ex.reps || 0} â€¢ ${parseNum(ex.weight)} ĞºĞ³`;
                return `<div class="modal-exercise"><span class="modal-exercise-name">${ex.name}</span><span class="modal-exercise-detail">${detail}</span></div>`;
              })
              .join('')}</div></div>`
              : ''
          }
          ${s.notes ? `<div class="modal-section"><div class="modal-section-title">Ğ—ĞĞœĞ•Ğ¢ĞšĞ˜</div><div style="padding: 12px; background: var(--bg); border-radius: 8px;">${s.notes}</div></div>` : ''}
        </div>
      `;
        document.getElementById('sessionModal').classList.add('active');
      }

      function showSettingsModal() {
        document.getElementById('settingsModal').innerHTML = `
        <div class="modal settings-modal">
          <h2>${ICONS.gear} ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</h2>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ğ¸Ğ· Supabase. ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ Ğ² Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğµ.</p>
          <label>Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚</label>
          <input type="text" id="clientIdInput" value="${selectedClientId || ''}" readonly style="opacity: 0.8;">
          <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal('settingsModal')">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
            <button class="btn-secondary" onclick="handleLogout()">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
          </div>
        </div>
      `;
        document.getElementById('settingsModal').classList.add('active');
      }

      function saveSettingsAndReload() {
        API_CONFIG.URL = document.getElementById('apiUrlInput').value.trim();
        API_CONFIG.CLIENT_ID = document.getElementById('clientIdInput').value.trim() || 'yaroslav';
        closeModal('settingsModal');
        loadDashboard();
      }

      function initTonnageChart() {
        const canvas = document.getElementById('tonnageChart');
        if (!canvas) return;

        const sessions = (data.recentSessions || []).slice(0, 10).reverse();
        if (tonnageChart) tonnageChart.destroy();

        tonnageChart = new Chart(canvas.getContext('2d'), {
          type: 'line',
          data: {
            labels: sessions.map((s) => formatDate(s.date)),
            datasets: [
              {
                label: 'Ğ¢Ğ¾Ğ½Ğ½Ğ°Ğ¶ (ĞºĞ³)',
                data: sessions.map((s) => s.totalVolume || 0),
                borderColor: '#0071e3',
                backgroundColor: 'rgba(0, 113, 227, 0.1)',
                borderWidth: 2,
                pointRadius: 5,
                pointBackgroundColor: '#0071e3',
                tension: 0.3,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: '#e5e5e5' } },
              x: { grid: { display: false } },
            },
          },
        });
      }

      function showSetupScreen() {
        document.getElementById('app').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 20px;">${ICONS.gear}</div>
          <h2>ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ</h2>
          <p style="color: var(--text-secondary); margin: 12px 0 24px;">Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ URL API Ğ¸ ID ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°</p>
          <button onclick="showSettingsModal()" class="btn btn-primary" style="width: auto; padding: 16px 32px;">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ</button>
        </div>
        <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeModal('settingsModal')"></div>
      `;
      }

      function showError(msg) {
        document.getElementById('app').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">${ICONS.sad}</div>
          <div style="color: var(--danger); margin-bottom: 8px;">ĞÑˆĞ¸Ğ±ĞºĞ°</div>
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">${msg}</div>
          <button onclick="loadDashboard()" class="btn btn-primary" style="width: auto;">ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
        </div>
        <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeModal('settingsModal')"></div>
      `;
      }

      // Init: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞµÑÑĞ¸Ğ¸ â†’ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² â†’ Ğ²Ñ‹Ğ±Ğ¾Ñ€ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¸Ğ»Ğ¸ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´
      document.addEventListener('DOMContentLoaded', async () => {
        if (!(await requireAuth())) return;
        try {
          clientsList = await loadClientsFromSupabase();
          selectedClientId = localStorage.getItem('dashboard_client_id') || null;
          if (selectedClientId && clientsList.some((c) => c.id === selectedClientId)) {
            programsList = await loadProgramsFromSupabase(selectedClientId);
            await loadDashboard();
          } else {
            selectedClientId = null;
            if (clientsList.length === 0) showClientPicker();
            else showClientPicker();
          }
        } catch (e) {
          showError('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (e.message || e));
        }
      });
    </script>
  </body>
</html>
