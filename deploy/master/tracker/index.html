<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Fitness Tracker</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a1a2e" />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- Supabase + Tracker API -->
    <script src="../js/supabase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/tracker-supabase.js"></script>

    <style>
      :root {
        --bg: #0f0f1a;
        --card: #1a1a2e;
        --card-hover: #252542;
        --border: #2a2a4a;
        --text: #e2e8f0;
        --text-secondary: #94a3b8;
        --accent: #a855f7;
        --accent-light: #c084fc;
        --success: #22c55e;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #3b82f6;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        padding-bottom: 80px;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* TOP NAVIGATION */
      /* ═══════════════════════════════════════════════════════════ */

      .top-nav {
        display: flex;
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 0;
        overflow-x: auto;
      }

      .top-nav-item {
        flex: 1;
        padding: 12px 16px;
        text-align: center;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .top-nav-item:hover {
        color: var(--text);
        background: var(--card-hover);
      }

      .top-nav-item.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* HEADER */
      /* ═══════════════════════════════════════════════════════════ */

      .app-header {
        background: var(--card);
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .app-title {
        font-size: 1.2em;
        font-weight: 700;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .settings-btn {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        position: relative;
        z-index: 10;
        -webkit-tap-highlight-color: transparent;
      }

      .settings-btn:active {
        background: var(--border);
      }

      .client-selector {
        width: 100%;
        padding: 12px 16px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text);
        font-size: 1em;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2394a3b8' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 24px;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* MODULE NAVIGATION */
      /* ═══════════════════════════════════════════════════════════ */

      .module-nav {
        display: flex;
        gap: 6px;
        padding: 12px 16px;
        background: var(--card);
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .module-nav::-webkit-scrollbar {
        display: none;
      }

      .module-tab {
        padding: 10px 16px;
        border-radius: 20px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.85em;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .module-tab.active {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
      }

      .module-tab:not(.active):hover {
        border-color: var(--accent);
        color: var(--text);
      }

      .module-tab .icon {
        font-size: 1.1em;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* MAIN CONTENT */
      /* ═══════════════════════════════════════════════════════════ */

      .main-content {
        padding: 16px;
        max-width: 600px;
        margin: 0 auto;
      }

      .module-content {
        display: none;
      }

      .module-content.active {
        display: block;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* CARDS */
      /* ═══════════════════════════════════════════════════════════ */

      .card {
        background: var(--card);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid var(--border);
        margin-bottom: 16px;
      }

      .card-title {
        font-size: 1em;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* FORM ELEMENTS */
      /* ═══════════════════════════════════════════════════════════ */

      .form-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
      }

      .form-group {
        flex: 1;
      }

      .form-label {
        font-size: 0.8em;
        color: var(--text-secondary);
        margin-bottom: 6px;
        display: block;
      }

      .form-input {
        width: 100%;
        padding: 12px 14px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        font-size: 1em;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .form-input::placeholder {
        color: var(--text-secondary);
      }

      textarea.form-input {
        min-height: 100px;
        resize: vertical;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* BUTTONS */
      /* ═══════════════════════════════════════════════════════════ */

      .btn {
        padding: 14px 24px;
        border-radius: 12px;
        border: none;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
        width: 100%;
      }

      .btn-primary:hover {
        background: #9333ea;
      }

      .btn-secondary {
        background: var(--bg);
        color: var(--text);
        border: 1px solid var(--border);
      }

      .btn-success {
        background: var(--success);
        color: white;
        width: 100%;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* QUICK STATS */
      /* ═══════════════════════════════════════════════════════════ */

      .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }

      .stat-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.5em;
        font-weight: 700;
        color: var(--accent);
      }

      .stat-label {
        font-size: 0.75em;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* HISTORY LIST */
      /* ═══════════════════════════════════════════════════════════ */

      .history-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .history-item {
        background: var(--bg);
        border-radius: 10px;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
      }

      .history-item:hover {
        background: var(--card-hover);
      }

      .history-item.history-hidden {
        display: none;
      }

      .history-list.expanded .history-item.history-hidden {
        display: flex;
      }

      .history-expand-btn {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        background: var(--bg);
        border: 1px dashed var(--border);
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
      }

      .history-expand-btn:hover {
        background: var(--card-hover);
        color: var(--text);
      }

      .history-expand-btn.expanded {
        border-style: solid;
      }

      .history-date {
        font-size: 0.85em;
        color: var(--text-secondary);
      }

      .history-name {
        font-weight: 600;
        color: var(--text);
      }

      .history-notes {
        font-size: 0.8em;
        color: var(--text-secondary);
        margin-top: 4px;
        font-style: italic;
      }

      .history-item-content {
        flex: 1;
      }

      .history-stats {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
        min-width: 80px;
      }

      .history-exercises {
        font-size: 0.85em;
        color: var(--text-secondary);
      }

      .history-rpe {
        font-size: 0.8em;
        color: var(--accent-light);
        margin-top: 2px;
      }

      .history-volume {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .volume-arrow {
        font-size: 1em;
        font-weight: bold;
      }

      .volume-arrow.up {
        color: #ef4444;
      }

      .volume-arrow.down {
        color: #22c55e;
      }

      .volume-text {
        font-size: 0.85em;
        color: var(--text-secondary);
        min-width: 35px;
        text-align: right;
      }

      .history-summary {
        font-size: 0.85em;
        color: var(--text-secondary);
      }

      .history-value {
        font-weight: 600;
        color: var(--accent);
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* LOADING & TOAST */
      /* ═══════════════════════════════════════════════════════════ */

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        flex-direction: column;
        gap: 16px;
      }

      .loading-overlay.active {
        display: flex;
      }

      .spinner {
        width: 48px;
        height: 48px;
        border: 3px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: var(--text-secondary);
      }

      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--card);
        padding: 12px 24px;
        border-radius: 12px;
        border: 1px solid var(--border);
        opacity: 0;
        transition: all 0.3s;
        z-index: 1001;
        max-width: 90%;
        text-align: center;
      }

      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .toast.success {
        border-color: var(--success);
      }
      .toast.error {
        border-color: var(--danger);
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* SETTINGS MODAL */
      /* ═══════════════════════════════════════════════════════════ */

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
        padding: 20px;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--card);
        border-radius: 16px;
        padding: 24px;
        width: 100%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 1.2em;
        font-weight: 600;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: none;
        background: var(--bg);
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 18px;
      }

      .modal-large {
        max-width: 500px;
      }

      /* New Block Modal */
      .new-block-modal {
        background: var(--card);
        border-radius: 16px;
        width: 100%;
        max-width: 450px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .new-block-modal .modal-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 0;
      }

      .new-block-modal .modal-header h2 {
        font-size: 1.2em;
        font-weight: 600;
        margin: 0;
      }

      .new-block-modal .modal-body {
        padding: 20px;
      }

      .new-block-modal .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .form-section {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--text);
      }

      .form-hint {
        font-size: 0.85em;
        color: var(--text-secondary);
        margin: 4px 0 10px;
      }

      .form-divider {
        height: 1px;
        background: var(--border);
        margin: 20px 0;
      }

      .task-inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .task-input-row {
        display: flex;
        gap: 10px;
      }

      .task-input-row .form-input {
        flex: 1;
      }

      .task-input-row .task-type {
        width: 110px;
        flex: none;
      }

      .btn-secondary {
        background: var(--bg);
        color: var(--text);
        border: 1px solid var(--border);
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
      }

      /* Also ensure modal-content uses display:flex for inline modals */
      .modal-content {
        background: var(--card);
        border-radius: 16px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }

      /* Workout Summary Modal */
      .summary-title {
        font-size: 1.1em;
        font-weight: 600;
        text-align: center;
        color: var(--accent-light);
        margin-bottom: 16px;
      }

      .summary-stats {
        display: flex;
        justify-content: space-around;
        padding: 16px 0;
        border-top: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        margin-bottom: 16px;
      }

      .summary-stat {
        text-align: center;
      }

      .summary-stat-value {
        font-size: 1.5em;
        font-weight: 700;
        color: var(--text);
      }

      .summary-stat-label {
        font-size: 0.75em;
        color: var(--text-secondary);
        text-transform: uppercase;
      }

      .summary-volume {
        text-align: center;
        padding: 12px;
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(34, 197, 94, 0.1));
        border-radius: 12px;
        margin-bottom: 12px;
      }

      .summary-volume-label {
        font-size: 0.8em;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }

      .summary-volume-value {
        font-size: 1.8em;
        font-weight: 700;
        color: var(--success);
      }

      .summary-rpe {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 8px;
        margin-bottom: 12px;
        color: var(--text-secondary);
      }

      .summary-rpe .rpe-value {
        font-weight: 600;
        color: var(--warning);
      }

      .summary-exercises {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 12px;
      }

      .summary-exercise {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--bg);
        border-radius: 8px;
        font-size: 0.9em;
      }

      .summary-exercise .ex-name {
        color: var(--text);
        font-weight: 500;
      }

      .summary-exercise .ex-detail {
        color: var(--text-secondary);
        font-size: 0.85em;
      }

      /* Workout Details */
      .workout-details-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .workout-details-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      .workout-meta-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .workout-meta-label {
        font-size: 0.75em;
        color: var(--text-secondary);
        text-transform: uppercase;
      }

      .workout-meta-value {
        font-weight: 600;
        color: var(--text);
      }

      .workout-notes {
        background: var(--bg);
        padding: 12px;
        border-radius: 8px;
        font-style: italic;
        color: var(--text-secondary);
      }

      .workout-notes-label {
        font-size: 0.85em;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 4px;
        font-style: normal;
      }

      .workout-exercise-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .workout-exercise-item {
        background: var(--bg);
        border-radius: 12px;
        padding: 12px;
      }

      .workout-exercise-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .workout-exercise-name {
        font-weight: 600;
      }

      .workout-exercise-category {
        font-size: 0.75em;
        padding: 4px 8px;
        border-radius: 12px;
        background: var(--accent);
        color: white;
      }

      .workout-sets-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .workout-set-badge {
        background: var(--card);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 0.9em;
      }

      .workout-set-badge .weight {
        color: var(--accent);
        font-weight: 600;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* WORKOUTS MODULE SPECIFIC */
      /* ═══════════════════════════════════════════════════════════ */

      .input-mode-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 16px;
        background: var(--bg);
        padding: 4px;
        border-radius: 10px;
      }

      .input-mode-tab {
        flex: 1;
        padding: 10px 12px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85em;
        font-weight: 500;
        transition: all 0.2s;
      }

      .input-mode-tab.active {
        background: var(--accent);
        color: white;
      }

      .voice-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid var(--accent);
        background: transparent;
        color: var(--accent);
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .voice-btn.recording {
        background: var(--danger);
        border-color: var(--danger);
        color: white;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .input-actions {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }

      .input-actions .btn-primary {
        flex: 1;
      }

      /* Exercise list for manual input */
      .exercise-search-input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg);
        color: var(--text);
        font-size: 1em;
        margin-bottom: 10px;
      }

      .category-filter {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .category-btn {
        padding: 6px 12px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text-secondary);
        border-radius: 20px;
        font-size: 0.8em;
        cursor: pointer;
      }

      .category-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
      }

      .exercise-list-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 10px;
      }

      .exercise-list-item {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
      }

      .exercise-list-item:last-child {
        border-bottom: none;
      }

      .exercise-list-item:hover {
        background: rgba(168, 85, 247, 0.1);
      }

      /* Parsed exercises */
      .parsed-exercise {
        background: var(--bg);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 10px;
        position: relative;
        display: flex;
        gap: 8px;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .parsed-exercise.dragging {
        opacity: 0.5;
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .parsed-exercise.drag-over {
        border: 2px dashed var(--accent);
      }

      .exercise-order-num {
        min-width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85em;
        color: var(--accent);
        font-weight: 700;
        background: rgba(168, 85, 247, 0.1);
        border-radius: 6px;
        margin-right: 12px;
        flex-shrink: 0;
      }

      .exercise-content {
        flex: 1;
        min-width: 0;
      }

      .parsed-exercise-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
        gap: 8px;
      }

      .parsed-exercise-name {
        font-weight: 600;
        flex: 1;
        font-size: 0.95em;
      }

      .new-exercise-badge {
        display: inline-block;
        font-size: 0.65em;
        padding: 2px 6px;
        background: var(--warning);
        color: #000;
        border-radius: 4px;
        font-weight: 700;
        margin-left: 6px;
        vertical-align: middle;
      }

      .exercise-actions {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      /* Вариации упражнения */
      .exercise-variations {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
        align-items: center;
      }

      .variation-select {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        font-size: 14px;
        cursor: pointer;
        min-width: 110px;
        max-width: 150px;
      }

      .variation-select:focus {
        outline: none;
        border-color: var(--accent);
      }

      .variation-select option {
        font-size: 14px;
        padding: 10px;
      }

      /* Унилатеральность */
      /* Muscle Load Preview */
      .muscle-load-preview {
        background: var(--bg);
        border-radius: 10px;
        padding: 12px;
        margin-top: 10px;
        border: 1px solid var(--border);
      }

      .muscle-load-title {
        font-size: 0.8em;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .muscle-load-title .edit-coeff-btn {
        padding: 3px 8px;
        font-size: 0.75em;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 5px;
        color: var(--text-secondary);
        cursor: pointer;
      }

      .muscle-load-title .edit-coeff-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .muscle-bars {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .muscle-bar-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .muscle-bar-name {
        width: 80px;
        font-size: 0.75em;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .muscle-bar-track {
        flex: 1;
        height: 16px;
        background: var(--card);
        border-radius: 3px;
        overflow: hidden;
        position: relative;
      }

      .muscle-bar-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .muscle-bar-fill.legs {
        background: linear-gradient(90deg, #22c55e, #16a34a);
      }
      .muscle-bar-fill.back {
        background: linear-gradient(90deg, #3b82f6, #2563eb);
      }
      .muscle-bar-fill.chest {
        background: linear-gradient(90deg, #ef4444, #dc2626);
      }
      .muscle-bar-fill.arms {
        background: linear-gradient(90deg, #f59e0b, #d97706);
      }
      .muscle-bar-fill.core {
        background: linear-gradient(90deg, #8b5cf6, #7c3aed);
      }

      .muscle-bar-pct {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.65em;
        font-weight: 600;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
      }

      .muscle-ai-badge {
        font-size: 0.7em;
        color: var(--warning);
        margin-left: 4px;
      }

      /* Coefficient Editor Modal */
      .coeff-modal-body {
        max-height: 55vh;
        overflow-y: auto;
        padding: 16px;
      }

      .coeff-info-box {
        padding: 10px 14px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 8px;
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-bottom: 12px;
      }

      .coeff-sum-box {
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        margin-bottom: 16px;
      }

      .coeff-sum-box.valid {
        background: rgba(16, 185, 129, 0.15);
        color: var(--success);
        border: 1px solid var(--success);
      }

      .coeff-sum-box.invalid {
        background: rgba(239, 68, 68, 0.15);
        color: var(--error);
        border: 1px solid var(--error);
      }

      .coeff-group {
        margin-bottom: 16px;
      }

      .coeff-group-title {
        font-size: 0.8em;
        font-weight: 600;
        color: var(--accent-light);
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid var(--border);
      }

      .coeff-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }

      .coeff-muscle-name {
        width: 110px;
        font-size: 0.85em;
        color: var(--text);
      }

      .coeff-slider-wrap {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .coeff-slider {
        flex: 1;
        height: 6px;
        -webkit-appearance: none;
        background: var(--border);
        border-radius: 3px;
        outline: none;
      }

      .coeff-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
      }

      .coeff-input {
        width: 50px;
        padding: 4px 6px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--card);
        color: var(--text);
        text-align: center;
        font-size: 0.85em;
      }

      .unilateral-toggle {
        font-size: 11px !important;
        font-weight: 600;
        padding: 3px 6px !important;
        border-radius: 4px;
        background: rgba(100, 100, 100, 0.2);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        opacity: 0.6;
      }

      .unilateral-toggle:hover {
        opacity: 1;
        background: rgba(100, 100, 100, 0.4);
      }

      .unilateral-toggle.active {
        background: rgba(16, 185, 129, 0.25);
        border-color: #10b981;
        color: #10b981;
        opacity: 1;
      }

      .unilateral-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 3px 6px;
        border-radius: 4px;
        color: var(--text-secondary);
      }

      .unilateral-badge.active {
        background: rgba(16, 185, 129, 0.25);
        border: 1px solid #10b981;
        color: #10b981;
      }

      .parsed-exercise-category {
        font-size: 0.7em;
        padding: 2px 6px;
        background: rgba(168, 85, 247, 0.2);
        color: var(--accent);
        border-radius: 8px;
        white-space: nowrap;
      }

      .parsed-sets {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .parsed-set {
        padding: 4px 10px;
        background: var(--card);
        border-radius: 6px;
        font-size: 0.85em;
        font-family: monospace;
        cursor: pointer;
      }

      .parsed-set:hover {
        background: var(--border);
      }

      .parsed-set .weight {
        color: var(--warning);
      }
      .parsed-set .reps {
        color: var(--success);
      }

      .parsed-set .mult-hint {
        font-size: 0.7em;
        color: var(--accent);
        vertical-align: super;
        margin-left: 1px;
      }

      .weight-multiplier-hint {
        font-size: 0.75em;
        color: var(--text-secondary);
        padding: 4px 8px;
        background: rgba(168, 85, 247, 0.1);
        border-radius: 6px;
        margin-bottom: 8px;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* DAILY MODULE SPECIFIC */
      /* ═══════════════════════════════════════════════════════════ */

      .metric-input-group {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: var(--bg);
        border-radius: 12px;
        margin-bottom: 12px;
      }

      .metric-icon {
        font-size: 1.5em;
        width: 40px;
        text-align: center;
      }

      .metric-input-wrapper {
        flex: 1;
      }

      .metric-label {
        font-size: 0.8em;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }

      .metric-input {
        width: 100%;
        padding: 10px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 1.1em;
        text-align: center;
      }

      .metric-unit {
        font-size: 0.9em;
        color: var(--text-secondary);
        width: 40px;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* NUTRITION MODULE SPECIFIC */
      /* ═══════════════════════════════════════════════════════════ */

      .macro-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-bottom: 16px;
      }

      .macro-card {
        background: var(--bg);
        border-radius: 10px;
        padding: 12px;
        text-align: center;
      }

      .macro-value {
        font-size: 1.3em;
        font-weight: 700;
      }

      .macro-card.calories .macro-value {
        color: var(--warning);
      }
      .macro-card.protein .macro-value {
        color: var(--danger);
      }
      .macro-card.fats .macro-value {
        color: var(--info);
      }
      .macro-card.carbs .macro-value {
        color: var(--success);
      }

      .macro-label {
        font-size: 0.7em;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      .macro-target {
        font-size: 0.65em;
        color: var(--text-secondary);
        margin-top: 2px;
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* WARMUP MODULE SPECIFIC */
      /* ═══════════════════════════════════════════════════════════ */

      .warmup-exercise {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px;
        background: var(--bg);
        border-radius: 12px;
        margin-bottom: 10px;
      }

      .warmup-checkbox {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        border: 2px solid var(--border);
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: transparent;
        transition: all 0.2s;
        font-size: 16px;
      }

      .warmup-checkbox.checked {
        background: var(--success);
        border-color: var(--success);
        color: white;
      }

      .warmup-info {
        flex: 1;
      }

      .warmup-name {
        font-weight: 500;
      }

      .warmup-detail {
        font-size: 0.8em;
        color: var(--text-secondary);
      }

      .warmup-progress {
        text-align: center;
        padding: 20px;
        margin-bottom: 16px;
      }

      .warmup-progress-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 6px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 1.5em;
        font-weight: 700;
      }

      .warmup-progress-circle.complete {
        border-color: var(--success);
        color: var(--success);
      }

      /* ═══════════════════════════════════════════════════════════ */
      /* RESPONSIVE */
      /* ═══════════════════════════════════════════════════════════ */

      @media (max-width: 400px) {
        .macro-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .quick-stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* Progress Bar */
      .progress-bar-container {
        height: 8px;
        background: var(--border);
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--success));
        border-radius: 4px;
        transition: width 0.3s;
      }

      /* Mandatory Tasks */
      .mandatory-tasks-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .mandatory-task {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        background: var(--bg);
        border-radius: 10px;
      }

      .task-name {
        font-weight: 500;
      }

      .task-target {
        font-size: 0.85em;
        color: var(--text-secondary);
      }

      /* Goals Grid */
      .goals-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .goal-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        background: var(--bg);
        border-radius: 12px;
      }

      .goal-icon {
        font-size: 1.5em;
        width: 40px;
        text-align: center;
      }

      .goal-info {
        flex: 1;
      }

      .goal-label {
        font-size: 0.85em;
        color: var(--text-secondary);
      }

      .goal-value {
        font-size: 1.1em;
        font-weight: 600;
        color: var(--accent);
      }

      .history-exercises {
        font-size: 0.85em;
        color: var(--text-secondary);
      }

      /* Sleep Time Row */
      .sleep-time-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
      }

      /* Date Selector */
      .date-selector-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .date-label {
        color: var(--text-secondary);
        font-size: 0.9em;
      }

      .date-input {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 14px;
        color: var(--text);
        font-size: 1em;
        cursor: pointer;
      }

      .date-input::-webkit-calendar-picker-indicator {
        filter: invert(0.8);
        cursor: pointer;
      }

      /* Section Divider */
      .section-divider {
        display: flex;
        align-items: center;
        margin: 20px 0 16px;
        color: var(--text-secondary);
        font-size: 0.9em;
      }

      .section-divider::before,
      .section-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border);
      }

      .section-divider span {
        padding: 0 12px;
      }

      /* Compact Macro Grid */
      .macro-grid.compact {
        gap: 8px;
        margin-bottom: 16px;
      }

      .macro-grid.compact .macro-card {
        padding: 10px;
      }

      .macro-grid.compact .macro-value {
        font-size: 1.2em;
      }

      /* Inline Progress */
      .progress-metric.inline {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: var(--bg);
        border-radius: 10px;
        margin-bottom: 10px;
      }

      .progress-label {
        font-size: 0.9em;
        color: var(--text);
      }

      .progress-input-inline {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .progress-input-inline .metric-input.small {
        width: 70px;
      }

      /* Large Button */
      .btn-large {
        margin-top: 20px;
        padding: 16px;
        font-size: 1.1em;
      }

      /* Weight Progress */
      .weight-progress {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
      }

      .weight-progress .current,
      .weight-progress .target {
        font-weight: 600;
        white-space: nowrap;
      }

      .weight-progress .current {
        color: var(--text);
      }

      .weight-progress .target {
        color: var(--success);
      }

      .weight-progress .progress-bar-container {
        flex: 1;
      }

      .metric-input-group.compact {
        flex: 1;
        margin-bottom: 0;
      }

      .metric-input-group.compact .metric-icon {
        width: 30px;
        font-size: 1.2em;
      }

      /* Sleep Result */
      .sleep-result {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 14px;
        background: var(--bg);
        border-radius: 12px;
        margin-bottom: 12px;
      }

      .sleep-result .sleep-icon {
        font-size: 1.5em;
      }

      .sleep-result .sleep-hours {
        font-size: 1.8em;
        font-weight: 700;
      }

      .sleep-result .sleep-label {
        color: var(--text-secondary);
      }

      .sleep-result.good .sleep-hours {
        color: var(--success);
      }
      .sleep-result.warning .sleep-hours {
        color: var(--warning);
      }
      .sleep-result.bad .sleep-hours {
        color: var(--danger);
      }

      /* Progress Metrics */
      .progress-metric {
        padding: 14px;
        background: var(--bg);
        border-radius: 12px;
        margin-bottom: 12px;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .progress-target {
        font-weight: 600;
        color: var(--accent);
      }

      .progress-input-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .metric-input.small {
        width: 120px;
        text-align: center;
      }

      /* Training Block Card */
      .training-block-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
      }

      .training-block-card.completed {
        border-color: var(--warning);
        background: linear-gradient(135deg, var(--card), rgba(234, 179, 8, 0.05));
      }

      .training-block-card.no-block {
        border-style: dashed;
        text-align: center;
      }

      .block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .block-title {
        font-weight: 600;
        color: var(--text);
      }

      .block-badge {
        font-size: 0.75em;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
      }

      .block-badge.done {
        background: var(--success);
        color: white;
      }

      .block-badge.warning {
        background: var(--warning);
        color: black;
      }

      .btn-accent {
        background: linear-gradient(135deg, var(--accent), var(--accent-light));
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        width: 100%;
      }

      .block-stats {
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin-bottom: 16px;
      }

      .block-stats.single {
        justify-content: center;
        margin-bottom: 0;
      }

      .block-stat {
        text-align: center;
      }

      .block-stat-value {
        font-size: 2.5em;
        font-weight: 700;
        color: var(--accent);
        line-height: 1;
      }

      .block-stat-value.secondary {
        font-size: 1.5em;
        color: var(--text-secondary);
      }

      .block-stat-label {
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-top: 4px;
        text-transform: uppercase;
      }

      /* Task Description */
      .task-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex: 1;
      }

      .task-desc {
        font-size: 0.8em;
        color: var(--text-secondary);
      }

      /* Mandatory Task Item with Checkbox */
      .mandatory-task-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        background: var(--bg);
        border-radius: 10px;
        margin-bottom: 8px;
      }

      .task-checkbox {
        position: relative;
        cursor: pointer;
        width: 24px;
        height: 24px;
        flex-shrink: 0;
      }

      .task-checkbox input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
      }

      .task-checkbox .checkmark {
        position: absolute;
        top: 0;
        left: 0;
        height: 24px;
        width: 24px;
        background-color: var(--card);
        border: 2px solid var(--border);
        border-radius: 6px;
        transition: all 0.2s;
      }

      .task-checkbox:hover .checkmark {
        border-color: var(--accent);
      }

      .task-checkbox input:checked ~ .checkmark {
        background-color: var(--success);
        border-color: var(--success);
      }

      .task-checkbox .checkmark:after {
        content: '';
        position: absolute;
        display: none;
        left: 7px;
        top: 3px;
        width: 6px;
        height: 12px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }

      .task-checkbox input:checked ~ .checkmark:after {
        display: block;
      }

      .mandatory-task-item.completed {
        opacity: 0.6;
      }

      .mandatory-task-item.completed .task-name {
        text-decoration: line-through;
      }

      /* Add Exercise Form */
      .add-exercise-form {
        background: var(--bg);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .add-exercise-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 12px 0;
      }

      .add-exercise-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      .btn-outline {
        background: transparent;
        border: 2px dashed var(--border);
        color: var(--text-secondary);
        padding: 12px;
        border-radius: 10px;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-outline:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .add-exercise-btn {
        margin-top: 8px;
      }

      .workout-notes-section {
        margin: 16px 0;
      }

      .notes-label {
        display: block;
        font-size: 0.9em;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .workout-notes-input {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--card);
        color: var(--text);
        font-size: 14px;
        resize: vertical;
        min-height: 60px;
      }

      .workout-notes-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .workout-notes-input::placeholder {
        color: var(--text-secondary);
        opacity: 0.7;
      }

      .btn-clear-workout {
        margin-top: 8px;
        margin-left: 8px;
        padding: 6px 12px;
        font-size: 0.85em;
        background: transparent;
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: #ef4444;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-clear-workout:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: #ef4444;
      }

      .mandatory-tasks-checklist {
        margin: 16px 0;
        padding: 12px;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 8px;
      }

      .checklist-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text-primary);
      }

      .task-checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .task-checkbox-item:last-child {
        border-bottom: none;
      }

      .task-checkbox-item input[type='checkbox'] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #10b981;
      }

      .task-checkbox-item label {
        flex: 1;
        cursor: pointer;
        color: var(--text-secondary);
      }

      .task-checkbox-item input:checked + label {
        color: #10b981;
        text-decoration: line-through;
      }

      .task-type-badge {
        font-size: 0.75em;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(139, 92, 246, 0.2);
        color: #a78bfa;
      }

      .exercise-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        font-size: 1em;
        opacity: 0.6;
        transition: opacity 0.2s;
      }

      .btn-icon:hover {
        opacity: 1;
      }

      .delete-exercise {
        color: var(--danger);
      }

      .edit-exercise {
        color: var(--accent);
      }

      .exercise-equipment {
        font-size: 0.75em;
        color: var(--text-secondary);
        background: var(--bg);
        padding: 2px 8px;
        border-radius: 4px;
      }

      /* Edit Exercise Form */
      .edit-exercise-form {
        background: var(--bg);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border: 2px solid var(--accent);
      }

      .parsed-exercise.editing {
        border: 2px solid var(--accent);
        box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.2);
      }

      .edit-set-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }

      .edit-set-row input {
        width: 70px;
      }

      .edit-exercise-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }

      .form-group {
        margin-bottom: 12px;
      }

      .form-label {
        display: block;
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }

      /* Parsed Set Clickable */
      .parsed-set {
        cursor: pointer;
        transition: background 0.2s;
      }

      .parsed-set:hover {
        background: var(--border);
      }

      .add-set-btn {
        margin-left: 4px;
        opacity: 0.5;
      }

      .parsed-sets:hover .add-set-btn {
        opacity: 1;
      }

      .btn-secondary {
        background: var(--bg);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
      }

      /* Workout Meta Form */
      .workout-meta-form {
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .rpe-selector {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
      }

      .rpe-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
      }

      .rpe-btn:hover {
        border-color: var(--accent);
      }

      .rpe-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
      }

      /* RPE цветовая шкала */
      .rpe-btn[data-value='1'],
      .rpe-btn[data-value='2'],
      .rpe-btn[data-value='3'],
      .rpe-btn[data-value='4'] {
        --rpe-color: #4caf50;
      }
      .rpe-btn[data-value='5'],
      .rpe-btn[data-value='6'],
      .rpe-btn[data-value='7'] {
        --rpe-color: #ff9800;
      }
      .rpe-btn[data-value='8'],
      .rpe-btn[data-value='9'],
      .rpe-btn[data-value='10'] {
        --rpe-color: #f44336;
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">Загрузка...</div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Top Navigation -->
    <nav class="top-nav">
      <a href="index.html" class="top-nav-item active">🏋️ Трекер</a>
      <a href="assessment.html" class="top-nav-item">📋 Assessment</a>
      <a href="../dashboard/?client=yaroslav" class="top-nav-item" target="_blank">📊 Дашборд →</a>
    </nav>

    <!-- Header -->
    <header class="app-header">
      <div class="header-row">
        <div class="app-title">
          <span>🏋️</span>
          <span>Fitness Tracker</span>
        </div>
        <button type="button" class="settings-btn" id="settingsBtn">⚙️</button>
      </div>
      <select class="client-selector" id="clientSelector" onchange="selectClient()">
        <option value="">Выберите клиента...</option>
      </select>
    </header>

    <!-- Module Navigation -->
    <nav class="module-nav" id="moduleNav" style="display: none">
      <!-- Tabs will be generated dynamically -->
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Welcome Screen -->
      <div class="module-content active" id="welcomeModule">
        <div class="card">
          <div class="card-title">👋 Добро пожаловать!</div>
          <p style="color: var(--text-secondary); margin-bottom: 16px">
            Выберите клиента для начала работы
          </p>
        </div>
      </div>

      <!-- Workouts Module -->
      <div class="module-content" id="workoutsModule">
        <!-- Will be populated dynamically -->
      </div>

      <!-- Daily Module -->
      <div class="module-content" id="dailyModule">
        <!-- Will be populated dynamically -->
      </div>

      <!-- Nutrition Module -->
      <div class="module-content" id="nutritionModule">
        <!-- Will be populated dynamically -->
      </div>

      <!-- Warmup Module -->
      <div class="module-content" id="warmupModule">
        <!-- Will be populated dynamically -->
      </div>

      <!-- Measurements Module -->
      <div class="module-content" id="measurementsModule">
        <!-- Will be populated dynamically -->
      </div>
    </main>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title">⚙️ Настройки</span>
          <button class="modal-close" onclick="closeSettings()">✕</button>
        </div>
        <div class="form-group" style="margin-bottom: 16px">
          <label class="form-label">API URL</label>
          <input
            type="text"
            class="form-input"
            id="apiUrlInput"
            placeholder="https://script.google.com/..."
          />
        </div>
        <button class="btn btn-primary" onclick="saveSettings()">💾 Сохранить</button>
      </div>
    </div>

    <!-- Workout Details Modal -->
    <div
      class="modal-overlay"
      id="workoutDetailsModal"
      onclick="if (event.target === this) closeWorkoutDetails();"
    >
      <div class="modal modal-large">
        <div class="modal-header">
          <span class="modal-title" id="workoutDetailsTitle">📋 Тренировка</span>
          <button class="modal-close" onclick="closeWorkoutDetails()">✕</button>
        </div>
        <div class="workout-details-content" id="workoutDetailsContent">
          <!-- Заполняется динамически -->
        </div>
      </div>
    </div>

    <script>
      // ═══════════════════════════════════════════════════════════
      // CONFIGURATION
      // ═══════════════════════════════════════════════════════════

      const CONFIG = {
        API_URL: localStorage.getItem('api_url') || '',
        CACHE_TTL: 5 * 60 * 1000, // 5 minutes
      };

      // ═══════════════════════════════════════════════════════════
      // STATE
      // ═══════════════════════════════════════════════════════════

      let clients = [];
      let currentClient = null;
      let clientProfile = {};
      let clientModules = {};
      let clientWeight = 70; // Вес клиента для bodyweight упражнений
      let exercises = [];
      // Группы мышц для отслеживания нагрузки
      const MUSCLE_GROUPS = {
        Грудь: { color: 'chest', group: 'Грудь' },
        Широчайшие: { color: 'back', group: 'Спина' },
        Трапеция: { color: 'back', group: 'Спина' },
        Поясница: { color: 'back', group: 'Спина' },
        'Передняя дельта': { color: 'arms', group: 'Плечи' },
        'Средняя дельта': { color: 'arms', group: 'Плечи' },
        'Задняя дельта': { color: 'arms', group: 'Плечи' },
        Бицепс: { color: 'arms', group: 'Руки' },
        Трицепс: { color: 'arms', group: 'Руки' },
        Квадрицепс: { color: 'legs', group: 'Ноги' },
        'Бицепс бедра': { color: 'legs', group: 'Ноги' },
        Ягодицы: { color: 'legs', group: 'Ноги' },
        Икры: { color: 'legs', group: 'Ноги' },
        Кор: { color: 'core', group: 'Корпус' },
      };

      // Кастомные коэффициенты для текущей тренировки
      let customCoeffs = {};
      let currentEditingExercise = null;

      let activeModule = 'welcome';

      // Module-specific state
      let workoutState = {
        parsedWorkout: null,
        currentSplit: '',
        workoutName: '',
        workoutRPE: 0,
        workoutDate: null,
        viewingSession: null,
        editingSessionId: null,
      };

      let dailyState = {
        todayData: null,
      };

      let nutritionState = {
        todayNutrition: null,
        targets: {},
      };

      let warmupState = {
        exercises: [],
        completed: [],
      };

      // ═══════════════════════════════════════════════════════════
      // INITIALIZATION
      // ═══════════════════════════════════════════════════════════

      document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('settingsBtn').addEventListener('click', openSettings);

        // Supabase: проверка сессии — без входа редирект на login
        if (window.supabase && window.SUPABASE_URL) {
          try {
            const {
              data: { session },
            } = await window.supabase
              .createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY)
              .auth.getSession();
            if (!session) {
              window.location.href =
                '../login.html?redirect=' + encodeURIComponent('tracker/index.html');
              return;
            }
          } catch (e) {
            window.location.href =
              '../login.html?redirect=' + encodeURIComponent('tracker/index.html');
            return;
          }
        }

        await loadClients();

        const lastClient = localStorage.getItem('last_client');
        if (lastClient) {
          document.getElementById('clientSelector').value = lastClient;
          await selectClient();
        }
      });

      // ═══════════════════════════════════════════════════════════
      // API CALLS
      // ═══════════════════════════════════════════════════════════

      async function apiCall(action, params = {}) {
        // Supabase: если есть handler — используем его
        if (window.TrackerSupabase?.hasHandler?.(action)) {
          return window.TrackerSupabase.apiCall(action, params);
        }
        // Fallback: GAS (для parseWorkout, saveNutrition и др.)
        if (!CONFIG.API_URL) {
          throw new Error('API URL не настроен. Supabase не поддерживает действие: ' + action);
        }
        const url = new URL(CONFIG.API_URL);
        url.searchParams.set('action', action);
        Object.entries(params).forEach(([key, value]) => {
          if (value !== undefined && value !== null) {
            url.searchParams.set(key, value);
          }
        });
        const response = await fetch(url.toString());
        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }
        return data;
      }

      // ═══════════════════════════════════════════════════════════
      // CLIENTS
      // ═══════════════════════════════════════════════════════════

      async function loadClients() {
        try {
          showLoading('Загрузка клиентов...');
          const data = await apiCall('getClients');
          clients = data.clients || [];

          const selector = document.getElementById('clientSelector');
          selector.innerHTML =
            '<option value="">Выберите клиента...</option>' +
            clients
              .map((c) => {
                const typeLabel =
                  c.clientType === 'online' ? '🌐' : c.clientType === 'hybrid' ? '🔄' : '🏋️';
                return `<option value="${c.id}">${c.name} ${typeLabel}</option>`;
              })
              .join('');

          hideLoading();
        } catch (error) {
          hideLoading();
          showToast('Ошибка загрузки: ' + error.message, 'error');
        }
      }

      async function selectClient() {
        const clientId = document.getElementById('clientSelector').value;
        if (!clientId) {
          currentClient = null;
          showModule('welcome');
          document.getElementById('moduleNav').style.display = 'none';
          return;
        }

        try {
          showLoading('Загрузка данных клиента...');

          // Load client profile and modules in parallel
          const [profileData, exercisesData] = await Promise.all([
            apiCall('getClientProfile', { clientId }),
            apiCall('getExercises', { clientId }),
          ]);

          currentClient = clients.find((c) => c.id === clientId);
          clientProfile = profileData.profile || {};
          exercises = exercisesData.exercises || [];

          // Получаем последний известный вес клиента для расчёта bodyweight упражнений
          try {
            const dailyData = await apiCall('getLastDailyData', { clientId });
            clientWeight = dailyData?.weight || clientProfile.startWeight || 70; // дефолт 70кг
          } catch (e) {
            clientWeight = clientProfile.startWeight || 70;
          }

          // Extract modules from profile
          clientModules = {
            workouts:
              clientProfile.modules_workouts === true || clientProfile.modules_workouts === 'true',
            nutrition:
              clientProfile.modules_nutrition === true ||
              clientProfile.modules_nutrition === 'true',
            daily: clientProfile.modules_daily === true || clientProfile.modules_daily === 'true',
            warmup:
              clientProfile.modules_warmup === true || clientProfile.modules_warmup === 'true',
            measurements:
              clientProfile.modules_measurements === true ||
              clientProfile.modules_measurements === 'true',
            mandatory:
              clientProfile.modules_mandatory === true ||
              clientProfile.modules_mandatory === 'true',
          };

          // Default modules if none set (backward compatibility)
          if (!Object.values(clientModules).some((v) => v)) {
            const clientType = clientProfile.clientType || 'offline';
            if (clientType === 'online') {
              clientModules = { nutrition: true, daily: true, mandatory: true };
            } else if (clientType === 'offline') {
              clientModules = { workouts: true, mandatory: true };
            } else {
              clientModules = { workouts: true, nutrition: true, daily: true, mandatory: true };
            }
          }

          // Save last client
          localStorage.setItem('last_client', clientId);

          // Render navigation and show first module
          renderModuleNav();

          // Show first available module
          const firstModule = getFirstActiveModule();
          await showModule(firstModule);

          hideLoading();
        } catch (error) {
          hideLoading();
          console.error('Select client error:', error);
          showToast('Ошибка: ' + error.message, 'error');
        }
      }

      function getFirstActiveModule() {
        const moduleOrder = ['workouts', 'daily', 'nutrition', 'warmup', 'measurements'];
        for (const mod of moduleOrder) {
          if (clientModules[mod]) return mod;
        }
        return 'workouts';
      }

      // ═══════════════════════════════════════════════════════════
      // MODULE NAVIGATION
      // ═══════════════════════════════════════════════════════════

      const MODULE_CONFIG = {
        workouts: { icon: '🏋️', label: 'Тренировки' },
        daily: { icon: '📊', label: 'Ежедневное' },
        nutrition: { icon: '🍎', label: 'Питание' },
        warmup: { icon: '🧘', label: 'Разминка' },
        measurements: { icon: '📏', label: 'Замеры' },
      };

      function renderModuleNav() {
        const nav = document.getElementById('moduleNav');
        const isOnline = clientModules.nutrition || clientProfile.clientType === 'online';

        const tabs = Object.entries(MODULE_CONFIG)
          .filter(([key]) => {
            // Для онлайн клиентов скрываем отдельную вкладку "Питание" (она в "Ежедневное")
            if (isOnline && key === 'nutrition') return false;
            return clientModules[key];
          })
          .map(
            ([key, config]) => `
                    <button class="module-tab ${activeModule === key ? 'active' : ''}" 
                            data-module="${key}" 
                            onclick="showModule('${key}')">
                        <span class="icon">${config.icon}</span>
                        <span>${config.label}</span>
                    </button>
                `
          )
          .join('');

        nav.innerHTML = tabs;
        nav.style.display = tabs ? 'flex' : 'none';
      }

      async function showModule(moduleName) {
        // Hide all modules
        document.querySelectorAll('.module-content').forEach((el) => {
          el.classList.remove('active');
        });

        // Update nav
        document.querySelectorAll('.module-tab').forEach((tab) => {
          tab.classList.toggle('active', tab.dataset.module === moduleName);
        });

        activeModule = moduleName;

        // Show and render module
        const moduleEl = document.getElementById(moduleName + 'Module');
        if (moduleEl) {
          moduleEl.classList.add('active');

          // Render module content
          switch (moduleName) {
            case 'workouts':
              await renderWorkoutsModule();
              break;
            case 'daily':
              await renderDailyModule();
              break;
            case 'nutrition':
              await renderNutritionModule();
              break;
            case 'warmup':
              await renderWarmupModule();
              break;
            case 'measurements':
              await renderMeasurementsModule();
              break;
          }
        }
      }

      // ═══════════════════════════════════════════════════════════
      // WORKOUTS MODULE
      // ═══════════════════════════════════════════════════════════

      async function renderWorkoutsModule() {
        const container = document.getElementById('workoutsModule');

        // Load data in parallel
        let recentWorkouts = [];
        let trainingBlock = null;
        let mandatoryTasks = [];

        try {
          showLoading('Загрузка...');

          const [workoutsData, blocksData, tasksData] = await Promise.all([
            apiCall('getRecentSessions', { clientId: currentClient.id, limit: 16 }).catch(() => ({
              sessions: [],
            })),
            apiCall('getTrainingBlocks', { clientId: currentClient.id }).catch(() => ({
              blocks: [],
            })),
            apiCall('getMandatoryTasks', { clientId: currentClient.id }).catch(() => ({
              tasks: [],
            })),
          ]);

          recentWorkouts = workoutsData.sessions || [];

          // Находим активный блок
          const blocks = blocksData.blocks || [];
          trainingBlock = blocks.find((b) => b.status === 'active');

          mandatoryTasks = (tasksData.tasks || []).filter((t) => t.active !== false);

          hideLoading();
        } catch (e) {
          hideLoading();
          console.error('Error loading workout data:', e);
        }

        // ═══════════════════════════════════════════════════════
        // Блок тренировок
        // ═══════════════════════════════════════════════════════
        let blockSection = '';
        if (trainingBlock) {
          const used = trainingBlock.usedSessions || 0;
          const total = trainingBlock.totalSessions || 0;
          const remaining = total - used;
          const isAlmostDone = remaining <= 2;
          const isDone = remaining <= 0;

          blockSection = `
                    <div class="training-block-card ${isDone ? 'completed' : ''}">
                        <div class="block-header">
                            <span class="block-title">📦 Блок ${trainingBlock.blockId || ''}</span>
                            ${
                              isDone
                                ? '<span class="block-badge done">Завершён</span>'
                                : isAlmostDone
                                  ? '<span class="block-badge warning">Заканчивается</span>'
                                  : ''
                            }
                        </div>
                        <div class="block-stats single">
                            <div class="block-stat main">
                                <div class="block-stat-value">${used}/${total}</div>
                                <div class="block-stat-label">Тренировки</div>
                            </div>
                        </div>
                        ${
                          isDone || isAlmostDone
                            ? `
                            <button class="btn btn-accent" onclick="showNewBlockModal()" style="margin-top: 12px;">
                                ➕ Новый блок
                            </button>
                        `
                            : ''
                        }
                    </div>
                `;
        } else {
          // Нет активного блока
          blockSection = `
                    <div class="training-block-card no-block">
                        <div class="block-header">
                            <span class="block-title">📦 Нет активного блока</span>
                        </div>
                        <p style="color: var(--text-secondary); text-align: center; margin: 12px 0;">
                            Создайте новый блок для отслеживания тренировок
                        </p>
                        <button class="btn btn-primary" onclick="showNewBlockModal()">
                            ➕ Создать блок
                        </button>
                    </div>
                `;
        }

        // ═══════════════════════════════════════════════════════
        // Обязательные задачи с чекбоксами
        // ═══════════════════════════════════════════════════════
        let tasksSection = '';
        if (mandatoryTasks.length > 0) {
          tasksSection = `
                    <div class="card">
                        <div class="card-title">✅ Обязательные задачи</div>
                        <div class="mandatory-tasks-list">
                            ${mandatoryTasks
                              .map(
                                (task, idx) => `
                                <div class="mandatory-task-item">
                                    <label class="task-checkbox">
                                        <input type="checkbox" id="task_${task.id || idx}" 
                                               data-task-id="${task.id || idx}"
                                               data-task-name="${task.name}">
                                        <span class="checkmark"></span>
                                    </label>
                                    <div class="task-info">
                                        <span class="task-name">${task.name}</span>
                                        ${task.description ? `<span class="task-desc">${task.description}</span>` : ''}
                                    </div>
                                    <span class="task-target">${task.target || ''}</span>
                                </div>
                            `
                              )
                              .join('')}
                        </div>
                        <button class="btn btn-success" onclick="saveMandatoryTasks()" style="margin-top: 12px;">
                            ✅ Отметить выполненные
                        </button>
                    </div>
                `;
        }

        container.innerHTML = `
                <!-- Training Block Stats -->
                ${blockSection}
                
                <!-- Mandatory Tasks -->
                ${tasksSection}
                
                <!-- Input Card -->
                <div class="card">
                    <div class="card-title">💬 Записать тренировку</div>
                    
                    <div class="input-mode-tabs">
                        <button class="input-mode-tab active" onclick="switchWorkoutInputMode('ai')">
                            ✨ AI
                        </button>
                        <button class="input-mode-tab" onclick="switchWorkoutInputMode('manual')">
                            📝 Вручную
                        </button>
                    </div>
                    
                    <div id="workoutInputContainer">
                        <!-- AI Input -->
                        <div id="aiWorkoutInput">
                            <textarea class="form-input" id="workoutTextInput" 
                                placeholder="Жим лёжа 60×12, 70×10, 80×8
Подтягивания 10, 8, 6 раз
Тяга блока 50 кг 3×12"></textarea>
                            <div class="input-actions">
                                <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">🎤</button>
                                <button class="btn btn-primary" onclick="processWorkoutInput()">
                                    ✨ Распознать
                                </button>
                            </div>
                        </div>
                        
                        <!-- Manual Input (hidden by default) -->
                        <div id="manualWorkoutInput" style="display: none;">
                            <input type="text" class="exercise-search-input" 
                                   placeholder="Поиск упражнения..." 
                                   oninput="filterExercises()">
                            <div class="category-filter" id="categoryFilter"></div>
                            <div class="exercise-list-container" id="exerciseList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Parsed Preview (hidden) -->
                <div class="card" id="workoutPreview" style="display: none;">
                    <div class="card-title">📋 Тренировка</div>
                    <div id="parsedExercises"></div>
                    
                    <!-- Комментарий к тренировке -->
                    <div class="workout-notes-section">
                        <label for="workoutNotesInput" class="notes-label">💬 Комментарий (опционально)</label>
                        <textarea id="workoutNotesInput" class="workout-notes-input" 
                                  placeholder="Как прошла тренировка? Самочувствие, особенности..."
                                  rows="2"></textarea>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveWorkout()">
                        💾 Сохранить
                    </button>
                </div>
                
                <!-- Recent Workouts -->
                <div class="card">
                    <div class="card-title">📅 Последние тренировки</div>
                    <div class="history-list" id="workoutHistory">
                        ${
                          recentWorkouts.length === 0
                            ? '<p style="color: var(--text-secondary); text-align: center;">Нет записей</p>'
                            : (() => {
                                // Вычисляем средний тоннаж для сравнения
                                const volumes = recentWorkouts
                                  .map((w) => w.totalVolume || 0)
                                  .filter((v) => v > 0);
                                const avgVolume =
                                  volumes.length > 0
                                    ? volumes.reduce((a, b) => a + b, 0) / volumes.length
                                    : 0;
                                const VISIBLE_COUNT = 3;

                                const items = recentWorkouts
                                  .map((w, idx) => {
                                    const volume = w.totalVolume || 0;
                                    const volumeText =
                                      volume > 1000
                                        ? (volume / 1000).toFixed(1) + 'т'
                                        : volume.toFixed(0) + 'кг';
                                    const rpeMatch = w.notes
                                      ? w.notes.match(/RPE:\s*(\d+)/i)
                                      : null;
                                    const rpe = rpeMatch ? rpeMatch[1] : null;

                                    // Стрелка: зелёная вниз если ниже среднего, красная вверх если выше
                                    let volumeIndicator = '';
                                    if (volume > 0 && avgVolume > 0) {
                                      if (volume < avgVolume) {
                                        volumeIndicator =
                                          '<span class="volume-arrow down">↓</span>';
                                      } else if (volume > avgVolume) {
                                        volumeIndicator = '<span class="volume-arrow up">↑</span>';
                                      }
                                    }

                                    // Скрываем элементы после первых 3
                                    const hiddenClass =
                                      idx >= VISIBLE_COUNT ? 'history-hidden' : '';

                                    return `
                                    <div class="history-item ${hiddenClass}" onclick="viewWorkout('${w.sessionId}')">
                                        <div class="history-item-content">
                                            <div class="history-name">${w.splitType || 'Тренировка'}</div>
                                            <div class="history-date">${formatDate(w.date)}</div>
                                            ${rpe ? `<div class="history-rpe">🏋️ RPE: ${rpe}</div>` : ''}
                                        </div>
                                        <div class="history-stats">
                                            <div class="history-exercises">${w.exerciseCount || '—'} упр.</div>
                                            ${
                                              volume > 0
                                                ? `
                                                <div class="history-volume">
                                                    ${volumeIndicator}
                                                    <span class="volume-text">${volumeText}</span>
                                                </div>
                                            `
                                                : ''
                                            }
                                        </div>
                                    </div>
                                `;
                                  })
                                  .join('');

                                // Кнопка "Показать ещё" если больше 3 тренировок
                                const expandBtn =
                                  recentWorkouts.length > VISIBLE_COUNT
                                    ? `
                                    <button class="history-expand-btn" id="historyExpandBtn" onclick="toggleHistoryExpand()">
                                        📋 Показать ещё (${recentWorkouts.length - VISIBLE_COUNT})
                                    </button>
                                `
                                    : '';

                                return items + expandBtn;
                              })()
                        }
                    </div>
                </div>
            `;

        renderCategoryFilter();
      }

      // Переключение отображения истории тренировок (3 / 16)
      function toggleHistoryExpand() {
        const container = document.getElementById('workoutHistory');
        const btn = document.getElementById('historyExpandBtn');

        if (!container || !btn) return;

        const isExpanded = container.classList.toggle('expanded');

        if (isExpanded) {
          btn.textContent = '📋 Свернуть';
          btn.classList.add('expanded');
        } else {
          // Подсчитываем скрытые элементы
          const hiddenCount = container.querySelectorAll('.history-hidden').length;
          btn.textContent = `📋 Показать ещё (${hiddenCount})`;
          btn.classList.remove('expanded');
        }
      }

      function calculateTotalVolume(workouts) {
        if (!workouts || workouts.length === 0) return '—';
        const total = workouts.reduce((sum, w) => sum + (w.totalVolume || 0), 0);
        return total > 1000 ? (total / 1000).toFixed(1) + 'т' : total;
      }

      function switchWorkoutInputMode(mode) {
        document.querySelectorAll('.input-mode-tab').forEach((tab) => {
          tab.classList.toggle(
            'active',
            tab.textContent.includes(mode === 'ai' ? 'AI' : 'Вручную')
          );
        });

        document.getElementById('aiWorkoutInput').style.display = mode === 'ai' ? 'block' : 'none';
        document.getElementById('manualWorkoutInput').style.display =
          mode === 'manual' ? 'block' : 'none';

        if (mode === 'manual') {
          renderExerciseList();
        }
      }

      // ═══════════════════════════════════════════════════════════
      // DAILY MODULE
      // ═══════════════════════════════════════════════════════════

      // Текущая выбранная дата для онлайн клиентов
      let selectedDate = new Date().toISOString().split('T')[0];

      async function renderDailyModule() {
        const container = document.getElementById('dailyModule');
        const isOnline = clientModules.nutrition || clientProfile.clientType === 'online';

        // Загружаем последний вес из Daily
        let lastWeight = clientProfile.weight || '—';
        let lastBench = clientProfile.bench_current || 0;
        let lastPullups = clientProfile.pullups_current || 0;

        try {
          const dailyData = await apiCall('getLastDailyData', { clientId: currentClient.id }).catch(
            () => null
          );
          if (dailyData && dailyData.weight) {
            lastWeight = dailyData.weight;
          }
          if (dailyData && dailyData.bench) {
            lastBench = dailyData.bench;
          }
          if (dailyData && dailyData.pullups) {
            lastPullups = dailyData.pullups;
          }
        } catch (e) {
          console.log('Could not load last daily data');
        }

        if (isOnline) {
          // ═══════════════════════════════════════════════════════
          // ONLINE: объединённая страница - дата, вес, сон, питание (КБЖУ)
          // ═══════════════════════════════════════════════════════

          // Получаем targets из профиля
          const targets = {
            calories: clientProfile.targetCalories || 2000,
            protein: clientProfile.targetProtein || 150,
            fats: clientProfile.targetFats || 70,
            carbs: clientProfile.targetCarbs || 200,
          };

          container.innerHTML = `
                    <div class="card">
                        <div class="card-title">📊 Ежедневный отчёт</div>
                        
                        <!-- Выбор даты -->
                        <div class="date-selector-row">
                            <label class="date-label">📅 Дата:</label>
                            <input type="date" class="date-input" id="reportDate" 
                                   value="${selectedDate}" 
                                   max="${new Date().toISOString().split('T')[0]}"
                                   onchange="onDateChange(this.value)">
                        </div>
                        
                        <!-- Вес -->
                        <div class="metric-input-group">
                            <div class="metric-icon">⚖️</div>
                            <div class="metric-input-wrapper">
                                <div class="metric-label">Вес</div>
                                <input type="number" class="metric-input" id="dailyWeight" 
                                       step="0.1" placeholder="${lastWeight}">
                            </div>
                            <div class="metric-unit">кг</div>
                        </div>
                        
                        <!-- Сон -->
                        <div class="sleep-time-row">
                            <div class="metric-input-group compact">
                                <div class="metric-icon">🌙</div>
                                <div class="metric-input-wrapper">
                                    <div class="metric-label">Лёг спать</div>
                                    <input type="time" class="metric-input" id="dailySleepTime" 
                                           onchange="calculateSleepHours()">
                                </div>
                            </div>
                            <div class="metric-input-group compact">
                                <div class="metric-icon">🌅</div>
                                <div class="metric-input-wrapper">
                                    <div class="metric-label">Проснулся</div>
                                    <input type="time" class="metric-input" id="dailyWakeTime"
                                           onchange="calculateSleepHours()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="sleep-result" id="sleepResult" style="display: none;">
                            <span class="sleep-icon">😴</span>
                            <span class="sleep-hours" id="sleepHoursDisplay">0</span>
                            <span class="sleep-label">часов сна</span>
                        </div>
                        
                        <!-- Оценка питания -->
                        <div class="metric-input-group">
                            <div class="metric-icon">🍽️</div>
                            <div class="metric-input-wrapper">
                                <div class="metric-label">Оценка питания</div>
                                <select class="metric-input" id="dailyNutrition">
                                    <option value="">Не указано</option>
                                    <option value="Отлично">Отлично</option>
                                    <option value="Норма">Норма</option>
                                    <option value="Срыв">Срыв</option>
                                </select>
                            </div>
                            <div class="metric-unit"></div>
                        </div>
                        
                        <!-- КБЖУ -->
                        <div class="section-divider">
                            <span>🍎 КБЖУ</span>
                        </div>
                        
                        <div class="macro-grid compact">
                            <div class="macro-card calories">
                                <div class="macro-value" id="nutritionCalories">0</div>
                                <div class="macro-label">Калории</div>
                                <div class="macro-target">/ ${targets.calories}</div>
                            </div>
                            <div class="macro-card protein">
                                <div class="macro-value" id="nutritionProtein">0</div>
                                <div class="macro-label">Белки</div>
                                <div class="macro-target">/ ${targets.protein}г</div>
                            </div>
                            <div class="macro-card fats">
                                <div class="macro-value" id="nutritionFats">0</div>
                                <div class="macro-label">Жиры</div>
                                <div class="macro-target">/ ${targets.fats}г</div>
                            </div>
                            <div class="macro-card carbs">
                                <div class="macro-value" id="nutritionCarbs">0</div>
                                <div class="macro-label">Углеводы</div>
                                <div class="macro-target">/ ${targets.carbs}г</div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 12px;">
                            <input type="number" class="form-input" id="inputCalories" placeholder="Калории">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="number" class="form-input" id="inputProtein" placeholder="Белки (г)">
                            </div>
                            <div class="form-group">
                                <input type="number" class="form-input" id="inputFats" placeholder="Жиры (г)">
                            </div>
                            <div class="form-group">
                                <input type="number" class="form-input" id="inputCarbs" placeholder="Углеводы (г)">
                            </div>
                        </div>
                        
                        <!-- Прогресс -->
                        ${
                          clientProfile.goal_pullups || clientProfile.goal_bench
                            ? `
                        <div class="section-divider">
                            <span>🎯 Контроль прогресса</span>
                        </div>
                        
                        ${
                          clientProfile.goal_pullups
                            ? `
                        <div class="progress-metric inline">
                            <span class="progress-label">💪 Подтягивания (${lastPullups} → ${clientProfile.goal_pullups})</span>
                            <div class="progress-input-inline">
                                <input type="number" class="metric-input small" id="dailyPullups" placeholder="MAX">
                                <span class="metric-unit">раз</span>
                            </div>
                        </div>
                        `
                            : ''
                        }
                        
                        ${
                          clientProfile.goal_bench
                            ? `
                        <div class="progress-metric inline">
                            <span class="progress-label">🏋️ Жим лёжа (${lastBench} → ${clientProfile.goal_bench} кг)</span>
                            <div class="progress-input-inline">
                                <input type="number" class="metric-input small" id="dailyBench" placeholder="Вес" step="2.5">
                                <span class="metric-unit">кг</span>
                            </div>
                        </div>
                        `
                            : ''
                        }
                        `
                            : ''
                        }
                        
                        <!-- Кнопка сохранения -->
                        <button class="btn btn-primary btn-large" onclick="saveAllDailyData()">
                            💾 Сохранить всё
                        </button>
                    </div>
                    
                    ${
                      clientProfile.targetWeight
                        ? `
                    <div class="card">
                        <div class="card-title">📈 Прогресс к цели</div>
                        <div class="weight-progress">
                            <span class="current">${lastWeight} кг</span>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${calculateWeightProgress(lastWeight)}%"></div>
                            </div>
                            <span class="target">${clientProfile.targetWeight} кг</span>
                        </div>
                    </div>
                    `
                        : ''
                    }
                `;
        } else {
          // ═══════════════════════════════════════════════════════
          // OFFLINE: только вес и сон
          // ═══════════════════════════════════════════════════════
          container.innerHTML = `
                    <div class="card">
                        <div class="card-title">📊 Сегодня: ${formatDate(today)}</div>
                        
                        <div class="metric-input-group">
                            <div class="metric-icon">⚖️</div>
                            <div class="metric-input-wrapper">
                                <div class="metric-label">Вес</div>
                                <input type="number" class="metric-input" id="dailyWeight" 
                                       step="0.1" placeholder="${clientProfile.weight || '—'}">
                            </div>
                            <div class="metric-unit">кг</div>
                        </div>
                        
                        <div class="metric-input-group">
                            <div class="metric-icon">😴</div>
                            <div class="metric-input-wrapper">
                                <div class="metric-label">Сон</div>
                                <input type="number" class="metric-input" id="dailySleep" 
                                       step="0.5" placeholder="7.5">
                            </div>
                            <div class="metric-unit">ч</div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveDailyData()">
                            💾 Сохранить
                        </button>
                    </div>
                `;
        }
      }

      function calculateSleepHours() {
        const sleepTime = document.getElementById('dailySleepTime')?.value;
        const wakeTime = document.getElementById('dailyWakeTime')?.value;
        const resultEl = document.getElementById('sleepResult');
        const displayEl = document.getElementById('sleepHoursDisplay');

        if (!sleepTime || !wakeTime || !resultEl) return;

        // Парсим время
        const [sleepH, sleepM] = sleepTime.split(':').map(Number);
        const [wakeH, wakeM] = wakeTime.split(':').map(Number);

        let sleepMinutes = sleepH * 60 + sleepM;
        let wakeMinutes = wakeH * 60 + wakeM;

        // Если время пробуждения меньше времени засыпания, значит проснулся на следующий день
        if (wakeMinutes <= sleepMinutes) {
          wakeMinutes += 24 * 60;
        }

        const totalMinutes = wakeMinutes - sleepMinutes;
        const hours = (totalMinutes / 60).toFixed(1);

        displayEl.textContent = hours;
        resultEl.style.display = 'flex';

        // Цвет в зависимости от количества сна
        if (hours >= 7) {
          resultEl.className = 'sleep-result good';
        } else if (hours >= 5) {
          resultEl.className = 'sleep-result warning';
        } else {
          resultEl.className = 'sleep-result bad';
        }
      }

      function calculateWeightProgress(currentWeight) {
        const current = parseFloat(currentWeight) || parseFloat(clientProfile.weight);
        const target = parseFloat(clientProfile.targetWeight);
        const start = parseFloat(clientProfile.startWeight) || current;

        if (!current || !target) return 0;
        if (start === target) return 100;

        const progress = ((start - current) / (start - target)) * 100;
        return Math.min(100, Math.max(0, progress));
      }

      // Функции для работы с датой
      function onDateChange(value) {
        const today = new Date().toISOString().split('T')[0];
        if (value > today) {
          selectedDate = today;
        } else {
          selectedDate = value;
        }
        renderDailyModule();
      }

      function formatDateShort(dateStr) {
        const date = new Date(dateStr);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (dateStr === today.toISOString().split('T')[0]) {
          return 'сегодня';
        } else if (dateStr === yesterday.toISOString().split('T')[0]) {
          return 'вчера';
        }
        return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
      }

      // Сохранение всех данных одной кнопкой
      async function saveAllDailyData() {
        const isOnline = clientModules.nutrition || clientProfile.clientType === 'online';

        // Собираем все данные
        const weight = document.getElementById('dailyWeight')?.value;
        const sleepTime = document.getElementById('dailySleepTime')?.value;
        const wakeTime = document.getElementById('dailyWakeTime')?.value;
        const nutrition = document.getElementById('dailyNutrition')?.value;
        const pullups = document.getElementById('dailyPullups')?.value;
        const bench = document.getElementById('dailyBench')?.value;

        const calories = document.getElementById('inputCalories')?.value;
        const protein = document.getElementById('inputProtein')?.value;
        const fats = document.getElementById('inputFats')?.value;
        const carbs = document.getElementById('inputCarbs')?.value;

        // Вычисляем часы сна
        let sleepHours = null;
        if (sleepTime && wakeTime) {
          const [sleepH, sleepM] = sleepTime.split(':').map(Number);
          const [wakeH, wakeM] = wakeTime.split(':').map(Number);
          let sleepMinutes = sleepH * 60 + sleepM;
          let wakeMinutes = wakeH * 60 + wakeM;
          if (wakeMinutes <= sleepMinutes) wakeMinutes += 24 * 60;
          sleepHours = ((wakeMinutes - sleepMinutes) / 60).toFixed(1);
        }

        // Проверяем что есть хоть какие-то данные
        const hasDailyData = weight || sleepHours || nutrition || pullups || bench;
        const hasNutritionData = calories || protein || fats || carbs;

        if (!hasDailyData && !hasNutritionData) {
          showToast('Заполните хотя бы одно поле', 'error');
          return;
        }

        try {
          showLoading('Сохранение...');

          const promises = [];

          // Сохраняем daily data
          if (hasDailyData) {
            promises.push(
              apiCall('saveDailyData', {
                clientId: currentClient.id,
                date: selectedDate,
                weight: weight || null,
                sleepHours: sleepHours || null,
                wakeTime: wakeTime || null,
                sleepTime: sleepTime || null,
                nutrition: nutrition || null,
                pullups: pullups || null,
                bench: bench || null,
              })
            );
          }

          // Сохраняем КБЖУ
          if (hasNutritionData) {
            promises.push(
              apiCall('saveNutrition', {
                clientId: currentClient.id,
                date: selectedDate,
                calories: calories || 0,
                protein: protein || 0,
                fats: fats || 0,
                carbs: carbs || 0,
              })
            );
          }

          await Promise.all(promises);

          hideLoading();
          showToast('✅ Данные сохранены!', 'success');

          // Очищаем поля КБЖУ
          if (hasNutritionData) {
            document.getElementById('inputCalories').value = '';
            document.getElementById('inputProtein').value = '';
            document.getElementById('inputFats').value = '';
            document.getElementById('inputCarbs').value = '';
          }
        } catch (error) {
          hideLoading();
          showToast('Ошибка: ' + error.message, 'error');
        }
      }

      async function saveDailyData() {
        const isOnline = clientModules.nutrition || clientProfile.clientType === 'online';

        const weight = document.getElementById('dailyWeight')?.value;

        let sleepHours = null;
        let wakeTime = null;
        let sleepTime = null;
        let nutrition = null;
        let pullups = null;
        let bench = null;

        if (isOnline) {
          sleepTime = document.getElementById('dailySleepTime')?.value;
          wakeTime = document.getElementById('dailyWakeTime')?.value;
          nutrition = document.getElementById('dailyNutrition')?.value;
          pullups = document.getElementById('dailyPullups')?.value;
          bench = document.getElementById('dailyBench')?.value;

          // Вычисляем часы сна
          if (sleepTime && wakeTime) {
            const [sleepH, sleepM] = sleepTime.split(':').map(Number);
            const [wakeH, wakeM] = wakeTime.split(':').map(Number);
            let sleepMinutes = sleepH * 60 + sleepM;
            let wakeMinutes = wakeH * 60 + wakeM;
            if (wakeMinutes <= sleepMinutes) wakeMinutes += 24 * 60;
            sleepHours = ((wakeMinutes - sleepMinutes) / 60).toFixed(1);
          }
        } else {
          sleepHours = document.getElementById('dailySleep')?.value;
        }

        if (!weight && !sleepHours && !nutrition && !pullups && !bench) {
          showToast('Заполните хотя бы одно поле', 'error');
          return;
        }

        try {
          showLoading('Сохранение...');

          await apiCall('saveDailyData', {
            clientId: currentClient.id,
            date: selectedDate,
            weight: weight || null,
            sleepHours: sleepHours || null,
            wakeTime: wakeTime || null,
            sleepTime: sleepTime || null,
            nutrition: nutrition || null,
            pullups: pullups || null,
            bench: bench || null,
          });

          hideLoading();
          showToast('✅ Сохранено!', 'success');
        } catch (error) {
          hideLoading();
          showToast('Ошибка: ' + error.message, 'error');
        }
      }

      async function saveMandatoryTasks() {
        const checkboxes = document.querySelectorAll('.task-checkbox input:checked');

        if (checkboxes.length === 0) {
          showToast('Отметьте выполненные задачи', 'warning');
          return;
        }

        const completedTasks = [];
        checkboxes.forEach((cb) => {
          completedTasks.push({
            taskId: cb.dataset.taskId,
            taskName: cb.dataset.taskName,
          });
        });

        try {
          showLoading('Сохранение...');

          await apiCall('saveMandatoryTaskLog', {
            clientId: currentClient.id,
            date: new Date().toISOString().split('T')[0],
            tasks: completedTasks,
          });

          hideLoading();
          showToast(`✅ Отмечено ${completedTasks.length} задач`, 'success');

          // Визуально отмечаем как выполненные
          checkboxes.forEach((cb) => {
            cb.closest('.mandatory-task-item').classList.add('completed');
          });
        } catch (error) {
          hideLoading();
          showToast('Ошибка: ' + error.message, 'error');
        }
      }

      // ═══════════════════════════════════════════════════════════
      // NUTRITION MODULE
      // ═══════════════════════════════════════════════════════════

      async function renderNutritionModule() {
        const container = document.getElementById('nutritionModule');

        // Get targets from profile or defaults
        const targets = {
          calories: clientProfile.targetCalories || 2000,
          protein: clientProfile.targetProtein || 150,
          fats: clientProfile.targetFats || 70,
          carbs: clientProfile.targetCarbs || 200,
        };

        container.innerHTML = `
                <div class="card">
                    <div class="card-title">🍎 Питание сегодня</div>
                    
                    <div class="macro-grid">
                        <div class="macro-card calories">
                            <div class="macro-value" id="nutritionCalories">0</div>
                            <div class="macro-label">Калории</div>
                            <div class="macro-target">/ ${targets.calories}</div>
                        </div>
                        <div class="macro-card protein">
                            <div class="macro-value" id="nutritionProtein">0</div>
                            <div class="macro-label">Белки</div>
                            <div class="macro-target">/ ${targets.protein}г</div>
                        </div>
                        <div class="macro-card fats">
                            <div class="macro-value" id="nutritionFats">0</div>
                            <div class="macro-label">Жиры</div>
                            <div class="macro-target">/ ${targets.fats}г</div>
                        </div>
                        <div class="macro-card carbs">
                            <div class="macro-value" id="nutritionCarbs">0</div>
                            <div class="macro-label">Углеводы</div>
                            <div class="macro-target">/ ${targets.carbs}г</div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 12px;">
                        <input type="number" class="form-input" id="inputCalories" placeholder="Калории">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="number" class="form-input" id="inputProtein" placeholder="Белки (г)">
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-input" id="inputFats" placeholder="Жиры (г)">
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-input" id="inputCarbs" placeholder="Углеводы (г)">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveNutrition()">
                        ➕ Добавить приём пищи
                    </button>
                </div>
            `;
      }

      async function saveNutrition() {
        const calories = document.getElementById('inputCalories').value;
        const protein = document.getElementById('inputProtein').value;
        const fats = document.getElementById('inputFats').value;
        const carbs = document.getElementById('inputCarbs').value;

        if (!calories && !protein) {
          showToast('Укажите калории или белки', 'error');
          return;
        }

        try {
          showLoading('Сохранение...');

          await apiCall('saveNutrition', {
            clientId: currentClient.id,
            date: new Date().toISOString().split('T')[0],
            calories: calories || 0,
            protein: protein || 0,
            fats: fats || 0,
            carbs: carbs || 0,
          });

          hideLoading();
          showToast('✅ Добавлено!', 'success');

          // Clear inputs
          document.getElementById('inputCalories').value = '';
          document.getElementById('inputProtein').value = '';
          document.getElementById('inputFats').value = '';
          document.getElementById('inputCarbs').value = '';

          // Refresh module
          await renderNutritionModule();
        } catch (error) {
          hideLoading();
          showToast('Ошибка: ' + error.message, 'error');
        }
      }

      // ═══════════════════════════════════════════════════════════
      // WARMUP MODULE
      // ═══════════════════════════════════════════════════════════

      async function renderWarmupModule() {
        const container = document.getElementById('warmupModule');

        // Default warmup exercises (can be customized per client)
        const warmupExercises = [
          { id: 1, name: 'Планка', duration: 60, unit: 'сек' },
          { id: 2, name: 'Приседания', reps: 20, unit: 'раз' },
          { id: 3, name: 'Наклоны', reps: 15, unit: 'раз' },
          { id: 4, name: 'Мост', duration: 30, unit: 'сек' },
          { id: 5, name: 'Выпады', reps: 10, unit: 'на ногу' },
        ];

        warmupState.exercises = warmupExercises;
        warmupState.completed = [];

        const completedCount = warmupState.completed.length;
        const totalCount = warmupExercises.length;
        const isComplete = completedCount === totalCount;

        container.innerHTML = `
                <div class="warmup-progress">
                    <div class="warmup-progress-circle ${isComplete ? 'complete' : ''}">
                        ${completedCount}/${totalCount}
                    </div>
                    <div style="color: var(--text-secondary);">
                        ${isComplete ? '🎉 Разминка выполнена!' : 'Выполните все упражнения'}
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">🧘 Утренняя разминка</div>
                    
                    ${warmupExercises
                      .map(
                        (ex) => `
                        <div class="warmup-exercise" id="warmup-${ex.id}">
                            <button class="warmup-checkbox ${warmupState.completed.includes(ex.id) ? 'checked' : ''}" 
                                    onclick="toggleWarmup(${ex.id})">
                                ✓
                            </button>
                            <div class="warmup-info">
                                <div class="warmup-name">${ex.name}</div>
                                <div class="warmup-detail">
                                    ${ex.duration ? ex.duration + ' ' + ex.unit : ex.reps + ' ' + ex.unit}
                                </div>
                            </div>
                        </div>
                    `
                      )
                      .join('')}
                    
                    <button class="btn btn-success" onclick="saveWarmup()" 
                            ${!isComplete ? 'disabled style="opacity: 0.5;"' : ''}>
                        💾 Сохранить разминку
                    </button>
                </div>
            `;
      }

      function toggleWarmup(exerciseId) {
        const idx = warmupState.completed.indexOf(exerciseId);
        if (idx > -1) {
          warmupState.completed.splice(idx, 1);
        } else {
          warmupState.completed.push(exerciseId);
        }
        renderWarmupModule();
      }

      async function saveWarmup() {
        try {
          showLoading('Сохранение...');

          await apiCall('saveWarmup', {
            clientId: currentClient.id,
            date: new Date().toISOString().split('T')[0],
            completed: true,
            exercises: warmupState.completed.join(','),
            duration: warmupState.exercises.reduce((sum, ex) => sum + (ex.duration || 0), 0),
          });

          hideLoading();
          showToast('🧘 Разминка сохранена!', 'success');
        } catch (error) {
          hideLoading();
          showToast('Ошибка: ' + error.message, 'error');
        }
      }

      // ═══════════════════════════════════════════════════════════
      // MEASUREMENTS MODULE
      // ═══════════════════════════════════════════════════════════

      async function renderMeasurementsModule() {
        const container = document.getElementById('measurementsModule');

        container.innerHTML = `
                <div class="card">
                    <div class="card-title">📏 Замеры тела</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Грудь (см)</label>
                            <input type="number" class="form-input" id="measureChest" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Талия (см)</label>
                            <input type="number" class="form-input" id="measureWaist" placeholder="80">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Бёдра (см)</label>
                            <input type="number" class="form-input" id="measureHips" placeholder="95">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Бицепс (см)</label>
                            <input type="number" class="form-input" id="measureBicep" placeholder="35">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Бедро (см)</label>
                            <input type="number" class="form-input" id="measureThigh" placeholder="55">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Икра (см)</label>
                            <input type="number" class="form-input" id="measureCalf" placeholder="38">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveMeasurements()">
                        💾 Сохранить замеры
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-title">📸 Фото прогресса</div>
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">
                        Скоро: загрузка фото
                    </p>
                </div>
            `;
      }

      async function saveMeasurements() {
        const measurements = {
          chest: document.getElementById('measureChest').value,
          waist: document.getElementById('measureWaist').value,
          hips: document.getElementById('measureHips').value,
          bicep: document.getElementById('measureBicep').value,
          thigh: document.getElementById('measureThigh').value,
          calf: document.getElementById('measureCalf').value,
        };

        const hasValue = Object.values(measurements).some((v) => v);
        if (!hasValue) {
          showToast('Заполните хотя бы одно поле', 'error');
          return;
        }

        try {
          showLoading('Сохранение...');

          await apiCall('saveMeasurements', {
            clientId: currentClient.id,
            date: new Date().toISOString().split('T')[0],
            ...measurements,
          });

          hideLoading();
          showToast('📏 Замеры сохранены!', 'success');
        } catch (error) {
          hideLoading();
          showToast('Ошибка: ' + error.message, 'error');
        }
      }

      // ═══════════════════════════════════════════════════════════
      // WORKOUT INPUT (AI & Manual)
      // ═══════════════════════════════════════════════════════════

      async function processWorkoutInput() {
        let text = document.getElementById('workoutTextInput').value.trim();
        if (!text) {
          showToast('Введите текст тренировки', 'error');
          return;
        }
        // Нормализация опечаток: "2 прохода" → "2 подхода"
        text = text.replace(/(\d+)\s*проход(?:а|ов)?/gi, '$1 подхода');

        // Сначала пробуем локальный парсер
        const localResult = parseWorkoutLocal(text);
        const localCount = localResult.exercises ? localResult.exercises.length : 0;

        // Считаем сколько строк во входном тексте
        const lineCount = text.split(/\n/).filter((l) => l.trim()).length;

        console.log(`Local parser: ${localCount}/${lineCount} exercises`);

        // Сохраняем текущее название тренировки
        const currentName =
          document.getElementById('workoutNameInput')?.value || workoutState.workoutName || '';

        // Функция для добавления упражнений (не замены!)
        const appendExercises = (newResult) => {
          const enriched = enrichParsedWorkout(newResult);
          if (!workoutState.parsedWorkout || !workoutState.parsedWorkout.exercises) {
            workoutState.parsedWorkout = enriched;
          } else {
            // Добавляем к существующим
            workoutState.parsedWorkout.exercises = [
              ...workoutState.parsedWorkout.exercises,
              ...enriched.exercises,
            ];
          }
          // Восстанавливаем название
          workoutState.workoutName = currentName;
        };

        // Если локальный парсер распознал все строки - используем его
        if (localCount >= lineCount) {
          appendExercises(localResult);
          renderWorkoutPreview();
          showToast(`Добавлено ${localCount} упражнений`, 'success');
          // Очищаем поле ввода
          document.getElementById('workoutTextInput').value = '';
          return;
        }

        // Иначе пробуем AI
        try {
          showLoading('Распознавание...');

          const aiResult = await apiCall('parseWorkout', {
            clientId: currentClient.id,
            text: text,
          });

          hideLoading();

          const aiCount = aiResult.success && aiResult.exercises ? aiResult.exercises.length : 0;
          console.log(`AI parser: ${aiCount}/${lineCount} exercises`);

          // Берём лучший результат
          if (aiCount > localCount) {
            appendExercises(aiResult);
            showToast(`Добавлено ${aiCount} упражнений`, 'success');
          } else {
            appendExercises(localResult);
            showToast(`Добавлено ${localCount} упражнений`, 'success');
          }

          renderWorkoutPreview();
          // Очищаем поле ввода
          document.getElementById('workoutTextInput').value = '';
        } catch (error) {
          hideLoading();
          // При ошибке AI используем локальный результат
          appendExercises(localResult);
          if (localCount > 0) {
            renderWorkoutPreview();
            showToast(`Добавлено ${localCount} упражнений`, 'success');
            document.getElementById('workoutTextInput').value = '';
          } else {
            showToast('Не удалось распознать', 'error');
          }
        }
      }

      // Позиции, которые могут быть в названии в скобках — переносим в поле «Позиция»
      const KNOWN_POSITIONS = [
        'в висе',
        'на перекладине',
        'в упоре',
        'на брусьях',
        'сидя',
        'стоя',
        'лёжа',
        'в наклоне',
        'на скамье',
        'наклонная',
      ];

      function extractPositionFromName(ex) {
        if (!ex.name || ex.position) return ex;
        const m = ex.name.match(/\s+\(([^)]+)\)\s*$/);
        if (!m) return ex;
        const pos = m[1].trim().toLowerCase().replace(/ё/g, 'е');
        if (KNOWN_POSITIONS.some((p) => pos === p || pos.includes(p) || p.includes(pos))) {
          return {
            ...ex,
            name: ex.name.replace(/\s*\([^)]+\)\s*$/, '').trim(),
            position: ex.position || m[1].trim(),
          };
        }
        return ex;
      }

      // Канонические упражнения с жёсткой привязкой (обход неоднозначного getExerciseFromDB)
      const CANONICAL_EXERCISE_OVERRIDES = [
        {
          match: (n) =>
            n.includes('отведение плеча') && n.includes('тренажер') && !n.includes('гантели назад'),
          name: 'Отведение плеча в тренажере',
          category: 'Плечи',
          coeffs: { 'Средняя дельта': 0.5, 'Передняя дельта': 0.25, 'Задняя дельта': 0.25 },
        },
      ];

      // Обогащение распарсенных упражнений данными из базы
      function enrichParsedWorkout(result) {
        if (!result || !result.exercises) return result;

        result.exercises = result.exercises.map((ex) => {
          const nameNorm = (ex.name || '').toLowerCase().replace(/ё/g, 'е');

          // Жёсткий override для известных паттернов — до любых DB-запросов
          for (const ov of CANONICAL_EXERCISE_OVERRIDES) {
            if (ov.match(nameNorm)) {
              const isUnilateralByText =
                /с одной ног|на каждую|поочерёдно|поочередно|одной рук|каждую рук|односторонн/.test(
                  nameNorm
                );
              return extractPositionFromName({
                ...ex,
                name: ov.name,
                category: ov.category,
                laterality: 'bilateral',
                unilateral: isUnilateralByText || ex.unilateral || false,
                equipment: ex.equipment || '',
                position: ex.position || '',
              });
            }
          }

          const dbEx = getExerciseFromDB(ex.name || '');

          // Автоопределение унилатеральности по тексту
          const nameLower = ex.name.toLowerCase();
          const isUnilateralByText =
            /с одной ног|на каждую|поочерёдно|поочередно|одной рук|каждую рук|односторонн/.test(
              nameLower
            );

          if (dbEx) {
            // Для canBeUnilateral - включаем если есть признаки в тексте
            const shouldBeUnilateral =
              dbEx.laterality === 'alwaysUnilateral' ||
              (dbEx.laterality === 'canBeUnilateral' && isUnilateralByText) ||
              ex.unilateral;

            // Название из базы; если в нём есть позиция в скобках — переносим в поле Позиция
            return extractPositionFromName({
              ...ex,
              name: dbEx.name,
              category: dbEx.category || ex.category || 'Другое',
              laterality: dbEx.laterality || 'bilateral',
              unilateral: shouldBeUnilateral,
              equipment: ex.equipment || '',
              position: ex.position || '',
            });
          }

          // Если не в базе - используем AI для определения категории
          const aiResult = aiGuessCoeffs(ex.name);

          return extractPositionFromName({
            ...ex,
            category: aiResult.category || ex.category || 'Другое',
            laterality: 'bilateral',
            unilateral: isUnilateralByText || ex.unilateral || false,
            equipment: ex.equipment || '',
            position: ex.position || '',
          });
        });

        return result;
      }

      function parseWorkoutLocal(text) {
        const result = { exercises: [] };
        // Разбиваем по строкам или по новому упражнению
        const lines = text.split(/\n/).filter((l) => l.trim());

        for (const line of lines) {
          const exercise = parseExerciseLine(line);
          if (exercise) {
            result.exercises.push(exercise);
          }
        }

        return result;
      }

      function parseExerciseLine(line) {
        line = line.trim().replace(/^[-•]\s*/, '');
        if (!line || line.length < 3) return null;

        // Применяем контекстные правила (например "сгибание ног в висе" → "подъём ног в висе")
        line = applyContextRules(line);

        // Normalize: число×число, число*число, числохчисло (Cyrillic х между цифрами) → числоxчисло
        line = line
          .replace(/×/g, 'x')
          .replace(/(\d)[хХ](\d)/g, '$1x$2') // 20х12 → 20x12
          .replace(/(\d)\s*\*\s*(\d)/g, '$1x$2')
          .replace(/(\d)\s*[xх×]\s*(\d)/gi, '$1x$2')
          .replace(/\s+/g, ' ');

        let sets = [];
        let exerciseName = '';
        let equipment = '';
        let position = '';

        // Извлекаем инвентарь (гриф, штанга, гантели, тренажер и т.д.)
        const equipmentPatterns = [
          { pattern: /гантел[а-яё]*/i, value: 'гантели' },
          { pattern: /штанг[а-яё]*/i, value: 'штанга' },
          { pattern: /гир[яеи][а-яё]*/i, value: 'гиря' },
          { pattern: /тренажер[а-яё]*/i, value: 'тренажер' },
          { pattern: /блоч?н[а-яё]*/i, value: 'тренажер' },
          { pattern: /блок[еуа]?/i, value: 'блок' },
          { pattern: /резин[а-яё]*/i, value: 'резина' },
          { pattern: /(z|ez)\s*гриф[а-яё]*/i, value: 'штанга' },
          { pattern: /с\s+грифом/i, value: 'штанга' },
          { pattern: /грифом/i, value: 'штанга' },
          { pattern: /гриф[а-яё]*/i, value: 'штанга' },
          { pattern: /тумб[уыеа]|бокс[а-яё]*/i, value: 'тумба' },
          { pattern: /перекладин[а-яё]*/i, value: 'перекладина' },
        ];

        for (const ep of equipmentPatterns) {
          if (ep.pattern.test(line)) {
            equipment = ep.value;
            break;
          }
        }

        // Извлекаем позицию (только позиции ТЕЛА!)
        // Порядок важен: более специфичные — выше (наклонная скамья ДО лёжа)
        const positionPatterns = [
          // Позиции на скамье (до лёжа — иначе "лежа" перехватит "на наклонной скамье")
          { pattern: /на\s+наклонн[а-яё]*\s+скамь[а-яё]*/i, value: 'наклонная' },
          { pattern: /наклонн[а-яё]*\s+скамь[а-яё]*/i, value: 'наклонная' },
          { pattern: /в\s+наклонн[а-яё]*/i, value: 'наклонная' },
          { pattern: /наклонн[а-яё]*/i, value: 'наклонная' },
          { pattern: /на\s+скамье/i, value: 'на скамье' },
          // Позиции тела
          { pattern: /сидя/i, value: 'сидя' },
          { pattern: /стоя/i, value: 'стоя' },
          { pattern: /л[её]жа/i, value: 'лёжа' },
          { pattern: /в\s*наклоне/i, value: 'в наклоне' },
          { pattern: /в\s+упоре/i, value: 'в упоре' },
          { pattern: /с\s+упором/i, value: 'с упором' },
          { pattern: /в\s+висе/i, value: 'в висе' },
        ];

        for (const pp of positionPatterns) {
          if (pp.pattern.test(line)) {
            position = pp.value;
            break;
          }
        }

        // Определяем унилатеральность по оригинальному тексту (ДО очистки)
        const unilateralByText =
          /одной\s+рук|одной\s+ног|на\s+каждую|поочер[её]дно|односторонн|по\s+одной/i.test(line);

        // ═══════════════════════════════════════════════════════════
        // НОВЫЙ Pattern: "по N раз с X кг, M подходов"
        // Пример: "Жим лежа по 8 раз с 40 кг, 3 подхода"
        // ═══════════════════════════════════════════════════════════
        const patternPoRaz = line.match(
          /^(.+?)\s+по\s+(\d+)\s*раз[а-яё]*\s+с\s+(\d+(?:[.,]\d+)?)\s*(?:кг)?\s*[,.]?\s*(\d+)\s*подход/i
        );
        if (patternPoRaz) {
          exerciseName = cleanExerciseName(patternPoRaz[1]);
          const reps = parseInt(patternPoRaz[2]);
          const weight = parseFloat(patternPoRaz[3].replace(',', '.'));
          const numSets = parseInt(patternPoRaz[4]);

          for (let i = 0; i < numSets; i++) {
            sets.push({ weight, reps });
          }
          if (sets.length > 0) {
            return {
              name: exerciseName,
              sets,
              category: 'Другое',
              equipment,
              position,
              unilateral: unilateralByText,
            };
          }
        }

        // ═══════════════════════════════════════════════════════════
        // НОВЫЙ Pattern: "N раз(а) по M раз на каждую ногу/руку"
        // Пример: "Запрыгивание на тумбу с одной ноги 2 раза по 5 раз на каждую ногу"
        // ═══════════════════════════════════════════════════════════
        const patternEachLeg = line.match(
          /^(.+?)\s+(\d+)\s*раз[а-яё]*\s+по\s+(\d+)\s*раз[а-яё]*\s+на\s+кажд/i
        );
        if (patternEachLeg) {
          exerciseName = cleanExerciseName(patternEachLeg[1]);
          const numSets = parseInt(patternEachLeg[2]);
          const reps = parseInt(patternEachLeg[3]);

          for (let i = 0; i < numSets; i++) {
            sets.push({ weight: 0, reps });
          }
          if (sets.length > 0) {
            return {
              name: exerciseName,
              sets,
              category: 'Другое',
              equipment,
              position,
              unilateral: true,
            };
          }
        }

        // ═══════════════════════════════════════════════════════════
        // НОВЫЙ Pattern: "по N/M/K раз с гантелями по X/Y/Z кг"
        // Пример: "Сгибание на бицепс сидя по 12/10/8 раз с гантелями по 10/10/7,5 кг"
        // ═══════════════════════════════════════════════════════════
        const patternWithEquipment = line.match(
          /^(.+?)\s+по\s+(\d+(?:\s*\/\s*\d+)+)\s*раз[а-яё]*\s+с\s+(?:гантел[а-яё]*|штанг[а-яё]*|гир[а-яё]*)\s+(?:по\s+)?(\d+(?:[.,]\d+)?(?:\s*\/\s*\d+(?:[.,]\d+)?)*)\s*кг/i
        );
        if (patternWithEquipment) {
          exerciseName = cleanExerciseName(patternWithEquipment[1]);
          const repsArr = patternWithEquipment[2].split(/\s*\/\s*/).map((r) => parseInt(r));
          const weightsArr = patternWithEquipment[3]
            .split(/\s*\/\s*/)
            .map((w) => parseFloat(w.replace(',', '.')));

          const count = Math.max(repsArr.length, weightsArr.length);
          for (let i = 0; i < count; i++) {
            sets.push({
              weight: weightsArr[i] || weightsArr[weightsArr.length - 1] || 0,
              reps: repsArr[i] || repsArr[repsArr.length - 1] || 0,
            });
          }
          if (sets.length > 0) {
            return {
              name: exerciseName,
              sets,
              category: 'Другое',
              equipment,
              position,
              unilateral: unilateralByText,
            };
          }
        }

        // ═══════════════════════════════════════════════════════════
        // НОВЫЙ Pattern: "по N/M/K раз с X/Y/Z кг" или "с X/Y/Z гантелей"
        // Пример: "Сгибание на бицепс сидя по 12/10/8 раз с 10/10/7,5 гантелей"
        // ═══════════════════════════════════════════════════════════
        const patternSlashReps = line.match(
          /^(.+?)\s+по\s+(\d+(?:\s*\/\s*\d+)+)\s*раз[а-яё]*\s+с\s+(\d+(?:[.,]\d+)?(?:\s*\/\s*\d+(?:[.,]\d+)?)*)/i
        );
        if (patternSlashReps) {
          exerciseName = cleanExerciseName(patternSlashReps[1]);
          const repsArr = patternSlashReps[2].split(/\s*\/\s*/).map((r) => parseInt(r));
          const weightsArr = patternSlashReps[3]
            .split(/\s*\/\s*/)
            .map((w) => parseFloat(w.replace(',', '.')));

          const count = Math.max(repsArr.length, weightsArr.length);
          for (let i = 0; i < count; i++) {
            sets.push({
              weight: weightsArr[i] || weightsArr[weightsArr.length - 1] || 0,
              reps: repsArr[i] || repsArr[repsArr.length - 1] || 0,
            });
          }
          if (sets.length > 0) {
            return {
              name: exerciseName,
              sets,
              category: 'Другое',
              equipment,
              position,
              unilateral: unilateralByText,
            };
          }
        }

        // ═══════════════════════════════════════════════════════════
        // Pattern 1: "30/50/40 кг на 12/8/10 повторений" - слеш формат для весов И повторений
        // ═══════════════════════════════════════════════════════════
        const slashBoth = line.match(
          /^(.+?)\s+(\d+(?:[.,]\d+)?(?:\s*\/\s*\d+(?:[.,]\d+)?)+)\s*кг\s*на\s*(\d+(?:\s*\/\s*\d+)+)/i
        );
        if (slashBoth) {
          exerciseName = cleanExerciseName(slashBoth[1]);
          const weights = slashBoth[2]
            .split(/\s*\/\s*/)
            .map((w) => parseFloat(w.replace(',', '.')));
          const reps = slashBoth[3].split(/\s*\/\s*/).map((r) => parseInt(r));

          // Сопоставляем веса и повторения
          const count = Math.max(weights.length, reps.length);
          for (let i = 0; i < count; i++) {
            sets.push({
              weight: weights[i] || weights[weights.length - 1] || 0,
              reps: reps[i] || reps[reps.length - 1] || 0,
            });
          }
          if (sets.length > 0) {
            return {
              name: exerciseName,
              sets,
              category: 'Другое',
              equipment,
              position,
              unilateral: unilateralByText,
            };
          }
        }

        // ═══════════════════════════════════════════════════════════
        // Pattern 2: "20 кг на 15 и 12 повторений" - один вес, несколько повторов через "и"
        // ═══════════════════════════════════════════════════════════
        const weightAndReps = line.match(
          /^(.+?)\s+(\d+(?:[.,]\d+)?)\s*кг\s*на\s*(\d+)\s*и\s*(\d+)/i
        );
        if (weightAndReps) {
          exerciseName = cleanExerciseName(weightAndReps[1]);
          const weight = parseFloat(weightAndReps[2].replace(',', '.'));
          sets.push({ weight, reps: parseInt(weightAndReps[3]) });
          sets.push({ weight, reps: parseInt(weightAndReps[4]) });
          return {
            name: exerciseName,
            sets,
            category: 'Другое',
            equipment,
            position,
            unilateral: unilateralByText,
          };
        }

        // ═══════════════════════════════════════════════════════════
        // Pattern 3: "3 выхода силой" - число в начале + существительное
        // ═══════════════════════════════════════════════════════════
        const startNumber = line.match(
          /^(\d+)\s+(выход[а-яё]*|подход[а-яё]*|повтор[а-яё]*|раз[а-яё]*|круг[а-яё]*)\s*/i
        );
        if (startNumber) {
          const reps = parseInt(startNumber[1]);
          // Название = нормализованное слово + остаток строки
          let baseWord = startNumber[2].toLowerCase();
          if (baseWord.startsWith('выход')) baseWord = 'Выходы';
          else if (baseWord.startsWith('подход')) baseWord = 'Подходы';
          else if (baseWord.startsWith('круг')) baseWord = 'Круги';
          else baseWord = capitalizeFirst(baseWord);

          let restOfLine = line.substring(startNumber[0].length).trim();
          exerciseName = restOfLine ? baseWord + ' ' + restOfLine : baseWord;

          sets.push({ weight: 0, reps });
          return {
            name: capitalizeFirst(exerciseName),
            sets,
            category: 'Другое',
            equipment,
            position,
          };
        }

        const hasKgNa = /\d+\s*кг\s*на\s*\d+/i.test(line);

        // ═══════════════════════════════════════════════════════════
        // Pattern 4b: "Скручивания в тренажере 10 кг 20 раз" — ДО multiRaz!
        // Иначе "10 кг 20 раз" ошибочно парсится как "20 раз" без веса
        // ═══════════════════════════════════════════════════════════
        if (!hasKgNa) {
          const patternKgRaz = line.match(/^(.+?)\s+(\d+(?:[.,]\d+)?)\s*кг\s+(\d+)\s*раз/i);
          if (patternKgRaz) {
            exerciseName = cleanExerciseName(patternKgRaz[1]);
            sets.push({
              weight: parseFloat(patternKgRaz[2].replace(',', '.')),
              reps: parseInt(patternKgRaz[3]),
            });
            return {
              name: exerciseName,
              sets,
              category: 'Другое',
              equipment,
              position,
              unilateral: unilateralByText,
            };
          }
        }

        // ═══════════════════════════════════════════════════════════
        // Pattern 3b: "Подтягивания 11 раз, 5 раз, 5 раз 5 раз" — несколько "N раз"
        // ═══════════════════════════════════════════════════════════
        if (!hasKgNa) {
          const multiRaz = line.match(/^(.+?)\s+((?:\d+\s*раз[а-яё]*\s*[,]?\s*)+)/i);
          if (multiRaz) {
            const nums = [...multiRaz[2].matchAll(/(\d+)\s*раз/gi)].map((m) => parseInt(m[1]));
            if (nums.length >= 1) {
              exerciseName = cleanExerciseName(multiRaz[1]);
              nums.forEach((r) => sets.push({ weight: 0, reps: r }));
              return {
                name: exerciseName,
                sets,
                category: 'Другое',
                equipment,
                position,
                unilateral: unilateralByText,
              };
            }
          }
        }

        // ═══════════════════════════════════════════════════════════
        // Pattern 4: "Подтягивания 10 раз" или "Подтягивания 10, 8, 6 раз"
        // НЕ срабатывает если есть "кг на" (это Pattern 5)
        // ═══════════════════════════════════════════════════════════
        if (!hasKgNa) {
          const simpleReps = line.match(/^(.+?)\s+(\d+(?:\s*[,;]\s*\d+)*)\s*(?:раз|повтор)/i);
          if (simpleReps) {
            exerciseName = cleanExerciseName(simpleReps[1]);
            const repsStr = simpleReps[2];
            repsStr.split(/[,;]\s*/).forEach((r) => {
              const val = parseInt(r.trim());
              if (val > 0) sets.push({ weight: 0, reps: val });
            });
            if (sets.length > 0) {
              return {
                name: exerciseName,
                sets,
                category: 'Другое',
                equipment,
                position,
                unilateral: unilateralByText,
              };
            }
          }
        }

        // ═══════════════════════════════════════════════════════════
        // Pattern 5: "Тяга 40 кг на 15 раз, 50 кг на 10 раз" или "27 кг на 15 раз, 2 подхода"
        // ═══════════════════════════════════════════════════════════
        const hasMultipleSets = line.match(/(\d+(?:[.,]\d+)?)\s*(?:кг)?\s*на\s*(\d+)/gi);
        if (hasMultipleSets && hasMultipleSets.length >= 1) {
          const firstNumMatch = line.match(/^(.+?)\s+\d/);
          if (firstNumMatch) {
            exerciseName = cleanExerciseName(firstNumMatch[1]);
            const allSets = [...line.matchAll(/(\d+(?:[.,]\d+)?)\s*(?:кг)?\s*на\s*(\d+)/gi)];
            allSets.forEach((m) => {
              sets.push({ weight: parseFloat(m[1].replace(',', '.')), reps: parseInt(m[2]) });
            });
            // "27 кг на 15 раз, 2 подхода" → 2 одинаковых подхода
            const setsModifier = line.match(/[,.\s]+(\d+)\s*подход(?:а|ов)?/i);
            if (setsModifier && sets.length === 1) {
              const numSets = parseInt(setsModifier[1]);
              if (numSets > 1) {
                const base = sets[0];
                sets.length = 0;
                for (let i = 0; i < numSets; i++) sets.push({ ...base });
              }
            }
            if (sets.length > 0) {
              return {
                name: exerciseName,
                sets,
                category: 'Другое',
                equipment,
                position,
                unilateral: unilateralByText,
              };
            }
          }
        }

        // ═══════════════════════════════════════════════════════════
        // Pattern 6: "Жим 60x12, 70x10, 80x8" или "15x8, 2 подхода"
        // ═══════════════════════════════════════════════════════════
        const xPattern = [...line.matchAll(/(\d+(?:[.,]\d+)?)\s*[xх×]\s*(\d+)/gi)];
        if (xPattern.length > 0) {
          const firstNum = line.search(/\d/);
          if (firstNum > 0) {
            exerciseName = cleanExerciseName(line.substring(0, firstNum));
          }
          xPattern.forEach((m) => {
            sets.push({ weight: parseFloat(m[1].replace(',', '.')), reps: parseInt(m[2]) });
          });

          // Проверяем модификатор "N подходов" в конце
          const setsModifier = line.match(/[,.\s]+(\d+)\s*подход/i);
          if (setsModifier && sets.length === 1) {
            const numSets = parseInt(setsModifier[1]);
            const baseSet = sets[0];
            sets.length = 0; // Очищаем
            for (let i = 0; i < numSets; i++) {
              sets.push({ ...baseSet });
            }
          }

          if (sets.length > 0 && exerciseName) {
            return {
              name: exerciseName,
              sets,
              category: 'Другое',
              equipment,
              position,
              unilateral: unilateralByText,
            };
          }
        }

        // ═══════════════════════════════════════════════════════════
        // Pattern 7: "3x12 50кг" формат
        // ═══════════════════════════════════════════════════════════
        const setsReps = line.match(/^(.+?)\s+(\d+)\s*x\s*(\d+)(?:\s*(\d+(?:[.,]\d+)?)\s*кг)?/i);
        if (setsReps) {
          exerciseName = cleanExerciseName(setsReps[1]);
          const numSets = parseInt(setsReps[2]);
          const reps = parseInt(setsReps[3]);
          const weight = setsReps[4] ? parseFloat(setsReps[4].replace(',', '.')) : 0;
          for (let i = 0; i < numSets; i++) {
            sets.push({ weight, reps });
          }
          if (sets.length > 0) {
            return {
              name: exerciseName,
              sets,
              category: 'Другое',
              equipment,
              position,
              unilateral: unilateralByText,
            };
          }
        }

        // ═══════════════════════════════════════════════════════════
        // Pattern 8: Fallback - ищем любые числа
        // ═══════════════════════════════════════════════════════════
        const anyNumbers = [...line.matchAll(/(\d+(?:[.,]\d+)?)/g)];
        if (anyNumbers.length > 0) {
          const firstNum = line.search(/\d/);
          if (firstNum > 1) {
            exerciseName = cleanExerciseName(line.substring(0, firstNum));

            if (line.toLowerCase().includes('кг')) {
              anyNumbers.forEach((m) => {
                const val = parseFloat(m[1].replace(',', '.'));
                if (val > 0 && val < 500) sets.push({ weight: val, reps: 0 });
              });
            } else {
              anyNumbers.forEach((m) => {
                const val = parseInt(m[1]);
                if (val > 0 && val < 100) sets.push({ weight: 0, reps: val });
              });
            }

            if (sets.length > 0 && exerciseName.length > 2) {
              return {
                name: exerciseName,
                sets,
                category: 'Другое',
                equipment,
                position,
                unilateral: unilateralByText,
              };
            }
          }
        }

        return null;
      }

      // Упражнения, где "в тренажере" / тип тренажёра — часть идентичности (не дублирование equipment)
      const MACHINE_IN_NAME =
        /в\s+(наклонн[а-яё]*|блочн[а-яё]*|рычажн[а-яё]*)?\s*тренажер[а-яё]*|гакк/i;
      const INCLINE_BENCH = /на\s*наклонн[а-яё]*\s*скамь[а-яё]*|наклонн[а-яё]*\s*скамь[а-яё]*/i;
      const EMBEDDED_NAME_PARTS = [
        // Жим лёжа в рычажном/любом тренажере ≠ жим со штангой
        { check: /жим.*(л[её]ж|грудь|штанг|гантел)/i, keep: MACHINE_IN_NAME },
        // Приседания в тренажере / гакк ≠ присед со штангой
        { check: /присед|приседани/i, keep: MACHINE_IN_NAME },
        // Сгибание/разгибание рук, отведение плеча в тренажере ≠ с гантелями
        { check: /сгибан.*(рук|плеч)|разгибан.*рук|отведени/i, keep: MACHINE_IN_NAME },
        // "на тумбу" - часть названия для запрыгиваний
        { check: /запрыгивани|прыжки/i, keep: /на\s+тумб[уыеа]/i },
        // "лёжа" - часть названия для жима лёжа
        { check: /жим.*л[её]жа|л[её]жа.*жим/i, keep: /л[её]жа/i },
        // "на наклонной скамье" - жим на наклонной ≠ жим лёжа
        { check: /жим.*(наклон|л[её]ж|грудь)/i, keep: INCLINE_BENCH },
        // "в наклоне" - часть названия для тяги в наклоне
        { check: /тяга.*в\s*наклоне|в\s*наклоне.*тяга/i, keep: /в\s*наклоне/i },
        // "в висе" - часть названия для подъёма ног в висе
        { check: /подъ[её]м\s+ног.*в\s+висе|в\s+висе.*подъ[её]м/i, keep: /в\s+висе/i },
        // "на брусьях" - для отжиманий И для скручиваний (разные упражнения!)
        { check: /отжимани.*на\s+брусьях/i, keep: /на\s+брусьях/i },
        { check: /скручиван.*(в\s+упоре|на\s+брусьях)/i, keep: /(в\s+упоре|на\s+брусьях)/i },
        // "на перекладине" - часть названия для подтягиваний
        { check: /подтягивани/i, keep: /на\s+перекладин[а-яё]*/i },
      ];

      function cleanExerciseName(name) {
        if (!name) return '';
        const nameLower = name.toLowerCase();

        // Убираем числа с "кг" и просто числа в конце (вес попавший в название)
        name = name.replace(/\s+\d+(?:[.,]\d+)?\s*кг?\s*$/gi, '');

        // Убираем унилатеральные фразы (уже обозначены иконкой)
        name = name.replace(/\s+с\s+одной\s+(ног[иа]|рук[иа])/gi, '');
        name = name.replace(/\s+на\s+каждую\s+(ногу|руку)/gi, '');
        name = name.replace(/\s+на\s+одной\s+(ноге|руке)/gi, '');
        name = name.replace(/\s+поочер[её]дно/gi, '');
        name = name.replace(/\s+односторонн[а-яё]*/gi, '');

        // Определяем какие части сохранять
        const keepPatterns = [];
        for (const rule of EMBEDDED_NAME_PARTS) {
          if (rule.check.test(nameLower)) {
            keepPatterns.push(rule.keep);
          }
        }

        // Функция проверки - нужно ли сохранять часть
        const shouldKeep = (pattern) => keepPatterns.some((kp) => kp.source === pattern.source);

        // Убираем "в тренажере" и варианты только если это не часть идентичности упражнения
        if (!shouldKeep(MACHINE_IN_NAME)) {
          name = name.replace(/\s+в\s+наклонн[а-яё]*\s+тренажер[а-яё]*/gi, '');
          name = name.replace(/\s+в\s+блочн[а-яё]*\s+тренажер[а-яё]*/gi, '');
          name = name.replace(/\s+в\s+рычажн[а-яё]*\s+тренажер[а-яё]*/gi, '');
          name = name.replace(/\s+в\s+тренажер[а-яё]*/gi, '');
          name = name.replace(/\s+гакк(\s+тренажер)?[а-яё]*/gi, '');
        }
        if (!shouldKeep(INCLINE_BENCH)) {
          name = name.replace(/\s+на\s+наклонн[а-яё]*\s+скамь[а-яё]*/gi, '');
          name = name.replace(/\s+наклонн[а-яё]*\s+скамь[а-яё]*/gi, '');
        }
        name = name.replace(
          /\s+(с\s+)?(z\s*гриф[а-яё]*|ez\s*гриф[а-яё]*|штанг[а-яё]*|гантел[а-яё]*|на\s+блоке|на\s+скамье|грифом|с\s+грифом|блочн[а-яё]*)/gi,
          ''
        );

        // Убираем "на тумбу" только если это НЕ часть названия
        if (!shouldKeep(/на\s+тумб[уыеа]/i)) {
          name = name.replace(/\s+на\s+тумб[уыеа]/gi, '');
        }

        // Убираем "на перекладине" только если это НЕ часть названия
        if (!shouldKeep(/на\s+перекладин[а-яё]*/i)) {
          name = name.replace(/\s+на\s+перекладин[а-яё]*/gi, '');
        }

        // Убираем позиции тела (если это НЕ часть названия)
        if (!shouldKeep(/в\s+висе/i)) {
          name = name.replace(/\s+в\s+висе/gi, '');
        }

        if (!shouldKeep(/л[её]жа/i)) {
          name = name.replace(/\s+л[её]жа\s*$/gi, '');
        }

        if (!shouldKeep(/в\s*наклоне/i)) {
          name = name.replace(/\s+в\s*наклоне\s*$/gi, '');
        }

        name = name.replace(/\s+(сидя|стоя|в\s+упоре)\s*$/gi, '');

        // Убираем предлоги и числа в конце (повторяем несколько раз)
        for (let i = 0; i < 3; i++) {
          name = name.replace(/\s+(по|с|и|кг|\d+)$/i, '');
        }
        return capitalizeFirst(name.trim());
      }

      function capitalizeFirst(str) {
        if (!str) return str;
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function renderWorkoutPreview() {
        const preview = document.getElementById('workoutPreview');
        const container = document.getElementById('parsedExercises');

        if (!workoutState.parsedWorkout || !workoutState.parsedWorkout.exercises) {
          preview.style.display = 'none';
          return;
        }

        container.innerHTML = `
                <!-- Название тренировки -->
                <div class="workout-meta-form">
                    <div class="form-group">
                        <label class="form-label">📅 Дата тренировки</label>
                        <input type="date" class="form-input" id="workoutDateInput" 
                               value="${workoutState.workoutDate || new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Название тренировки</label>
                        <input type="text" class="form-input" id="workoutNameInput" 
                               placeholder="Спина+бицепс, Ноги, Push day..."
                               value="${workoutState.workoutName || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Общий RPE (5-10)</label>
                        <div class="rpe-selector" id="rpeSelector">
                            ${[5, 6, 7, 8, 9, 10]
                              .map(
                                (n) => `
                                <button type="button" class="rpe-btn ${workoutState.workoutRPE === n ? 'active' : ''}" 
                                        onclick="selectRPE(${n})">${n}</button>
                            `
                              )
                              .join('')}
                        </div>
                    </div>
                </div>
                
                ${workoutState.parsedWorkout.exercises
                  .map(
                    (ex, idx) => `
                    <div class="parsed-exercise" data-idx="${idx}" id="exercise_${idx}" draggable="true" 
                         ondragstart="dragStart(event, ${idx})" ondragover="dragOver(event)" 
                         ondrop="drop(event, ${idx})" ondragend="dragEnd(event)">
                        <div class="exercise-order-num">${idx + 1}</div>
                        <div class="exercise-content">
                            <div class="parsed-exercise-header">
                                <span class="parsed-exercise-name">${ex.name}${!getExerciseFromDB(ex.name) ? ' <span class="new-exercise-badge">NEW</span>' : ''}</span>
                                <div class="exercise-actions">
                                    ${renderUnilateralButton(idx, ex)}
                                    <button type="button" class="btn-icon edit-exercise" onclick="event.stopPropagation(); editExercise(${idx})" title="Редактировать">✏️</button>
                                    <button type="button" class="btn-icon delete-exercise" onclick="event.stopPropagation(); removeExercise(${idx})" title="Удалить">🗑️</button>
                                </div>
                            </div>
                            <!-- Вариации: оборудование + позиция -->
                            <div class="exercise-variations">
                                ${(() => {
                                  const opts = getExerciseOptions(ex.name);
                                  return (
                                    renderEquipmentSelect(idx, ex.equipment, opts.equipment) +
                                    renderPositionSelect(idx, ex.position, opts.positions)
                                  );
                                })()}
                                <span class="parsed-exercise-category">${ex.category || 'Другое'}</span>
                            </div>
                            ${renderWeightMultiplierHint(ex)}
                            <div class="parsed-sets">
                                ${ex.sets
                                  .map((s, setIdx) => {
                                    const mult = getWeightMultiplier(ex);
                                    const displayWeight = s.weight > 0 ? s.weight : 0;
                                    const effectiveWeight = displayWeight * mult;

                                    return `
                                        <span class="parsed-set" onclick="event.stopPropagation(); editSet(${idx}, ${setIdx})">
                                            ${
                                              displayWeight > 0
                                                ? `
                                                <span class="weight">${displayWeight}</span>${mult > 1 ? `<span class="mult-hint">×${mult}</span>` : ''}×
                                            `
                                                : ''
                                            }
                                            <span class="reps">${s.reps}</span>${displayWeight === 0 ? ' раз' : ''}
                                        </span>
                                    `;
                                  })
                                  .join('')}
                                <button type="button" class="btn-icon add-set-btn" onclick="event.stopPropagation(); addSetToExercise(${idx})" title="Добавить подход">➕</button>
                            </div>
                            ${renderMuscleLoadPreview(idx, ex.name, getExerciseCoeffs(ex.name).coeffs)}
                        </div>
                    </div>
                `
                  )
                  .join('')}
                
                <!-- Форма редактирования упражнения -->
                <div class="edit-exercise-form" id="editExerciseForm" style="display: none;">
                    <input type="hidden" id="editExerciseIdx">
                    <div class="form-group">
                        <label class="form-label">Название упражнения</label>
                        <input type="text" class="form-input" id="editExerciseName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Подходы (вес × повторы)</label>
                        <div id="editSetsContainer"></div>
                    </div>
                    <div class="edit-exercise-actions">
                        <button type="button" class="btn btn-secondary" onclick="cancelEditExercise()">Отмена</button>
                        <button type="button" class="btn btn-primary" onclick="saveEditExercise()">Сохранить</button>
                    </div>
                </div>
                
                <!-- Добавить упражнение -->
                <div class="add-exercise-form" id="addExerciseForm" style="display: none;">
                    <input type="text" class="form-input" id="newExerciseName" placeholder="Название упражнения">
                    <div class="add-exercise-row">
                        <input type="number" class="metric-input small" id="newExerciseWeight" placeholder="Вес" step="2.5">
                        <span>кг</span>
                        <input type="number" class="metric-input small" id="newExerciseReps" placeholder="Повторы">
                        <span>раз</span>
                    </div>
                    <div class="add-exercise-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideAddExercise()">Отмена</button>
                        <button type="button" class="btn btn-primary" onclick="addExerciseToWorkout()">Добавить</button>
                    </div>
                </div>
                
                <button type="button" class="btn btn-outline add-exercise-btn" onclick="showAddExercise()">
                    ➕ Добавить упражнение
                </button>
                <button type="button" class="btn-clear-workout" onclick="clearWorkout()" title="Очистить всё">
                    🗑️ Очистить
                </button>
            `;

        preview.style.display = 'block';
      }

      function selectRPE(value) {
        workoutState.workoutRPE = value;
        document.querySelectorAll('.rpe-btn').forEach((btn) => {
          btn.classList.toggle('active', parseInt(btn.textContent) === value);
        });
      }

      function getCheckedMandatoryTasks() {
        // Берём данные из верхней секции обязательных задач
        const checked = [];
        document.querySelectorAll('.task-checkbox input').forEach((cb) => {
          checked.push({
            taskId: cb.dataset.taskId,
            taskName: cb.dataset.taskName || '',
            completed: cb.checked,
          });
        });
        return checked;
      }

      // ═══════════════════════════════════════════════════════════
      // ОПЦИИ УПРАЖНЕНИЙ ИЗ БАЗЫ
      // ═══════════════════════════════════════════════════════════

      // Дефолтные опции если упражнения нет в базе
      const DEFAULT_EQUIPMENT = [
        'штанга',
        'гантели',
        'гиря',
        'тренажер',
        'блок',
        'резина',
        'свой вес',
      ];
      const DEFAULT_POSITIONS = [
        'стоя',
        'сидя',
        'лёжа',
        'наклонная',
        'в наклоне',
        'в упоре',
        'на скамье',
        'в тренажере',
      ];

      function normalizeText(text) {
        return text.toLowerCase().trim().replace(/ё/g, 'е');
      }

      // Получить основу слова (первые N символов)
      function getStem(word, minLen = 5) {
        const w = normalizeText(word);
        return w.length > minLen ? w.substring(0, minLen) : w;
      }

      // ЯВНЫЕ ПРАВИЛА для 100% точного распознавания
      // Формат: { pattern: regex, exerciseId: 'id' }
      const EXPLICIT_EXERCISE_RULES = [
        // Разгибания - различаем по контексту (КРИТИЧНО!)
        { pattern: /разгибан.*(блок|канат|трицепс|рук)/i, id: 'tricep_pushdown' },
        { pattern: /(блок|канат|трицепс).*разгибан/i, id: 'tricep_pushdown' },
        { pattern: /разгибан.*ног/i, id: 'leg_extension' },
        { pattern: /разгибан.*гантел.*голов/i, id: 'tricep_overhead_db' },
        { pattern: /французский.*жим/i, id: 'tricep_overhead' },

        // Сгибания - ноги vs руки
        { pattern: /сгибан.*ног.*леж/i, id: 'leg_curl_lying' },
        { pattern: /сгибан.*ног.*сид/i, id: 'leg_curl_seated' },
        { pattern: /сгибан.*ног/i, id: 'leg_curl_lying' },
        { pattern: /сгибан.*(рук|бицепс|гантел|штанг)/i, id: 'bicep_curl' },

        // Тяги
        { pattern: /тяга.*верхн.*блок/i, id: 'lat_pulldown' },
        { pattern: /тяга.*нижн.*блок|тяга.*блок.*сид/i, id: 'cable_row' },
        { pattern: /тяга.*пояс/i, id: 'cable_row' },
        { pattern: /румынская|рдл|rdl/i, id: 'rdl_barbell' },
        { pattern: /станов.*тяга|deadlift/i, id: 'deadlift' },

        // Приседания
        { pattern: /гакк/i, id: 'squat_hack' },
        { pattern: /присед.*смит/i, id: 'squat_smith' },
        { pattern: /фронтальн.*присед/i, id: 'squat_front' },
        { pattern: /гоблет/i, id: 'squat_goblet' },

        // Жимы
        { pattern: /жим.*ног/i, id: 'leg_press' },
        { pattern: /жим.*(леж|грудь|штанг)/i, id: 'bench_press' },
        { pattern: /жим.*(плеч|сид|арнольд)/i, id: 'shoulder_press' },
      ];

      function getExerciseFromDB(name) {
        if (!exercises || exercises.length === 0) return null;

        const nameNorm = normalizeText(applyExerciseSynonyms(name));
        const nameWords = nameNorm.split(/\s+/).filter((w) => w.length > 2);
        const firstWordStem = nameWords[0] ? getStem(nameWords[0], 5) : '';

        // 0-ПРИОРИТЕТ: «Отведение плеча в тренажере» = Махи в стороны (средняя дельта)
        // ДО любых других проверок — иначе stem/alias могут вернуть «Отведение гантели назад»
        if (
          nameNorm.includes('отведение плеча') &&
          nameNorm.includes('тренажер') &&
          !nameNorm.includes('гантели назад')
        ) {
          const lateral = exercises.find((e) => {
            const n = normalizeText(e.name);
            return (
              (n.includes('махи') && n.includes('сторон')) ||
              (e.aliases || []).some((a) => normalizeText(String(a)).includes('отведение плеча'))
            );
          });
          if (lateral) return lateral;
        }

        // 0. Поиск по aliases (разговорные/социальные варианты → каноническое название)
        for (const ex of exercises) {
          const aliases = ex.aliases || [];
          for (const a of aliases) {
            const aNorm = normalizeText(String(a));
            if (aNorm === nameNorm || nameNorm.includes(aNorm)) {
              // Не путать: "скручивания в упоре на брусьях" ≠ "отжимания на брусьях"
              if (nameNorm.includes('скручиван') && normalizeText(ex.name).includes('отжимани'))
                continue;
              // «Отведение плеча в тренажере» ≠ «Отведение гантели назад»
              if (
                nameNorm.includes('отведение плеча') &&
                nameNorm.includes('тренажер') &&
                !nameNorm.includes('гантели')
              )
                if (
                  normalizeText(ex.name).includes('гантели') &&
                  normalizeText(ex.name).includes('назад')
                )
                  continue;
              return ex;
            }
          }
        }

        if (nameNorm.includes('отведение плеча') && !nameNorm.includes('гантели назад')) {
          const anyLateral = exercises.find((e) => {
            const n = normalizeText(e.name);
            // «Отведение плеча в тренажере» ≠ «Отведение гантели назад» — при «тренажер» во вводе исключаем гантели назад
            if (nameNorm.includes('тренажер') && n.includes('гантели') && n.includes('назад'))
              return false;
            return (
              (n.includes('махи') || n.includes('отведение')) &&
              (e.category || '').toLowerCase().includes('плеч')
            );
          });
          if (anyLateral) return anyLateral;
        }
        // 0c. Жим на наклонной скамье → Жим лёжа (наклонная) и т.п.
        if (
          nameNorm.includes('жим') &&
          (nameNorm.includes('наклон') || nameNorm.includes('наклонн'))
        ) {
          const incline = exercises.find((e) => {
            const n = normalizeText(e.name);
            return n.includes('жим') && (n.includes('наклон') || n.includes('наклонн'));
          });
          if (incline) return incline;
        }
        // 0b. Отведение гантели назад = задняя дельта (в БД: "Задняя дельта (в наклоне)" или "Отведение гантели назад (в наклоне)")
        if (nameNorm.includes('отведение гантели') && nameNorm.includes('назад')) {
          const rearDelt = exercises.find((e) => {
            const n = normalizeText(e.name);
            return (
              (n.includes('махи') && n.includes('наклон')) ||
              n.includes('задняя дельта') ||
              (n.includes('отведение') && n.includes('назад') && n.includes('гантел'))
            );
          });
          if (rearDelt) return rearDelt;
        }
        // 0. ЯВНЫЕ ПРАВИЛА - 100% точность для известных паттернов
        for (const rule of EXPLICIT_EXERCISE_RULES) {
          if (rule.pattern.test(nameNorm)) {
            const found = exercises.find((e) => (e.key || e.id) === rule.id);
            if (found) {
              console.log(`[DB] Explicit rule: "${name}" → ${rule.id}`);
              return found;
            }
          }
        }

        // 1. Точное совпадение названия
        let found = exercises.find((e) => normalizeText(e.name) === nameNorm);
        if (found) return found;

        // 2. Название из базы полностью содержится во вводе (приоритет длинным)
        const containedMatches = exercises
          .filter((e) => {
            const dbNorm = normalizeText(e.name);
            if (!nameNorm.includes(dbNorm)) return false;
            // Скручивания ≠ Отжимания на брусьях (разные упражнения)
            if (nameNorm.includes('скручиван') && dbNorm.includes('отжимани')) return false;
            if (nameNorm.includes('подтягиван') && dbNorm.includes('отжимани')) return false;
            // «Отведение плеча в тренажере» ≠ «Отведение гантели назад»
            if (
              nameNorm.includes('отведение плеча') &&
              nameNorm.includes('тренажер') &&
              !nameNorm.includes('гантели')
            )
              if (dbNorm.includes('гантели') && dbNorm.includes('назад')) return false;
            return true;
          })
          .sort((a, b) => normalizeText(b.name).length - normalizeText(a.name).length);

        if (containedMatches.length > 0) {
          // Если есть контекст - фильтруем по нему
          const contextKeywords = {
            блок: 'Блок',
            тренажер: 'Тренажёр',
            штанг: 'Штанга',
            гантел: 'Гантели',
            гир: 'Гиря',
            тумб: 'Тумба',
          };

          for (const [keyword, equipValue] of Object.entries(contextKeywords)) {
            if (nameNorm.includes(keyword)) {
              // Ищем среди containedMatches с правильным equipment
              const contextMatch = containedMatches.find((e) => {
                const equipNorm = normalizeText(e.equipment || '');
                const dbNorm = normalizeText(e.name);
                return equipNorm.includes(keyword) || dbNorm.includes(keyword);
              });
              if (contextMatch) return contextMatch;
            }
          }

          // Если контекста нет - возвращаем самое длинное совпадение
          return containedMatches[0];
        }

        // 3. Контекстный поиск по equipment + первое слово
        const contextKeywords = [
          'блок',
          'тренажер',
          'штанг',
          'гантел',
          'тумб',
          'перекладин',
          'скамь',
          'канат',
        ];
        const inputContext = contextKeywords.filter((kw) => nameNorm.includes(kw));

        if (inputContext.length > 0) {
          // Ищем ВСЕ упражнения с совпадающим контекстом
          const contextMatches = exercises.filter((e) => {
            const dbNorm = normalizeText(e.name);
            const dbFirstStem = getStem(dbNorm.split(/\s+/)[0], 5);

            // Первое слово должно совпадать
            if (firstWordStem !== dbFirstStem) return false;

            // Контекст в названии ИЛИ в equipment
            const equipNorm = normalizeText(e.equipment || '');
            return inputContext.some((kw) => dbNorm.includes(kw) || equipNorm.includes(kw));
          });

          if (contextMatches.length > 0) {
            // Приоритет: больше общих слов = лучше
            contextMatches.sort((a, b) => {
              const aWords = normalizeText(a.name).split(/\s+/);
              const bWords = normalizeText(b.name).split(/\s+/);
              const aCommon = aWords.filter((w) => nameWords.includes(w)).length;
              const bCommon = bWords.filter((w) => nameWords.includes(w)).length;
              return bCommon - aCommon;
            });
            return contextMatches[0];
          }
        }

        // 4. Поиск по stem первого слова БЕЗ конфликтующего контекста
        const stemMatches = exercises.filter((e) => {
          const dbNorm = normalizeText(e.name);
          const dbFirstStem = getStem(dbNorm.split(/\s+/)[0], 5);
          if (firstWordStem !== dbFirstStem) return false;
          // «Отведение плеча в тренажере» ≠ «Отведение гантели назад» — разные упражнения!
          if (
            nameNorm.includes('отведение плеча') &&
            nameNorm.includes('тренажер') &&
            !nameNorm.includes('гантели')
          )
            if (dbNorm.includes('гантели') && dbNorm.includes('назад')) return false;
          return true;
        });

        if (stemMatches.length > 0) {
          // Если контекст есть во вводе - исключаем несовпадающие
          if (inputContext.length > 0) {
            const filtered = stemMatches.filter((e) => {
              const dbNorm = normalizeText(e.name);
              const equipNorm = normalizeText(e.equipment || '');
              return inputContext.some((kw) => dbNorm.includes(kw) || equipNorm.includes(kw));
            });
            if (filtered.length > 0) return filtered[0];
          }

          // Приоритет по общим словам
          stemMatches.sort((a, b) => {
            const aWords = normalizeText(a.name).split(/\s+/);
            const bWords = normalizeText(b.name).split(/\s+/);
            const aCommon = aWords.filter((w) => nameWords.includes(w)).length;
            const bCommon = bWords.filter((w) => nameWords.includes(w)).length;
            return bCommon - aCommon;
          });
          return stemMatches[0];
        }

        return null;
      }

      // Словарь синонимов для упражнений (нормализация названий)
      const EXERCISE_SYNONYMS = {
        голени: 'ног',
        голень: 'ног',
        икр: 'ног',
        бедра: 'ног',
        бедро: 'ног',
        квадрицепс: 'ног',
        рук: 'руки',
        руку: 'руки',
        плеч: 'плечи',
        плечо: 'плечи',
        груди: 'грудь',
        спины: 'спина',
        пресса: 'пресс',
        корпуса: 'корпус',
        тумбы: 'тумбу',
        подьем: 'подъём',
        подъем: 'подъём',
      };

      // Контекстные правила для определения упражнения
      // Формат: [паттерн, замена названия]
      const CONTEXT_RULES = [
        // "сгибание ног в висе" → "подъём ног в висе" (это leg_raise, не leg_curl)
        [/сгибани[ея]\s+ног\s+(в\s+висе|на\s+перекладин)/gi, 'подъём ног $1'],
        // "поднятие ног" → "подъём ног"
        [/подняти[ея]\s+ног/gi, 'подъём ног'],
      ];

      function applyContextRules(text) {
        let result = text;
        for (const [pattern, replacement] of CONTEXT_RULES) {
          result = result.replace(pattern, replacement);
        }
        return result;
      }

      function applyExerciseSynonyms(text) {
        let result = text.toLowerCase();
        // Сначала применяем контекстные правила
        result = applyContextRules(result);
        // Потом синонимы
        for (const [from, to] of Object.entries(EXERCISE_SYNONYMS)) {
          result = result.replace(new RegExp(from, 'gi'), to);
        }
        return result;
      }

      // Словарь перевода equipment с английского на русский
      const EQUIPMENT_TRANSLATE = {
        barbell: 'штанга',
        dumbbell: 'гантели',
        kettlebell: 'гиря',
        cable: 'блок',
        machine: 'тренажер',
        bodyweight: 'свой вес',
        weighted: 'с отягощением',
        smith: 'смит',
        plate: 'блин',
        ez_bar: 'ez-гриф',
        't-bar': 't-гриф',
        резина: 'резина',
        резинка: 'резинка',
      };

      function translateEquipment(eng) {
        return EQUIPMENT_TRANSLATE[eng.toLowerCase()] || eng;
      }

      function getExerciseOptions(name) {
        const dbExercise = getExerciseFromDB(name);

        if (dbExercise) {
          // Переводим equipmentOptions с английского
          const translatedEquipment =
            dbExercise.equipmentOptions && dbExercise.equipmentOptions.length > 0
              ? dbExercise.equipmentOptions.map((e) => translateEquipment(e))
              : DEFAULT_EQUIPMENT;

          return {
            equipment: translatedEquipment,
            positions:
              dbExercise.positionOptions && dbExercise.positionOptions.length > 0
                ? dbExercise.positionOptions
                : DEFAULT_POSITIONS,
            laterality: dbExercise.laterality || 'bilateral',
            category: dbExercise.category || 'Другое',
          };
        }

        return {
          equipment: DEFAULT_EQUIPMENT,
          positions: DEFAULT_POSITIONS,
          laterality: 'bilateral',
          category: 'Другое',
        };
      }

      function renderEquipmentSelect(idx, currentValue, options) {
        // Если текущее значение не в списке опций — добавляем его
        let allOptions = [...options];
        if (currentValue && !allOptions.includes(currentValue)) {
          allOptions.push(currentValue);
        }
        const opts = allOptions
          .map(
            (opt) =>
              `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${capitalizeFirst(opt)}</option>`
          )
          .join('');
        return `
                <select class="variation-select" onchange="updateVariation(${idx}, 'equipment', this.value)">
                    <option value="">Оборудование</option>
                    ${opts}
                </select>
            `;
      }

      function renderPositionSelect(idx, currentValue, options) {
        // Если текущее значение не в списке опций — добавляем его
        let allOptions = [...options];
        if (currentValue && !allOptions.includes(currentValue)) {
          allOptions.push(currentValue);
        }
        const opts = allOptions
          .map(
            (opt) =>
              `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${capitalizeFirst(opt)}</option>`
          )
          .join('');
        return `
                <select class="variation-select" onchange="updateVariation(${idx}, 'position', this.value)">
                    <option value="">Позиция</option>
                    ${opts}
                </select>
            `;
      }

      function renderUnilateralButton(idx, ex) {
        const laterality = ex.laterality || 'bilateral';

        // Для alwaysUnilateral - всегда показываем ×2 (заблокировано)
        if (laterality === 'alwaysUnilateral') {
          return `
                    <span class="unilateral-badge active" title="Всегда на каждую сторону (вес ×2)">×2</span>
                `;
        }

        // Для всех остальных - переключаемая кнопка
        // Показываем ×2 если активно, иначе маленькую кнопку ±
        if (ex.unilateral) {
          return `
                    <button type="button" class="unilateral-toggle active" 
                            onclick="event.stopPropagation(); toggleUnilateral(${idx})" 
                            title="На каждую сторону (вес ×2). Нажмите чтобы отключить">
                        ×2
                    </button>
                `;
        } else {
          return `
                    <button type="button" class="unilateral-toggle" 
                            onclick="event.stopPropagation(); toggleUnilateral(${idx})" 
                            title="Нажмите если на каждую сторону (×2)">
                        ±
                    </button>
                `;
        }
      }

      // ═══════════════════════════════════════════════════════════
      // РАСЧЁТ ВЕСА ГАНТЕЛЕЙ
      // ═══════════════════════════════════════════════════════════

      function getWeightMultiplier(ex) {
        // Гантели + bilateral = вес × 2
        const isDumbbell = ex.equipment === 'гантели';
        const isBilateral = !ex.unilateral;
        return isDumbbell && isBilateral ? 2 : 1;
      }

      function renderWeightMultiplierHint(ex) {
        const mult = getWeightMultiplier(ex);
        if (mult <= 1) return '';

        return `
                <div class="weight-multiplier-hint">
                    💡 Вес записывается за 1 гантель, объём × ${mult}
                </div>
            `;
      }

      // ═══════════════════════════════════════════════════════════
      // DRAG & DROP для изменения порядка упражнений
      // ═══════════════════════════════════════════════════════════

      let draggedIdx = null;

      function dragStart(e, idx) {
        draggedIdx = idx;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', idx);
      }

      function dragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const target = e.target.closest('.parsed-exercise');
        if (target) {
          document
            .querySelectorAll('.parsed-exercise')
            .forEach((el) => el.classList.remove('drag-over'));
          target.classList.add('drag-over');
        }
      }

      function drop(e, targetIdx) {
        e.preventDefault();
        document.querySelectorAll('.parsed-exercise').forEach((el) => {
          el.classList.remove('drag-over', 'dragging');
        });

        if (draggedIdx === null || draggedIdx === targetIdx) return;

        reorderExercises(draggedIdx, targetIdx);
      }

      function dragEnd(e) {
        draggedIdx = null;
        document.querySelectorAll('.parsed-exercise').forEach((el) => {
          el.classList.remove('drag-over', 'dragging');
        });
      }

      function reorderExercises(fromIdx, toIdx) {
        const exercises = workoutState.parsedWorkout.exercises;
        const [movedItem] = exercises.splice(fromIdx, 1);
        exercises.splice(toIdx, 0, movedItem);

        draggedIdx = null;
        renderWorkoutPreview();
        showToast('Порядок изменён', 'success');
      }

      function moveExercise(idx, direction) {
        const exercises = workoutState.parsedWorkout.exercises;
        const newIdx = idx + direction;

        if (newIdx < 0 || newIdx >= exercises.length) return;

        // Меняем местами
        [exercises[idx], exercises[newIdx]] = [exercises[newIdx], exercises[idx]];
        renderWorkoutPreview();
      }

      // ═══════════════════════════════════════════════════════════
      // ВАРИАЦИИ И УНИЛАТЕРАЛЬНОСТЬ
      // ═══════════════════════════════════════════════════════════

      function toggleUnilateral(idx) {
        const ex = workoutState.parsedWorkout.exercises[idx];
        if (!ex) return;

        // Проверяем laterality из базы
        const laterality = ex.laterality || 'bilateral';

        // alwaysUnilateral нельзя отключить
        if (laterality === 'alwaysUnilateral') {
          showToast('Это упражнение всегда на каждую сторону', 'info');
          return;
        }

        // Для всех остальных - можно переключать
        ex.unilateral = !ex.unilateral;
        renderWorkoutPreview();

        showToast(ex.unilateral ? '×2: на каждую сторону' : 'Обычный режим', 'info');
      }

      function updateVariation(idx, type, value) {
        const ex = workoutState.parsedWorkout.exercises[idx];
        if (!ex) return;

        ex[type] = value;
        // Не перерисовываем чтобы не сбросить фокус
      }

      // ═══════════════════════════════════════════════════════════
      // MUSCLE LOAD - Распределение нагрузки по мышцам
      // ═══════════════════════════════════════════════════════════

      const COEFF_DB_TO_UI = {
        chest: 'Грудь',
        front_delt: 'Передняя дельта',
        mid_delt: 'Средняя дельта',
        rear_delt: 'Задняя дельта',
        triceps: 'Трицепс',
        biceps: 'Бицепс',
        lats: 'Широчайшие',
        traps: 'Трапеция',
        low_back: 'Поясница',
        quads: 'Квадрицепс',
        hamstrings: 'Бицепс бедра',
        glutes: 'Ягодицы',
        calves: 'Икры',
        core: 'Кор',
      };

      function normalizeCoeffsForEditor(rawCoeffs) {
        let coeffs = {};
        for (const [k, v] of Object.entries(rawCoeffs || {})) {
          const uiKey = COEFF_DB_TO_UI[k] || k;
          if (typeof v === 'number' && v > 0) coeffs[uiKey] = v;
        }
        let sum = Object.values(coeffs).reduce((a, b) => a + b, 0);
        if (sum > 0 && Math.abs(sum - 1) > 0.01) {
          for (const k of Object.keys(coeffs)) coeffs[k] = coeffs[k] / sum;
        }
        return coeffs;
      }

      function getExerciseCoeffs(exerciseName) {
        // Канонические коэффициенты для однозначных упражнений (до DB)
        const n = (exerciseName || '').toLowerCase().replace(/ё/g, 'е');
        if (
          n.includes('отведение плеча') &&
          n.includes('тренажер') &&
          !n.includes('гантели назад')
        ) {
          return {
            coeffs: { 'Средняя дельта': 0.5, 'Передняя дельта': 0.25, 'Задняя дельта': 0.25 },
            fromMaster: true,
            category: 'Плечи',
            subcategory: 'Средняя дельта',
          };
        }

        // Ищем упражнение в базе данных
        const dbEx = getExerciseFromDB(exerciseName);

        if (dbEx && dbEx.muscleCoeffs) {
          // Парсим коэффициенты из базы (ключи могут быть EN: chest, front_delt...)
          try {
            const raw =
              typeof dbEx.muscleCoeffs === 'string'
                ? JSON.parse(dbEx.muscleCoeffs)
                : dbEx.muscleCoeffs;
            const coeffs = normalizeCoeffsForEditor(raw);
            return {
              coeffs,
              fromMaster: true,
              category: dbEx.category,
              subcategory: dbEx.subcategory,
            };
          } catch (e) {
            console.warn('Ошибка парсинга коэффициентов:', e);
          }
        }

        // Если есть категория и subcategory из базы - используем их
        if (dbEx?.category && dbEx.category !== 'Другое') {
          const coeffs = generateDefaultCoeffs(dbEx.category, dbEx.subcategory);
          return {
            coeffs,
            fromMaster: false,
            category: dbEx.category,
            subcategory: dbEx.subcategory,
          };
        }

        // AI-угадывание по названию
        return aiGuessCoeffs(exerciseName);
      }

      // AI определение коэффициентов по названию упражнения
      function aiGuessCoeffs(name) {
        const n = name.toLowerCase();

        const patterns = {
          Ноги: {
            kw: [
              'присед',
              'выпад',
              'жим ног',
              'ягодиц',
              'икр',
              'гакк',
              'платформ',
              'степ',
              'запрыг',
            ],
            def: { Квадрицепс: 0.4, 'Бицепс бедра': 0.3, Ягодицы: 0.3 },
          },
          Спина: {
            kw: ['тяга', 'подтяг', 'гребл', 'гипер', 'т-гриф', 'пулов', 'верхн блок', 'нижн блок'],
            def: { Широчайшие: 0.6, Трапеция: 0.2, Бицепс: 0.2 },
          },
          Грудь: {
            kw: [
              'жим лёж',
              'жим леж',
              'жим гант',
              'отжим',
              'разводк',
              'сведен',
              'кроссовер',
              'бабочк',
            ],
            def: { Грудь: 0.6, 'Передняя дельта': 0.2, Трицепс: 0.2 },
          },
          Плечи: {
            kw: [
              'жим сид',
              'жим плеч',
              'армей',
              'махи',
              'дельт',
              'плечи',
              'жим вверх',
              'отведение плеча',
              'отведение руки в сторону',
              'махи в сторону',
              'отведение гантели назад', // задняя дельта (НЕ трицепс!)
            ],
            def: { 'Передняя дельта': 0.35, 'Средняя дельта': 0.35, 'Задняя дельта': 0.3 },
          },
          Руки: {
            kw: [
              'бицепс',
              'трицепс',
              'сгиб рук',
              'разгиб рук',
              'французск',
              'молот',
              'на блоке',
              'кик-бэк',
              'разгибание предплечья',
              'разгибание плеча', // длинная головка трицепса (overhead)
            ],
            def: { Бицепс: 0.5, Трицепс: 0.5 },
          },
          Корпус: {
            kw: ['пресс', 'скручив', 'планк', 'кор', 'живот', 'подъём ног'],
            def: { Кор: 1.0 },
          },
        };

        for (const [cat, data] of Object.entries(patterns)) {
          if (data.kw.some((kw) => n.includes(kw))) {
            let coeffs = { ...data.def };

            // Уточнения
            if (cat === 'Ноги') {
              if (n.includes('сгиб') && !n.includes('рук')) coeffs = { 'Бицепс бедра': 1.0 };
              else if (n.includes('разгиб') && !n.includes('рук') && !n.includes('блок'))
                coeffs = { Квадрицепс: 1.0 };
              else if (n.includes('икр')) coeffs = { Икры: 1.0 };
              else if (n.includes('ягодиц')) coeffs = { Ягодицы: 0.7, 'Бицепс бедра': 0.3 };
            }
            if (cat === 'Руки') {
              if (n.includes('бицепс') || n.includes('молот') || n.includes('сгиб'))
                coeffs = { Бицепс: 1.0 };
              else if (
                n.includes('трицепс') ||
                n.includes('французск') ||
                n.includes('разгиб') ||
                n.includes('блок') ||
                n.includes('разгибание предплечья') ||
                n.includes('кик-бэк')
              )
                coeffs = { Трицепс: 1.0 };
            }
            if (cat === 'Плечи') {
              if (
                n.includes('отведение гантели назад') ||
                n.includes('махи в наклон') ||
                (n.includes('разведен') && n.includes('наклон'))
              )
                coeffs = { 'Задняя дельта': 0.9, 'Средняя дельта': 0.1 };
              else if (
                n.includes('отведение плеча') ||
                n.includes('махи в сторон') ||
                n.includes('отведение руки')
              )
                coeffs = { 'Средняя дельта': 0.7, 'Передняя дельта': 0.2, 'Задняя дельта': 0.1 };
            }
            if (cat === 'Спина') {
              if (n.includes('верхн') || n.includes('широч'))
                coeffs = { Широчайшие: 0.8, Бицепс: 0.2 };
              else if (n.includes('тяга') && n.includes('пояс'))
                coeffs = { Широчайшие: 0.5, Трапеция: 0.3, Бицепс: 0.2 };
            }

            return { coeffs, category: cat, fromMaster: false };
          }
        }

        // Жимы
        if (n.includes('жим') && !n.includes('ног')) {
          if (n.includes('лёж') || n.includes('леж')) {
            return {
              coeffs: { Грудь: 0.6, 'Передняя дельта': 0.2, Трицепс: 0.2 },
              category: 'Грудь',
              fromMaster: false,
            };
          }
        }

        // Разгибания - важно! "разгибания на блоке" = трицепс, "разгибания ног" = квадрицепс
        if (n.includes('разгиб')) {
          if (n.includes('блок') || n.includes('рук') || n.includes('одной')) {
            return { coeffs: { Трицепс: 1.0 }, category: 'Руки', fromMaster: false };
          } else if (n.includes('ног')) {
            return { coeffs: { Квадрицепс: 1.0 }, category: 'Ноги', fromMaster: false };
          }
        }

        return {
          coeffs: { Кор: 0.34, Квадрицепс: 0.33, Широчайшие: 0.33 },
          category: 'Другое',
          fromMaster: false,
        };
      }

      function generateDefaultCoeffs(category, subcategory = '') {
        // Если есть subcategory - используем точные коэффициенты
        const subcatDefaults = {
          // Руки - по подкатегории
          Трицепс: { Трицепс: 1.0 },
          Бицепс: { Бицепс: 1.0 },
          Предплечье: { Предплечье: 1.0 },
          // Ноги - по подкатегории
          Квадрицепс: { Квадрицепс: 0.7, Ягодицы: 0.2, 'Бицепс бедра': 0.1 },
          'Бицепс бедра': { 'Бицепс бедра': 0.7, Ягодицы: 0.2, Икры: 0.1 },
          Ягодицы: { Ягодицы: 0.6, 'Бицепс бедра': 0.25, Квадрицепс: 0.15 },
          Икры: { Икры: 1.0 },
          // Спина
          Широчайшие: { Широчайшие: 0.7, Бицепс: 0.2, Трапеция: 0.1 },
          Трапеция: { Трапеция: 0.8, 'Задняя дельта': 0.2 },
          Поясница: { Поясница: 0.8, Ягодицы: 0.2 },
          // Плечи
          'Передние дельты': { 'Передняя дельта': 0.8, 'Средняя дельта': 0.2 },
          'Средние дельты': { 'Средняя дельта': 0.8, 'Передняя дельта': 0.1, 'Задняя дельта': 0.1 },
          'Задние дельты': { 'Задняя дельта': 0.8, Трапеция: 0.2 },
          // Корпус
          Пресс: { Кор: 1.0 },
        };

        // Сначала проверяем subcategory
        if (subcategory && subcatDefaults[subcategory]) {
          return subcatDefaults[subcategory];
        }

        // Фоллбек на категорию
        const defaults = {
          Грудь: { Грудь: 0.6, 'Передняя дельта': 0.25, Трицепс: 0.15 },
          Спина: { Широчайшие: 0.5, Бицепс: 0.25, Трапеция: 0.15, 'Задняя дельта': 0.1 },
          Ноги: { Квадрицепс: 0.4, 'Бицепс бедра': 0.3, Ягодицы: 0.2, Икры: 0.1 },
          Плечи: {
            'Передняя дельта': 0.35,
            'Средняя дельта': 0.35,
            'Задняя дельта': 0.2,
            Трапеция: 0.1,
          },
          Руки: { Бицепс: 0.5, Трицепс: 0.5 },
          Корпус: { Кор: 1.0 },
          'Всё тело': { Квадрицепс: 0.2, Грудь: 0.2, Широчайшие: 0.2, Плечи: 0.2, Кор: 0.2 },
        };
        return defaults[category] || { Кор: 1.0 };
      }

      function calcMuscleLoad(coeffs, weight, reps) {
        const load = {};
        for (const [muscle, coeff] of Object.entries(coeffs)) {
          if (coeff > 0) {
            load[muscle] = (load[muscle] || 0) + weight * reps * coeff;
          }
        }
        return load;
      }

      function renderMuscleLoadPreview(idx, exerciseName, coeffs) {
        const exData = getExerciseCoeffs(exerciseName);
        const finalCoeffs = customCoeffs[idx] || coeffs || exData.coeffs;

        // Сортируем по значению
        const sorted = Object.entries(finalCoeffs)
          .filter(([, v]) => v > 0)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3); // Показываем топ-3

        if (sorted.length === 0) return '';

        return `
                <div class="muscle-load-preview">
                    <div class="muscle-load-title">
                        <span>📊 Нагрузка${!exData.fromMaster ? '<span class="muscle-ai-badge">(AI)</span>' : ''}</span>
                        <button class="edit-coeff-btn" onclick="event.stopPropagation(); openCoeffEditor(${idx}, '${exerciseName.replace(/'/g, "\\'")}')">✏️</button>
                    </div>
                    <div class="muscle-bars">
                        ${sorted
                          .map(([muscle, coeff]) => {
                            const pct = Math.round(coeff * 100);
                            const info = MUSCLE_GROUPS[muscle] || { color: 'core' };
                            return `
                                <div class="muscle-bar-row">
                                    <div class="muscle-bar-name">${muscle}</div>
                                    <div class="muscle-bar-track">
                                        <div class="muscle-bar-fill ${info.color}" style="width: ${pct}%"></div>
                                        <span class="muscle-bar-pct">${pct}%</span>
                                    </div>
                                </div>
                            `;
                          })
                          .join('')}
                    </div>
                </div>
            `;
      }

      function openCoeffEditor(idx, exerciseName) {
        currentEditingExercise = { idx, name: exerciseName };
        const exData = getExerciseCoeffs(exerciseName);
        const coeffs = customCoeffs[idx] || exData.coeffs;

        // Получаем категорию упражнения
        const ex = workoutState.parsedWorkout?.exercises?.[idx];
        const category = ex?.category || 'Другое';

        // Фильтруем мышцы по категории
        const CATEGORY_MUSCLES = {
          Руки: ['Грудь', 'Спина', 'Плечи', 'Руки'],
          Ноги: ['Спина', 'Ноги', 'Корпус'],
          Грудь: ['Грудь', 'Плечи', 'Руки', 'Корпус'],
          Спина: ['Спина', 'Плечи', 'Руки', 'Корпус'],
          Плечи: ['Грудь', 'Спина', 'Плечи', 'Руки', 'Корпус'],
          Корпус: ['Грудь', 'Спина', 'Плечи', 'Руки', 'Ноги', 'Корпус'],
          'Всё тело': ['Грудь', 'Спина', 'Плечи', 'Руки', 'Ноги', 'Корпус'],
          Другое: ['Грудь', 'Спина', 'Плечи', 'Руки', 'Ноги', 'Корпус'],
        };

        const allowedGroups = CATEGORY_MUSCLES[category] || CATEGORY_MUSCLES['Другое'];

        // Группируем мышцы с фильтрацией
        const groups = {};
        for (const [muscle, info] of Object.entries(MUSCLE_GROUPS)) {
          const g = info.group;
          if (!allowedGroups.includes(g)) continue;

          if (!groups[g]) groups[g] = [];
          groups[g].push({ muscle, value: coeffs[muscle] || 0 });
        }

        let html = `
                <div class="coeff-info-box">
                    💡 Настройте распределение для "<strong>${exerciseName}</strong>" (${category}). Сумма = 100%.
                </div>
                <div class="coeff-sum-box valid" id="coeffSumBox">Сумма: 100%</div>
            `;

        for (const [groupName, muscles] of Object.entries(groups)) {
          html += `
                    <div class="coeff-group">
                        <div class="coeff-group-title">${groupName}</div>
                        ${muscles
                          .map(
                            (m) => `
                            <div class="coeff-row">
                                <div class="coeff-muscle-name">${m.muscle}</div>
                                <div class="coeff-slider-wrap">
                                    <input type="range" class="coeff-slider" 
                                           data-muscle="${m.muscle}"
                                           min="0" max="100" value="${Math.round(m.value * 100)}"
                                           oninput="onCoeffSlider(this)">
                                    <input type="number" class="coeff-input"
                                           data-muscle="${m.muscle}"
                                           min="0" max="100" value="${Math.round(m.value * 100)}"
                                           oninput="onCoeffInput(this)">
                                </div>
                            </div>
                        `
                          )
                          .join('')}
                    </div>
                `;
        }

        document.getElementById('coeffEditorBody').innerHTML = html;
        document.getElementById('coeffEditorModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        updateCoeffSum();
      }

      function closeCoeffEditor() {
        document.getElementById('coeffEditorModal').classList.remove('active');
        document.body.style.overflow = '';
        currentEditingExercise = null;
      }

      function onCoeffSlider(slider) {
        const muscle = slider.dataset.muscle;
        const newValue = parseInt(slider.value);
        const input = document.querySelector(`.coeff-input[data-muscle="${muscle}"]`);

        if (input) input.value = newValue;

        // Автоперераспределение для поддержания 100%
        redistributeCoeffs(muscle, newValue);
      }

      function onCoeffInput(input) {
        const muscle = input.dataset.muscle;
        const newValue = Math.min(100, Math.max(0, parseInt(input.value) || 0));
        const slider = document.querySelector(`.coeff-slider[data-muscle="${muscle}"]`);

        input.value = newValue;
        if (slider) slider.value = newValue;

        // Автоперераспределение для поддержания 100%
        redistributeCoeffs(muscle, newValue);
      }

      // Автоматическое перераспределение коэффициентов
      // Гарантирует сумму = 100% после каждого изменения
      function redistributeCoeffs(changedMuscle, newValue) {
        const allInputs = document.querySelectorAll('.coeff-input');

        // Собираем остальные мышцы с ненулевыми значениями
        const others = [];
        let othersSum = 0;

        allInputs.forEach((inp) => {
          if (inp.dataset.muscle !== changedMuscle) {
            const val = parseInt(inp.value) || 0;
            if (val > 0) {
              others.push({ muscle: inp.dataset.muscle, value: val });
              othersSum += val;
            }
          }
        });

        // Сколько остаётся для распределения
        const remaining = 100 - newValue;

        if (remaining <= 0) {
          // Всё забрала одна мышца - обнуляем остальные
          others.forEach((item) => {
            const inp = document.querySelector(`.coeff-input[data-muscle="${item.muscle}"]`);
            const slid = document.querySelector(`.coeff-slider[data-muscle="${item.muscle}"]`);
            if (inp) inp.value = 0;
            if (slid) slid.value = 0;
          });
        } else if (othersSum > 0) {
          // Пропорционально распределяем remaining между остальными
          // Формула: newVal = oldVal * (remaining / othersSum)
          let distributed = 0;

          for (let i = 0; i < others.length; i++) {
            const item = others[i];
            let newVal;

            if (i === others.length - 1) {
              // Последний элемент получает остаток (избегаем ошибок округления)
              newVal = remaining - distributed;
            } else {
              newVal = Math.round((item.value * remaining) / othersSum);
            }

            newVal = Math.max(0, Math.min(100, newVal));
            distributed += newVal;

            const inp = document.querySelector(`.coeff-input[data-muscle="${item.muscle}"]`);
            const slid = document.querySelector(`.coeff-slider[data-muscle="${item.muscle}"]`);
            if (inp) inp.value = newVal;
            if (slid) slid.value = newVal;
          }
        }

        updateCoeffSum();
      }

      function updateCoeffSum() {
        const inputs = document.querySelectorAll('.coeff-input');
        let sum = 0;
        inputs.forEach((i) => (sum += parseInt(i.value) || 0));

        const box = document.getElementById('coeffSumBox');
        if (box) {
          box.textContent = `Сумма: ${sum}%`;
          box.className = sum === 100 ? 'coeff-sum-box valid' : 'coeff-sum-box invalid';
        }
      }

      function resetCoeffEditor() {
        if (!currentEditingExercise) return;
        delete customCoeffs[currentEditingExercise.idx];
        openCoeffEditor(currentEditingExercise.idx, currentEditingExercise.name);
      }

      function applyCoeffEditor() {
        if (!currentEditingExercise) return;

        const inputs = document.querySelectorAll('.coeff-input');
        let sum = 0;
        inputs.forEach((i) => (sum += parseInt(i.value) || 0));

        if (sum !== 100) {
          showToast('Сумма должна быть 100%', 'error');
          return;
        }

        const newCoeffs = {};
        inputs.forEach((i) => {
          const val = parseInt(i.value) || 0;
          if (val > 0) {
            newCoeffs[i.dataset.muscle] = val / 100;
          }
        });

        customCoeffs[currentEditingExercise.idx] = newCoeffs;
        closeCoeffEditor();
        renderWorkoutPreview();
        showToast('Коэффициенты сохранены', 'success');
      }

      function editExercise(idx) {
        if (!workoutState.parsedWorkout || !workoutState.parsedWorkout.exercises) {
          showToast('Сначала распознайте тренировку', 'error');
          return;
        }

        const ex = workoutState.parsedWorkout.exercises[idx];
        if (!ex) return;

        const editForm = document.getElementById('editExerciseForm');
        const editIdx = document.getElementById('editExerciseIdx');
        const editName = document.getElementById('editExerciseName');
        const setsContainer = document.getElementById('editSetsContainer');

        if (!editForm || !editIdx || !editName || !setsContainer) {
          console.error('Edit form elements not found!');
          return;
        }

        editIdx.value = idx;
        editName.value = ex.name;

        // Подсвечиваем редактируемое упражнение
        document
          .querySelectorAll('.parsed-exercise')
          .forEach((el) => el.classList.remove('editing'));
        const exerciseEl = document.getElementById(`exercise_${idx}`);
        if (exerciseEl) exerciseEl.classList.add('editing');

        // Рендерим подходы
        setsContainer.innerHTML =
          ex.sets
            .map(
              (s, setIdx) => `
                <div class="edit-set-row" data-set-idx="${setIdx}">
                    <input type="number" class="metric-input small" value="${s.weight}" step="2.5" placeholder="Вес">
                    <span>×</span>
                    <input type="number" class="metric-input small" value="${s.reps}" placeholder="Повторы">
                    <button type="button" class="btn-icon" onclick="removeEditSet(${setIdx})">🗑️</button>
                </div>
            `
            )
            .join('') +
          `
                <button type="button" class="btn btn-outline" onclick="addEditSet()" style="margin-top: 8px;">➕ Подход</button>
            `;

        editForm.style.display = 'block';
        const addForm = document.getElementById('addExerciseForm');
        if (addForm) addForm.style.display = 'none';

        // Скроллим к форме
        setTimeout(() => {
          editForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }

      function addEditSet() {
        const container = document.getElementById('editSetsContainer');
        const addBtn = container.querySelector('.btn-outline');
        const setIdx = container.querySelectorAll('.edit-set-row').length;

        const newRow = document.createElement('div');
        newRow.className = 'edit-set-row';
        newRow.dataset.setIdx = setIdx;
        newRow.innerHTML = `
                <input type="number" class="metric-input small" value="" step="2.5" placeholder="Вес">
                <span>×</span>
                <input type="number" class="metric-input small" value="" placeholder="Повторы">
                <button type="button" class="btn-icon" onclick="this.parentElement.remove()">🗑️</button>
            `;

        container.insertBefore(newRow, addBtn);
      }

      function removeEditSet(setIdx) {
        const row = document.querySelector(`.edit-set-row[data-set-idx="${setIdx}"]`);
        if (row) row.remove();
      }

      function cancelEditExercise() {
        document.getElementById('editExerciseForm').style.display = 'none';
        document
          .querySelectorAll('.parsed-exercise')
          .forEach((el) => el.classList.remove('editing'));
      }

      function saveEditExercise() {
        const idx = parseInt(document.getElementById('editExerciseIdx').value);
        const name = document.getElementById('editExerciseName').value.trim();

        if (!name) {
          showToast('Введите название', 'error');
          return;
        }

        // Собираем подходы
        const sets = [];
        document.querySelectorAll('.edit-set-row').forEach((row) => {
          const inputs = row.querySelectorAll('input');
          const weight = parseFloat(inputs[0].value) || 0;
          const reps = parseInt(inputs[1].value) || 0;
          if (reps > 0) {
            sets.push({ weight, reps });
          }
        });

        if (sets.length === 0) {
          showToast('Добавьте хотя бы один подход', 'error');
          return;
        }

        // Обновляем
        workoutState.parsedWorkout.exercises[idx] = {
          ...workoutState.parsedWorkout.exercises[idx],
          name: capitalizeFirst(name),
          sets,
        };

        cancelEditExercise();
        renderWorkoutPreview();
        showToast('✅ Упражнение обновлено', 'success');
      }

      function editSet(exerciseIdx, setIdx) {
        // Быстрое редактирование одного подхода - открываем полную форму
        editExercise(exerciseIdx);
      }

      function addSetToExercise(exerciseIdx) {
        const ex = workoutState.parsedWorkout.exercises[exerciseIdx];
        if (!ex) return;

        // Добавляем пустой подход (копируем последний вес)
        const lastWeight = ex.sets.length > 0 ? ex.sets[ex.sets.length - 1].weight : 0;
        ex.sets.push({ weight: lastWeight, reps: 0 });

        // Открываем редактирование
        editExercise(exerciseIdx);
      }

      function showAddExercise() {
        document.getElementById('addExerciseForm').style.display = 'block';
        document.getElementById('editExerciseForm').style.display = 'none';
        document.getElementById('newExerciseName').focus();
      }

      function hideAddExercise() {
        document.getElementById('addExerciseForm').style.display = 'none';
        document.getElementById('newExerciseName').value = '';
        document.getElementById('newExerciseWeight').value = '';
        document.getElementById('newExerciseReps').value = '';
      }

      function clearWorkout() {
        if (!workoutState.parsedWorkout?.exercises?.length) {
          showToast('Нечего очищать', 'info');
          return;
        }

        if (confirm('Очистить все упражнения?')) {
          workoutState.parsedWorkout = null;
          workoutState.workoutName = '';
          workoutState.workoutRPE = null;
          workoutState.workoutDate = null;
          customCoeffs = {}; // Сбрасываем кастомные коэффициенты

          document.getElementById('workoutTextInput').value = '';
          const notesInput = document.getElementById('workoutNotesInput');
          if (notesInput) notesInput.value = '';
          document.getElementById('workoutPreview').style.display = 'none';
          showToast('Тренировка очищена', 'info');
        }
      }

      function addExerciseToWorkout() {
        const name = document.getElementById('newExerciseName').value.trim();
        const weight = parseFloat(document.getElementById('newExerciseWeight').value) || 0;
        const reps = parseInt(document.getElementById('newExerciseReps').value) || 0;

        if (!name) {
          showToast('Введите название упражнения', 'error');
          return;
        }

        if (reps <= 0) {
          showToast('Введите количество повторений', 'error');
          return;
        }

        // Получаем данные из базы
        const dbEx = getExerciseFromDB(name);
        const newExercise = {
          name: capitalizeFirst(name),
          sets: [{ weight, reps }],
          category: dbEx?.category || 'Другое',
          laterality: dbEx?.laterality || 'bilateral',
          unilateral: dbEx?.laterality === 'alwaysUnilateral' || false,
          equipment: '',
          position: '',
        };

        workoutState.parsedWorkout.exercises.push(newExercise);

        hideAddExercise();
        renderWorkoutPreview();
        showToast('✅ Упражнение добавлено', 'success');
      }

      function removeExercise(idx) {
        if (workoutState.parsedWorkout && workoutState.parsedWorkout.exercises) {
          workoutState.parsedWorkout.exercises.splice(idx, 1);
          renderWorkoutPreview();
        }
      }

      async function saveWorkout() {
        if (!workoutState.parsedWorkout || !currentClient) return;
        if (window._saveWorkoutInProgress) {
          if (typeof showToast === 'function') showToast('Сохранение уже идёт, подождите…', 'info');
          return;
        }
        window._saveWorkoutInProgress = true;

        // Получаем название, RPE и комментарий
        const workoutName = document.getElementById('workoutNameInput')?.value.trim() || '';
        const workoutRPE = workoutState.workoutRPE || 0;
        const workoutNotes = document.getElementById('workoutNotesInput')?.value.trim() || '';

        // Формируем notes: RPE + комментарий
        let notesText = '';
        if (workoutRPE) notesText += `RPE: ${workoutRPE}`;
        if (workoutNotes) {
          if (notesText) notesText += '. ';
          notesText += workoutNotes;
        }

        // Проверяем режим редактирования
        const isEditing = !!workoutState.editingSessionId;

        try {
          showLoading(isEditing ? 'Обновление...' : 'Сохранение...');

          // Если редактируем - удаляем старую сессию
          if (isEditing) {
            try {
              // Пытаемся удалить старую сессию
              await apiCall('deleteSession', {
                clientId: currentClient.id,
                sessionId: workoutState.editingSessionId,
              });
              console.log('Удалена старая сессия:', workoutState.editingSessionId);
            } catch (e) {
              // Если deleteSession не поддерживается - показываем предупреждение
              console.warn('deleteSession не поддерживается, создаём новую сессию:', e);
              showToast('⚠️ Создана новая запись (удаление старой не поддерживается)', 'warning');
            }
          }

          // Сначала добавляем новые упражнения в exercises_master
          for (const ex of workoutState.parsedWorkout.exercises) {
            const isNew = !getExerciseFromDB(ex.name);
            if (isNew) {
              try {
                await apiCall('addExercise', {
                  name: ex.name,
                  category: ex.category || 'Другое',
                  equipment: ex.equipment || '',
                  notes: '📱 Добавлено из трекера',
                });
                console.log('Добавлено новое упражнение:', ex.name);
              } catch (e) {
                console.warn('Не удалось добавить упражнение:', ex.name, e);
              }
            }
          }

          // Start session
          const workoutDate =
            document.getElementById('workoutDateInput')?.value ||
            new Date().toISOString().split('T')[0];
          const sessionResult = await apiCall('startSession', {
            clientId: currentClient.id,
            date: workoutDate,
            splitType: workoutName,
            notes: notesText,
          });

          const sessionId = sessionResult.sessionId;

          // Add each exercise
          for (const ex of workoutState.parsedWorkout.exercises) {
            // Генерируем exerciseId из базового названия
            const exerciseId = generateExerciseId(ex.name);

            // Формируем полное название с вариациями
            let fullName = ex.name;
            const variations = [];
            if (ex.equipment) variations.push(ex.equipment);
            if (ex.position) variations.push(ex.position);
            if (variations.length > 0) {
              fullName += ' (' + variations.join(', ') + ')';
            }

            // Расчёт веса
            const isDumbbell = ex.equipment === 'гантели';
            const isBilateral = !ex.unilateral;
            const isBodyweight =
              ex.equipment === 'свой вес' ||
              (!ex.equipment && ex.sets.every((s) => !s.weight || s.weight === 0));

            // Получаем bodyweightRatio из базы
            const dbEx = getExerciseFromDB(ex.name);
            const bodyweightRatio = dbEx?.bodyweightRatio || 0.65; // дефолт 65%

            // Множитель: гантели bilateral → вес × 2
            const weightMultiplier = isDumbbell && isBilateral ? 2 : 1;

            for (const set of ex.sets) {
              let effectiveWeight;

              if (isBodyweight && (!set.weight || set.weight === 0)) {
                // Bodyweight: используем вес клиента × коэффициент
                effectiveWeight = Math.round(clientWeight * bodyweightRatio);
              } else {
                effectiveWeight = (set.weight || 0) * weightMultiplier;
              }

              await apiCall('addSet', {
                clientId: currentClient.id,
                sessionId,
                exerciseId: exerciseId,
                exerciseName: fullName,
                category: ex.category || 'Другое',
                weight: effectiveWeight,
                reps: set.reps || 0,
                equipment: ex.equipment || '',
                unilateral: ex.unilateral || false,
              });
            }
          }

          // End session with RPE
          await apiCall('finishSession', {
            clientId: currentClient.id,
            sessionId,
            rating: workoutRPE,
          });

          // Логируем выполнение обязательных задач
          const checkedTasks = getCheckedMandatoryTasks();
          if (checkedTasks.length > 0) {
            try {
              // Получаем blockId из текущего блока
              const blockData = await apiCall('getActiveBlock', { clientId: currentClient.id });
              const blockId = blockData.block?.blockId || 1;

              await apiCall('logMandatoryTaskCompletion', {
                clientId: currentClient.id,
                sessionId,
                blockId,
                tasks: checkedTasks.map((t) => ({
                  taskId: t.taskId,
                  taskName: t.taskName,
                  completed: t.completed,
                })),
              });
              console.log('Обязательные задачи залогированы');
            } catch (e) {
              console.warn('Не удалось залогировать задачи:', e);
            }
          }

          hideLoading();

          // Вычисляем статистику тренировки ДО сброса
          const workoutStats = calculateWorkoutStats(
            workoutState.parsedWorkout,
            workoutName,
            workoutRPE
          );

          // Показываем итоги
          showWorkoutSummary(workoutStats);

          // Reset and refresh
          workoutState.parsedWorkout = null;
          workoutState.workoutName = '';
          workoutState.workoutRPE = 0;
          workoutState.workoutDate = null;
          workoutState.editingSessionId = null; // Сбрасываем режим редактирования
          customCoeffs = {}; // Сбрасываем кастомные коэффициенты

          document.getElementById('workoutTextInput').value = '';
          document.getElementById('workoutNotesInput').value = '';
          document.getElementById('workoutPreview').style.display = 'none';
          await renderWorkoutsModule();
        } catch (error) {
          hideLoading();
          showToast('Ошибка: ' + error.message, 'error');
        } finally {
          window._saveWorkoutInProgress = false;
        }
      }

      // Генерация exerciseId из русского названия (транслитерация)
      function generateExerciseId(name) {
        const translit = {
          а: 'a',
          б: 'b',
          в: 'v',
          г: 'g',
          д: 'd',
          е: 'e',
          ё: 'yo',
          ж: 'zh',
          з: 'z',
          и: 'i',
          й: 'y',
          к: 'k',
          л: 'l',
          м: 'm',
          н: 'n',
          о: 'o',
          п: 'p',
          р: 'r',
          с: 's',
          т: 't',
          у: 'u',
          ф: 'f',
          х: 'kh',
          ц: 'ts',
          ч: 'ch',
          ш: 'sh',
          щ: 'shch',
          ъ: '',
          ы: 'y',
          ь: '',
          э: 'e',
          ю: 'yu',
          я: 'ya',
        };

        return name
          .toLowerCase()
          .split('')
          .map((char) => translit[char] || char)
          .join('')
          .replace(/[^a-z0-9]/g, '_')
          .replace(/_+/g, '_')
          .replace(/^_|_$/g, '');
      }

      // Вычисление статистики тренировки
      function calculateWorkoutStats(workout, name, rpe) {
        if (!workout || !workout.exercises) return null;

        let totalVolume = 0;
        let totalSets = 0;
        let totalReps = 0;
        const exerciseStats = [];

        for (const ex of workout.exercises) {
          let exVolume = 0;
          let exSets = ex.sets.length;
          let exReps = 0;

          // Расчёт множителя для гантелей
          const isDumbbell = ex.equipment === 'гантели';
          const isBilateral = !ex.unilateral;
          const weightMultiplier = isDumbbell && isBilateral ? 2 : 1;

          for (const set of ex.sets) {
            const effectiveWeight = (set.weight || 0) * weightMultiplier;
            const reps = set.reps || 0;
            exVolume += effectiveWeight * reps;
            exReps += reps;
          }

          totalVolume += exVolume;
          totalSets += exSets;
          totalReps += exReps;

          exerciseStats.push({
            name: ex.name,
            equipment: ex.equipment,
            sets: exSets,
            reps: exReps,
            volume: exVolume,
          });
        }

        return {
          name: name || 'Тренировка',
          rpe: rpe,
          exerciseCount: workout.exercises.length,
          totalSets,
          totalReps,
          totalVolume,
          exercises: exerciseStats,
        };
      }

      // Показ итогов тренировки
      function showWorkoutSummary(stats) {
        if (!stats) {
          showToast('🎉 Тренировка сохранена!', 'success');
          return;
        }

        const volumeText =
          stats.totalVolume > 1000
            ? (stats.totalVolume / 1000).toFixed(1) + ' т'
            : stats.totalVolume.toFixed(0) + ' кг';

        const modal = document.createElement('div');
        modal.className = 'modal-overlay active';
        modal.id = 'workoutSummaryModal';
        modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>🎉 Тренировка сохранена!</h3>
                        <button type="button" class="modal-close" onclick="closeWorkoutSummary()">×</button>
                    </div>
                    <div class="modal-content">
                        <div class="summary-title">${stats.name}</div>
                        
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="summary-stat-value">${stats.exerciseCount}</div>
                                <div class="summary-stat-label">упражнений</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-stat-value">${stats.totalSets}</div>
                                <div class="summary-stat-label">подходов</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-stat-value">${stats.totalReps}</div>
                                <div class="summary-stat-label">повторений</div>
                            </div>
                        </div>
                        
                        <div class="summary-volume">
                            <div class="summary-volume-label">Общий объём</div>
                            <div class="summary-volume-value">${volumeText}</div>
                        </div>
                        
                        ${
                          stats.rpe
                            ? `
                            <div class="summary-rpe">
                                <span>Интенсивность:</span>
                                <span class="rpe-value">RPE ${stats.rpe}</span>
                            </div>
                        `
                            : ''
                        }
                        
                        <div class="summary-exercises">
                            ${stats.exercises
                              .map(
                                (ex) => `
                                <div class="summary-exercise">
                                    <span class="ex-name">${ex.name}</span>
                                    <span class="ex-detail">${ex.sets}×${Math.round(ex.reps / ex.sets)} · ${ex.volume > 0 ? (ex.volume > 1000 ? (ex.volume / 1000).toFixed(1) + 'т' : ex.volume.toFixed(0) + 'кг') : '—'}</span>
                                </div>
                            `
                              )
                              .join('')}
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="closeWorkoutSummary()">Отлично! 💪</button>
                    </div>
                </div>
            `;

        // Блокируем скролл фона
        document.body.style.overflow = 'hidden';
        document.body.appendChild(modal);
      }

      function closeWorkoutSummary() {
        const modal = document.getElementById('workoutSummaryModal');
        if (modal) modal.remove();
        // Восстанавливаем скролл фона
        document.body.style.overflow = '';
      }

      // Manual exercise input
      function renderCategoryFilter() {
        const categories = ['Все', 'Грудь', 'Спина', 'Ноги', 'Плечи', 'Руки', 'Корпус'];
        const container = document.getElementById('categoryFilter');
        if (!container) return;

        container.innerHTML = categories
          .map(
            (cat) => `
                <button class="category-btn ${cat === 'Все' ? 'active' : ''}" 
                        onclick="filterByCategory('${cat}')">${cat}</button>
            `
          )
          .join('');
      }

      function filterByCategory(category) {
        document.querySelectorAll('.category-btn').forEach((btn) => {
          btn.classList.toggle('active', btn.textContent === category);
        });
        renderExerciseList(category === 'Все' ? null : category);
      }

      function filterExercises() {
        const query = document.querySelector('.exercise-search-input')?.value || '';
        renderExerciseList(null, query);
      }

      function renderExerciseList(category = null, search = '') {
        const container = document.getElementById('exerciseList');
        if (!container) return;

        let filtered = exercises;

        if (category) {
          filtered = filtered.filter((e) => e.category === category);
        }

        if (search) {
          const q = search.toLowerCase();
          filtered = filtered.filter((e) => e.name.toLowerCase().includes(q));
        }

        container.innerHTML =
          filtered
            .slice(0, 30)
            .map(
              (ex) => `
                <div class="exercise-list-item" onclick="selectExercise('${ex.id}')">
                    <span>${ex.name}</span>
                    <span style="color: var(--text-secondary); font-size: 0.8em;">${ex.category}</span>
                </div>
            `
            )
            .join('') ||
          '<p style="padding: 20px; text-align: center; color: var(--text-secondary);">Не найдено</p>';
      }

      // ═══════════════════════════════════════════════════════════
      // VOICE INPUT
      // ═══════════════════════════════════════════════════════════

      let recognition = null;
      let isRecording = false;

      function toggleVoice() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          showToast('Голосовой ввод не поддерживается', 'error');
          return;
        }

        if (isRecording) {
          stopVoice();
        } else {
          startVoice();
        }
      }

      function startVoice() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU';
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = 0; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          document.getElementById('workoutTextInput').value = transcript;
        };

        recognition.onerror = () => {
          stopVoice();
          showToast('Ошибка распознавания', 'error');
        };

        recognition.onend = () => {
          stopVoice();
        };

        recognition.start();
        isRecording = true;
        document.getElementById('voiceBtn').classList.add('recording');
      }

      function stopVoice() {
        if (recognition) {
          recognition.stop();
        }
        isRecording = false;
        document.getElementById('voiceBtn')?.classList.remove('recording');
      }

      // ═══════════════════════════════════════════════════════════
      // SETTINGS
      // ═══════════════════════════════════════════════════════════

      function openSettings() {
        const modal = document.getElementById('settingsModal');
        const input = document.getElementById('apiUrlInput');

        if (!modal) {
          alert('Ошибка: модальное окно не найдено');
          return;
        }

        if (input) {
          input.value = CONFIG.API_URL || '';
        }

        modal.style.display = 'flex';
        modal.classList.add('active');
      }

      function closeSettings() {
        const modal = document.getElementById('settingsModal');
        if (modal) {
          modal.style.display = 'none';
          modal.classList.remove('active');
        }
      }

      function saveSettings() {
        const apiUrl = document.getElementById('apiUrlInput').value.trim();

        if (!apiUrl) {
          showToast('Введите API URL', 'error');
          return;
        }

        CONFIG.API_URL = apiUrl;
        localStorage.setItem('api_url', apiUrl);

        closeSettings();
        showToast('✅ Настройки сохранены', 'success');

        // Reload clients
        loadClients();
      }

      // ═══════════════════════════════════════════════════════════
      // UTILITIES
      // ═══════════════════════════════════════════════════════════

      function showLoading(text = 'Загрузка...') {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingOverlay').classList.add('active');
      }

      function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
      }

      function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;

        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      function formatDate(dateStr) {
        if (!dateStr) return '—';
        const date = new Date(dateStr);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (date.toDateString() === today.toDateString()) {
          return 'Сегодня';
        } else if (date.toDateString() === yesterday.toDateString()) {
          return 'Вчера';
        }

        return date.toLocaleDateString('ru-RU', {
          day: 'numeric',
          month: 'short',
        });
      }

      function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength).trim() + '...';
      }

      async function viewWorkout(sessionId) {
        try {
          showLoading('Загрузка...');

          const result = await apiCall('getSessionDetails', {
            clientId: currentClient.id,
            sessionId: sessionId,
          });

          hideLoading();

          if (!result.session) {
            showToast('Тренировка не найдена', 'error');
            return;
          }

          const session = result.session;
          const exercises = result.exercises || [];

          // Заголовок
          document.getElementById('workoutDetailsTitle').textContent =
            `📋 ${session.splitType || 'Тренировка'} — ${session.date}`;

          // Контент
          const content = document.getElementById('workoutDetailsContent');

          content.innerHTML = `
                    <!-- Метаданные -->
                    <div class="workout-details-meta">
                        <div class="workout-meta-item">
                            <span class="workout-meta-label">Дата</span>
                            <span class="workout-meta-value">${session.date}</span>
                        </div>
                        ${
                          session.totalVolume
                            ? `
                            <div class="workout-meta-item">
                                <span class="workout-meta-label">Объём</span>
                                <span class="workout-meta-value">${formatVolume(session.totalVolume)}</span>
                            </div>
                        `
                            : ''
                        }
                        ${
                          session.rating
                            ? `
                            <div class="workout-meta-item">
                                <span class="workout-meta-label">RPE</span>
                                <span class="workout-meta-value">${session.rating}/10</span>
                            </div>
                        `
                            : ''
                        }
                        <div class="workout-meta-item">
                            <span class="workout-meta-label">Упражнений</span>
                            <span class="workout-meta-value">${exercises.length}</span>
                        </div>
                    </div>
                    
                    ${
                      session.notes
                        ? `
                        <div class="workout-notes">
                            <div class="workout-notes-label">📝 Заметки</div>
                            ${session.notes}
                        </div>
                    `
                        : ''
                    }
                    
                    <!-- Упражнения -->
                    <div class="workout-exercise-list">
                        ${exercises
                          .map(
                            (ex, exIdx) => `
                            <div class="workout-exercise-item" data-exercise-id="${ex.exerciseId}">
                                <div class="workout-exercise-header">
                                    <span class="workout-exercise-name">${ex.name}</span>
                                    <span class="workout-exercise-category">${ex.category || 'Другое'}</span>
                                </div>
                                <div class="workout-sets-list">
                                    ${ex.sets
                                      .map(
                                        (s) => `
                                        <span class="workout-set-badge">
                                            ${s.weight > 0 ? `<span class="weight">${s.weight}</span>×` : ''}
                                            ${s.reps}${s.weight === 0 ? ' раз' : ''}
                                        </span>
                                    `
                                      )
                                      .join('')}
                                </div>
                            </div>
                        `
                          )
                          .join('')}
                    </div>
                    
                    <!-- Кнопка редактирования -->
                    <button class="btn btn-outline" onclick="editHistoricalWorkout('${sessionId}')">
                        ✏️ Редактировать тренировку
                    </button>
                `;

          // Сохраняем данные для редактирования
          workoutState.viewingSession = { sessionId, session, exercises };

          // Показываем модальное окно
          const modal = document.getElementById('workoutDetailsModal');
          modal.style.display = 'flex';
          modal.classList.add('active');
        } catch (error) {
          hideLoading();
          showToast('Ошибка загрузки: ' + error.message, 'error');
        }
      }

      function closeWorkoutDetails() {
        const modal = document.getElementById('workoutDetailsModal');
        modal.style.display = 'none';
        modal.classList.remove('active');
      }

      function editHistoricalWorkout(sessionId) {
        if (!workoutState.viewingSession) {
          showToast('Ошибка загрузки данных', 'error');
          return;
        }

        const { session, exercises } = workoutState.viewingSession;

        // Преобразуем в формат для редактирования
        workoutState.parsedWorkout = {
          exercises: exercises.map((ex) => ({
            name: ex.name.replace(/\s*\([^)]*\)\s*$/, ''), // Убираем вариации из названия
            category: ex.category,
            equipment: '',
            position: '',
            unilateral: false,
            sets: ex.sets.map((s) => ({
              weight: s.weight || 0,
              reps: s.reps || 0,
            })),
          })),
        };

        workoutState.workoutName = session.splitType || '';
        workoutState.workoutRPE = session.rating || 0;
        workoutState.workoutDate = session.date || new Date().toISOString().split('T')[0];
        workoutState.editingSessionId = sessionId; // Для обновления вместо создания новой

        // Закрываем модальное окно просмотра
        closeWorkoutDetails();

        // Отрисовываем preview для редактирования
        renderWorkoutPreview();

        // Заполняем поле названия
        const nameInput = document.getElementById('workoutNameInput');
        if (nameInput) nameInput.value = workoutState.workoutName;

        showToast('Редактирование тренировки', 'info');
      }

      function formatVolume(volume) {
        if (volume >= 1000) {
          return (volume / 1000).toFixed(1) + ' т';
        }
        return volume + ' кг';
      }

      function selectExercise(exerciseId) {
        // TODO: Add exercise to workout
        const ex = exercises.find((e) => e.id === exerciseId);
        if (ex) {
          showToast('Выбрано: ' + ex.name, 'info');
        }
      }

      // ═══════════════════════════════════════════════════════════
      // НОВЫЙ БЛОК - МОДАЛКА
      // ═══════════════════════════════════════════════════════════

      function showNewBlockModal() {
        // Получаем текущие обязательные задачи для предзаполнения
        const tasksHtml = getMandatoryTasksForModal();

        const modalHtml = `
                <div class="modal-overlay" id="newBlockModal" style="display:flex;" onclick="closeNewBlockModal(event)">
                    <div class="modal-content new-block-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>📦 Новый тренировочный блок</h2>
                            <button class="modal-close" onclick="closeNewBlockModal()">✕</button>
                        </div>
                        
                        <div class="modal-body">
                            <div class="form-section">
                                <label class="form-label">Количество тренировок</label>
                                <input type="number" class="form-input" id="newBlockSessions" 
                                       value="10" min="1" max="50">
                            </div>
                            
                            <div class="form-section">
                                <label class="form-label">Стоимость блока ($)</label>
                                <input type="number" class="form-input" id="newBlockPrice" 
                                       placeholder="0" min="0">
                            </div>
                            
                            <div class="form-section">
                                <label class="form-label">Заметки</label>
                                <input type="text" class="form-input" id="newBlockNotes" 
                                       placeholder="Блок 2, февраль...">
                            </div>
                            
                            <div class="form-divider"></div>
                            
                            <div class="form-section">
                                <label class="form-label">✅ Обязательные задачи (1-3)</label>
                                <p class="form-hint">Задачи, которые нужно выполнять каждую тренировку</p>
                                
                                <div class="task-inputs">
                                    <div class="task-input-row">
                                        <input type="text" class="form-input" id="task1Name" 
                                               placeholder="Задача 1 (напр. Выход силой через две руки)">
                                        <select class="form-input task-type" id="task1Type">
                                            <option value="Навык">Навык</option>
                                            <option value="Выход">Выход</option>
                                            <option value="Разминка">Разминка</option>
                                            <option value="Заминка">Заминка</option>
                                            <option value="Растяжка">Растяжка</option>
                                            <option value="ЛФК">ЛФК</option>
                                            <option value="Контроль">Контроль</option>
                                            <option value="Осанка">Осанка</option>
                                            <option value="Другое">Другое</option>
                                        </select>
                                    </div>
                                    <div class="task-input-row">
                                        <input type="text" class="form-input" id="task2Name" 
                                               placeholder="Задача 2 (опционально)">
                                        <select class="form-input task-type" id="task2Type">
                                            <option value="Навык">Навык</option>
                                            <option value="Выход">Выход</option>
                                            <option value="Разминка">Разминка</option>
                                            <option value="Заминка">Заминка</option>
                                            <option value="Растяжка">Растяжка</option>
                                            <option value="ЛФК">ЛФК</option>
                                            <option value="Контроль">Контроль</option>
                                            <option value="Осанка">Осанка</option>
                                            <option value="Другое">Другое</option>
                                        </select>
                                    </div>
                                    <div class="task-input-row">
                                        <input type="text" class="form-input" id="task3Name" 
                                               placeholder="Задача 3 (опционально)">
                                        <select class="form-input task-type" id="task3Type">
                                            <option value="Навык">Навык</option>
                                            <option value="Выход">Выход</option>
                                            <option value="Разминка">Разминка</option>
                                            <option value="Заминка">Заминка</option>
                                            <option value="Растяжка">Растяжка</option>
                                            <option value="ЛФК">ЛФК</option>
                                            <option value="Контроль">Контроль</option>
                                            <option value="Осанка">Осанка</option>
                                            <option value="Другое">Другое</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeNewBlockModal()">Отмена</button>
                            <button class="btn btn-primary" onclick="saveNewBlock()">
                                ✅ Создать блок
                            </button>
                        </div>
                    </div>
                </div>
            `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Предзаполняем задачи если есть текущие
        prefillMandatoryTasks();
      }

      function getMandatoryTasksForModal() {
        // Будет использоваться для предзаполнения
        return '';
      }

      function prefillMandatoryTasks() {
        // Если есть текущие mandatory tasks - предзаполняем
        // (можно загрузить через API или использовать кэшированные)
      }

      function closeNewBlockModal(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('newBlockModal');
        if (modal) modal.remove();
      }

      async function saveNewBlock() {
        const sessions = document.getElementById('newBlockSessions').value;
        const price = document.getElementById('newBlockPrice').value;
        const notes = document.getElementById('newBlockNotes').value;

        // Собираем задачи
        const tasks = [];
        for (let i = 1; i <= 3; i++) {
          const name = document.getElementById('task' + i + 'Name').value.trim();
          const type = document.getElementById('task' + i + 'Type').value;
          if (name) {
            tasks.push({ name, type, frequency: 'every', priority: i });
          }
        }

        if (!sessions || sessions < 1) {
          showToast('Укажите количество тренировок', 'error');
          return;
        }

        try {
          showLoading('Создание блока...');

          // 1. Создаём блок
          const blockResult = await apiCall('createTrainingBlock', {
            clientId: currentClient.id,
            totalSessions: parseInt(sessions),
            totalPrice: parseFloat(price) || 0,
            currency: 'USD',
            notes: notes,
          });

          if (!blockResult.success) {
            throw new Error(blockResult.error || 'Ошибка создания блока');
          }

          // 2. Обновляем обязательные задачи
          if (tasks.length > 0) {
            await apiCall('updateMandatoryTasks', {
              clientId: currentClient.id,
              tasks: tasks,
              blockId: blockResult.blockId,
            });
          }

          hideLoading();
          closeNewBlockModal();

          showToast('✅ Блок #' + blockResult.blockId + ' создан!', 'success');

          // Перезагружаем модуль
          await showModule('workouts');
        } catch (error) {
          hideLoading();
          showToast('Ошибка: ' + error.message, 'error');
        }
      }
    </script>
    <!-- Coefficient Editor Modal -->
    <div class="modal-overlay" id="coeffEditorModal">
      <div class="modal" style="max-width: 450px">
        <div class="modal-header">
          <h3>⚖️ Распределение нагрузки</h3>
          <button type="button" class="modal-close" onclick="closeCoeffEditor()">×</button>
        </div>
        <div class="coeff-modal-body" id="coeffEditorBody">
          <!-- Заполняется динамически -->
        </div>
        <div class="modal-actions" style="display: flex; gap: 10px">
          <button class="btn btn-secondary" onclick="resetCoeffEditor()">Сбросить</button>
          <button class="btn btn-primary" onclick="applyCoeffEditor()">Применить</button>
        </div>
      </div>
    </div>
  </body>
</html>
