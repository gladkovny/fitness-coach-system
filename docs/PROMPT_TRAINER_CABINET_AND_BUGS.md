# Промпт: разбор багов дашборда и ТЗ «Рабочий кабинет тренера»

Используй этот документ как единый промпт для:
1. **Определения причин багов** (расхождение трекер ↔ дашборд).
2. **Предложения решений** по исправлению.
3. **Создания рабочего кабинета тренера** по ТЗ ниже.

---

## Контекст проекта

- **Контур:** Master (Supabase). Фронт: `deploy/master/` (login, dashboard, tracker).
- **Трекер тренера** — мобильная версия для ввода тренировок (в дальнейшем дорабатывается).
- **Дашборд** — просмотр прогресса клиента (блок, нагрузка, последние тренировки и т.д.).
- **Цель сейчас:** сделать **компьютерную версию** — рабочий кабинет тренера для просмотра и редактирования данных, которые приходят в SQL (Supabase), чтобы быстро видеть «входные и выходные» данные клиента и исправлять их.

---

## Описание багов (по скриншотам)

### Факты

1. **В трекере** у клиента Ярослав видно **три записи** одной и той же тренировки «Жимы - грудь/плечи + бицепс 28.01» (даты отображения: 2 февр., 2 февр., 1 февр.).
2. **В дашборде**:
   - в блоке «Последние тренировки» отображается **только одна** тренировка (26 янв.);
   - записей от **28.01** нет;
   - в блоке «Нагрузка» нет нормального распределения по мышцам (только «Кор: 10 подх.», остальные группы по 0 подх.).
3. Дополнительно: в дашборде «Тоннаж (кг)» при текущей неделе 0 и прошлой 3.5k отображается «+100%» — логическая ошибка отображения.

### Что нужно сделать по багам

1. **Найти причину расхождения:**
   - почему в дашборде одна тренировка и нет записей от 28.01 при том, что в трекере видно три записи;
   - откуда берутся данные для «Последние тренировки» и для «Нагрузка» (какие запросы, фильтры, период «Блок»/«3 мес»/«Всё»);
   - почему распределение по мышцам пустое (какие подходы попадают в расчёт, как связаны `workout_sessions`, `workout_sets`, `exercises`, `block_id` и период).

2. **Проверить гипотезы (в коде и при необходимости в БД):**
   - при трёх нажатиях «Распознать» в трекере создаётся три сессии в `workout_sessions` (каждый раз `startSession` → `addSet` → `finishSession`);
   - дашборд при периоде «Блок» фильтрует сессии по `block_id === activeBlock.id`; сессии без `block_id` или с другим блоком не попадают в расчёт нагрузки и могут по-другому влиять на отображение;
   - «Последние тренировки» строятся из `allSessions.slice(0, 15)` (до 15 последних по дате); если в БД реально три сессии с датами 01.02/02.02 — они должны были бы попасть в список;
   - возможны: разный `client_id` (UUID в дашборде vs строковый id в трекере), RLS, кэш, или источник данных (дашборд иногда берёт данные не из Supabase).

3. **Предложить конкретные исправления** (по шагам, без массового рефакторинга):
   - запросы и фильтры дашборда (период, блок, лимиты);
   - логика «Неделя vs прошлая» (расчёт процента при нуле тоннажа);
   - при необходимости — трекер (защита от дублирования сессий при повторном «Распознать» или явное предупреждение).

---

## ТЗ: Рабочий кабинет тренера (компьютерная версия)

### Назначение

Удобный инструмент для тренера на компьютере:
- **смотреть** всю информацию по клиенту, которая есть в БД (входные и выходные данные);
- **обновлять и редактировать** эти данные (тренировки, подходы, профиль, блоки и т.д.).

Трекер (мобильный) остаётся основным способом ввода тренировок; кабинет — для контроля и правок.

### Требования к функционалу (MVP)

1. **Выбор клиента**  
   Список клиентов тренера из Supabase (`clients`), выбор одного — как в текущем дашборде.

2. **Просмотр данных по клиенту (как в SQL)**  
   Минимум:
   - **Сессии тренировок** (`workout_sessions`): id, client_id, block_id, date, type, status, notes, total_tonnage, created_at — список с сортировкой по дате (новые сверху), фильтр по периоду (блок / 3 мес / всё).
   - **Подходы** (`workout_sets`) по выбранной сессии: session_id, exercise_id, exercise_name, set_number, reps, weight, rpe — с возможностью открыть детали сессии и увидеть все подходы.
   - **Распределение нагрузки по мышцам** по выбранному периоду (блок / 3 мес / всё) — те же данные, что считает дашборд, но в явном виде (какие группы, сколько подходов/тоннаж), чтобы можно было сверить с дашбордом.

3. **Редактирование (минимум для MVP)**  
   - **Сессия:** изменить дату, тип (название), заметки, при необходимости привязать к другому блоку (`block_id`).  
   - **Подход:** изменить вес, повторения, при необходимости упражнение (через выбор из `exercises` или правка `exercise_name`).  
   - **Удаление:** удалить подход; удалить сессию (с каскадом подходов по текущей схеме БД).

4. **Профиль клиента**  
   Просмотр и редактирование полей, которые хранятся в `clients` и в `profile` (JSONB): имя, email, статус, цели, вес и т.д. — в соответствии с текущей схемой.

5. **Блоки и программа**  
   Просмотр `training_blocks` и `programs` по клиенту (название блока, total_sessions, used_sessions, даты). При необходимости — правка used_sessions или смена активного блока (если это делается через обновление полей в БД).

### Нефункциональные требования

- **Расположение:** отдельная страница/раздел в контуре Master, например `deploy/master/cabinet/` или вкладка/раздел внутри текущего дашборда (на твоё усмотрение с учётом структуры проекта).
- **Стек:** как в проекте — vanilla HTML/CSS/JS, Supabase JS client, без лишних фреймворков.
- **Безопасность:** те же RLS и авторизация Supabase, что и для дашборда (доступ только к своим клиентам).
- **Удобство:** таблицы или карточки с данными, явные кнопки «Сохранить»/«Отмена», при удалении — подтверждение. Данные после правок перезагружать из БД и при необходимости обновлять отображаемые блоки (последние тренировки, нагрузка).

### Что можно отложить на следующий этап

- Редактирование обязательных задач (`mandatory_tasks`).
- Сложные отчёты и аналитика.
- Импорт/экспорт в файлы.

---

## Ожидаемый результат по промпту

1. **Отчёт по багам:**  
   - причина расхождения трекер ↔ дашборд (с указанием файлов и мест в коде);  
   - список конкретных правок (по шагам) с номерами разделов системы [1]–[7] и контуром Master.

2. **Реализация рабочего кабинета тренера** по ТЗ выше (MVP: просмотр и редактирование сессий, подходов, профиля клиента, блоков; безопасность и UX как в проекте).

3. **Краткий чек-лист проверки:**  
   - после исправлений: в дашборде у Ярослава видны все записанные в трекере сессии (в т.ч. от 28.01) и корректное распределение нагрузки по мышцам;  
   - в кабинете тренера можно выбрать клиента, увидеть те же данные, что в SQL, и отредактировать/удалить сессию или подход.

---

## Ссылки на код (для разбора багов)

- Дашборд: `deploy/master/dashboard/index.html` — функция `loadDashboardFromSupabase(clientId)`, фильтр по `currentPeriod` и `block_id`, формирование `sessions`, `displaySessions`, `recentSessions`, `computeMuscleLoad(allSets, ...)`, запросы к `workout_sessions` и `workout_sets`.
- Трекер: `deploy/master/tracker/index.html` — поток «Распознать»: удаление старой сессии (если редактирование), `startSession` → `addSet` (цикл) → `finishSession`; `deploy/master/js/tracker-supabase.js` — `startSessionSupabase`, `addSetSupabase`, `finishSessionSupabase`, получение `block_id` для новой сессии.
- API/клиент: `deploy/master/js/api.js`, `deploy/master/js/supabase-config.js`. Схема БД: `supabase/migrations/00001_initial_schema.sql`, `00008_workout_sets_exercise_name.sql`.
- Правила: `docs/cursorrules_v2.1.md`, `docs/CLAUDE_RULES_V2.1.md`, `docs/SYNC_STATUS.md`.

При работе с Supabase и RLS используй Context7 MCP для актуальной документации.

---

## Отчёт по багам (разбор и правки)

### 1. Причины расхождения трекер ↔ дашборд

**«Последние тренировки»: в дашборде одна (26 янв), в трекере три (28.01)**
- **Источник данных:** `loadDashboardFromSupabase` → `workout_sessions` по `client_id`, `order('date', { ascending: false }).limit(1000)`; «Последние тренировки» = `displaySessions = allSessions.slice(0, 15)` → `recentSessions` (без фильтра по блоку). Файл: `deploy/master/dashboard/index.html`, строки 182–183, 232, 289–304.
- **Гипотезы:**
  1. **Кэш:** при ошибке загрузки дашборд подставляет старые данные из `localStorage` без TTL (`getCachedData`), и пользователь видит устаревший список. Строки 636–638.
  2. **Три сессии в БД:** каждое нажатие «Распознать» в трекере создаёт новую сессию (`startSession` → `addSet` → `finishSession`). Три нажатия → три записи в `workout_sessions`. Трекер: ~6314–6378.
  3. **client_id:** в Master оба контура используют UUID из `clients`; расхождение по типу id маловероятно, если везде выбран один и тот же клиент.

**«Нагрузка»: только «Кор: 10 подх.», остальные 0**
- **Источник:** нагрузка по мышцам считается только по сессиям, входящим в выбранный период. При периоде «Блок» берутся сессии с `s.block_id === activeBlock.id`. Файл: дашборд, 224–231, 234–235, 245: `allSets = fetchedSets.filter(st => sessionIds.includes(st.session_id))`, т.е. только подходы из `sessions` (уже отфильтрованных по блоку).
- **Причина:** если три сессии от 28.01 созданы без `block_id` (нет активного блока у клиента в момент создания) или с другим блоком, они не попадают в `sessions` → их подходы не входят в `allSets` → в расчёт нагрузки попадают только подходы из других сессий (например, одна старая с «Кор»). Итог: пустое или почти пустое распределение по мышцам.

**Тоннаж «+100%» при текущей 0 и прошлой 3.5k**
- В коде при `thisWeekVol === 0 && lastWeekVol > 0` возвращается `-100` (строки 338, 388). Отрицательный процент отображается как «↓ 100%». Если на экране видно «+100%», возможны: (1) подставлены закэшированные данные с другой структурой/знаками; (2) путаница недель (границы понедельник–воскресенье). Уточнение отображения и подписей снижает риск непонимания.

### 2. Конкретные правки (по шагам)

| № | Раздел/контур | Что сделать |
|---|----------------|-------------|
| 1 | [2] Backend, Master | **Кэш дашборда:** сохранять в кэш время записи; при ошибке загрузки использовать кэш только если ему не больше 5 минут; иначе показывать ошибку и кнопку «Обновить». Не показывать устаревший кэш как основной контент. |
| 2 | [4] Frontend, Master | **Процент тоннажа:** при `thisWeekVol === 0 && lastWeekVol > 0` явно показывать «−100%» (минус), не «+100%»; при отображении не ставить «+» перед положительным процентом, если значение пришло из кэша с перепутанными неделями — пересчитывать из актуальных `thisWeek`/`lastWeek`. |
| 3 | [4] Frontend, Master | **Блок «Нагрузка»:** при периоде «Блок» добавить подпись «По текущему блоку», чтобы было ясно, что сессии без блока или из другого блока не учитываются. |
| 4 | [4] Frontend, Master | **Трекер:** при повторном нажатии «Распознать» без режима редактирования показывать предупреждение: «Будет создана новая сессия. Редактировать существующую?» с возможностью перейти к редактированию последней сессии или продолжить создание новой. Либо блокировать второе нажатие, пока не закрыт итог предыдущего сохранения. |

### 3. Чек-лист проверки после правок
- [ ] В дашборде у Ярослава после «Обновить» видны все сессии из Supabase (в т.ч. от 28.01), если они есть в `workout_sessions` для его `client_id`.
- [ ] При периоде «Блок» и сессиях с заполненным `block_id` распределение по мышцам не пустое (где есть подходы).
- [ ] При текущей неделе 0 кг и прошлой 3.5k отображается «↓ 100%» (или «−100%»), не «+100%».
- [ ] В трекере при повторном «Распознать» либо показывается предупреждение о новой сессии, либо дубликаты не создаются без подтверждения.
