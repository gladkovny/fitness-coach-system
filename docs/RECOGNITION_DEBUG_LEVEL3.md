# Анализ: Распознавание упражнений не работает (Уровень 3)

**Дата:** 03.02.2026  
**Протокол:** Problem Solving Protocol, Уровень 3

---

## 1. Понимание проблемы

**Проблема своими словами:**  
После нескольких попыток распознать текст тренировки система либо выдаёт неверные результаты (упражнения определяются неправильно), либо перестаёт работать (ошибка, зависание, некорректное поведение).

**Симптомы из описания и скриншотов:**
- «Отведение плеча в тренажере» распознаётся как «Отведение гантели назад» с 100% трицепс
- Жим лёжа: подходы 40 раз, 12 раз, 2 раз — похоже на неверный парсинг
- Ошибка «не работает после нескольких попыток» — неясно, это про каждый раз или после 2–3 вызовов подряд

---

## 2. Пример: Input → Expected → Actual

### Входной текст (6 упражнений)
```
Подтягивания 11 раз, 5 раз, 5, раз 5 раз 
Скручивания в упоре на брусьях 15 раз 
Скручивания в тренажере 10 кг 20 раз  
Приседания в тренажере гакк 20х12, 40х12 
Жим лежа на наклонной скамье 40*12, 2 прохода 
Отведение плеча в тренажере сидя 27 кг на 15 раз, 2 подхода
```

### Ожидаемый результат
| № | Упражнение | Подходы | Категория |
|---|------------|---------|-----------|
| 1 | Подтягивания | 11, 5, 5, 5 | Спина |
| 2 | Скручивания (в упоре на брусьях) | 15 | Корпус |
| 3 | Скручивания (в тренажере) | 10кг×20 | Корпус |
| 4 | Приседания в гакк-тренажере | 20×12, 40×12 | Ноги |
| 5 | Жим лёжа на наклонной скамье | 40×12, 40×12 (2 подхода) | Грудь |
| 6 | Отведение плеча в тренажере | 27×15, 27×15 (2 подхода) | Плечи |

### Фактический результат (по скриншотам)
| № | Упражнение | Проблема |
|---|------------|----------|
| 5 | Жим лёжа | Подходы: 40 раз, 12 раз, 2 раз (явная ошибка парсинга) |
| 6 | Отведение гантели назад | Неверно — должно быть «Отведение плеча», категория «Плечи», а не 100% трицепс |

---

## 3. История попыток

| Попытка | Что сделано | Результат |
|---------|-------------|-----------|
| 1 | Промпт AI (parse-workout) с блоком «ЗАПРЕЩЕНО» | AI всё ещё путает упражнения |
| 2 | Пост-обработка в Edge Function | Должна исправлять, но на скриншоте ошибка сохраняется |
| 3 | fixAIResultForShoulderAbduction в трекере | Добавлена, но неясно, применяется ли |
| 4 | enrichParsedWorkout с lastRecognizeInput | Добавлена коррекция по контексту |

**Возможные причины, почему не сработало:**
1. Опечатка в ID: `workoutInput` вместо `workoutTextInput` → падение при очистке поля.
2. AI не успевает применяться: локальный парсер может выигрывать по `localCount >= lineCount`.
3. Форматы ввода: «2 прохода» вместо «2 подхода», «40*12» вместо «40×12» — парсер может не учитывать эти варианты.

---

## 4. Обнаруженные баги

### Критический: неправильный ID элемента
```javascript
document.getElementById('workoutInput').value = '';  // Элемент не существует!
// Должно быть:
document.getElementById('workoutTextInput').value = '';
```
**Эффект:** при успешном распознавании скрипт падает при попытке очистить поле. Пользователь может видеть ошибку в консоли и считать, что «распознавание не работает».

### Парсинг «2 прохода»
В тексте: «40*12, 2 прохода». Скорее всего имелось в виду «2 подхода». Локальный парсер и AI должны уметь распознавать такие опечатки.

### Расширение подходов для «Отведение плеча»
Regex в Edge Function и в трекере ищет «подход»; «проход» не обрабатывается.

---

## 5. Варианты решения

### Вариант A: Быстрый фикс (минимальные изменения)
**Что делать:**
1. Исправить `workoutInput` → `workoutTextInput` во всех местах.
2. Добавить в парсер распознавание «N проход» как «N подхода».

**Плюсы:** мало правок, быстро.  
**Минусы:** не решает корневые проблемы с AI и локальным парсером.

---

### Вариант B: Улучшение локального парсера
**Что делать:**
1. Фикс ID (как в A).
2. Расширить паттерны в parseExerciseLine:
   - «X кг Y раз» без «на» (упражнение 3);
   - «X*Y, N проход» как N одинаковых подходов;
   - «11 раз, 5 раз, 5, раз 5 раз» как несколько подходов.
3. Сделать так, чтобы при localCount >= lineCount результат был максимально полным и корректным.

**Плюсы:** меньше зависимость от AI, быстрее ответ.  
**Минусы:** много правил, возможны конфликты паттернов.

---

### Вариант C: Гибрид + диагностика
**Что делать:**
1. Фикс ID (как в A).
2. Добавить логирование:
   - какой источник выбран (локальный / AI);
   - localCount, lineCount, aiCount;
   - применена ли коррекция shoulder abduction.
3. Исправить «проход» → «подход» в промпте AI и в пост-обработке.
4. Проверить, что при `localCount >= lineCount` для «Отведение плеча» вызывается fixAIResultForShoulderAbduction (сейчас он вызывается только в appendExercises, но при 6 строках и 6 упражнениях от локального парсера AI не вызывается).

**Плюсы:** понятно, что происходит; исправляются и баг с ID, и опечатка «проход».  
**Минусы:** нужна проверка после изменений.

---

## 6. Рекомендация

Оптимально начать с **Варианта C**:
1. Исправить ID — это снимает падение при очистке.
2. Добавить логирование — прояснит поведение «не работает после нескольких попыток».
3. Добавить обработку «проход» → «подход».
4. Убедиться, что fixAIResultForShoulderAbduction вызывается и для локального результата (уже вызывается в appendExercises для любого результата).

---

## 7. Реализованные исправления (03.02.2026)

| # | Исправление | Файл |
|---|-------------|------|
| 1 | `workoutInput` → `workoutTextInput` (критический баг) | tracker/index.html |
| 2 | Нормализация «2 прохода» → «2 подхода» (фронт + Edge Function) | tracker, parse-workout |
| 3 | Regex для подходов: поддержка «, 2 подхода» после «раз» | tracker, parse-workout |
| 4 | Нормализация «40*12» → «40x12» | tracker |

---

## 8. План проверки после изменений

- [ ] Вставить полный текст из примера и нажать «Распознать».
- [ ] Проверить, что поле ввода очищается без ошибок.
- [ ] Упражнение 6: «Отведение плеча в тренажере» → категория «Плечи», не трицепс.
- [ ] Упражнение 5: «Жим лежа на наклонной скамье» → 2 подхода по 40×12.
- [ ] Повторить распознавание 2–3 раза подряд — поведение должно быть стабильным.
- [ ] Посмотреть консоль (F12) — не должно быть ошибок и исключений.
