<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f5f5f7;
      --card: #ffffff;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --accent: #0071e3;
      --accent-light: #e8f4fd;
      --success: #34c759;
      --warning: #ff9500;
      --danger: #ff3b30;
      --border: #d2d2d7;
      --shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
      padding-bottom: 90px;
    }
    
    .header {
      background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%);
      color: white;
      padding: 20px 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .header h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
    .header .start-date { opacity: 0.7; font-size: 13px; margin-top: 4px; }
    
    .settings-btn {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }
    
    main { padding: 16px; max-width: 600px; margin: 0 auto; }
    
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    .period-selector {
      display: flex;
      gap: 4px;
      background: var(--bg);
      padding: 3px;
      border-radius: 8px;
    }
    
    .period-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .period-btn.active {
      background: white;
      color: var(--text);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .block-stats {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .block-circle {
      width: 80px;
      height: 80px;
      position: relative;
    }
    
    .block-circle svg {
      transform: rotate(-90deg);
      width: 80px;
      height: 80px;
    }
    
    .block-circle-bg {
      fill: none;
      stroke: var(--bg);
      stroke-width: 6;
    }
    
    .block-circle-fill {
      fill: none;
      stroke: var(--accent);
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }
    
    .block-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-weight: 700;
    }
    
    .block-info { flex: 1; }
    .block-label { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .block-sublabel { font-size: 13px; color: var(--text-secondary); }
    
    .goals-list { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .goal-tag {
      background: var(--accent-light);
      color: var(--accent);
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .muscle-groups { display: flex; flex-direction: column; gap: 12px; }
    
    .muscle-group {
      background: var(--bg);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .muscle-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .muscle-group-header:hover { background: rgba(0,0,0,0.02); }
    
    .muscle-group-name {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 15px;
    }
    
    .muscle-group-icon { font-size: 20px; }
    
    .muscle-group-stats {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .muscle-group-sets {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .muscle-group-bar {
      width: 60px;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .muscle-group-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .muscle-group-arrow {
      color: var(--text-secondary);
      transition: transform 0.2s;
    }
    
    .muscle-group.expanded .muscle-group-arrow { transform: rotate(180deg); }
    
    .muscle-details {
      display: none;
      padding: 0 16px 14px;
    }
    
    .muscle-group.expanded .muscle-details { display: block; }
    
    .muscle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-top: 1px solid var(--border);
    }
    
    .muscle-name { font-size: 14px; color: var(--text-secondary); }
    .muscle-value { font-size: 14px; font-weight: 500; }
    
    .weeks-comparison {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .week-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }
    
    .week-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
    .week-value { font-size: 24px; font-weight: 700; }
    .week-subvalue { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    
    .week-change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 8px;
    }
    
    .week-change.up { background: #d4edda; color: #155724; }
    .week-change.down { background: #f8d7da; color: #721c24; }
    .week-change.same { background: var(--border); color: var(--text-secondary); }
    
    .progress-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .progress-item:last-child { border-bottom: none; }
    
    .progress-info { flex: 1; }
    .progress-name { font-weight: 600; font-size: 15px; }
    .progress-date { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    
    .progress-values { text-align: right; }
    
    .progress-weight { font-size: 18px; font-weight: 700; color: var(--accent); }
    .progress-change { font-size: 12px; color: var(--success); font-weight: 500; }
    
    .session-item {
      padding: 14px;
      background: var(--bg);
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .session-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .session-item:last-child { margin-bottom: 0; }
    
    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .session-date { font-weight: 600; font-size: 15px; }
    .session-type { font-size: 13px; color: var(--accent); font-weight: 500; }
    
    .session-stats {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .session-stat { display: flex; align-items: center; gap: 4px; }
    
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 300;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal {
      background: var(--card);
      border-radius: 20px 20px 0 0;
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      padding: 20px;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    
    .modal-handle {
      width: 36px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 0 auto 16px;
    }
    
    .modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .modal-subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
    
    .modal-section { margin-bottom: 20px; }
    .modal-section-title { font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; font-weight: 600; text-transform: uppercase; }
    
    .modal-stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .modal-stat {
      background: var(--bg);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .modal-stat-value { font-size: 20px; font-weight: 700; }
    .modal-stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
    
    .modal-exercise-list { list-style: none; }
    
    .modal-exercise {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-exercise:last-child { border-bottom: none; }
    .modal-exercise-name { font-size: 14px; flex: 1; }
    .modal-exercise-detail { font-size: 14px; color: var(--text-secondary); text-align: right; }
    
    .settings-modal {
      border-radius: 20px;
      max-width: 400px;
      margin: auto;
    }
    
    .settings-modal h2 { margin-bottom: 20px; }
    
    .settings-modal label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .settings-modal input {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .modal-buttons { display: flex; gap: 12px; margin-top: 10px; }
    
    .modal-buttons button {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-cancel { background: var(--bg); border: none; color: var(--text); }
    .btn-save { background: var(--accent); border: none; color: white; }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      display: flex;
      justify-content: space-around;
      padding: 10px 0 20px;
      box-shadow: 0 -1px 10px rgba(0,0,0,0.08);
      z-index: 100;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 24px; margin-bottom: 2px; }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .empty-state {
      text-align: center;
      padding: 32px;
      color: var(--text-secondary);
    }
    
    .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    
    .history-page, .records-page { display: none; }
    .history-page.active, .records-page.active { display: block; }
    .main-page { display: block; }
    .main-page.hidden { display: none; }
    
    .chart-container {
      height: 220px;
      position: relative;
    }
    
    .record-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      background: var(--bg);
      border-radius: 12px;
      margin-bottom: 10px;
    }
    
    .record-type {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .record-name { font-weight: 600; font-size: 15px; margin-top: 2px; }
    
    .record-value-container { text-align: right; }
    .record-value { font-size: 20px; font-weight: 700; color: var(--accent); }
    .record-date { font-size: 12px; color: var(--text-secondary); }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">
      <div class="spinner"></div>
      <div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ICONS (text-based to avoid encoding issues)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const ICONS = {
      block: '&#128230;',      // ğŸ“¦
      target: '&#127919;',     // ğŸ¯
      muscle: '&#128170;',     // ğŸ’ª
      leg: '&#129461;',        // ğŸ¦µ
      back: '&#128281;',       // ğŸ”™
      chest: '&#9881;',       // âš™ï¸ ĞºĞ¾Ğ»ĞµÑĞ¾ (Ğ³Ñ€ÑƒĞ´ÑŒ ĞºĞ¾Ğ»ĞµÑĞ¾Ğ¼)
      chart: '&#128202;',      // ğŸ“Š
      chartUp: '&#128200;',    // ğŸ“ˆ
      trophy: '&#127942;',     // ğŸ†
      calendar: '&#128197;',   // ğŸ“…
      weight: '&#127947;',     // ğŸ‹ï¸
      rocket: '&#128640;',     // ğŸš€
      party: '&#127881;',      // ğŸ‰
      clipboard: '&#128203;',  // ğŸ“‹
      gear: '&#9881;',         // âš™ï¸
      sad: '&#128533;',        // ğŸ˜•
      scale: '&#9878;',        // âš–ï¸
      fire: '&#128293;',       // ğŸ”¥
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIG & STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const CONFIG = {
      get API_URL() { return localStorage.getItem('api_url') || 'https://script.google.com/macros/s/AKfycbzLfiQUxi5HAojhxaitEpqUxrn7E0XFEDFSNc2WGbgVrYNv14awSB7W7VigbcbmvOX9/exec'; },
      set API_URL(v) { localStorage.setItem('api_url', v); },
      get CLIENT_ID() {
        return new URLSearchParams(window.location.search).get('client') || 
               localStorage.getItem('client_id') || 'yaroslav';
      },
      set CLIENT_ID(v) { localStorage.setItem('client_id', v); }
    };
    
    let data = null;
    let currentPage = 'main';
    let currentPeriod = 'block';
    let tonnageChart = null;
    
    // Demo mode for local testing
    const DEMO_MODE = new URLSearchParams(window.location.search).has('demo') || 
                      window.location.hostname === 'localhost' ||
                      window.location.hostname === '127.0.0.1' ||
                      window.location.protocol === 'file:';
    
    // Debug mode - add ?debug=true to URL
    const DEBUG_MODE = new URLSearchParams(window.location.search).has('debug');
    
    const DEMO_DATA = {
      success: true,
      clientId: 'demo',
      period: 'block',
      generatedAt: new Date().toISOString(),
      profile: { name: 'Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚' },
      goals: { clientName: 'Ğ”ĞµĞ¼Ğ¾ ĞšĞ»Ğ¸ĞµĞ½Ñ‚', startDate: '2026-01-08', mainGoals: 'ĞĞ¤ĞŸ, ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ 15 Ñ€Ğ°Ğ·, ĞšĞ¾Ñ€Ñ€ĞµĞºÑ†Ğ¸Ñ Ğ¾ÑĞ°Ğ½ĞºĞ¸' },
      currentBlock: { blockId: 1, blockNumber: 1, totalSessions: 10, usedSessions: 3, remaining: 7, progress: 30, status: 'active' },
      mandatoryStats: { completed: 5, total: 10, rate: 50 },
      recentSessions: [
        { sessionId: 'S001', date: '2026-01-24', type: 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°', splitType: 'Push', duration: 60, exerciseCount: 6, totalSets: 11, totalVolume: 1100, rating: 7, notes: 'RPE: 7', exercises: [
          { name: 'Ğ–Ğ¸Ğ¼ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ĞµĞ¹ Ğ»Ñ‘Ğ¶Ğ°', sets: 3, reps: 10, weight: 12.5 },
          { name: 'Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸', sets: 2, reps: 12, weight: 30 },
          { name: 'Ğ¢ÑĞ³Ğ° Ğ¢-Ğ³Ñ€Ğ¸Ñ„Ğ°', sets: 3, reps: 10, weight: 30 },
          { name: 'ĞŸÑ€Ğ¸ÑĞµĞ´Ğ°Ğ½Ğ¸Ñ Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶Ñ‘Ñ€Ğµ', sets: 2, reps: 10, weight: 15 },
          { name: 'Ğ–Ğ¸Ğ¼ Ğ² Ğ±Ğ»Ğ¾Ñ‡Ğ½Ğ¾Ğ¼ Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶ĞµÑ€Ğµ', sets: 2, reps: 12, weight: 30 }
        ]},
        { sessionId: 'S002', date: '2026-01-21', type: 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°', splitType: 'Pull', duration: 55, exerciseCount: 5, totalSets: 10, totalVolume: 950, rating: 8, notes: '', exercises: [
          { name: 'Ğ¢ÑĞ³Ğ° Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°', sets: 3, reps: 12, weight: 40 },
          { name: 'Ğ¢ÑĞ³Ğ° Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°', sets: 3, reps: 10, weight: 35 },
          { name: 'Ğ¡Ğ³Ğ¸Ğ±Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ±Ğ¸Ñ†ĞµĞ¿Ñ', sets: 2, reps: 12, weight: 10 }
        ]},
        { sessionId: 'S003', date: '2026-01-19', type: 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°', splitType: 'Legs', duration: 50, exerciseCount: 4, totalSets: 9, totalVolume: 1200, rating: 7, exercises: [
          { name: 'ĞŸÑ€Ğ¸ÑĞµĞ´Ğ°Ğ½Ğ¸Ñ', sets: 3, reps: 10, weight: 40 },
          { name: 'Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸', sets: 3, reps: 12, weight: 60 },
          { name: 'Ğ’Ñ‹Ğ¿Ğ°Ğ´Ñ‹', sets: 2, reps: 10, weight: 20 }
        ]}
      ],
      allSessions: [
        { sessionId: 'S001', date: '2026-01-24', totalVolume: 1100, totalSets: 11 },
        { sessionId: 'S002', date: '2026-01-21', totalVolume: 950, totalSets: 10 },
        { sessionId: 'S003', date: '2026-01-19', totalVolume: 1200, totalSets: 9 },
        { sessionId: 'S004', date: '2026-01-16', totalVolume: 800, totalSets: 8 },
        { sessionId: 'S005', date: '2026-01-14', totalVolume: 1050, totalSets: 10 }
      ],
      exerciseProgress: {
        improvements: [
          { name: 'Ğ–Ğ¸Ğ¼ Ğ³Ğ°Ğ½Ñ‚ĞµĞ»ĞµĞ¹ Ğ»Ñ‘Ğ¶Ğ°', currentWeight: 12.5, firstWeight: 7.5, progressKg: 5, progressPercent: 67, lastDate: '2026-01-24' },
          { name: 'Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸', currentWeight: 30, firstWeight: 20, progressKg: 10, progressPercent: 50, lastDate: '2026-01-19' },
          { name: 'ĞŸÑ€Ğ¸ÑĞµĞ´Ğ°Ğ½Ğ¸Ñ', currentWeight: 15, firstWeight: 10, progressKg: 5, progressPercent: 50, lastDate: '2026-01-19' },
          { name: 'Ğ¢ÑĞ³Ğ° Ğ¢-Ğ³Ñ€Ğ¸Ñ„Ğ°', currentWeight: 30, firstWeight: 20, progressKg: 10, progressPercent: 50, lastDate: '2026-01-24' },
          { name: 'Ğ–Ğ¸Ğ¼ Ğ² Ñ‚Ñ€ĞµĞ½Ğ°Ğ¶ĞµÑ€Ğµ', currentWeight: 30, firstWeight: 20, progressKg: 10, progressPercent: 50, lastDate: '2026-01-21' }
        ]
      },
      muscleLoad: {
        period: 'block',
        maxGroupSets: 12,
        groups: {
          legs: { name: 'ĞĞ¾Ğ³Ğ¸', totalSets: 8.5, totalVolume: 4200, muscles: {
            quads: { name: 'ĞšĞ²Ğ°Ğ´Ñ€Ğ¸Ñ†ĞµĞ¿Ñ', sets: 4, volume: 2000 },
            hamstrings: { name: 'Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ Ğ±ĞµĞ´Ñ€Ğ°', sets: 2, volume: 800 },
            glutes: { name: 'Ğ¯Ğ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹', sets: 2, volume: 1000 },
            calves: { name: 'Ğ˜ĞºÑ€Ñ‹', sets: 0.5, volume: 400 }
          }},
          back: { name: 'Ğ¡Ğ¿Ğ¸Ğ½Ğ°', totalSets: 9, totalVolume: 3200, muscles: {
            lats: { name: 'Ğ¨Ğ¸Ñ€Ğ¾Ñ‡Ğ°Ğ¹ÑˆĞ¸Ğµ', sets: 6, volume: 2100 },
            traps: { name: 'Ğ¢Ñ€Ğ°Ğ¿ĞµÑ†Ğ¸Ñ', sets: 2, volume: 700 },
            low_back: { name: 'ĞŸĞ¾ÑÑĞ½Ğ¸Ñ†Ğ°', sets: 1, volume: 400 }
          }},
          chest: { name: 'Ğ“Ñ€ÑƒĞ´ÑŒ', totalSets: 4, totalVolume: 1600, muscles: {
            chest: { name: 'Ğ“Ñ€ÑƒĞ´ÑŒ', sets: 4, volume: 1600 }
          }},
          arms: { name: 'Ğ ÑƒĞºĞ¸ Ğ¸ Ğ¿Ğ»ĞµÑ‡Ğ¸', totalSets: 8, totalVolume: 2700, muscles: {
            biceps: { name: 'Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ', sets: 2, volume: 600 },
            triceps: { name: 'Ğ¢Ñ€Ğ¸Ñ†ĞµĞ¿Ñ', sets: 2, volume: 600 },
            front_delt: { name: 'ĞŸĞµÑ€ĞµĞ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°', sets: 2, volume: 800 },
            mid_delt: { name: 'Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°', sets: 1, volume: 400 },
            rear_delt: { name: 'Ğ—Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°', sets: 1, volume: 300 }
          }}
        }
      },
      weeklyComparison: {
        thisWeek: { count: 2, volume: 2050, sets: 21 },
        lastWeek: { count: 2, volume: 2000, sets: 17 },
        changes: { count: 0, volumePercent: 2 }
      },
      allRecords: {
        byWeight: [
          { name: 'Ğ–Ğ¸Ğ¼ Ğ½Ğ¾Ğ³Ğ°Ğ¼Ğ¸', maxWeight: 60, reps: 12, date: '2026-01-19' },
          { name: 'Ğ¢ÑĞ³Ğ° Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°', maxWeight: 40, reps: 12, date: '2026-01-21' },
          { name: 'ĞŸÑ€Ğ¸ÑĞµĞ´Ğ°Ğ½Ğ¸Ñ', maxWeight: 40, reps: 10, date: '2026-01-19' }
        ],
        byReps: [
          { name: 'ĞÑ‚Ğ¶Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ', maxReps: 20, weight: 0, date: '2026-01-14' },
          { name: 'ĞŸĞ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ', maxReps: 8, weight: 0, date: '2026-01-12' }
        ]
      }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadDashboard() {
      // Demo mode - use mock data
      if (DEMO_MODE) {
        console.log('ğŸ­ DEMO MODE - using mock data');
        data = DEMO_DATA;
        renderApp();
        return;
      }
      
      if (!CONFIG.API_URL) { showSetupScreen(); return; }
      
      try {
        let url = `${CONFIG.API_URL}?action=getOfflineDashboardV2&clientId=${CONFIG.CLIENT_ID}&period=${currentPeriod}`;
        let response = await fetch(url);
        data = await response.json();
        
        if (data.error && data.error.includes('Unknown action')) {
          url = `${CONFIG.API_URL}?action=getOfflineDashboard&clientId=${CONFIG.CLIENT_ID}`;
          response = await fetch(url);
          data = await response.json();
        }
        
        if (data.error) { showError(data.error); return; }
        
        renderApp();
        localStorage.setItem(`dashboard_${CONFIG.CLIENT_ID}`, JSON.stringify(data));
        
      } catch (error) {
        const cached = localStorage.getItem(`dashboard_${CONFIG.CLIENT_ID}`);
        if (cached) { data = JSON.parse(cached); renderApp(); }
        else { showError('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' + error.message); }
      }
    }
    
    function renderApp() {
      const clientName = data.goals?.clientName || data.profile?.name || 'ĞšĞ»Ğ¸ĞµĞ½Ñ‚';
      const startDate = data.goals?.startDate || '';
      
      // Debug panel for ?debug=true
      const debugPanel = DEBUG_MODE ? `
        <div style="margin: 16px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 11px; font-family: monospace;">
          <strong>ğŸ” DEBUG MODE</strong> ${DEMO_MODE ? '(DEMO DATA)' : '(API DATA)'}
          <details style="margin-top: 8px;">
            <summary style="cursor: pointer;">ğŸ“Š muscleLoad (${data.muscleLoad?.groups ? Object.keys(data.muscleLoad.groups).length + ' groups' : 'null'})</summary>
            <pre style="overflow: auto; max-height: 150px; background: #f8f9fa; padding: 8px; margin-top: 4px; border-radius: 4px;">${JSON.stringify(data.muscleLoad, null, 2)}</pre>
          </details>
          <details style="margin-top: 8px;">
            <summary style="cursor: pointer;">ğŸ“‹ recentSessions[0].exercises (${data.recentSessions?.[0]?.exercises?.length || 0} items)</summary>
            <pre style="overflow: auto; max-height: 150px; background: #f8f9fa; padding: 8px; margin-top: 4px; border-radius: 4px;">${JSON.stringify(data.recentSessions?.[0]?.exercises, null, 2)}</pre>
          </details>
          <details style="margin-top: 8px;">
            <summary style="cursor: pointer;">ğŸ“… allSessions (${data.allSessions?.length || 0} items)</summary>
            <pre style="overflow: auto; max-height: 150px; background: #f8f9fa; padding: 8px; margin-top: 4px; border-radius: 4px;">${JSON.stringify(data.allSessions?.slice(0, 5), null, 2)}</pre>
          </details>
          <details style="margin-top: 8px;">
            <summary style="cursor: pointer;">ğŸ“ˆ weeklyComparison</summary>
            <pre style="overflow: auto; max-height: 150px; background: #f8f9fa; padding: 8px; margin-top: 4px; border-radius: 4px;">${JSON.stringify(data.weeklyComparison, null, 2)}</pre>
          </details>
        </div>
      ` : '';
      
      document.getElementById('app').innerHTML = `
        <header class="header">
          <div class="header-top">
            <div>
              <h1>${clientName}</h1>
              ${startDate ? `<div class="start-date">Ğ¡ ${formatDateFull(startDate)}</div>` : ''}
            </div>
            <button class="settings-btn" onclick="showSettings()">${ICONS.gear}</button>
          </div>
        </header>
        
        ${debugPanel}
        
        <main class="main-page" id="mainPage">
          ${renderBlockProgress()}
          ${renderGoals()}
          ${renderMuscleLoad()}
          ${renderWeeklyComparison()}
          ${renderProgress()}
          ${renderRecentSessions()}
        </main>
        
        <main class="history-page" id="historyPage">
          ${renderHistoryPage()}
        </main>
        
        <main class="records-page" id="recordsPage">
          ${renderRecordsPage()}
        </main>
        
        <nav class="bottom-nav">
          <div class="nav-item active" onclick="showPage('main')"><span class="nav-icon">${ICONS.chart}</span>Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</div>
          <div class="nav-item" onclick="showPage('history')"><span class="nav-icon">${ICONS.chartUp}</span>Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</div>
          <div class="nav-item" onclick="showPage('records')"><span class="nav-icon">${ICONS.trophy}</span>Ğ ĞµĞºĞ¾Ñ€Ğ´Ñ‹</div>
        </nav>
        
        <div class="modal-overlay" id="sessionModal" onclick="if(event.target===this)closeModal()"></div>
        <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)hideSettings()"></div>
      `;
      
      if (currentPage === 'history') {
        document.getElementById('historyPage').classList.add('active');
        document.getElementById('mainPage').classList.add('hidden');
        setTimeout(initTonnageChart, 100);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER: BLOCK PROGRESS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderBlockProgress() {
      const block = data.currentBlock;
      if (!block || block.status === 'none') {
        return `<div class="card"><div class="card-title">${ICONS.block} Ğ‘Ğ›ĞĞš</div>
          <div class="empty-state"><div class="empty-icon">${ICONS.block}</div>ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°</div></div>`;
      }
      
      const circumference = 2 * Math.PI * 35;
      const offset = circumference - (block.progress / 100) * circumference;
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.block} Ğ‘Ğ›ĞĞš ${block.blockId || 1}</span></div>
          <div class="block-stats">
            <div class="block-circle">
              <svg viewBox="0 0 80 80">
                <circle class="block-circle-bg" cx="40" cy="40" r="35"/>
                <circle class="block-circle-fill" cx="40" cy="40" r="35" 
                  stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/>
              </svg>
              <div class="block-number">${block.usedSessions}</div>
            </div>
            <div class="block-info">
              <div class="block-label">${block.usedSessions} Ğ¸Ğ· ${block.totalSessions} Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº</div>
              <div class="block-sublabel">${block.remaining > 0 ? `ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ ${block.remaining}` : ICONS.party + ' Ğ—Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½!'}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER: GOALS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderGoals() {
      const goalsText = data.goals?.mainGoals || '';
      if (!goalsText) return '';
      
      const goals = goalsText.split(/[.,]/).map(g => g.trim()).filter(g => g.length > 2);
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.target} Ğ¦Ğ•Ğ›Ğ˜</span></div>
          <div class="goals-list">${goals.map(g => `<span class="goal-tag">${g}</span>`).join('')}</div>
        </div>
      `;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER: MUSCLE LOAD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderMuscleLoad() {
      // Support both V1 (muscleHeatmap) and V2 (muscleLoad) API formats
      const heatmap = data.muscleHeatmap;
      const muscleLoad = data.muscleLoad;
      
      // Check if we have data from either source
      const hasHeatmapData = heatmap?.muscles && Object.keys(heatmap.muscles).length > 0;
      const hasMuscleLoadData = muscleLoad?.groups && Object.keys(muscleLoad.groups).length > 0;
      
      if (!hasHeatmapData && !hasMuscleLoadData) {
        return `<div class="card"><div class="card-title">${ICONS.muscle} Ğ ĞĞ¡ĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ•ĞĞ˜Ğ• ĞĞĞ“Ğ Ğ£Ğ—ĞšĞ˜</div>
          <div class="empty-state"><div class="empty-icon">${ICONS.muscle}</div>ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ</div></div>`;
      }
      
      // Define muscle groups for rendering
      const groupDefs = {
        legs: { 
          name: 'ĞĞ¾Ğ³Ğ¸', 
          icon: ICONS.leg, 
          color: '#007aff',
          muscles: ['quads', 'hamstrings', 'glutes', 'calves'],
          labels: { quads: 'ĞšĞ²Ğ°Ğ´Ñ€Ğ¸Ñ†ĞµĞ¿Ñ', hamstrings: 'Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ Ğ±ĞµĞ´Ñ€Ğ°', glutes: 'Ğ¯Ğ³Ğ¾Ğ´Ğ¸Ñ†Ñ‹', calves: 'Ğ˜ĞºÑ€Ñ‹' }
        },
        back: { 
          name: 'Ğ¡Ğ¿Ğ¸Ğ½Ğ°', 
          icon: ICONS.back, 
          color: '#5856d6',
          muscles: ['lats', 'traps', 'low_back'],
          labels: { lats: 'Ğ¨Ğ¸Ñ€Ğ¾Ñ‡Ğ°Ğ¹ÑˆĞ¸Ğµ', traps: 'Ğ¢Ñ€Ğ°Ğ¿ĞµÑ†Ğ¸Ñ', low_back: 'ĞŸĞ¾ÑÑĞ½Ğ¸Ñ†Ğ°' }
        },
        chest: { 
          name: 'Ğ“Ñ€ÑƒĞ´ÑŒ', 
          icon: ICONS.chest, 
          color: '#ff2d55',
          muscles: ['chest'],
          labels: { chest: 'Ğ“Ñ€ÑƒĞ´ÑŒ' }
        },
        arms: { 
          name: 'Ğ ÑƒĞºĞ¸ Ğ¸ Ğ¿Ğ»ĞµÑ‡Ğ¸', 
          icon: ICONS.muscle, 
          color: '#ff9500',
          muscles: ['biceps', 'triceps', 'front_delt', 'mid_delt', 'rear_delt'],
          labels: { biceps: 'Ğ‘Ğ¸Ñ†ĞµĞ¿Ñ', triceps: 'Ğ¢Ñ€Ğ¸Ñ†ĞµĞ¿Ñ', front_delt: 'ĞŸĞµÑ€ĞµĞ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°', mid_delt: 'Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°', rear_delt: 'Ğ—Ğ°Ğ´Ğ½ÑÑ Ğ´ĞµĞ»ÑŒÑ‚Ğ°' }
        }
      };
      
      let maxGroupSets = 0;
      const groups = {};
      
      if (hasMuscleLoadData) {
        // V2 API format: muscleLoad.groups
        for (const [key, groupData] of Object.entries(muscleLoad.groups)) {
          const def = groupDefs[key];
          if (!def) continue;
          
          groups[key] = {
            ...def,
            totalSets: groupData.totalSets || 0,
            muscleData: groupData.muscles || {}
          };
          maxGroupSets = Math.max(maxGroupSets, groups[key].totalSets);
        }
      } else if (hasHeatmapData) {
        // V1 API format: muscleHeatmap.muscles
        const muscles = heatmap.muscles;
        for (const [key, def] of Object.entries(groupDefs)) {
          const totalSets = def.muscles.reduce((sum, m) => sum + (muscles[m]?.sets || 0), 0);
          groups[key] = {
            ...def,
            totalSets: totalSets,
            muscleData: {}
          };
          // Convert to V2 format
          for (const m of def.muscles) {
            groups[key].muscleData[m] = {
              name: def.labels[m],
              sets: muscles[m]?.sets || 0,
              volume: muscles[m]?.volume || 0
            };
          }
          maxGroupSets = Math.max(maxGroupSets, totalSets);
        }
      }
      
      return `
        <div class="card">
          <div class="card-header">
            <span class="card-title">${ICONS.muscle} Ğ ĞĞ¡ĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ•ĞĞ˜Ğ• ĞĞĞ“Ğ Ğ£Ğ—ĞšĞ˜</span>
            <div class="period-selector">
              <button class="period-btn ${currentPeriod === 'block' ? 'active' : ''}" onclick="setPeriod('block')">Ğ‘Ğ»Ğ¾Ğº</button>
              <button class="period-btn ${currentPeriod === '3m' ? 'active' : ''}" onclick="setPeriod('3m')">3 Ğ¼ĞµÑ</button>
              <button class="period-btn ${currentPeriod === 'all' ? 'active' : ''}" onclick="setPeriod('all')">Ğ’ÑÑ‘</button>
            </div>
          </div>
          <div class="muscle-groups">
            ${Object.entries(groups)
              .sort((a, b) => b[1].totalSets - a[1].totalSets)
              .map(([key, group]) => {
              const width = maxGroupSets > 0 ? (group.totalSets / maxGroupSets) * 100 : 0;
              return `
                <div class="muscle-group" id="group-${key}">
                  <div class="muscle-group-header" onclick="toggleMuscleGroup('${key}')">
                    <div class="muscle-group-name">
                      <span class="muscle-group-icon">${group.icon}</span>
                      ${group.name}
                    </div>
                    <div class="muscle-group-stats">
                      <span class="muscle-group-sets">${Math.round(group.totalSets)} Ğ¿Ğ¾Ğ´Ñ….</span>
                      <div class="muscle-group-bar">
                        <div class="muscle-group-fill" style="width: ${width}%; background: ${group.color}"></div>
                      </div>
                      <span class="muscle-group-arrow">â–¼</span>
                    </div>
                  </div>
                  <div class="muscle-details">
                    ${group.muscles.map(m => {
                      const mData = group.muscleData[m] || {};
                      const sets = mData.sets || 0;
                      return `
                        <div class="muscle-item">
                          <span class="muscle-name">${group.labels[m]}</span>
                          <span class="muscle-value">${Math.round(sets * 10) / 10}</span>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }
    
    function toggleMuscleGroup(key) {
      document.getElementById(`group-${key}`).classList.toggle('expanded');
    }
    
    async function setPeriod(period) {
      currentPeriod = period;
      await loadDashboard();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER: WEEKLY COMPARISON
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderWeeklyComparison() {
      // Use pre-calculated data from API if available
      const apiComparison = data.weeklyComparison;
      
      let thisWeek, lastWeek, countChange, volumeChange;
      
      if (apiComparison?.thisWeek) {
        // Use API data
        thisWeek = apiComparison.thisWeek;
        lastWeek = apiComparison.lastWeek;
        countChange = apiComparison.changes?.count || (thisWeek.count - lastWeek.count);
        volumeChange = apiComparison.changes?.volumePercent || 0;
      } else {
        // Fallback: calculate from allSessions
        const sessions = data.allSessions || data.recentSessions || [];
        
        const now = new Date();
        const dayOfWeek = now.getDay();
        const thisWeekStart = new Date(now);
        thisWeekStart.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        thisWeekStart.setHours(0, 0, 0, 0);
        
        const lastWeekStart = new Date(thisWeekStart);
        lastWeekStart.setDate(lastWeekStart.getDate() - 7);
        
        thisWeek = { count: 0, volume: 0 };
        lastWeek = { count: 0, volume: 0 };
        
        sessions.forEach(s => {
          const date = new Date(s.date);
          const volume = s.totalVolume || 0;
          
          if (date >= thisWeekStart) {
            thisWeek.count++;
            thisWeek.volume += volume;
          } else if (date >= lastWeekStart && date < thisWeekStart) {
            lastWeek.count++;
            lastWeek.volume += volume;
          }
        });
        
        countChange = thisWeek.count - lastWeek.count;
        volumeChange = lastWeek.volume > 0 
          ? Math.round(((thisWeek.volume - lastWeek.volume) / lastWeek.volume) * 100) 
          : 0;
      }
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.chart} Ğ­Ğ¢Ğ ĞĞ•Ğ”Ğ•Ğ›Ğ¯ VS ĞŸĞ ĞĞ¨Ğ›ĞĞ¯</span></div>
          <div class="weeks-comparison">
            <div class="week-card">
              <div class="week-label">Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº</div>
              <div class="week-value">${thisWeek.count}</div>
              <div class="week-subvalue">Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°Ñ: ${lastWeek.count}</div>
              <div class="week-change ${countChange > 0 ? 'up' : countChange < 0 ? 'down' : 'same'}">
                ${countChange > 0 ? 'â†‘' : countChange < 0 ? 'â†“' : '='} ${Math.abs(countChange)}
              </div>
            </div>
            <div class="week-card">
              <div class="week-label">Ğ¢Ğ¾Ğ½Ğ½Ğ°Ğ¶ (ĞºĞ³)</div>
              <div class="week-value">${formatNumber(thisWeek.volume)}</div>
              <div class="week-subvalue">Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°Ñ: ${formatNumber(lastWeek.volume)}</div>
              <div class="week-change ${volumeChange > 0 ? 'up' : volumeChange < 0 ? 'down' : 'same'}">
                ${volumeChange > 0 ? 'â†‘' : volumeChange < 0 ? 'â†“' : ''} ${Math.abs(volumeChange)}%
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER: PROGRESS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderProgress() {
      // API V2 Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ improvements, V1 - topExercises
      const progress = data.exerciseProgress?.improvements || data.exerciseProgress?.topExercises || [];
      const improved = progress.filter(ex => (ex.progressPercent || ex.progress) > 0);
      
      if (!improved.length) {
        return `<div class="card"><div class="card-title">${ICONS.rocket} ĞŸĞ ĞĞ“Ğ Ğ•Ğ¡Ğ¡</div>
          <div class="empty-state"><div class="empty-icon">${ICONS.rocket}</div>ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ¾Ğ²</div></div>`;
      }
      
      return `
        <div class="card">
          <div class="card-header">
            <span class="card-title">${ICONS.rocket} ĞŸĞ ĞĞ“Ğ Ğ•Ğ¡Ğ¡</span>
            <span style="font-size: 12px; color: var(--text-secondary);">ĞŸĞ¾Ğ²Ñ‹ÑˆĞµĞ½Ğ¸Ğµ Ğ²ĞµÑĞ°</span>
          </div>
          ${improved.slice(0, 5).map(ex => {
            const weight = ex.currentWeight || ex.lastWeight || 0;
            const progressKg = ex.progressKg || 0;
            const progressPct = ex.progressPercent || ex.progress || 0;
            return `
            <div class="progress-item">
              <div class="progress-info">
                <div class="progress-name">${ex.name}</div>
                <div class="progress-date">${ICONS.calendar} ${ex.lastDate || ex.recordDate || 'Ğ½ĞµĞ´Ğ°Ğ²Ğ½Ğ¾'}</div>
              </div>
              <div class="progress-values">
                <div class="progress-weight">${weight} ĞºĞ³</div>
                <div class="progress-change">+${progressKg} ĞºĞ³ (+${progressPct}%)</div>
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER: RECENT SESSIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderRecentSessions() {
      const sessions = data.recentSessions || [];
      
      if (!sessions.length) {
        return `<div class="card"><div class="card-title">${ICONS.calendar} Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞ˜</div>
          <div class="empty-state"><div class="empty-icon">${ICONS.calendar}</div>ĞĞµÑ‚ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº</div></div>`;
      }
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.calendar} ĞŸĞĞ¡Ğ›Ğ•Ğ”ĞĞ˜Ğ• Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞ˜</span></div>
          ${sessions.slice(0, 3).map((s, i) => `
            <div class="session-item" onclick="showSessionModal(${i})">
              <div class="session-header">
                <span class="session-date">${formatDate(s.date)}</span>
                <span class="session-type">${s.splitType || s.type || 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°'}</span>
              </div>
              <div class="session-stats">
                <span class="session-stat">${ICONS.weight} ${s.exerciseCount || 0} ÑƒĞ¿Ñ€.</span>
                <span class="session-stat">${ICONS.chart} ${s.totalSets || 0} Ğ¿Ğ¾Ğ´Ñ….</span>
                <span class="session-stat">${ICONS.scale} ${formatNumber(s.totalVolume || 0)} ĞºĞ³</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER: HISTORY PAGE WITH CHART
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderHistoryPage() {
      const sessions = data.recentSessions || [];
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.chartUp} Ğ¢ĞĞĞĞĞ– ĞŸĞ Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞĞœ</span></div>
          <div class="chart-container">
            <canvas id="tonnageChart"></canvas>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.clipboard} Ğ’Ğ¡Ğ• Ğ¢Ğ Ğ•ĞĞ˜Ğ ĞĞ’ĞšĞ˜</span></div>
          ${sessions.map((s, i) => `
            <div class="session-item" onclick="showSessionModal(${i})">
              <div class="session-header">
                <span class="session-date">${formatDate(s.date)}</span>
                <span class="session-type">${s.splitType || s.type || ''}</span>
              </div>
              <div class="session-stats">
                <span class="session-stat">${ICONS.weight} ${s.exerciseCount || 0} ÑƒĞ¿Ñ€.</span>
                <span class="session-stat">${ICONS.scale} ${formatNumber(s.totalVolume || 0)} ĞºĞ³</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function initTonnageChart() {
      const canvas = document.getElementById('tonnageChart');
      if (!canvas) return;
      
      const sessions = (data.recentSessions || []).slice(0, 10).reverse();
      
      if (tonnageChart) {
        tonnageChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      tonnageChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sessions.map(s => formatDate(s.date)),
          datasets: [{
            label: 'Ğ¢Ğ¾Ğ½Ğ½Ğ°Ğ¶ (ĞºĞ³)',
            data: sessions.map(s => s.totalVolume || 0),
            borderColor: '#0071e3',
            backgroundColor: 'rgba(0, 113, 227, 0.1)',
            borderWidth: 2,
            pointRadius: 5,
            pointBackgroundColor: '#0071e3',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 7,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#e5e5e5' },
              ticks: { font: { size: 11 } }
            },
            x: {
              grid: { display: false },
              ticks: { font: { size: 10 } }
            }
          }
        }
      });
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER: RECORDS PAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function renderRecordsPage() {
      // API V2 Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ improvements, V1 - topExercises
      const progress = data.exerciseProgress?.improvements || data.exerciseProgress?.topExercises || [];
      const allRecords = progress.filter(p => (p.progressPercent || p.progress) > 0).map(p => ({
        type: 'ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ²ĞµÑĞ°',
        name: p.name,
        value: `${p.currentWeight || p.lastWeight} ĞºĞ³`,
        date: p.lastDate || p.recordDate,
        change: `+${p.progressKg} ĞºĞ³`
      }));
      
      return `
        <div class="card">
          <div class="card-header"><span class="card-title">${ICONS.trophy} Ğ’Ğ¡Ğ• Ğ Ğ•ĞšĞĞ Ğ”Ğ«</span></div>
          ${allRecords.length ? allRecords.map(r => `
            <div class="record-item">
              <div>
                <div class="record-type">${r.type}</div>
                <div class="record-name">${r.name}</div>
              </div>
              <div class="record-value-container">
                <div class="record-value">${r.value}</div>
                <div class="record-date">${r.date || ''} ${r.change ? 'â€¢ ' + r.change : ''}</div>
              </div>
            </div>
          `).join('') : `<div class="empty-state"><div class="empty-icon">${ICONS.trophy}</div>ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ¾Ğ²</div>`}
        </div>
      `;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODALS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function showSessionModal(index) {
      const session = data.recentSessions[index];
      if (!session) return;
      
      // Get exercises from session
      const exercises = session.exercises || [];
      
      const modal = document.getElementById('sessionModal');
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-handle"></div>
          <h2>${formatDate(session.date)}</h2>
          <div class="modal-subtitle">${session.splitType || session.type || 'Ğ¢Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°'}</div>
          
          <div class="modal-section">
            <div class="modal-stat-grid">
              <div class="modal-stat">
                <div class="modal-stat-value">${session.exerciseCount || exercises.length || 0}</div>
                <div class="modal-stat-label">Ğ£Ğ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğ¹</div>
              </div>
              <div class="modal-stat">
                <div class="modal-stat-value">${session.totalSets || 0}</div>
                <div class="modal-stat-label">ĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´Ğ¾Ğ²</div>
              </div>
              <div class="modal-stat">
                <div class="modal-stat-value">${formatNumber(session.totalVolume || 0)}</div>
                <div class="modal-stat-label">Ğ¢Ğ¾Ğ½Ğ½Ğ°Ğ¶ (ĞºĞ³)</div>
              </div>
            </div>
          </div>
          
          ${exercises.length ? `
          <div class="modal-section">
            <div class="modal-section-title">${ICONS.weight} Ğ£ĞŸĞ ĞĞ–ĞĞ•ĞĞ˜Ğ¯</div>
            <div class="modal-exercise-list">
              ${exercises.map(ex => {
                const setsText = ex.sets ? ex.sets + ' Ğ¿Ğ¾Ğ´Ñ…' : '';
                const repsText = ex.reps ? 'Ã— ' + ex.reps : '';
                const weightText = ex.weight ? ex.weight + ' ĞºĞ³' : 'Ğ±ĞµĞ· Ğ²ĞµÑĞ°';
                return `
                <div class="modal-exercise">
                  <span class="modal-exercise-name">${ex.name || 'Ğ£Ğ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ğµ'}</span>
                  <span class="modal-exercise-detail">
                    ${setsText}${repsText}${ex.weight ? ' â€¢ ' + weightText : ''}
                  </span>
                </div>
              `}).join('')}
            </div>
          </div>
          ` : `
          <div class="modal-section">
            <div class="modal-section-title">${ICONS.weight} Ğ£ĞŸĞ ĞĞ–ĞĞ•ĞĞ˜Ğ¯</div>
            <div style="color: var(--text-secondary); font-size: 14px; padding: 12px 0;">
              Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ± ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸ÑÑ… Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ğ¸Ğ· WorkoutLog...
            </div>
          </div>
          `}
          
          ${session.notes ? `
          <div class="modal-section">
            <div class="modal-section-title">Ğ—ĞĞœĞ•Ğ¢ĞšĞ˜</div>
            <div style="padding: 12px; background: var(--bg); border-radius: 8px;">${session.notes}</div>
          </div>
          ` : ''}
          
          <div class="modal-section" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
            <div style="color: var(--text-secondary); font-size: 13px; text-align: center;">
              ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ² Google Sheets
            </div>
          </div>
        </div>
      `;
      modal.classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('sessionModal').classList.remove('active');
    }
    
    function showSettings() {
      const modal = document.getElementById('settingsModal');
      modal.innerHTML = `
        <div class="modal settings-modal">
          <h2>${ICONS.gear} ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</h2>
          <label>API URL</label>
          <input type="text" id="apiUrlInput" value="${CONFIG.API_URL}" placeholder="https://script.google.com/...">
          <label>Client ID</label>
          <input type="text" id="clientIdInput" value="${CONFIG.CLIENT_ID}" placeholder="yaroslav">
          <div class="modal-buttons">
            <button class="btn-cancel" onclick="hideSettings()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
            <button class="btn-save" onclick="saveSettings()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
          </div>
        </div>
      `;
      modal.classList.add('active');
    }
    
    function hideSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }
    
    function saveSettings() {
      CONFIG.API_URL = document.getElementById('apiUrlInput').value.trim();
      CONFIG.CLIENT_ID = document.getElementById('clientIdInput').value.trim() || 'yaroslav';
      hideSettings();
      loadDashboard();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function showPage(page) {
      currentPage = page;
      
      document.querySelectorAll('.nav-item').forEach((item, i) => {
        const pages = ['main', 'history', 'records'];
        item.classList.toggle('active', pages[i] === page);
      });
      
      document.getElementById('mainPage').classList.toggle('hidden', page !== 'main');
      document.getElementById('historyPage').classList.toggle('active', page === 'history');
      document.getElementById('recordsPage').classList.toggle('active', page === 'records');
      
      if (page === 'history') {
        setTimeout(initTonnageChart, 100);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function formatDate(str) {
      if (!str) return '';
      try {
        return new Date(str).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
      } catch { return str; }
    }
    
    function formatDateFull(str) {
      if (!str) return '';
      try {
        return new Date(str).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
      } catch { return str; }
    }
    
    function formatNumber(n) {
      if (n >= 1000) return Math.round(n / 100) / 10 + 'k';
      return Math.round(n);
    }
    
    function showSetupScreen() {
      document.getElementById('app').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 20px;">${ICONS.gear}</div>
          <h2 style="margin-bottom: 12px;">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ</h2>
          <p style="color: var(--text-secondary); margin-bottom: 24px;">Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ URL API Ğ¸ ID ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°</p>
          <button onclick="showSettingsFromSetup()" style="background: var(--accent); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 16px; cursor: pointer;">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ</button>
        </div>
        <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)hideSettings()"></div>
      `;
    }
    
    function showSettingsFromSetup() { showSettings(); }
    
    function showError(msg) {
      document.getElementById('app').innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">${ICONS.sad}</div>
          <div style="color: var(--danger); margin-bottom: 8px;">ĞÑˆĞ¸Ğ±ĞºĞ°</div>
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; max-width: 300px;">${msg}</div>
          <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
            <button onclick="loadDashboard()" style="background: var(--accent); color: white; border: none; padding: 14px 28px; border-radius: 12px; cursor: pointer;">ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
            <button onclick="showSettings()" style="background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 14px 28px; border-radius: 12px; cursor: pointer;">${ICONS.gear} ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</button>
          </div>
          <div style="margin-top: 24px; padding: 16px; background: var(--card); border-radius: 12px; max-width: 320px; text-align: left;">
            <div style="font-weight: 600; margin-bottom: 8px;">Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
              â€¢ API Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½ (Ğ½ÑƒĞ¶ĞµĞ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Deploy)<br>
              â€¢ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ URL API<br>
              â€¢ ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½
            </div>
          </div>
        </div>
        <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)hideSettings()"></div>
      `;
    }
    
    // Init
    document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
</body>
</html>
