# Подробная инструкция: первый запуск и восстановление работы

Пошаговая инструкция для первого раза: что за что отвечает, чем дашборд Марка отличается от дашборда офлайн-клиентов, как всё запустить и что сделать для единой концепции (Supabase).

**Правила для AI:** при изменениях в коде указывать затронутые разделы [1]–[7] и контур (Master/Supabase или Mark/GAS). Полные правила: **docs/cursorrules_v2.1.md**, **docs/CLAUDE_RULES_V2.1.md**. Текущий статус: **docs/SYNC_STATUS.md**.

---

## Часть 1. Архитектура: кто что использует

Перед тем как что-то запускать, важно понимать **две разные ветки** системы.

### 1.1. Дашборд тренера и офлайн-клиентов (Kирилл, Ярослав)

| Что | Где | Откуда данные |
|-----|-----|----------------|
| Вход | `deploy/master/login.html` | Supabase Auth |
| Дашборд | `deploy/master/dashboard/index.html` | **Supabase** (таблицы `clients`, `programs`, `training_blocks`, `workout_sessions` и т.д.) |
| Выбор клиента | На дашборде после входа | Список клиентов из Supabase по твоему `trainer_id` |

**Особенности:**  
Тренер логинится → выбирает клиента из списка → видит его блок, тренировки, неделю и т.д. Всё уже переведено на Supabase (после миграции и настройки RLS).

---

### 1.2. Дашборд Марка (трекер Марка) — другая архитектура

У Марка **отдельный дашборд** — не тот же HTML, что у офлайн-клиентов. С ним работа строилась иначе: один клиент (Марк), без выбора из списка, без входа тренера.

| Что | Где | Откуда данные **сейчас** |
|-----|-----|----------------------------|
| Дашборд Марка (трекер) | `deploy/mark/dashboard/index.html` | **Google Apps Script (Master API)** по умолчанию: `dashboardMasterApiUrl` → запросы с `clientId=1` (Марк) |
| Ссылка «Программа» | Ведёт на `deploy/mark/program/index.html` | См. ниже |

**Чем отличается от дашборда офлайн-клиентов:**

- Нет страницы входа: Марк открывает свой дашборд по прямой ссылке.
- Нет экрана «Выберите клиента»: всегда один клиент (Марк, `CLIENT_ID = '1'`).
- Данные дашборда (цели, Daily, тренировки, питание) берутся из **Master API** (Google Script), а не из Supabase.
- В настройках дашборда Марка хранятся: URL Master API и ID клиента (1).

То есть **дашборд Марка** — это по сути «Master API + clientId=1» с другим интерфейсом и без логина. До интеграции в Supabase так и работало.

---

### 1.3. Программа Марка (тренировочная программа, которую он заполняет сам)

У Марка есть **вторая часть** — страница **«Программа»** (тренировки A/B/C, ввод подходов, сохранение в таблицу).

| Что | Где | Откуда данные |
|-----|-----|----------------|
| Программа тренировок Марка | `deploy/mark/program/index.html` | **Отдельный Google Apps Script** (свой URL в настройках: `markWorkoutApiUrl`) |

**Важно:** это **не** тот же скрипт, что Master API для дашборда.

- У **Master API** есть: `getClients`, `getGoals`, `getDaily`, `getWorkouts` и т.д. (нет `getWorkoutPrograms`).
- У **скрипта Марка** (его таблица/скрипт): `getWorkoutPrograms` (содержимое программ A/B/C, которое Марк/тренер заполняет в таблице), плюс `getWorkouts`, `getDaily` и методы сохранения (workouts, daily).

В интерфейсе программы Марка это отображается так:

- Если указан `markWorkoutApiUrl` и скрипт отвечает — показывается бейдж **«Программы из таблицы»**.
- Если URL не задан или ошибка — используются **«Стандартные программы»** (встроенные в JS программы A/B/C).

Итого: **дашборд Марка** = Master API (общий скрипт, clientId=1); **программа Марка** = свой скрипт и своя таблица с тренировочной программой.

---

### 1.4. Сводная схема

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Тренер + офлайн-клиенты (Кирилл, Ярослав)                                │
│   login.html → dashboard (master) → выбор клиента → данные из SUPABASE  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ Марк                                                                     │
│   • Дашборд Марка (deploy/mark/dashboard) → MASTER API (clientId=1)     │
│   • Программа Марка (deploy/mark/program)  → ОТДЕЛЬНЫЙ СКРИПТ/ТАБЛИЦА   │
│     (getWorkoutPrograms, getWorkouts, getDaily, save...)                 │
└─────────────────────────────────────────────────────────────────────────┘
```

До перехода на Supabase всё работало так. Сейчас: master-дашборд уже на Supabase; дашборд и программа Марка по-прежнему могут опираться на старые скрипты, пока их не переведут на Supabase.

---

## Часть 2. Подготовка (один раз)

Сделай это перед первым запуском.

### Шаг 2.1. Пользователь для входа в Supabase

1. Зайди в **Supabase Dashboard**: https://supabase.com/dashboard  
2. Выбери проект (например, **fitness-coach-system**).  
3. В левом меню: **Authentication** → **Users**.  
4. Проверь: есть ли пользователь с твоим email (например `gladkovny@gmail.com`).  
   - Если **нет** — нажми **Add user**, введи email и пароль, запомни пароль.  
   - Если **есть** — пароль ты задавал при создании; при необходимости сбрось или создай нового пользователя.

Этот email и пароль будут использоваться на странице входа в master-дашборд.

---

### Шаг 2.2. Привязка тренера к пользователю (auth_id)

Без этого после входа список клиентов не появится (RLS отфильтрует по `auth_id`).

1. В Supabase: **Table Editor** → таблица **trainers**.  
2. Найди строку с твоим email.  
3. В колонке **auth_id** должно быть значение (UUID).  
   - Если **auth_id пустой**:  
     - Зайди в **Authentication** → **Users** и скопируй **id** (UUID) нужного пользователя.  
     - В **SQL Editor** выполни (подставь свой email и скопированный UUID):

```sql
UPDATE trainers
SET auth_id = 'СЮДА_ВСТАВЬ_UUID_ИЗ_AUTH_USERS'
WHERE email = 'твой_email@gmail.com';
```

---

### Шаг 2.3. Конфиг фронта (master)

1. В проекте открой **`deploy/master/js/supabase-config.js`**.  
2. Должны быть заданы:
   - `window.SUPABASE_URL` — Project URL из Supabase (**Project Settings** → **API** → **Project URL**);
   - `window.SUPABASE_ANON_KEY` — ключ **anon public** с того же экрана.

Без правильных URL и ключа вход и загрузка данных из Supabase не заработают.

---

### Шаг 2.4. Марк в Supabase (чтобы он был в списке клиентов master-дашборда)

Чтобы в общем дашборде (после входа) можно было выбрать Марка и видеть его данные из Supabase, Марк должен быть в таблице `clients` и иметь программу/блок.

1. В Supabase открой **SQL Editor**.  
2. Выполни скрипт **`supabase/scripts/ensure_mark_dashboard.sql`** (скопируй содержимое файла и вставь в редактор, затем Run).

Скрипт: находит тренера, при отсутствии создаёт клиента «Марк», при отсутствии — программу и один блок. После этого в master-дашборде в списке клиентов появится Марк, и его дашборд из Supabase будет открываться по выбору «Марк».

Это не меняет работу **отдельного** дашборда Марка (`deploy/mark/dashboard`) и его **программы** (`deploy/mark/program`) — они по-прежнему ходят в свои API (Master API и скрипт Марка).

---

## Часть 3. Запуск и проверка по шагам (первый раз)

### Шаг 3.1. Запуск локального сервера

Страницы нужно открывать через локальный сервер (не двойной щелчок по файлу), иначе возможны ошибки CORS при обращении к Supabase.

1. Открой терминал (в Cursor: **Terminal** → **New Terminal**, или PowerShell/cmd).  
2. Перейди в корень проекта:

   ```bash
   cd C:\Users\n.gladkov\Desktop\fitness-coach-system
   ```

3. Запусти раздачу папки `deploy/master` на порт 3000.

   **Вариант А — Node.js (если установлен):**

   ```bash
   npx serve deploy/master -l 3000
   ```

   Если появляется ошибка *«npx не распознан»* или *«npx is not recognized»* — Node.js не установлен или не в PATH; используй вариант Б (Python) или установи Node.js с https://nodejs.org (LTS).

   При первом запуске может спросить установить пакет `serve` — ответь **y**.

   **Вариант Б — без Node (Python):**

   ```powershell
   cd deploy\master
   python -m http.server 3000
   ```

   Если `python` не найден, попробуй `py -m http.server 3000`. Убедись, что находишься в корне проекта перед `cd` (при необходимости выполни: `cd C:\Users\n.gladkov\Desktop\fitness-coach-system`).

4. Сервер оставь включённым. Адрес для браузера: **http://localhost:3000/login.html**

Если ни `npx`, ни `python`/`py` нет — установи Node.js (https://nodejs.org, LTS), перезапусти терминал и снова выполни команду из варианта А.

---

### Шаг 3.2. Вход и дашборд тренера (офлайн-клиенты)

1. В браузере открой: **http://localhost:3000/login.html**  
2. Введи email и пароль из Supabase (Authentication → Users).  
3. Нажми **«Войти»**.  
4. Должен произойти переход на **http://localhost:3000/dashboard/index.html** — экран **«Выберите клиента»**.  
5. Выбери клиента (Кирилл, Ярослав или Марк).  
6. Должна загрузиться главная страница дашборда: блок, цели, последние тренировки, неделя и т.д. Данные — из Supabase.

Если список клиентов пустой — проверь шаг 2.2 (заполнен ли `auth_id` у тренера). Если по клиенту пусто (нет блока, тренировок) — проверь данные в Supabase и при необходимости выполни шаги из [DATA_RESTORE_AND_MARK.md](DATA_RESTORE_AND_MARK.md) (Кирилл/Ярослав) и скрипт для Марка (шаг 2.4).

---

### Шаг 3.3. Проверка: без входа дашборд не открывается

1. В новой вкладке открой сразу: **http://localhost:3000/dashboard/index.html**  
2. Ожидаемое поведение: после проверки сессии браузер перенаправит на **login.html**. Если дашборд открылся без входа — проверка сессии на фронте не сработала.

---

### Шаг 3.4. Дашборд Марка (отдельный сайт Марка)

Это **не** тот же URL, что master-дашборд. У Марка свой интерфейс и свой источник данных (пока Master API).

1. Страницы Марка лежат в `deploy/mark/`, а не в `deploy/master/`. Если ты запускаешь только `npx serve deploy/master -l 3000`, то дашборд и программа Марка этим сервером не раздаются.  
   **Вариант А — один сервер из корня проекта:**
   ```bash
   npx serve -l 3000
   ```
   Тогда:
   - Master: http://localhost:3000/deploy/master/login.html  
   - Дашборд Марка: http://localhost:3000/deploy/mark/dashboard/index.html  
   - Программа Марка: http://localhost:3000/deploy/mark/program/index.html  

   **Вариант Б — два сервера:** оставь master на 3000 (`npx serve deploy/master -l 3000`). В **втором терминале** запусти:
   ```bash
   npx serve deploy/mark -l 3001
   ```
   Тогда дашборд Марка: http://localhost:3001/dashboard/index.html, программа Марка: http://localhost:3001/program/index.html.

   Либо открой файлы из `deploy/mark/` через `file://` (с риском CORS при запросах к Google Script).

2. Открой **дашборд Марка** по выбранному URL.  
3. Должен загрузиться дашборд с именем Марка, целями, Daily, тренировками. Данные идут из **Master API** (Google Script) с `clientId=1`.  
4. В настройках (иконка шестерёнки) указаны **URL Master API** и **ID клиента** (1). Если URL не задан — при первом открытии может показаться модальное окно с вводом URL.

Если данных нет — проверь, что Master API (Google Apps Script) опубликован и URL в настройках дашборда Марка верный. До миграции на Supabase дашборд Марка полностью зависел от этого скрипта.

---

### Шаг 3.5. Программа Марка (тренировки A/B/C, сохранение в таблицу)

1. С дашборда Марка перейди по ссылке **«Программа»** или открой вручную **`deploy/mark/program/index.html`** (через тот же сервер/порт, чтобы не было CORS).  
2. Если впервые: в блоке настроек может потребоваться ввести **URL Google Apps Script** Марка (тот, где реализованы `getWorkoutPrograms`, `getWorkouts`, `getDaily` и сохранение). Это значение сохраняется в `localStorage` как `markWorkoutApiUrl`.  
3. После ввода URL и сохранения должны подгрузиться программы из таблицы (бейдж **«Программы из таблицы»**). Если URL не задан или скрипт недоступен — останутся **«Стандартные программы»**.  
4. Выбери тренировку (A, B, C и т.д.), введи подходы и сохрани — запрос уйдёт в скрипт Марка (POST), данные пишутся в его таблицу.

Восстановление работы «как до Supabase» для Марка значит: Master API доступен для дашборда Марка, отдельный скрипт Марка доступен и настроен в программе (`markWorkoutApiUrl`).

---

## Часть 4. Восстановление данных (если что-то пусто)

- **Кирилл / Ярослав:** проверка и восстановление описаны в [DATA_RESTORE_AND_MARK.md](DATA_RESTORE_AND_MARK.md) (п. 1.1–1.3): SQL-проверка, при необходимости повторная миграция из Google Sheets или ручное дополнение в Supabase.  
- **Марк в списке клиентов master-дашборда:** выполни **`supabase/scripts/ensure_mark_dashboard.sql`** (см. шаг 2.4).  
- **Дашборд Марка (отдельный сайт):** данные идут из Master API; проверь публикацию скрипта и URL в настройках дашборда Марка.  
- **Программа Марка:** данные из отдельного скрипта/таблицы; проверь URL в настройках страницы программы (`markWorkoutApiUrl`) и работу скрипта (getWorkoutPrograms, getWorkouts, getDaily, save).

---

## Часть 5. Краткий чеклист первого запуска

- [ ] В Supabase есть пользователь Auth (email + пароль), пароль известен.  
- [ ] В таблице **trainers** у моей строки заполнен **auth_id** (UUID из Authentication → Users).  
- [ ] В **deploy/master/js/supabase-config.js** указаны актуальные **SUPABASE_URL** и **SUPABASE_ANON_KEY**.  
- [ ] Выполнен **ensure_mark_dashboard.sql**, Марк есть в `clients` с программой/блоком.  
- [ ] Запущен локальный сервер (например `npx serve deploy/master -l 3000` или с раздачей корня).  
- [ ] Открыт **http://localhost:3000/login.html**, введён email и пароль — переход на дашборд.  
- [ ] На дашборде выбран клиент (Кирилл, Ярослав или Марк) — загружаются данные из Supabase.  
- [ ] Проверено: при открытии dashboard без входа происходит редирект на login.  
- [ ] (Опционально) Открыт дашборд Марка (`deploy/mark/dashboard`) — данные подтягиваются из Master API.  
- [ ] (Опционально) Открыта программа Марка (`deploy/mark/program`), при необходимости задан URL скрипта Марка — программы и сохранение работают.

---

## Часть 6. Единая концепция: что уже в Supabase, что ещё нет

| Компонент | Сейчас | Дальше (для целостности) |
|-----------|--------|---------------------------|
| Вход, список клиентов, дашборд тренера (выбор клиента) | Supabase | — |
| Данные офлайн-клиентов (Кирилл, Ярослав) | Supabase | — |
| Марк в списке клиентов и его дашборд в master | Supabase (после ensure_mark_dashboard.sql) | — |
| Дашборд Марка (отдельный сайт) | Master API (GAS) | По желанию: перевести на чтение из Supabase по client_id Марка. |
| Программа Марка (A/B/C, сохранение) | Отдельный скрипт/таблица (markWorkoutApiUrl) | По желанию: перенести программы и логи тренировок в Supabase, заменить скрипт на API/Supabase. |

Когда всё переведено на Supabase, можно будет отключить зависимость от Google-скриптов и иметь единый источник данных и единую концепцию. Данная инструкция помогает первый раз запустить систему и восстановить работу как для тренера и офлайн-клиентов (уже Supabase), так и для Марка (дашборд + программа с его скриптом и таблицей).

Дополнительно: пошаговое тестирование входа и master-дашборда — в [TESTING_FIRST_TIME.md](TESTING_FIRST_TIME.md); восстановление данных Кирилла/Ярослава и Марка — в [DATA_RESTORE_AND_MARK.md](DATA_RESTORE_AND_MARK.md). Правила для AI (7 разделов, 2 контура): **docs/cursorrules_v2.1.md**, **docs/CLAUDE_RULES_V2.1.md**; текущий статус: **docs/SYNC_STATUS.md**.
