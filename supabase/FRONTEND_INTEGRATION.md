# Подключение фронтенда к Supabase

Экран входа, проверка сессии и загрузка клиентов/программ из Supabase.

> **Первый раз тестируешь этот этап?** Пошаговая инструкция «что открыть и в каком порядке» — в **[TESTING_FIRST_TIME.md](TESTING_FIRST_TIME.md)**.

---

## 1. Ключи проекта

В **Supabase Dashboard** → **Project Settings** → **API** возьми:

- **Project URL** — например `https://xxxx.supabase.co`
- **anon public** key — публичный ключ для браузера (не `service_role`)

Они задаются в одном месте: **`deploy/master/js/supabase-config.js`**. От этого файла зависят страница входа и дашборд.

---

## 2. Страница входа

Файл **`deploy/master/login.html`** подключает `supabase-config.js` и Supabase JS. После ввода email и пароля вызывается `signInWithPassword`; при успехе — переход на `dashboard/index.html` (или на URL из параметра `?redirect=...`).

---

## 3. Дашборд: сессия и клиенты

Дашборд **`deploy/master/dashboard/index.html`**:

1. Проверяет сессию — без входа редирект на `login.html`.
2. Загружает список клиентов из Supabase (`clients`), показывает экран «Выберите клиента».
3. После выбора клиента загружает программы, блоки, сессии и подходы и строит главную страницу (блок, цели, последние тренировки, неделя vs неделя).

Ключ и URL берутся из `deploy/master/js/supabase-config.js`. RLS ограничивает данные по тренеру (`auth.uid()` → `trainers.auth_id`).

---

## 4. Как проверить данный этап

### Что должно быть уже сделано

- В Supabase создан пользователь Auth (email + пароль) и запись в `trainers` связана с ним через `auth_id` ([AUTH_SETUP.md](AUTH_SETUP.md)).
- В таблицах `clients`, `programs`, `workout_sessions` и т.д. есть данные (миграция из GAS/Sheets выполнена).
- В **`deploy/master/js/supabase-config.js`** прописаны актуальные `SUPABASE_URL` и `SUPABASE_ANON_KEY`.

### Важно: как открывать страницы

Запросы к Supabase из браузера при открытии файлов по протоколу `file://` могут блокироваться (CORS, политики). Поэтому страницы лучше открывать через локальный сервер или хостинг.

**Вариант A — локальный сервер (рекомендуется):**

1. В корне проекта выполни:
   ```bash
   npx serve deploy/master -l 3000
   ```
2. В браузере открой: `http://localhost:3000/login.html`

**Вариант B — без сервера:**  
Открой `deploy/master/login.html` двойным щелчком. Если в консоли (F12) появятся ошибки CORS или «Failed to fetch» — перейди на вариант A.

---

### Шаг 1: Проверка входа

1. Открой `login.html` (через сервер или файл).
2. Введи **email** и **пароль** пользователя из Supabase Auth (тот же, что в таблице `trainers` по `auth_id`).
3. Нажми **«Войти»**.

**Ожидаемый результат:**

- Сообщений об ошибке нет (или «Неверный email или пароль» только при неверных данных).
- Происходит переход на `dashboard/index.html` (или на URL из `?redirect=...`).

**Если ошибка при входе:**

- Проверь в Supabase: **Authentication** → **Users** — есть ли пользователь с этим email.
- Проверь в **Authentication** → **Configuration** → **Providers** → Email: не включено ли обязательное подтверждение email (для теста его можно отключить).
- Убедись, что в `supabase-config.js` указаны именно **Project URL** и **anon public** key (не service_role).

---

### Шаг 2: Проверка выбора клиента и дашборда

1. После успешного входа должен открыться дашборд.
2. Если клиентов в Supabase нет — появится экран «Выберите клиента» с текстом «Нет клиентов».
3. Если клиенты есть — появится список имён. Нажми на одного клиента.

**Ожидаемый результат:**

- Загружается главная страница дашборда: имя клиента в шапке, карточки (блок, цели, последние тренировки, неделя vs неделя и т.д.).
- Данные соответствуют выбранному клиенту (из таблиц `clients`, `programs`, `workout_sessions` и т.д.).

**Если «Нет клиентов» при существующих записях в Supabase:**

- Убедись, что у тренера в `trainers` заполнен `auth_id` и он совпадает с `id` пользователя в **Authentication** → **Users**.
- В **SQL Editor** выполни:
  ```sql
  SELECT c.id, c.name, c.trainer_id, t.auth_id
  FROM clients c
  JOIN trainers t ON t.id = c.trainer_id
  WHERE t.auth_id IS NOT NULL;
  ```
  Должны вернуться клиенты твоего тренера. Если пусто — проверь `trainer_id` у записей в `clients`.

---

### Шаг 3: Проверка защиты по сессии

1. Выйди из учётной записи: на дашборде нажми «Сменить клиента», затем «Выйти», либо в настройках (шестерёнка) нажми «Выйти».
2. Вручную открой в браузере URL дашборда, например:  
   `http://localhost:3000/dashboard/index.html`

**Ожидаемый результат:**

- Происходит редирект на `login.html` (иногда с параметром `?redirect=...`), дашборд без входа не показывается.

---

### Шаг 4: Смена клиента и выход

1. Снова войди через `login.html`.
2. На дашборде в шапке нажми **«Сменить клиента»**.

**Ожидаемый результат:**

- Появляется экран выбора клиента; можно выбрать другого и снова увидеть его дашборд.
3. В настройках (шестерёнка) нажми **«Выйти»**.

**Ожидаемый результат:**

- Редирект на `login.html`, при повторном открытии дашборда снова запрашивается вход.

---

### Краткий чеклист этапа

| Проверка | Результат |
|----------|-----------|
| Вход с правильным email/паролем | Переход на дашборд |
| Список клиентов загружается | Видны клиенты из Supabase (или «Нет клиентов») |
| Выбор клиента | Отображается его дашборд (блок, сессии и т.д.) |
| Открытие дашборда без входа | Редирект на login |
| «Сменить клиента» и «Выйти» | Работают без ошибок |

Если все пункты выполняются — этап считается пройденным.

---

## 5. Что нужно сделать дальше

После успешной проверки логичный порядок такой:

### 5.1. Трекер (офлайн-трекинг тренировок)

Сейчас трекер (`deploy/master/tracker/index.html`) ходит в GAS API (свой URL и `client` в параметрах). Имеет смысл:

- Добавить на трекер ту же проверку сессии Supabase (редирект на `login.html` при отсутствии сессии).
- Выбор клиента — из Supabase (как на дашборде), либо передавать `client_id` в URL после входа.
- Загрузка программ/блоков/упражнений для выбранного клиента — из Supabase (`programs`, `training_blocks`, `exercises`).
- Запись новых тренировок и подходов — писать в Supabase (`workout_sessions`, `workout_sets`) вместо или вдобавок к GAS.

Итог: один вход (Supabase), один источник данных (Supabase) для дашборда и трекера.

---

### 5.2. Страница оценки (assessment)

Файл `deploy/master/tracker/assessment.html` — сохранение вводной оценки. Варианты:

- Либо оставить вызов GAS для сохранения (если там сложная логика).
- Либо сохранять в Supabase (например, в `daily_logs` или отдельную таблицу оценок), с той же авторизацией и привязкой к клиенту.

---

### 5.3. Полный отказ от GAS API (по желанию)

Когда весь нужный функционал будет дублироваться в Supabase:

- Убрать с фронта обращение к GAS URL (или оставить только для редких операций).
- Сложную логику (агрегации, отчёты) вынести в **Supabase Edge Functions** и вызывать их с фронта с передачей `Authorization: Bearer <access_token>`.

---

### 5.4. Деплой на хостинг

Сейчас проверка идёт локально или через `npx serve`. Для постоянного использования:

- Разместить папку `deploy/master` (или сборку фронта) на Netlify, Vercel, GitHub Pages и т.п.
- Убедиться, что в production используется тот же `supabase-config.js` с нужными URL и anon key (или подставлять их через переменные окружения при сборке).

---

### Сводка «что дальше»

| Приоритет | Задача | Описание |
|-----------|--------|----------|
| 1 | Трекер + Supabase | Сессия, выбор клиента из Supabase, чтение/запись тренировок в Supabase. |
| 2 | Assessment | Сохранение оценок в Supabase или оставить GAS. |
| 3 | Отказ от GAS | Постепенно перенести оставшиеся действия в Supabase / Edge Functions. |
| 4 | Деплой | Выложить фронт на хостинг с тем же конфигом Supabase. |

Дополнительно: [AUTH_SETUP.md](AUTH_SETUP.md), [ROADMAP_NEXT_STEPS.md](../docs/ROADMAP_NEXT_STEPS.md).
