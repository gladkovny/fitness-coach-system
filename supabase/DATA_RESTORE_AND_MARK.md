# Восстановление данных клиентов и дашборд Марка

Как проверить и при необходимости восстановить данные Кирилла и Ярослава, и как сделать так, чтобы дашборд Марка отображался в общей системе (master).

---

## 1. Кирилл и Ярослав — проверка и восстановление данных

Дашборд в `deploy/master/dashboard` тянет данные из Supabase: **clients**, **programs**, **training_blocks**, **workout_sessions**, **workout_sets**. Если у клиента «Нет данных» по нагрузке или пустой прогресс — чаще всего в БД нет записей или не заполнен `profile`.

### 1.1. Проверка в Supabase (SQL Editor)

Выполни в **Supabase → SQL Editor**:

```sql
-- Клиенты и количество связанных записей
SELECT
  c.id,
  c.name,
  (SELECT COUNT(*) FROM programs p WHERE p.client_id = c.id) AS programs_count,
  (SELECT COUNT(*) FROM workout_sessions s WHERE s.client_id = c.id) AS sessions_count,
  (SELECT COUNT(*) FROM training_blocks b
   JOIN programs p ON p.id = b.program_id WHERE p.client_id = c.id) AS blocks_count
FROM clients c
WHERE c.name ILIKE '%кирилл%'
   OR c.name ILIKE '%ярослав%'
   OR c.name ILIKE '%yaroslav%'
ORDER BY c.name;
```

По результату:
- **programs_count = 0** — у клиента нет программ, блок и часть дашборда будут пустыми.
- **sessions_count = 0** — нет тренировок, «Последние тренировки» и «Неделя vs прошлая» будут пустыми.
- **blocks_count = 0** — карточка «Блок» покажет «Нет активного блока».

### 1.2. Восстановление из Google Sheets (повторная миграция)

Если данные в Sheets актуальны, а в Supabase чего-то не хватает:

1. В **Google Apps Script** (проект с Master API) открой **MigrateToSupabase.gs**.
2. Убедись, что заданы свойства: **SUPABASE_URL**, **SUPABASE_SERVICE_ROLE_KEY**, **MIGRATION_TRAINER_EMAIL**.
3. Запуск:
   - **Полная миграция:** `migrateToSupabase()` (без аргументов). Перезапишет/добавит тренера, клиентов, упражнения, программы, блоки, сессии, подходы.
   - Только один клиент по его ID в Sheets не поддерживается напрямую; полный прогон обновит всех, включая Кирилла и Ярослава.

После прогона снова выполни проверочный SQL из п. 1.1 и открой дашборд master — выбери Кирилла и Ярослава по очереди и проверь блоки, тренировки, нагрузку.

### 1.3. Ручное дополнение в Supabase

Если миграцию повторять не хочешь:

- **Цели и дата старта:** в **Table Editor → clients** открой запись Кирилла/Ярослава и в колонке **profile** (JSONB) добавь, например:  
  `{"mainGoals": "ОФП, сила", "startDate": "2026-01-08"}`.
- **Программа и блок:** создай запись в **programs** (client_id = id клиента, trainer_id = твой тренер), затем в **training_blocks** (program_id = id программы, total_sessions, used_sessions, start_date, status = 'active').
- **Тренировки:** при необходимости добавляй **workout_sessions** и **workout_sets** вручную или через трекер.

---

## 2. Дашборд Марка в общей системе (master)

В master дашборде список клиентов и данные берутся из Supabase. Чтобы у Марка был такой же дашборд, как у Кирилла и Ярослава (выбор «Марк» → его блок, тренировки, неделя и т.д.), нужно:

1. **Марк есть в таблице `clients`** с тем же `trainer_id`, что и у остальных клиентов.
2. У него есть хотя бы одна **program** и один **training_block** (иначе блок будет «Нет активного блока», но дашборд откроется).
3. При наличии **workout_sessions** и **workout_sets** появятся «Последние тренировки» и сравнение недель.

### 2.1. Проверка: есть ли Марк среди клиентов

В **SQL Editor**:

```sql
SELECT id, name, trainer_id, status FROM clients WHERE name ILIKE '%марк%';
```

- Если записей нет — Марк нужно добавить в `clients` (см. скрипт ниже).
- Если Марк есть, но с другим `trainer_id` — поправь `trainer_id` на того же тренера, что у Кирилла/Ярослава.

### 2.2. Добавление Марка и минимальных данных для дашборда

Используй скрипт **`supabase/scripts/ensure_mark_dashboard.sql`** (см. ниже). Он:

- Находит тренера по `auth_id` или по первой записи в `trainers`.
- Если клиента с именем «Марк» нет — создаёт запись в `clients`.
- Если у Марка нет ни одной программы — создаёт одну программу и один блок (чтобы дашборд не был полностью пустым).

После выполнения открой **deploy/master** → вход → «Выберите клиента» → выбери **Марк**. Должен открыться его дашборд (как у Ярослава/Кирилла), с блоком и при наличии сессий — с тренировками.

### 2.3. Отдельный сайт Марка (deploy/mark)

Папка **deploy/mark** (отдельный дашборд и программа с личным API) может оставаться как отдельная ссылка для Марка. Со временем можно перевести и его на Supabase: тогда данные Марка будут только в Supabase, а в master дашборде он уже будет отображаться после выполнения п. 2.1–2.2.

---

## 3. Краткий чеклист

| Задача | Действие |
|--------|----------|
| Данные Кирилла/Ярослава | Проверка SQL (п. 1.1) → при необходимости повторная миграция GAS (п. 1.2) или ручное дополнение (п. 1.3). |
| Марк в списке клиентов | Проверка (п. 2.1) → при отсутствии выполнить `ensure_mark_dashboard.sql`. |
| Дашборд Марка в master | После появления Марка в `clients` и при наличии программы/блока — выбрать «Марк» на экране выбора клиента. |

Скрипт SQL для Марка: **`supabase/scripts/ensure_mark_dashboard.sql`**.
